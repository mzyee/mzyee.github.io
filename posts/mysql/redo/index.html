<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>InnoDB Redo æ—¥å¿—ç³»ç»Ÿ | MZY&#39;s Blog</title>
<meta name="keywords" content="MySQL, Redo">
<meta name="description" content="InnoDB Redo æ—¥å¿—çš„å‰åå‘æµç¨‹">
<meta name="author" content="Miao Zheyu">
<link rel="canonical" href="https://mzyee.github.io/posts/mysql/redo/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.4f68b80af0db3eb7759a35d1bff637bffd115ac309cb14b149caeeb1b7149650.css" integrity="sha256-T2i4CvDbPrd1mjXRv/Y3v/0RWsMJyxSxScrusbcUllA=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://mzyee.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://mzyee.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://mzyee.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://mzyee.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://mzyee.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<meta property="og:title" content="InnoDB Redo æ—¥å¿—ç³»ç»Ÿ" />
<meta property="og:description" content="InnoDB Redo æ—¥å¿—çš„å‰åå‘æµç¨‹" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mzyee.github.io/posts/mysql/redo/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-10-30T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-10-30T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="InnoDB Redo æ—¥å¿—ç³»ç»Ÿ"/>
<meta name="twitter:description" content="InnoDB Redo æ—¥å¿—çš„å‰åå‘æµç¨‹"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://mzyee.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "MySQL",
      "item": "https://mzyee.github.io/posts/mysql/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "InnoDB Redo æ—¥å¿—ç³»ç»Ÿ",
      "item": "https://mzyee.github.io/posts/mysql/redo/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "InnoDB Redo æ—¥å¿—ç³»ç»Ÿ",
  "name": "InnoDB Redo æ—¥å¿—ç³»ç»Ÿ",
  "description": "InnoDB Redo æ—¥å¿—çš„å‰åå‘æµç¨‹",
  "keywords": [
    "MySQL", "Redo"
  ],
  "articleBody": "1. å‰è¨€ InnoDB çš„ redo log æ¨¡å—æ˜¯ä¿è¯äº‹åŠ¡æŒä¹…æ€§çš„æ ¸å¿ƒï¼ŒInnoDB éµå®ˆ WAL åŸåˆ™ä¿è¯æ€»æ˜¯æ—¥å¿—å…ˆè¡Œï¼Œå³åœ¨æŒä¹…åŒ–æ•°æ®æ–‡ä»¶æ—¶ä¿è¯å…¶å¯¹åº”çš„ redo æ—¥å¿—å·²ç»å†™åˆ°ç£ç›˜ï¼Œè¿™æ ·åœ¨å´©æºƒçš„æƒ…å†µä¸‹ï¼Œå®ƒå°±å¯ä»¥ç”¨äºæ¢å¤å¯¹å·²ä¿®æ”¹ä½†å°šæœªåˆ·æ–°åˆ°ç£ç›˜çš„é¡µé¢çš„ä¿®æ”¹ã€‚æœ¬æ–‡ä¸»è¦è®¨è®º InnoDB ä¸­ redo æ—¥å¿—çš„ç‰©ç†ç»„ç»‡æ ¼å¼ï¼Œå†…å­˜ç»“æ„åŠå‰åå‘çš„ç”Ÿæˆ/åº”ç”¨æµç¨‹ã€‚å¯ä»¥å‚è€ƒé˜…è¯»æ–‡æ¡£ï¼š\næ•°æ®åº“æ•…éšœæ¢å¤æœºåˆ¶ï¼šARIESã€ARIES/IM InnoDB Redo Log å®˜æ–¹ä»‹ç» InnoDB redo log æ¼«æ¸¸ åº–ä¸è§£ InnoDB ä¹‹ REDO LOG 2. Redo æ—¥å¿—çš„ç‰©ç†æ ¼å¼ åœ¨ 8.0.30 ç‰ˆæœ¬å‰ï¼ŒMySQL é€šè¿‡ innodb_log_file_size å’Œ innodb_log_files_in_group åˆ†åˆ«æ§åˆ¶ redo æ–‡ä»¶çš„å¤§å°å’Œæ•°ç›®ï¼Œæ–‡ä»¶åä¸º ib_logfilexxï¼›åœ¨ 8.0.30 ç‰ˆæœ¬åï¼Œå®˜æ–¹æ–°åŠ äº†å‚æ•° innodb_redo_log_capacity å¹¶å…è®¸åŠ¨æ€é…ç½® redo æ—¥å¿—çš„æ€»å®¹é‡ï¼Œç³»ç»Ÿä¸€å…±ç»´æŠ¤äº† 32 ä¸ªæ–‡ä»¶åä¸º #ib_redoxx å’Œ #ib_redoxx_tmpï¼Œå…·æœ‰ _tmp åç¼€çš„æ–‡ä»¶ä¸ºç©ºä½™æœªä½¿ç”¨çš„æ–‡ä»¶ã€‚redo æ—¥å¿—ä¸­çš„æ•°æ®æ˜¯ä»¥ append çš„å½¢å¼ä¸æ–­å¢åŠ ï¼Œæ–‡ä»¶ä¸­ä»»ä¸€ä½ç‚¹çš„æ•°æ®å¯¹åº”ä¸€ä¸ªæ°¸ä¹…é€’å¢çš„ LSN å·æ ‡å¿—ã€‚\nä¸€ä¸ª redo æ–‡ä»¶é¦–å…ˆä»¥ LOG_FILE_HDR_SIZE (2KB = 4*512B) å¤§å°çš„ file header å¼€å¤´ï¼ŒåŒ…å« header info blockã€checkpoint 1ã€encryption infoã€checkpoint 2 è¿™ 4 ä¸ªblockï¼›å…¶ä¸­ header info block è®°å½•äº†ä¸€äº›ï¼Œ4å­—èŠ‚çš„ Log ç‰ˆæœ¬ FORMATã€4å­—èŠ‚ LOG_UUIDã€8å­—èŠ‚ START_LSN æ ‡è¯†çš„å½“å‰æ–‡ä»¶å¼€å§‹LSNã€æœ€é•¿32ä½çš„ Creator ä¿¡æ¯è¡¨ç¤ºå½“å‰ mysql ç‰ˆæœ¬ã€‚æœ‰ä¸¤ä¸ª checkpoint çš„åŸå› æ˜¯é€šè¿‡ double write æœºåˆ¶é˜²æ­¢å•ä¸ª checkpoint è®°å½•å› ä¸ºå†™ç›˜è¿‡ç¨‹ä¸­é—´ crash è€ŒæŸåï¼ˆç°åœ¨å¤šæ•° SSD æ”¯æŒåŸå­å†™ 4K ç²’åº¦ï¼‰ã€‚\nè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯åœ¨ 8.0 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œcheckpoint_lsn ä¸€å®šæŒ‡å‘ä¸€ä¸ª mtr record group çš„å¼€å¤´ï¼Œå¹¶ä¸”è¯¥ mtr record åº”è¯¥è¢«æ¢å¤ï¼ˆè™½ç„¶ç›¸å…³é¡µé¢ä»ç„¶å¯èƒ½å·²è¢«åˆ·å†™ä¸‹å»ï¼‰ã€‚ä½†ä» 8.0 å¼€å§‹ï¼Œç”±äº recent_closed buffer çš„å­˜åœ¨ï¼Œè¿™ä¸ªå€¼å¯èƒ½æŒ‡å‘ record group ä¸­é—´çš„æŸä¸ªå­—èŠ‚ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ¢å¤åº”è¯¥è·³è¿‡åŒ…å«æ£€æŸ¥ç‚¹ lsn çš„æ—¥å¿—è®°å½•ç»„å¹¶ä»å…¶ä¸‹ä¸€æ¡å¼€å§‹ã€‚redo æ–‡ä»¶ä¸­å†™å…¥çš„ checkpoint_lsn ä¸€å®šåœ¨æ­¤ redo çš„ lsn èŒƒå›´ã€‚\næ¥ç€ file header çš„æ˜¯ä¸€ä¸ªä¸ª OS_FILE_LOG_BLOCK_SIZE (512B) å¤§å°çš„ log blockï¼ŒåŒ…æ‹¬12å­—èŠ‚çš„ Header (block number + data length + first record offset + checkpoint number)ã€496ä¸ªå­—èŠ‚çš„ Bodyã€4å­—èŠ‚çš„ Tailer (checksum)ã€‚å¯¹äº Header éƒ¨åˆ†çš„è¯´æ˜æ˜¯ï¼š\n4å­—èŠ‚ Block Numberï¼Œè€ç‰ˆæœ¬ä¸­ Flush Flag å ç”¨æœ€é«˜ä½bitæ ‡è¯†ä¸€æ¬¡ I/O çš„ç¬¬ä¸€ä¸ª Blockï¼Œå‰©ä¸‹çš„31ä¸ª bit æ˜¯å½“å‰ Block ç¼–å· 2å­—èŠ‚ Data Lengthï¼Œé•¿åº¦ä¸º 0 ä¸º æœªä½¿ç”¨ blockï¼ˆreuse æƒ…å†µä¸‹å¯èƒ½æ— æ•ˆï¼‰ï¼Œé•¿åº¦ä¸º [12 , 508) è¡¨ç¤ºæœ€åä¸€ä¸ªæœªå†™å®Œçš„ blockï¼Œ é•¿åº¦ä¸º 512 è¡¨ç¤ºå†™å®Œæ•´çš„ blockï¼› 2å­—èŠ‚ First Record Group Offsetï¼Œç”¨æ¥æŒ‡å‘ Block ä¸­ç¬¬ä¸€ä¸ª mtr record group çš„å¼€å§‹ä½ç½®ï¼Œå¦‚æœå’Œ Data Length ç›¸åŒåˆ™è¯´æ˜å†…éƒ¨æ²¡æœ‰å¼€å¯è®°å½•æ–°çš„ mtr record groupï¼› 4å­—èŠ‚ Epoch Numberï¼Œå’Œ Block Number ä¸€èµ·ç»„æˆäº† block çš„å”¯ä¸€æ ‡å¿—ï¼Œé€šè¿‡ 64 ä½ block start lsn è½¬æ¢è·å¾—ã€‚åœ¨è€ç‰ˆæœ¬ä¸­ï¼Œè¿™é‡Œè®°å½•çš„æ˜¯æ¯æ¬¡åˆ· checkpoint æ—¶æ¨è¿›çš„ log_sys-\u003enext_checkpoint_no çš„ä½å››ä½ã€‚ åœ¨ log block çš„ body éƒ¨åˆ†ï¼Œåˆ™æ˜¯ä¸€æ¡æ¡å®é™…çš„ redo log recordï¼Œæˆ–è€…åœ¨ InnoDB ä¸­ç§°ä¸º mtr record æ›´ä¸ºè´´åˆ‡ã€‚æ¯ä¸ª redo record çš„ç¬¬ä¸€ä¸ª Byte æ˜¯è¿™ä¸ªè®°å½•çš„ç±»å‹ï¼Œå…¶ä¸­æœ€é«˜ä½çš„ bit ä¸º MLOG_SINGLE_REC_FLAGï¼Œå¦‚æœè¢«è®¾ç½®åˆ™è¡¨ç¤ºæ­¤ mtr åªåŒ…å«äº†ï¼ˆæœ€å¤šå•ä¸ªé¡µç›¸å…³ï¼‰çš„å•æ¡è®°å½•ï¼Œå¦åˆ™æ˜¯ç”±å¤šæ¡å• record ç»„æˆçš„ mtr record groupï¼Œå¹¶ä¸”åœ¨ group ç»“å°¾ä¼šä»¥ MLOG_MULTI_REC_ENDæ ‡è®°ï¼›ä¹‹åä»¥å‹ç¼©æ ¼å¼è®°å½•å½“å‰ record å¯¹åº”çš„ space id å’Œ page noï¼ˆé™¤ TABLE_DYNAMIC_META ç­‰ç±»å‹ï¼‰ï¼›æ¥ç€æ˜¯å½“å‰ record å¯¹åº”çš„ record body éƒ¨åˆ†å†…å®¹ï¼Œå…·ä½“å†…å®¹ä¼šç”± record çš„ç±»å‹å†³å®šã€‚\nInnoDB çš„ redo æ˜¯ Physiological Loggingï¼Œç½‘ä¸Šä¸€ç§å¸¸ç”¨è¯´æ³•æ˜¯ â€œPhysical to a pageï¼Œlogical within a pageâ€ï¼Œå®é™…ä¸Šå¯ä»¥ç†è§£æ˜¯åœ¨è®°å½•æ—¥å¿—æ—¶å¯¹å‰å‘è¿‡ç¨‹æ—¥å¿—è®°å½•é‡å’Œåå‘æ—¥å¿—æ¢å¤é€Ÿåº¦çš„ä¼˜åŒ–è€ƒè™‘ï¼Œåœ¨å¯¹äº page å†…çš„ä¿®æ”¹æ—¥å¿—å¹¶éä¸€å®šæ˜¯ logical çš„ï¼Œä½†åœ¨å¯¹äºä¸€ä¸ªæˆ–å¤šä¸ª page çš„å›ºå®šæ¨¡å¼çš„ä¿®æ”¹å¯ä»¥é€šè¿‡ logical log æ¥å‡å° redo è®°å½•é‡ã€‚å¦å¤–åœ¨ undo ç›¸å…³çš„åˆ†ææ–‡ç« ä¸­æåˆ°è¿‡ undo è¡¨ç©ºé—´æ•°æ®ä¹Ÿæ˜¯é€šè¿‡ redo æ¥ç»´æŠ¤çš„ï¼Œè€Œ undo æœ¬èº«æ˜¯åŸºäºé€»è¾‘è€Œéç‰©ç†å»åšå›æ»šçš„ã€‚\n3. Redo æ—¥å¿—çš„ç”Ÿæˆ é¦–å…ˆæœ‰å¿…è¦ä»‹ç» InnoDB ä¸­ mtr (mini-transaction) çš„æ¦‚å¿µï¼ŒInnoDB ä¸­å¯¹äºç‰©ç†æ–‡ä»¶çš„ä¿®æ”¹éƒ½æ˜¯ä»¥ mtr ä½œä¸ºåŸå­å•ä½ï¼ˆæ— è®ºå…¶å†…æ˜¯ single è¿˜æ˜¯ multi record çš„ï¼‰ã€‚ä¸€ä¸ª mtr åœ¨å‰å‘æ‰§è¡Œè¿‡ç¨‹ä¸­ä¼šå æ®æ‰€éœ€çš„èµ„æºï¼ŒåŒ…æ‹¬ indexã€page åŠå…¶å¯¹åº”ç‰©ç†é”ç­‰ï¼Œä»¥ä¿è¯å¹¶å‘æ“ä½œæ­£ç¡®æ€§ï¼Œå¹¶å°†æ•°æ®ä¿®æ”¹æ“ä½œå¯¹åº”ç”Ÿæˆçš„ redo åœ¨ mtr å†…éƒ¨ç¼“å­˜ã€‚åœ¨ mtr commit çš„æ—¶å€™æ­¤ mtr ä¼šå°†ç¼“å­˜çš„ redo record æäº¤åˆ°å…¨å±€ log buffer ä¸­ç­‰å¾…è½ç›˜ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨å†…å­˜é€»è¾‘æ¥çœ‹ï¼ˆä¸å‘ç”Ÿcrashæƒ…å†µä¸‹ï¼‰mtr ä¸€æ—¦æäº¤å°±ä»£è¡¨äº†è¿™ä¸ªç‰©ç†æ“ä½œåœ¨ç³»ç»Ÿå…¨å±€äº§ç”ŸæŒä¹…åŒ–æ•ˆæœï¼Œå“ªæ€•å¯¹åº”æ‰€å±çš„ transaction è¿˜æ²¡æœ‰æˆ–æœ€ç»ˆæœ€ç»ˆæäº¤ï¼Œå› æ­¤è¿™é‡Œåœ¨å¿…é¡»æ—¶å°±éœ€è¦ undo mtr çš„æ“ä½œï¼Œå› æ­¤åœ¨å¯¹åº”æ•°æ®æ“ä½œå‰éƒ½éœ€è¦å…ˆè®°å½• undoï¼›æ­¤å¤–ï¼Œéƒ¨åˆ†ç‰©ç†æ“ä½œå¯èƒ½ä¸ä¼šè¢«æ’¤é”€ï¼Œæ¯”å¦‚ç©ºé—´æ‹“å±•åˆ†é…ç­‰ã€‚\nå¦‚æœ mtr äº§ç”Ÿ redo log åˆ™å…¶åœ¨æäº¤è¿‡ç¨‹ä¸­ï¼š\næ ¹æ®æ•°æ®é•¿åº¦å‘ log_sys ç”³è¯·å¯¹åº”çš„å…¨å±€é¡ºåºè®°å½•çš„ sn èŒƒå›´ï¼Œå…¶é€šè¿‡åŠ ä¸Š block header å’Œ tailerï¼Œä¸åŒ…æ‹¬ file header å¯ä»¥è½¬æ¢ä¸ºå¯¹åº”çš„ lsn èŒƒå›´ï¼›å¹¶ä¸”ç­‰å¾…åˆ° log buffer çš„ç©ºé—´è¶³å¤Ÿå¯¹åº” sn èŒƒå›´æ•°æ®è¢«å†™å…¥ï¼› å¯¹äº mtr ä¸­ç¼“å­˜çš„æ‰€æœ‰ redo recordï¼ŒæŒ‰ log block çš„æ ¼å¼å°† header å’Œ tailer ç•™ç©º copy body å†…å®¹ï¼Œå¹¶å°† header ä¸­çš„ First Record Group Offset å­—æ®µï¼ˆå†™å®Œåçš„ä¸‹ä¸€ä¸ªï¼‰å¡«ä¸Šï¼› ç­‰å¾…è‡³ recent_written link_buf æœ‰ç©ºé—²ä½ç½®ï¼Œè¡¨ç¤ºåˆ°è¿™ä¸€ä½ç½®çš„ lsn å¯¹åº”çš„ log å¯ä»¥è¢«å†™å…¥ï¼›å†æ¨è¿›æ­¤ç»“æ„çš„ä¸­ç›¸åº”çš„ lsn èŒƒå›´ï¼Œè¡¨ç¤ºè¿™ä¸€æ®µå†…å®¹å·²ç»å®Œæ•´å†™å…¥åˆ° log buffer ä¸­ï¼Œå¹¶å°è¯•æ¨è¿›å…¶ m_tailï¼ˆå·²ç»è¿ç»­å®Œæ•´å†™å…¥åˆ°ä½ç½®ï¼‰ï¼› ç­‰å¾…è‡³ recent_closed link_buf æœ‰ç©ºé—²ä½ç½®ï¼Œè¡¨ç¤ºåˆ°è¿™ä¸€ä½ç½®çš„ lsn å¯¹åº”çš„ dirty page å¯ä»¥è¢«åŠ åˆ° flush list ä¸Šï¼›å†å°† dirty page æŒ‚åˆ° flush list ä¸Šï¼› æœ€ç»ˆé‡Šæ”¾æ‰€æœ‰ page é”ç­‰ç‹¬å èµ„æºã€‚ 4. Redo æ—¥å¿—çš„å†™å…¥ åœ¨ mtr redo record å†™å…¥åˆ°å…¨å±€ log buffer ä¸­åï¼Œç³»ç»Ÿé€šè¿‡å…¨å±€ç»“æ„ log_t *log_sys å’Œåå°å·¥ä½œçº¿ç¨‹æ¥å†™å…¥ redo æ—¥å¿—ï¼Œå¹¶ç»´æŠ¤å¦‚å„ç§ lsn ä½ç‚¹ç­‰ç›¸å…³çŠ¶æ€ã€‚\nåå°å·¥ä½œçº¿ç¨‹æœ‰å¦‚ä¸‹è¿™äº›ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 /* æ§åˆ¶ log æ–‡ä»¶çš„è½®è½¬ */ void log_files_governor(log_t *log_ptr); /* å°†å…¨å±€ log buffer ä¸­çš„æ—¥å¿—å†™å…¥åˆ° OS buffer ä¸­ */ void log_writer(log_t *log_ptr); /* å°† OS buffers ä¸­çš„æ•°æ®åˆ·å†™åˆ°ç£ç›˜ä¸Š (fsyncs) */ void log_flusher(log_t *log_ptr); /* é€šçŸ¥ç”¨æˆ·çº¿ç¨‹å¯¹åº” log write å®Œæˆï¼Œwrite_lsn å·²æ›´æ–° */ void log_write_notifier(log_t *log_ptr); /* é€šçŸ¥ç”¨æˆ·çº¿ç¨‹å¯¹åº” log flush å®Œæˆï¼Œflushed_to_disk_lsn å·²æ›´æ–° */ void log_flush_notifier(log_t *log_ptr); /* æ£€æŸ¥æ˜¯å¦éœ€è¦è¦æ±‚å®Œæˆå¼ºåˆ¶åˆ·è„å¹¶å†™å…¥ checkpoint lsn åˆ°æ—¥å¿—æ–‡ä»¶ä¸­ */ void log_checkpointer(log_t *log_ptr); è¿™é‡Œåˆ·å†™ç›¸å…³çš„ä»»åŠ¡å…¶å®éƒ½æ˜¯å›´ç»• log file å’Œ log buffer é¦–ä½ç«¯çš„æ¨è¿›ï¼š\nç³»ç»Ÿç»´æŠ¤äº†æ‰€æœ‰çš„ log file çš„å†…å­˜å¯¹è±¡ Log_files_dictï¼Œå¹¶é€šè¿‡ log_files_governor æ§åˆ¶å·²å†™å…¥å®Œå…¨ï¼ˆå¯ purge æˆ–ä»éœ€è¦ï¼‰ã€å½“å‰æ­£åœ¨å†™å…¥ã€åç»­å¯ä½¿ç”¨çš„ redo æ–‡ä»¶çŠ¶æ€ï¼› log buffer å¤´éƒ¨çš„æ¨è¿›çš„ç›¸å…³çŠ¶æ€ï¼Œbuf_limit_snï¼ˆé™åˆ¶å¯è¢«å†™å…¥åˆ° buffer çš„æœ€å¤§ snï¼Œå³ wirte_lsn + buf_sizeï¼‰ã€recent_written bufferï¼ˆè¿½è¸ªæ§åˆ¶ mtr å¹¶å‘å†™å…¥çŠ¶æ€ log bufferï¼‰ã€recent_closed bufferï¼ˆè¿½è¸ªæ§åˆ¶ dirty page æŒ‚è½½ flush listï¼‰ï¼› log buffer åˆ·å†™çŠ¶æ€ï¼Œåˆ° recent_written tail ä½ç½®çš„ redo å·²ç»å®Œæ•´å¯å†™ç›˜ï¼ˆè¿™é‡Œéœ€è¦ç­‰è‡³ä¸Šä¸€æ¬¡ checkpoint åŠ  redo file æ€»å®¹é‡è¶…è¿‡ç›®æ ‡å†™å…¥ lsnï¼‰ï¼Œlog writer ä¼šå°† log block çš„ header å’Œ tailer å¡«å……ï¼Œç„¶åç¡®å®šå†™å…¥èŒƒå›´ç›´æ¥ä» log bufferï¼ˆå®Œæ•´ log_write_ahead_size å¤§å°å€æ•°ï¼‰æˆ–é€šè¿‡ write_ahead_bufferï¼ˆå°äº log_write_ahead_sizeï¼‰ å†™å…¥ log fileï¼› log buffer å°¾éƒ¨çš„æ¨è¿›çš„ç›¸å…³çŠ¶æ€ï¼Œå¦‚ write_lsnã€flushed_to_disk_lsnï¼Œäº‹ä»¶é€šçŸ¥ç­‰ã€‚ checkpoint æ¨è¿›ï¼Œå¹¶å¯¹ log file å°¾éƒ¨æ–‡ä»¶çš„å›æ”¶ã€‚ å¯¹åº”çº¿ç¨‹å…·ä½“çš„æ‰§è¡Œæµç¨‹ä»‹ç»å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚ 5. Redo æ—¥å¿—åº”ç”¨åŠ InnoDB å¥”æºƒæ¢å¤ åœ¨å¥”æºƒæ¢å¤çš„æƒ…å†µä¸‹ï¼ŒInnoDBé€šè¿‡åº”ç”¨ redo æ¥æ¢å¤å·²ç»æäº¤ä½†è¿˜æ²¡æœ‰åˆ·ç›˜çš„äº‹åŠ¡æ•°æ®ã€‚å¦å¤–ï¼Œä¸€äº›åŸºäºç‰©ç†å¤åˆ¶æ¶æ„çš„æ•°æ®åº“ï¼Œåƒ PolarDBã€AWS Aurora ç­‰ï¼Œè¿˜å­˜åœ¨é€šè¿‡åº”ç”¨ redo æ¥è¿›è¡Œæ•°æ®åŒæ­¥çš„æµç¨‹ã€‚æˆ‘ä»¬è¿™é‡Œåªè®¨è®º recovery çš„ redo é˜¶æ®µï¼Œæ•´ä¸ª InnoDB server çš„å¯åŠ¨ç®€åŒ–æµç¨‹å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 dberr_t srv_start(bool create_new_db) { // Step 0. ç¯å¢ƒå‡†å¤‡å’Œæ£€æŸ¥ï¼Œ... // Step 1. åˆå§‹åŒ– SRV å˜é‡ï¼Œ... srv_boot(); // Step 2. æ‰«æé…ç½®çš„ç›®å½•ï¼Œç”Ÿæˆæ–‡ä»¶map fil_init(innobase_get_open_files_limit()); // ç¡®å®šè·¯å¾„... // æ‰«æè·å– .IBD å’Œ undo æ–‡ä»¶ï¼Œä»é¦– page ä¸­è¯»å– space_id å¹¶è®°å½•åˆ° fil_system çš„ Tablespace_dirs err = fil_scan_for_tablespaces(); // Step 3. INNODB STATUS ç›‘æ§æ–‡ä»¶... // Step 4. åˆå§‹åŒ– AIO çº¿ç¨‹... os_aio_init(srv_n_read_io_threads, srv_n_write_io_threads) // Step 5. åˆå§‹åŒ– buffer pool... err = buf_pool_init(srv_buf_pool_size, srv_buf_pool_instances); // Step 6. åˆå§‹åŒ–å¤šä¸ªå­ç³»ç»Ÿ... fsp_init(); pars_init(); recv_sys_create(); recv_sys_init(); trx_sys_create(); lock_sys_create(srv_lock_table_size); os_aio_start_threads();/* i/o-handler threads */ buf_flush_page_cleaner_init(); // Step 7. åˆå§‹åŒ– system tablespace... // ibdata1 æ–‡ä»¶å†…å«ç³»ç»Ÿè¡¨ç©ºé—´ï¼ˆæ³¨æ„ä¸ å…ƒæ•°æ®DDè¡¨ç©ºé—´ æˆ–å« å†…éƒ¨ç³»ç»Ÿè¡¨ çš„ mysql.ibd åŒºåˆ†ï¼‰ // å†…å« change buffer(ï¼Œç‰¹å®šæƒ…å†µä¸‹å«ç”¨æˆ·è¡¨ã€undo è¡¨)ç­‰ // åˆ›å»ºå¯¹åº”çš„ sysspace å¹¶åŠ å…¥ fil_system (fil_space_create + fil_node_create) err = srv_sys_space.open_or_create(false, create_new_db, \u0026sum_of_new_sizes, \u0026flushed_lsn); dict_persist_init(); // Step 8. åˆå§‹åŒ– log sysï¼Œè¿™é‡Œè¿˜ä¼šæ‰«æå‡ºæ‰€æœ‰ redo file æ¥æ„å»º Log_files_dict err = log_sys_init(create_new_db, flushed_lsn, new_files_lsn); //... if (create_new_db) { // åˆå§‹åŒ–å»ºç«‹æ–° db } else { // Step 9. BPçŠ¶æ€é‡ç½® err = dblwr::v1::init(); /* åˆå§‹åŒ– double write */ buf_pool_invalidate(); /* æ·˜æ±°æ‰€æœ‰ page ç¡®ä¿ recovery é‡è¯» */ // Step 10. æ‰“å¼€æ‰€æœ‰ log files å’Œ system data files fil_open_system_tablespace_files(); // Step 11. å¼€å§‹æ¢å¤ redo æ—¥å¿—... err = recv_recovery_from_checkpoint_start(*log_sys, flushed_lsn); // ... åˆå§‹åŒ– innodb data dictionary system // Step 12. å¯åŠ¨åå° log çº¿ç¨‹ ... if (!srv_read_only_mode) { log_start_background_threads(*log_sys); } // Step 13. åº”ç”¨å‰©ä½™çš„æœ€åä¸€æ‰¹ hashed log records if (srv_force_recovery \u003c SRV_FORCE_NO_LOG_REDO) { err = recv_apply_hashed_log_recs(*log_sys, !recv_sys-\u003eis_cloned_db \u0026\u0026 !log_upgrade); } // ä¸€äº›æ£€æŸ¥... // Step 14. åˆ·å†™æ‰€æœ‰è„é¡µ if (!srv_force_recovery \u0026\u0026 !srv_read_only_mode) { buf_flush_sync_all_buf_pools(); } // Step 15. å®Œæˆ redo æ—¥å¿—æ¢å¤åçš„æ¸…ç†ï¼Œæ¢å¤dynamic metadata MetadataRecover *dict_metadata = recv_recovery_from_checkpoint_finish(false); /* æ­¤æ—¶ DDï¼ˆtable persistent dataï¼‰è¿˜æ²¡æœ‰å®Œå…¨ recovery */ if (!recv_sys-\u003eis_cloned_db \u0026\u0026 !dict_metadata-\u003eempty()) { fil_space_t *space = fil_space_acquire_silent(dict_sys_t::s_dict_space_id); if (space == nullptr) { dberr_t error = fil_ibd_open(true, FIL_TYPE_TABLESPACE, dict_sys_t::s_dict_space_id, predefined_flags, dict_sys_t::s_dd_space_name, dict_sys_t::s_dd_space_file_name, true, false); } else { fil_space_release(space); } dict_persist-\u003etable_buffer = ut::new_withkey\u003cDDTableBuffer\u003e(UT_NEW_THIS_FILE_PSI_KEY); dict_metadata-\u003estore(); // å°†æ¢å¤è¿‡ç¨‹ä¸­persistent dynamic metadataä¿®æ”¹ store åˆ° mysql.innodb_dynamic_metadata log_buffer_flush_to_disk(*log_sys); } ut::delete_(dict_metadata); // Step 16. æ„å»º Undo Tablespaces å’Œ Rollback Segments å†…å­˜ç»“æ„å¹¶è¿›è¡Œæ¢å¤ err = srv_undo_tablespaces_init(false); trx_purge_sys_mem_create(); purge_queue = trx_sys_init_at_db_start(); srv_undo_tablespaces_upgrade(); trx_purge_sys_initialize(srv_threads.m_purge_workers_n, purge_queue); } /* Open temp-tablespace and keep it open until shutdown. */ err = srv_open_tmp_tablespace(create_new_db, \u0026srv_tmp_space); err = ibt::open_or_create(create_new_db); // Step 17. å®Œæ•´åŒ– undo è¡¨ç©ºé—´ // å¢åŠ  rollback segment æ•°ç›®åˆ° srv_rollback_segmentsï¼Œæ­¤æ¬¡é…ç½®å¯èƒ½å’Œä¸Šæ¬¡ä¸åŒ trx_rseg_adjust_rollback_segments(srv_rollback_segments); // æ„å»ºå®Œæˆå®Œæ•´ undo è¡¨ç©ºé—´ï¼Œåˆ é™¤ trunc.logï¼Œè®¾ç½®active srv_undo_tablespaces_mark_construction_done(); undo::spaces-\u003es_lock(); for (auto undo_space : undo::spaces-\u003em_spaces) { if (!undo_space-\u003eis_empty()) { undo_space-\u003eset_active(); } } undo::spaces-\u003es_unlock(); // Step 18. ç›‘æ§ç³»ç»Ÿç­‰... // Step 19. something... return (DB_SUCCESS); } å…¶ä¸­æ¯”è¾ƒå…³é”®çš„é˜¶æ®µåœ¨äº Step 11 recv_recovery_from_checkpoint_start ä¸­è¿›è¡Œ redo æ¢å¤ä»¥åŠ Step 16 æ¢å¤ undo å’Œ trx ç³»ç»Ÿçš„çŠ¶æ€ï¼Œåè€…åœ¨ undo ç³»ç»Ÿçš„è®¨è®ºä¸­è¿›è¡Œä»‹ç»ï¼Œæœ¬æ–‡ä¸»è¦è®¨è®ºå‰è€…ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 dberr_t recv_recovery_from_checkpoint_start(log_t \u0026log, lsn_t flush_lsn) { // Step 1. åˆå§‹åŒ–flush_rbtï¼Œä¿è¯è„é¡µæŒ‰åºæ’å…¥flush list buf_flush_init_flush_rbt(); // Step 2. é€šè¿‡æ‰«æ Log_files_dict æ‰¾æœ€åçš„ checkpoint è®°å½• Log_checkpoint_location checkpoint; recv_find_max_checkpoint(log, checkpoint); // ... /* Step 3. è§£æå­˜å‚¨ redo recordï¼š 1. ä» checkpoint è¯»å– redo æ–‡ä»¶æš‚å­˜åˆ° log_sys-\u003ebufï¼› 2. æŒ‰ log block æ‰«æå» block head/tail å­˜åˆ° recv_sys-\u003ebuf ä¸­ï¼› 3. å°† recv_sys-\u003ebuf ä¸­çš„è®°å½• parseï¼Œç”Ÿæˆ recv_t *recvï¼ˆå•ä¸ª recordï¼‰å’Œ recv_addr_t *recv_addrï¼ˆpage æ‰€æœ‰ record ä¸²ï¼‰ï¼› 4. å­˜å‚¨ recv_addr_t åˆ° recv_sys å“ˆå¸Œè¡¨å¯¹åº”çš„ (space_id, page_no) å¤„ 5. ï¼ˆå¦‚æœå ç”¨å†…å­˜è¾ƒå¤§ï¼‰å°†æ‰€æœ‰å­˜å‚¨çš„ record apply åˆ° page ä¸Šï¼Œbpå†…çš„èµ° recv_recover_pageã€bpå¤–çš„èµ° buf_read_recv_pages */ recv_recovery_begin(log, checkpoint_lsn); // Step 4. åˆå§‹åŒ– log_sys çŠ¶æ€ï¼ŒåŒ…æ‹¬å„ lsn ä½ç‚¹ã€å„ buf çŠ¶æ€ lsn_t recovered_lsn = log.recovered_lsn = recv_sys-\u003erecovered_lsn; auto check_scanned_lsn = log.m_scanned_lsn; if (check_scanned_lsn % OS_FILE_LOG_BLOCK_SIZE == 0) { // If it is at block boundary, add header size. check_scanned_lsn += LOG_BLOCK_HDR_SIZE; } err = log_start(log, checkpoint_lsn, recovered_lsn, false); if (!srv_read_only_mode) { log.next_checkpoint_header_no = log_next_checkpoint_header(checkpoint.m_checkpoint_header_no); err = log_files_next_checkpoint(log, checkpoint_lsn); } mutex_enter(\u0026recv_sys-\u003emutex); recv_sys-\u003eapply_log_recs = true; mutex_exit(\u0026recv_sys-\u003emutex); return DB_SUCCESS; } å¯¹åº” redo çš„ä½¿ç”¨ä¸»è¦åœ¨äº parse å’Œ apply ä¸¤ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«å¯¹åº” recv_parse_log_recs å’Œ recv_apply_log_rec ä¸¤ä¸ªæ¥å£ã€‚parse é˜¶æ®µå®Œæˆå recv_sys å†… redo record hash çš„ç»“æ„å±‚æ¬¡å¦‚ä¸‹ï¼Œå­˜å‚¨çš„æ˜¯å¯¹åº” (space,page) çš„è§£æå®Œæˆçš„ redo record bodyã€‚\n1 2 3 4 recv_sys =\u003e space_m =\u003e page_x =\u003e recv_addr_t =\u003e recv_t(data1)-\u003erecv_t(data2)-\u003erecv_t(data3) =\u003e page_y =\u003e recv_addr_t =\u003e recv_t(data1)-\u003e... =\u003e ... space_n =\u003e ... è§£æçš„é€»è¾‘è¾ƒä¸ºç®€å•ï¼Œç”±äº InnoDB å¯¹äºå•ä¸ª redo record ä¸ä¼šè®°å½•é•¿åº¦ï¼Œå› æ­¤å°±æ˜¯é€šè¿‡ redo ç±»å‹ç¡®å®šèµ°ä¸åŒè§£æé€»è¾‘ç¡®å®š redo record é•¿åº¦ï¼ˆè¿™é‡Œ MariaDB è®°å½•äº†é•¿åº¦æ¥åŠ é€Ÿï¼Œå½“ç„¶å…¶ redo å†…å®¹ä¹Ÿè¿˜æœ‰è®¸å¤šå…¶ä»–ä¿®æ”¹ï¼‰ã€‚éœ€è¦æ³¨æ„çš„æ˜¯å¯¹åº”ä¸€äº›éç‰©ç† page çš„ redo (å¦‚ MLOG_FILE_EXTEND) æˆ–ç‰¹æ®Š page (å¦‚ page 0) å…ƒä¿¡æ¯ä¿®æ”¹ï¼Œåœ¨ parse é˜¶æ®µå°±ä¼šåšé¢å¤–çš„å¤„ç†å·¥ä½œæ¥ç»´æŠ¤çŠ¶æ€ã€‚\nåº”ç”¨çš„é€»è¾‘è§¦å‘é€»è¾‘æœ‰ä¸¤ç§ï¼Œå¯¹äº bp å†…çš„ page ç›´æ¥èµ° recv_recover_pageï¼Œå¯¹äº bp å¤–çš„ page åœ¨è¯» I/O å®Œæˆæ—¶ buf_page_io_complete ä¹Ÿæ˜¯è°ƒç”¨ recv_recover_pageï¼ˆå”¯ä¸€ä¸åŒçš„æ˜¯åè€…ä¼šè½¬ç§» page çš„ x-latch çš„ ownership åˆ°å½“å‰çº¿ç¨‹ï¼‰ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 void recv_recover_page_func(bool just_read_in, buf_block_t *block) { mutex_enter(\u0026recv_sys-\u003emutex); if (recv_sys-\u003eapply_log_recs == false) { mutex_exit(\u0026recv_sys-\u003emutex); return; } recv_addr_t *recv_addr = recv_get_rec(block-\u003epage.id.space(), block-\u003epage.id.page_no()); if (recv_addr == nullptr || recv_addr-\u003estate == RECV_BEING_PROCESSED || recv_addr-\u003estate == RECV_PROCESSED) { mutex_exit(\u0026recv_sys-\u003emutex); return; } recv_addr-\u003estate = RECV_BEING_PROCESSED; mutex_exit(\u0026recv_sys-\u003emutex); mtr_t mtr; mtr_start(\u0026mtr); mtr_set_log_mode(\u0026mtr, MTR_LOG_NONE); // redo åº”ç”¨ä¸åœ¨è®°å½•redo // è·å– page block page_t *page = block-\u003eframe; page_zip_des_t *page_zip = buf_block_get_page_zip(block); if (just_read_in) { rw_lock_x_lock_move_ownership(\u0026block-\u003elock); } bool success = buf_page_get_known_nowait( RW_X_LATCH, block, Cache_hint::KEEP_OLD, __FILE__, __LINE__, \u0026mtr); ut_a(success); // è·å– page lsn lsn_t page_lsn = mach_read_from_8(page + FIL_PAGE_LSN); lsn_t page_newest_lsn = buf_page_get_newest_modification(\u0026block-\u003epage); lsn_t end_lsn = 0; lsn_t start_lsn = 0; bool modification_to_page = false; if (page_newest_lsn) { page_lsn = page_newest_lsn; } for (auto recv : recv_addr-\u003erec_list) { end_lsn = recv-\u003eend_lsn; byte *buf = nullptr; if (recv-\u003elen \u003e RECV_DATA_BLOCK_SIZE) { buf = static_cast\u003cbyte *\u003e(ut::malloc_withkey(UT_NEW_THIS_FILE_PSI_KEY, recv-\u003elen)); recv_data_copy_to_buf(buf, recv); } else if (recv-\u003edata != nullptr) { buf = ((byte *)(recv-\u003edata)) + sizeof(recv_data_t); } if (recv-\u003etype == MLOG_INIT_FILE_PAGE) { // init page ç±»å‹å…ˆä¿®æ­£ page lsnï¼Œç›¸å½“äºç¬¬ä¸€æ¬¡ä¼šå¼ºåˆ¶åš apply page_lsn = page_newest_lsn; memset(FIL_PAGE_LSN + page, 0, 8); memset(UNIV_PAGE_SIZE - FIL_PAGE_END_LSN_OLD_CHKSUM + page, 0, 8); if (page_zip) memset(FIL_PAGE_LSN + page_zip-\u003edata, 0, 8); } // è¿‡æ»¤æ¡ä»¶ï¼š1. page lsn ä¸è¶…è¿‡ redo çš„ lsnï¼›2. å¯¹äº undo ç©ºé—´æ²¡æœ‰ truncate if (recv-\u003estart_lsn \u003e= page_lsn \u0026\u0026 undo::is_active(recv_addr-\u003espace)) { lsn_t end_lsn; unsigned char *buf_end = nullptr; if (!modification_to_page) { modification_to_page = true; start_lsn = recv-\u003estart_lsn; } if (buf != nullptr) { buf_end = buf + recv-\u003elen; } // è¿™é‡ŒæŒ‰ç…§ redo ç±»å‹å¯¹ page çœŸæ­£è¿›è¡Œæ•°æ®ä¿®æ”¹æ¢å¤ recv_parse_or_apply_log_rec_body(recv-\u003etype, buf, buf_end, recv_addr-\u003espace, recv_addr-\u003epage_no, block, \u0026mtr, ULINT_UNDEFINED, LSN_MAX); end_lsn = recv-\u003estart_lsn + recv-\u003elen; // æ›´æ–° page lsn mach_write_to_8(FIL_PAGE_LSN + page, end_lsn); mach_write_to_8(UNIV_PAGE_SIZE - FIL_PAGE_END_LSN_OLD_CHKSUM + page, end_lsn); if (page_zip) mach_write_to_8(FIL_PAGE_LSN + page_zip-\u003edata, end_lsn); ++applied_recs; } else { ++skipped_recs; } if (recv-\u003elen \u003e RECV_DATA_BLOCK_SIZE) ut::free(buf); } // æœ‰ä¿®æ”¹è¦åŠ å…¥è„é¡µ if (modification_to_page) { buf_flush_recv_note_modification(block, start_lsn, end_lsn); } mtr_commit(\u0026mtr); // æ›´æ–° recv_sys çŠ¶æ€ mutex_enter(\u0026recv_sys-\u003emutex); if (recv_max_page_lsn \u003c page_lsn) recv_max_page_lsn = page_lsn; recv_addr-\u003estate = RECV_PROCESSED; --recv_sys-\u003en_addrs; mutex_exit(\u0026recv_sys-\u003emutex); } ç‰ˆæƒå£°æ˜ï¼šå¦‚éœ€è½¬è½½æˆ–å¼•ç”¨ï¼Œè¯·é™„åŠ æœ¬æ–‡é“¾æ¥å¹¶æ³¨æ˜æ¥æºã€‚ ",
  "wordCount" : "1829",
  "inLanguage": "zh",
  "datePublished": "2023-10-30T00:00:00Z",
  "dateModified": "2023-10-30T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Miao Zheyu"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://mzyee.github.io/posts/mysql/redo/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "MZY's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://mzyee.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://mzyee.github.io" accesskey="h" title="MZY&#39;s Blog (Alt + H)">
                <img src="https://mzyee.github.io/img/eye.jpeg" alt="" aria-label="logo"
                    height="33">MZY&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://mzyee.github.io/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://mzyee.github.io/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://mzyee.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://mzyee.github.io/contact" title="Contact">
                    <span>Contact</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://mzyee.github.io">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://mzyee.github.io/posts/">Posts</a>&nbsp;Â»&nbsp;<a href="https://mzyee.github.io/posts/mysql/">MySQL</a></div>
    <h1 class="post-title">
      InnoDB Redo æ—¥å¿—ç³»ç»Ÿ
    </h1>
    <div class="post-meta"><span title='2023-10-30 00:00:00 +0000 UTC'>åæœˆ 30, 2023</span>&nbsp;Â·&nbsp;9 åˆ†é’Ÿ&nbsp;Â·&nbsp;Miao Zheyu
      &nbsp;|&nbsp;ğŸ“– &nbsp;
      <ul class="post-tags-meta">
        <a href="https://mzyee.github.io/tags/mysql/">MySQL</a>
        <a href="https://mzyee.github.io/tags/redo/">&nbsp;Redo</a>
      </ul>&nbsp;|&nbsp;<a href="https://github.com/mzyee/mzyee.github.io" rel="noopener noreferrer" target="_blank">Suggestions</a>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#1-%e5%89%8d%e8%a8%80" aria-label="1. å‰è¨€">1. å‰è¨€</a></li>
                    <li>
                        <a href="#2-redo-%e6%97%a5%e5%bf%97%e7%9a%84%e7%89%a9%e7%90%86%e6%a0%bc%e5%bc%8f" aria-label="2. Redo æ—¥å¿—çš„ç‰©ç†æ ¼å¼">2. Redo æ—¥å¿—çš„ç‰©ç†æ ¼å¼</a></li>
                    <li>
                        <a href="#3-redo-%e6%97%a5%e5%bf%97%e7%9a%84%e7%94%9f%e6%88%90" aria-label="3. Redo æ—¥å¿—çš„ç”Ÿæˆ">3. Redo æ—¥å¿—çš„ç”Ÿæˆ</a></li>
                    <li>
                        <a href="#4-redo-%e6%97%a5%e5%bf%97%e7%9a%84%e5%86%99%e5%85%a5" aria-label="4. Redo æ—¥å¿—çš„å†™å…¥">4. Redo æ—¥å¿—çš„å†™å…¥</a></li>
                    <li>
                        <a href="#5-redo-%e6%97%a5%e5%bf%97%e5%ba%94%e7%94%a8%e5%8f%8a-innodb-%e5%a5%94%e6%ba%83%e6%81%a2%e5%a4%8d" aria-label="5. Redo æ—¥å¿—åº”ç”¨åŠ InnoDB å¥”æºƒæ¢å¤">5. Redo æ—¥å¿—åº”ç”¨åŠ InnoDB å¥”æºƒæ¢å¤</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>


  <div class="post-content"><h3 id="1-å‰è¨€">1. å‰è¨€<a hidden class="anchor" aria-hidden="true" href="#1-å‰è¨€">#</a></h3>
<p>â€ƒâ€ƒ InnoDB çš„ redo log æ¨¡å—æ˜¯ä¿è¯äº‹åŠ¡æŒä¹…æ€§çš„æ ¸å¿ƒï¼ŒInnoDB éµå®ˆ WAL åŸåˆ™ä¿è¯æ€»æ˜¯æ—¥å¿—å…ˆè¡Œï¼Œå³åœ¨æŒä¹…åŒ–æ•°æ®æ–‡ä»¶æ—¶ä¿è¯å…¶å¯¹åº”çš„ redo æ—¥å¿—å·²ç»å†™åˆ°ç£ç›˜ï¼Œè¿™æ ·åœ¨å´©æºƒçš„æƒ…å†µä¸‹ï¼Œå®ƒå°±å¯ä»¥ç”¨äºæ¢å¤å¯¹å·²ä¿®æ”¹ä½†å°šæœªåˆ·æ–°åˆ°ç£ç›˜çš„é¡µé¢çš„ä¿®æ”¹ã€‚æœ¬æ–‡ä¸»è¦è®¨è®º InnoDB ä¸­ redo æ—¥å¿—çš„ç‰©ç†ç»„ç»‡æ ¼å¼ï¼Œå†…å­˜ç»“æ„åŠå‰åå‘çš„ç”Ÿæˆ/åº”ç”¨æµç¨‹ã€‚å¯ä»¥å‚è€ƒé˜…è¯»æ–‡æ¡£ï¼š</p>
<ul>
<li>æ•°æ®åº“æ•…éšœæ¢å¤æœºåˆ¶ï¼š<a href="https://dl.acm.org/doi/pdf/10.1145/128765.128770">ARIES</a>ã€<a href="https://dl.acm.org/doi/pdf/10.1145/141484.130338">ARIES/IM</a></li>
<li><a href="https://dev.mysql.com/doc/dev/mysql-server/latest/PAGE_INNODB_REDO_LOG.html">InnoDB Redo Log å®˜æ–¹ä»‹ç»</a></li>
<li><a href="http://mysql.taobao.org/monthly/2015/05/01/">InnoDB redo log æ¼«æ¸¸</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/109417488">åº–ä¸è§£ InnoDB ä¹‹ REDO LOG</a></li>
</ul>
<!-- Redo æ—¥å¿—çš„ç‰©ç†æ ¼å¼ -->
<h3 id="2-redo-æ—¥å¿—çš„ç‰©ç†æ ¼å¼">2. Redo æ—¥å¿—çš„ç‰©ç†æ ¼å¼<a hidden class="anchor" aria-hidden="true" href="#2-redo-æ—¥å¿—çš„ç‰©ç†æ ¼å¼">#</a></h3>
<p>â€ƒâ€ƒ åœ¨ 8.0.30 ç‰ˆæœ¬å‰ï¼ŒMySQL é€šè¿‡ innodb_log_file_size å’Œ innodb_log_files_in_group åˆ†åˆ«æ§åˆ¶ redo æ–‡ä»¶çš„å¤§å°å’Œæ•°ç›®ï¼Œæ–‡ä»¶åä¸º <code>ib_logfilexx</code>ï¼›åœ¨ 8.0.30 ç‰ˆæœ¬åï¼Œå®˜æ–¹æ–°åŠ äº†å‚æ•° innodb_redo_log_capacity å¹¶å…è®¸åŠ¨æ€é…ç½® redo æ—¥å¿—çš„æ€»å®¹é‡ï¼Œç³»ç»Ÿä¸€å…±ç»´æŠ¤äº† 32 ä¸ªæ–‡ä»¶åä¸º <code>#ib_redoxx</code> å’Œ <code>#ib_redoxx_tmp</code>ï¼Œå…·æœ‰ <code>_tmp</code> åç¼€çš„æ–‡ä»¶ä¸ºç©ºä½™æœªä½¿ç”¨çš„æ–‡ä»¶ã€‚redo æ—¥å¿—ä¸­çš„æ•°æ®æ˜¯ä»¥ append çš„å½¢å¼ä¸æ–­å¢åŠ ï¼Œæ–‡ä»¶ä¸­ä»»ä¸€ä½ç‚¹çš„æ•°æ®å¯¹åº”ä¸€ä¸ªæ°¸ä¹…é€’å¢çš„ LSN å·æ ‡å¿—ã€‚</p>
<p>â€ƒâ€ƒ ä¸€ä¸ª redo æ–‡ä»¶é¦–å…ˆä»¥ <code>LOG_FILE_HDR_SIZE (2KB = 4*512B)</code> å¤§å°çš„ file header å¼€å¤´ï¼ŒåŒ…å« <strong>header info block</strong>ã€<strong>checkpoint 1</strong>ã€<strong>encryption info</strong>ã€<strong>checkpoint 2</strong> è¿™ 4 ä¸ªblockï¼›å…¶ä¸­ header info block è®°å½•äº†ä¸€äº›ï¼Œ4å­—èŠ‚çš„ Log ç‰ˆæœ¬ FORMATã€4å­—èŠ‚ LOG_UUIDã€8å­—èŠ‚ START_LSN æ ‡è¯†çš„å½“å‰æ–‡ä»¶å¼€å§‹LSNã€æœ€é•¿32ä½çš„ Creator ä¿¡æ¯è¡¨ç¤ºå½“å‰ mysql ç‰ˆæœ¬ã€‚æœ‰ä¸¤ä¸ª checkpoint çš„åŸå› æ˜¯é€šè¿‡ double write æœºåˆ¶é˜²æ­¢å•ä¸ª checkpoint è®°å½•å› ä¸ºå†™ç›˜è¿‡ç¨‹ä¸­é—´ crash è€ŒæŸåï¼ˆç°åœ¨å¤šæ•° SSD æ”¯æŒåŸå­å†™ 4K ç²’åº¦ï¼‰ã€‚</p>
<p>â€ƒâ€ƒ è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯åœ¨ 8.0 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œcheckpoint_lsn ä¸€å®šæŒ‡å‘ä¸€ä¸ª mtr record group çš„å¼€å¤´ï¼Œå¹¶ä¸”è¯¥ mtr record åº”è¯¥è¢«æ¢å¤ï¼ˆè™½ç„¶ç›¸å…³é¡µé¢ä»ç„¶å¯èƒ½å·²è¢«åˆ·å†™ä¸‹å»ï¼‰ã€‚ä½†ä» 8.0 å¼€å§‹ï¼Œç”±äº recent_closed buffer çš„å­˜åœ¨ï¼Œè¿™ä¸ªå€¼å¯èƒ½æŒ‡å‘ record group ä¸­é—´çš„æŸä¸ªå­—èŠ‚ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ¢å¤åº”è¯¥è·³è¿‡åŒ…å«æ£€æŸ¥ç‚¹ lsn çš„æ—¥å¿—è®°å½•ç»„å¹¶ä»å…¶ä¸‹ä¸€æ¡å¼€å§‹ã€‚redo æ–‡ä»¶ä¸­å†™å…¥çš„ checkpoint_lsn ä¸€å®šåœ¨æ­¤ redo çš„ lsn èŒƒå›´ã€‚</p>
<p>â€ƒâ€ƒ æ¥ç€ file header çš„æ˜¯ä¸€ä¸ªä¸ª <code>OS_FILE_LOG_BLOCK_SIZE (512B)</code> å¤§å°çš„ log blockï¼ŒåŒ…æ‹¬12å­—èŠ‚çš„ Header (block number + data length + first record offset + checkpoint number)ã€496ä¸ªå­—èŠ‚çš„ Bodyã€4å­—èŠ‚çš„ Tailer (checksum)ã€‚å¯¹äº Header éƒ¨åˆ†çš„è¯´æ˜æ˜¯ï¼š</p>
<ul>
<li><strong>4å­—èŠ‚ Block Number</strong>ï¼Œè€ç‰ˆæœ¬ä¸­ Flush Flag å ç”¨æœ€é«˜ä½bitæ ‡è¯†ä¸€æ¬¡ I/O çš„ç¬¬ä¸€ä¸ª Blockï¼Œå‰©ä¸‹çš„31ä¸ª bit æ˜¯å½“å‰ Block ç¼–å·</li>
<li><strong>2å­—èŠ‚ Data Length</strong>ï¼Œé•¿åº¦ä¸º 0 ä¸º æœªä½¿ç”¨ blockï¼ˆreuse æƒ…å†µä¸‹å¯èƒ½æ— æ•ˆï¼‰ï¼Œé•¿åº¦ä¸º [12 , 508) è¡¨ç¤ºæœ€åä¸€ä¸ªæœªå†™å®Œçš„ blockï¼Œ é•¿åº¦ä¸º 512 è¡¨ç¤ºå†™å®Œæ•´çš„ blockï¼›</li>
<li><strong>2å­—èŠ‚ First Record Group Offset</strong>ï¼Œç”¨æ¥æŒ‡å‘ Block ä¸­ç¬¬ä¸€ä¸ª mtr record group çš„å¼€å§‹ä½ç½®ï¼Œå¦‚æœå’Œ Data Length ç›¸åŒåˆ™è¯´æ˜å†…éƒ¨æ²¡æœ‰å¼€å¯è®°å½•æ–°çš„ mtr record groupï¼›</li>
<li><strong>4å­—èŠ‚ Epoch Number</strong>ï¼Œå’Œ Block Number ä¸€èµ·ç»„æˆäº† block çš„å”¯ä¸€æ ‡å¿—ï¼Œé€šè¿‡ 64 ä½ block start lsn è½¬æ¢è·å¾—ã€‚åœ¨è€ç‰ˆæœ¬ä¸­ï¼Œè¿™é‡Œè®°å½•çš„æ˜¯æ¯æ¬¡åˆ· checkpoint æ—¶æ¨è¿›çš„ log_sys-&gt;next_checkpoint_no çš„ä½å››ä½ã€‚</li>
</ul>
<p>â€ƒâ€ƒ åœ¨ log block çš„ body éƒ¨åˆ†ï¼Œåˆ™æ˜¯ä¸€æ¡æ¡å®é™…çš„ redo log recordï¼Œæˆ–è€…åœ¨ InnoDB ä¸­ç§°ä¸º mtr record æ›´ä¸ºè´´åˆ‡ã€‚æ¯ä¸ª redo record çš„ç¬¬ä¸€ä¸ª Byte æ˜¯è¿™ä¸ª<strong>è®°å½•çš„ç±»å‹</strong>ï¼Œå…¶ä¸­æœ€é«˜ä½çš„ bit ä¸º <strong>MLOG_SINGLE_REC_FLAG</strong>ï¼Œå¦‚æœè¢«è®¾ç½®åˆ™è¡¨ç¤ºæ­¤ mtr åªåŒ…å«äº†ï¼ˆæœ€å¤šå•ä¸ªé¡µç›¸å…³ï¼‰çš„å•æ¡è®°å½•ï¼Œå¦åˆ™æ˜¯ç”±å¤šæ¡å• record ç»„æˆçš„ mtr record groupï¼Œå¹¶ä¸”åœ¨ group ç»“å°¾ä¼šä»¥ <strong>MLOG_MULTI_REC_END</strong>æ ‡è®°ï¼›ä¹‹åä»¥å‹ç¼©æ ¼å¼è®°å½•å½“å‰ record <strong>å¯¹åº”çš„ space id å’Œ page no</strong>ï¼ˆé™¤ TABLE_DYNAMIC_META ç­‰ç±»å‹ï¼‰ï¼›æ¥ç€æ˜¯å½“å‰ record å¯¹åº”çš„ <strong>record body</strong> éƒ¨åˆ†å†…å®¹ï¼Œå…·ä½“å†…å®¹ä¼šç”± record çš„ç±»å‹å†³å®šã€‚</p>
<p>â€ƒâ€ƒ InnoDB çš„ redo æ˜¯ Physiological Loggingï¼Œç½‘ä¸Šä¸€ç§å¸¸ç”¨è¯´æ³•æ˜¯ â€œPhysical to a pageï¼Œlogical within a pageâ€ï¼Œå®é™…ä¸Šå¯ä»¥ç†è§£æ˜¯åœ¨è®°å½•æ—¥å¿—æ—¶å¯¹å‰å‘è¿‡ç¨‹æ—¥å¿—è®°å½•é‡å’Œåå‘æ—¥å¿—æ¢å¤é€Ÿåº¦çš„ä¼˜åŒ–è€ƒè™‘ï¼Œåœ¨å¯¹äº page å†…çš„ä¿®æ”¹æ—¥å¿—å¹¶éä¸€å®šæ˜¯ logical çš„ï¼Œä½†åœ¨å¯¹äºä¸€ä¸ªæˆ–å¤šä¸ª page çš„å›ºå®šæ¨¡å¼çš„ä¿®æ”¹å¯ä»¥é€šè¿‡ logical log æ¥å‡å° redo è®°å½•é‡ã€‚å¦å¤–åœ¨ undo ç›¸å…³çš„åˆ†ææ–‡ç« ä¸­æåˆ°è¿‡ undo è¡¨ç©ºé—´æ•°æ®ä¹Ÿæ˜¯é€šè¿‡ redo æ¥ç»´æŠ¤çš„ï¼Œè€Œ undo æœ¬èº«æ˜¯åŸºäºé€»è¾‘è€Œéç‰©ç†å»åšå›æ»šçš„ã€‚</p>
<!-- Redo æ—¥å¿—çš„ç”Ÿæˆ -->
<h3 id="3-redo-æ—¥å¿—çš„ç”Ÿæˆ">3. Redo æ—¥å¿—çš„ç”Ÿæˆ<a hidden class="anchor" aria-hidden="true" href="#3-redo-æ—¥å¿—çš„ç”Ÿæˆ">#</a></h3>
<p>â€ƒâ€ƒ é¦–å…ˆæœ‰å¿…è¦ä»‹ç» InnoDB ä¸­ mtr (mini-transaction) çš„æ¦‚å¿µï¼ŒInnoDB ä¸­å¯¹äºç‰©ç†æ–‡ä»¶çš„ä¿®æ”¹éƒ½æ˜¯ä»¥ mtr ä½œä¸º<strong>åŸå­å•ä½</strong>ï¼ˆæ— è®ºå…¶å†…æ˜¯ single è¿˜æ˜¯ multi record çš„ï¼‰ã€‚ä¸€ä¸ª mtr åœ¨å‰å‘æ‰§è¡Œè¿‡ç¨‹ä¸­ä¼šå æ®æ‰€éœ€çš„èµ„æºï¼ŒåŒ…æ‹¬ indexã€page åŠå…¶å¯¹åº”ç‰©ç†é”ç­‰ï¼Œä»¥ä¿è¯å¹¶å‘æ“ä½œæ­£ç¡®æ€§ï¼Œå¹¶å°†æ•°æ®ä¿®æ”¹æ“ä½œå¯¹åº”ç”Ÿæˆçš„ redo åœ¨ mtr å†…éƒ¨ç¼“å­˜ã€‚åœ¨ mtr commit çš„æ—¶å€™æ­¤ mtr ä¼šå°†ç¼“å­˜çš„ redo record æäº¤åˆ°å…¨å±€ log buffer ä¸­ç­‰å¾…è½ç›˜ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨å†…å­˜é€»è¾‘æ¥çœ‹ï¼ˆä¸å‘ç”Ÿcrashæƒ…å†µä¸‹ï¼‰mtr ä¸€æ—¦æäº¤å°±ä»£è¡¨äº†è¿™ä¸ªç‰©ç†æ“ä½œåœ¨ç³»ç»Ÿå…¨å±€äº§ç”ŸæŒä¹…åŒ–æ•ˆæœï¼Œå“ªæ€•å¯¹åº”æ‰€å±çš„ transaction è¿˜æ²¡æœ‰æˆ–æœ€ç»ˆæœ€ç»ˆæäº¤ï¼Œå› æ­¤è¿™é‡Œåœ¨å¿…é¡»æ—¶å°±éœ€è¦ undo mtr çš„æ“ä½œï¼Œå› æ­¤åœ¨å¯¹åº”æ•°æ®æ“ä½œå‰éƒ½éœ€è¦å…ˆè®°å½• undoï¼›æ­¤å¤–ï¼Œéƒ¨åˆ†ç‰©ç†æ“ä½œå¯èƒ½ä¸ä¼šè¢«æ’¤é”€ï¼Œæ¯”å¦‚ç©ºé—´æ‹“å±•åˆ†é…ç­‰ã€‚</p>
<p>â€ƒâ€ƒ å¦‚æœ mtr äº§ç”Ÿ redo log åˆ™å…¶åœ¨æäº¤è¿‡ç¨‹ä¸­ï¼š</p>
<ul>
<li>æ ¹æ®æ•°æ®é•¿åº¦å‘ log_sys <strong>ç”³è¯·</strong>å¯¹åº”çš„å…¨å±€é¡ºåºè®°å½•çš„ <strong>sn èŒƒå›´</strong>ï¼Œå…¶é€šè¿‡åŠ ä¸Š block header å’Œ tailerï¼Œä¸åŒ…æ‹¬ file header å¯ä»¥è½¬æ¢ä¸ºå¯¹åº”çš„ lsn èŒƒå›´ï¼›å¹¶ä¸”ç­‰å¾…åˆ° log buffer çš„<strong>ç©ºé—´è¶³å¤Ÿ</strong>å¯¹åº” sn èŒƒå›´æ•°æ®è¢«å†™å…¥ï¼›</li>
<li>å¯¹äº mtr ä¸­ç¼“å­˜çš„æ‰€æœ‰ redo recordï¼ŒæŒ‰ log block çš„æ ¼å¼å°† header å’Œ tailer ç•™ç©º <strong>copy body</strong> å†…å®¹ï¼Œå¹¶å°† header ä¸­çš„ First Record Group Offset å­—æ®µï¼ˆå†™å®Œåçš„ä¸‹ä¸€ä¸ªï¼‰å¡«ä¸Šï¼›</li>
<li>ç­‰å¾…è‡³ <strong>recent_written</strong> link_buf æœ‰ç©ºé—²ä½ç½®ï¼Œè¡¨ç¤ºåˆ°è¿™ä¸€ä½ç½®çš„ lsn å¯¹åº”çš„ log å¯ä»¥è¢«å†™å…¥ï¼›å†æ¨è¿›æ­¤ç»“æ„çš„ä¸­ç›¸åº”çš„ lsn èŒƒå›´ï¼Œè¡¨ç¤ºè¿™ä¸€æ®µå†…å®¹å·²ç»å®Œæ•´å†™å…¥åˆ° log buffer ä¸­ï¼Œå¹¶å°è¯•æ¨è¿›å…¶ m_tailï¼ˆå·²ç»è¿ç»­å®Œæ•´å†™å…¥åˆ°ä½ç½®ï¼‰ï¼›</li>
<li>ç­‰å¾…è‡³ <strong>recent_closed</strong> link_buf æœ‰ç©ºé—²ä½ç½®ï¼Œè¡¨ç¤ºåˆ°è¿™ä¸€ä½ç½®çš„ lsn å¯¹åº”çš„ dirty page å¯ä»¥è¢«åŠ åˆ° flush list ä¸Šï¼›å†å°† dirty page æŒ‚åˆ°  flush list ä¸Šï¼›</li>
<li>æœ€ç»ˆé‡Šæ”¾æ‰€æœ‰ page é”ç­‰ç‹¬å èµ„æºã€‚</li>
</ul>
<!-- Redo æ—¥å¿—çš„å†™å…¥ -->
<h3 id="4-redo-æ—¥å¿—çš„å†™å…¥">4. Redo æ—¥å¿—çš„å†™å…¥<a hidden class="anchor" aria-hidden="true" href="#4-redo-æ—¥å¿—çš„å†™å…¥">#</a></h3>
<p><img loading="lazy" src="redo_write.png" alt="redo_write"  />

â€ƒâ€ƒ åœ¨ mtr redo record å†™å…¥åˆ°å…¨å±€ log buffer ä¸­åï¼Œç³»ç»Ÿé€šè¿‡å…¨å±€ç»“æ„ log_t *log_sys å’Œåå°å·¥ä½œçº¿ç¨‹æ¥å†™å…¥ redo æ—¥å¿—ï¼Œå¹¶ç»´æŠ¤å¦‚å„ç§ lsn ä½ç‚¹ç­‰ç›¸å…³çŠ¶æ€ã€‚</p>
<p>â€ƒâ€ƒ åå°å·¥ä½œçº¿ç¨‹æœ‰å¦‚ä¸‹è¿™äº›ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cm">/* æ§åˆ¶ log æ–‡ä»¶çš„è½®è½¬ */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">log_files_governor</span><span class="p">(</span><span class="n">log_t</span> <span class="o">*</span><span class="n">log_ptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* å°†å…¨å±€ log buffer ä¸­çš„æ—¥å¿—å†™å…¥åˆ° OS buffer ä¸­ */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">log_writer</span><span class="p">(</span><span class="n">log_t</span> <span class="o">*</span><span class="n">log_ptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* å°† OS buffers ä¸­çš„æ•°æ®åˆ·å†™åˆ°ç£ç›˜ä¸Š (fsyncs) */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">log_flusher</span><span class="p">(</span><span class="n">log_t</span> <span class="o">*</span><span class="n">log_ptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* é€šçŸ¥ç”¨æˆ·çº¿ç¨‹å¯¹åº” log write å®Œæˆï¼Œwrite_lsn å·²æ›´æ–° */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">log_write_notifier</span><span class="p">(</span><span class="n">log_t</span> <span class="o">*</span><span class="n">log_ptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* é€šçŸ¥ç”¨æˆ·çº¿ç¨‹å¯¹åº” log flush å®Œæˆï¼Œflushed_to_disk_lsn å·²æ›´æ–° */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">log_flush_notifier</span><span class="p">(</span><span class="n">log_t</span> <span class="o">*</span><span class="n">log_ptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* æ£€æŸ¥æ˜¯å¦éœ€è¦è¦æ±‚å®Œæˆå¼ºåˆ¶åˆ·è„å¹¶å†™å…¥ checkpoint lsn åˆ°æ—¥å¿—æ–‡ä»¶ä¸­ */</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">log_checkpointer</span><span class="p">(</span><span class="n">log_t</span> <span class="o">*</span><span class="n">log_ptr</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>â€ƒâ€ƒ è¿™é‡Œåˆ·å†™ç›¸å…³çš„ä»»åŠ¡å…¶å®éƒ½æ˜¯å›´ç»• log file å’Œ log buffer é¦–ä½ç«¯çš„æ¨è¿›ï¼š</p>
<ul>
<li>ç³»ç»Ÿç»´æŠ¤äº†æ‰€æœ‰çš„ <strong>log file</strong> çš„å†…å­˜å¯¹è±¡ Log_files_dictï¼Œå¹¶é€šè¿‡ log_files_governor æ§åˆ¶å·²å†™å…¥å®Œå…¨ï¼ˆå¯ purge æˆ–ä»éœ€è¦ï¼‰ã€å½“å‰æ­£åœ¨å†™å…¥ã€åç»­å¯ä½¿ç”¨çš„ redo æ–‡ä»¶çŠ¶æ€ï¼›</li>
<li><strong>log buffer å¤´éƒ¨</strong>çš„æ¨è¿›çš„ç›¸å…³çŠ¶æ€ï¼Œbuf_limit_snï¼ˆé™åˆ¶å¯è¢«å†™å…¥åˆ° buffer çš„æœ€å¤§ snï¼Œå³ wirte_lsn + buf_sizeï¼‰ã€recent_written bufferï¼ˆè¿½è¸ªæ§åˆ¶ mtr å¹¶å‘å†™å…¥çŠ¶æ€ log bufferï¼‰ã€recent_closed bufferï¼ˆè¿½è¸ªæ§åˆ¶ dirty page æŒ‚è½½ flush listï¼‰ï¼›</li>
<li><strong>log buffer åˆ·å†™</strong>çŠ¶æ€ï¼Œåˆ° recent_written tail ä½ç½®çš„ redo å·²ç»å®Œæ•´å¯å†™ç›˜ï¼ˆè¿™é‡Œéœ€è¦ç­‰è‡³ä¸Šä¸€æ¬¡ checkpoint åŠ  redo file æ€»å®¹é‡è¶…è¿‡ç›®æ ‡å†™å…¥ lsnï¼‰ï¼Œlog writer ä¼šå°† log block çš„ header å’Œ tailer å¡«å……ï¼Œç„¶åç¡®å®šå†™å…¥èŒƒå›´ç›´æ¥ä» log bufferï¼ˆå®Œæ•´ log_write_ahead_size å¤§å°å€æ•°ï¼‰æˆ–é€šè¿‡ <strong>write_ahead_buffer</strong>ï¼ˆå°äº log_write_ahead_sizeï¼‰ å†™å…¥ log fileï¼›</li>
<li><strong>log buffer å°¾éƒ¨</strong>çš„æ¨è¿›çš„ç›¸å…³çŠ¶æ€ï¼Œå¦‚ write_lsnã€flushed_to_disk_lsnï¼Œäº‹ä»¶é€šçŸ¥ç­‰ã€‚</li>
<li><strong>checkpoint æ¨è¿›</strong>ï¼Œå¹¶å¯¹ log file å°¾éƒ¨æ–‡ä»¶çš„å›æ”¶ã€‚
å¯¹åº”çº¿ç¨‹å…·ä½“çš„æ‰§è¡Œæµç¨‹ä»‹ç»å¯ä»¥å‚è€ƒ<a href="https://dev.mysql.com/doc/dev/mysql-server/latest/PAGE_INNODB_REDO_LOG_THREADS.html">å®˜æ–¹æ–‡æ¡£</a>ã€‚</li>
</ul>
<!-- Redo æ—¥å¿—çš„åº”ç”¨ -->
<h3 id="5-redo-æ—¥å¿—åº”ç”¨åŠ-innodb-å¥”æºƒæ¢å¤">5. Redo æ—¥å¿—åº”ç”¨åŠ InnoDB å¥”æºƒæ¢å¤<a hidden class="anchor" aria-hidden="true" href="#5-redo-æ—¥å¿—åº”ç”¨åŠ-innodb-å¥”æºƒæ¢å¤">#</a></h3>
<p>â€ƒâ€ƒ åœ¨å¥”æºƒæ¢å¤çš„æƒ…å†µä¸‹ï¼ŒInnoDBé€šè¿‡åº”ç”¨ redo æ¥æ¢å¤å·²ç»æäº¤ä½†è¿˜æ²¡æœ‰åˆ·ç›˜çš„äº‹åŠ¡æ•°æ®ã€‚å¦å¤–ï¼Œä¸€äº›åŸºäºç‰©ç†å¤åˆ¶æ¶æ„çš„æ•°æ®åº“ï¼Œåƒ <a href="https://www.alibabacloud.com/zh/product/polardb-for-mysql">PolarDB</a>ã€AWS Aurora ç­‰ï¼Œè¿˜å­˜åœ¨é€šè¿‡åº”ç”¨ redo æ¥è¿›è¡Œæ•°æ®åŒæ­¥çš„æµç¨‹ã€‚æˆ‘ä»¬è¿™é‡Œåªè®¨è®º recovery çš„ redo é˜¶æ®µï¼Œæ•´ä¸ª InnoDB server çš„å¯åŠ¨ç®€åŒ–æµç¨‹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">dberr_t</span> <span class="nf">srv_start</span><span class="p">(</span><span class="kt">bool</span> <span class="n">create_new_db</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Step 0. ç¯å¢ƒå‡†å¤‡å’Œæ£€æŸ¥ï¼Œ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Step 1. åˆå§‹åŒ– SRV å˜é‡ï¼Œ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">srv_boot</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Step 2. æ‰«æé…ç½®çš„ç›®å½•ï¼Œç”Ÿæˆæ–‡ä»¶map
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">fil_init</span><span class="p">(</span><span class="n">innobase_get_open_files_limit</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ç¡®å®šè·¯å¾„...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// æ‰«æè·å– .IBD å’Œ undo æ–‡ä»¶ï¼Œä»é¦– page ä¸­è¯»å– space_id å¹¶è®°å½•åˆ° fil_system çš„ Tablespace_dirs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">err</span> <span class="o">=</span> <span class="n">fil_scan_for_tablespaces</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Step 3. INNODB STATUS ç›‘æ§æ–‡ä»¶...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Step 4. åˆå§‹åŒ– AIO çº¿ç¨‹...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">os_aio_init</span><span class="p">(</span><span class="n">srv_n_read_io_threads</span><span class="p">,</span> <span class="n">srv_n_write_io_threads</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Step 5. åˆå§‹åŒ– buffer pool...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">err</span> <span class="o">=</span> <span class="n">buf_pool_init</span><span class="p">(</span><span class="n">srv_buf_pool_size</span><span class="p">,</span> <span class="n">srv_buf_pool_instances</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Step 6. åˆå§‹åŒ–å¤šä¸ªå­ç³»ç»Ÿ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">fsp_init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">pars_init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">recv_sys_create</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">recv_sys_init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">trx_sys_create</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">lock_sys_create</span><span class="p">(</span><span class="n">srv_lock_table_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">os_aio_start_threads</span><span class="p">();</span><span class="cm">/* i/o-handler threads */</span>
</span></span><span class="line"><span class="cl">  <span class="n">buf_flush_page_cleaner_init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Step 7. åˆå§‹åŒ– system tablespace...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// ibdata1 æ–‡ä»¶å†…å«ç³»ç»Ÿè¡¨ç©ºé—´ï¼ˆæ³¨æ„ä¸ å…ƒæ•°æ®DDè¡¨ç©ºé—´ æˆ–å« å†…éƒ¨ç³»ç»Ÿè¡¨ çš„ mysql.ibd åŒºåˆ†ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// å†…å« change buffer(ï¼Œç‰¹å®šæƒ…å†µä¸‹å«ç”¨æˆ·è¡¨ã€undo è¡¨)ç­‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// åˆ›å»ºå¯¹åº”çš„ sysspace å¹¶åŠ å…¥ fil_system (fil_space_create + fil_node_create)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">err</span> <span class="o">=</span> <span class="n">srv_sys_space</span><span class="p">.</span><span class="n">open_or_create</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="n">create_new_db</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="o">&amp;</span><span class="n">sum_of_new_sizes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flushed_lsn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">dict_persist_init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Step 8. åˆå§‹åŒ– log sysï¼Œè¿™é‡Œè¿˜ä¼šæ‰«æå‡ºæ‰€æœ‰ redo file æ¥æ„å»º Log_files_dict
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">err</span> <span class="o">=</span> <span class="n">log_sys_init</span><span class="p">(</span><span class="n">create_new_db</span><span class="p">,</span> <span class="n">flushed_lsn</span><span class="p">,</span> <span class="n">new_files_lsn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">create_new_db</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// åˆå§‹åŒ–å»ºç«‹æ–° db
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Step 9. BPçŠ¶æ€é‡ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">err</span> <span class="o">=</span> <span class="n">dblwr</span><span class="o">::</span><span class="n">v1</span><span class="o">::</span><span class="n">init</span><span class="p">();</span> <span class="cm">/* åˆå§‹åŒ– double write */</span>
</span></span><span class="line"><span class="cl">    <span class="n">buf_pool_invalidate</span><span class="p">();</span> <span class="cm">/* æ·˜æ±°æ‰€æœ‰ page ç¡®ä¿ recovery é‡è¯» */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Step 10. æ‰“å¼€æ‰€æœ‰ log files å’Œ system data files
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">fil_open_system_tablespace_files</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Step 11. å¼€å§‹æ¢å¤ redo æ—¥å¿—...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">err</span> <span class="o">=</span> <span class="n">recv_recovery_from_checkpoint_start</span><span class="p">(</span><span class="o">*</span><span class="n">log_sys</span><span class="p">,</span> <span class="n">flushed_lsn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ... åˆå§‹åŒ– innodb data dictionary system
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Step 12. å¯åŠ¨åå° log çº¿ç¨‹ ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">srv_read_only_mode</span><span class="p">)</span> <span class="p">{</span> <span class="n">log_start_background_threads</span><span class="p">(</span><span class="o">*</span><span class="n">log_sys</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Step 13. åº”ç”¨å‰©ä½™çš„æœ€åä¸€æ‰¹ hashed log records
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">srv_force_recovery</span> <span class="o">&lt;</span> <span class="n">SRV_FORCE_NO_LOG_REDO</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">err</span> <span class="o">=</span> <span class="n">recv_apply_hashed_log_recs</span><span class="p">(</span><span class="o">*</span><span class="n">log_sys</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="o">!</span><span class="n">recv_sys</span><span class="o">-&gt;</span><span class="n">is_cloned_db</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">log_upgrade</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ä¸€äº›æ£€æŸ¥...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Step 14. åˆ·å†™æ‰€æœ‰è„é¡µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">srv_force_recovery</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">srv_read_only_mode</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">buf_flush_sync_all_buf_pools</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Step 15. å®Œæˆ redo æ—¥å¿—æ¢å¤åçš„æ¸…ç†ï¼Œæ¢å¤dynamic metadata
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">MetadataRecover</span> <span class="o">*</span><span class="n">dict_metadata</span> <span class="o">=</span> <span class="n">recv_recovery_from_checkpoint_finish</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* æ­¤æ—¶ DDï¼ˆtable persistent dataï¼‰è¿˜æ²¡æœ‰å®Œå…¨ recovery */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">recv_sys</span><span class="o">-&gt;</span><span class="n">is_cloned_db</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dict_metadata</span><span class="o">-&gt;</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">fil_space_t</span> <span class="o">*</span><span class="n">space</span> <span class="o">=</span> <span class="n">fil_space_acquire_silent</span><span class="p">(</span><span class="n">dict_sys_t</span><span class="o">::</span><span class="n">s_dict_space_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">space</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">dberr_t</span> <span class="n">error</span> <span class="o">=</span> <span class="n">fil_ibd_open</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="n">FIL_TYPE_TABLESPACE</span><span class="p">,</span> <span class="n">dict_sys_t</span><span class="o">::</span><span class="n">s_dict_space_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="n">predefined_flags</span><span class="p">,</span> <span class="n">dict_sys_t</span><span class="o">::</span><span class="n">s_dd_space_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="n">dict_sys_t</span><span class="o">::</span><span class="n">s_dd_space_file_name</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">fil_space_release</span><span class="p">(</span><span class="n">space</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">dict_persist</span><span class="o">-&gt;</span><span class="n">table_buffer</span> <span class="o">=</span> <span class="n">ut</span><span class="o">::</span><span class="n">new_withkey</span><span class="o">&lt;</span><span class="n">DDTableBuffer</span><span class="o">&gt;</span><span class="p">(</span><span class="n">UT_NEW_THIS_FILE_PSI_KEY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">dict_metadata</span><span class="o">-&gt;</span><span class="n">store</span><span class="p">();</span> <span class="c1">// å°†æ¢å¤è¿‡ç¨‹ä¸­persistent dynamic metadataä¿®æ”¹ store åˆ° mysql.innodb_dynamic_metadata
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">log_buffer_flush_to_disk</span><span class="p">(</span><span class="o">*</span><span class="n">log_sys</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">ut</span><span class="o">::</span><span class="n">delete_</span><span class="p">(</span><span class="n">dict_metadata</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Step 16. æ„å»º Undo Tablespaces å’Œ Rollback Segments å†…å­˜ç»“æ„å¹¶è¿›è¡Œæ¢å¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">err</span> <span class="o">=</span> <span class="n">srv_undo_tablespaces_init</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">trx_purge_sys_mem_create</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">purge_queue</span> <span class="o">=</span> <span class="n">trx_sys_init_at_db_start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">srv_undo_tablespaces_upgrade</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">trx_purge_sys_initialize</span><span class="p">(</span><span class="n">srv_threads</span><span class="p">.</span><span class="n">m_purge_workers_n</span><span class="p">,</span> <span class="n">purge_queue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* Open temp-tablespace and keep it open until shutdown. */</span>
</span></span><span class="line"><span class="cl">  <span class="n">err</span> <span class="o">=</span> <span class="n">srv_open_tmp_tablespace</span><span class="p">(</span><span class="n">create_new_db</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">srv_tmp_space</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">err</span> <span class="o">=</span> <span class="n">ibt</span><span class="o">::</span><span class="n">open_or_create</span><span class="p">(</span><span class="n">create_new_db</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Step 17. å®Œæ•´åŒ– undo è¡¨ç©ºé—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// å¢åŠ  rollback segment æ•°ç›®åˆ° srv_rollback_segmentsï¼Œæ­¤æ¬¡é…ç½®å¯èƒ½å’Œä¸Šæ¬¡ä¸åŒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">trx_rseg_adjust_rollback_segments</span><span class="p">(</span><span class="n">srv_rollback_segments</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// æ„å»ºå®Œæˆå®Œæ•´ undo è¡¨ç©ºé—´ï¼Œåˆ é™¤ trunc.logï¼Œè®¾ç½®active
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">srv_undo_tablespaces_mark_construction_done</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">undo</span><span class="o">::</span><span class="n">spaces</span><span class="o">-&gt;</span><span class="n">s_lock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">undo_space</span> <span class="p">:</span> <span class="n">undo</span><span class="o">::</span><span class="n">spaces</span><span class="o">-&gt;</span><span class="n">m_spaces</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">undo_space</span><span class="o">-&gt;</span><span class="n">is_empty</span><span class="p">())</span> <span class="p">{</span> <span class="n">undo_space</span><span class="o">-&gt;</span><span class="n">set_active</span><span class="p">();</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">undo</span><span class="o">::</span><span class="n">spaces</span><span class="o">-&gt;</span><span class="n">s_unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Step 18. ç›‘æ§ç³»ç»Ÿç­‰...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Step 19. something...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">(</span><span class="n">DB_SUCCESS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>â€ƒâ€ƒ å…¶ä¸­æ¯”è¾ƒå…³é”®çš„é˜¶æ®µåœ¨äº Step 11 <code>recv_recovery_from_checkpoint_start</code> ä¸­è¿›è¡Œ redo æ¢å¤ä»¥åŠ Step 16 æ¢å¤ undo å’Œ trx ç³»ç»Ÿçš„çŠ¶æ€ï¼Œåè€…åœ¨ <a href="/posts/mysql/undo">undo ç³»ç»Ÿ</a>çš„è®¨è®ºä¸­è¿›è¡Œä»‹ç»ï¼Œæœ¬æ–‡ä¸»è¦è®¨è®ºå‰è€…ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">dberr_t</span> <span class="nf">recv_recovery_from_checkpoint_start</span><span class="p">(</span><span class="n">log_t</span> <span class="o">&amp;</span><span class="n">log</span><span class="p">,</span> <span class="n">lsn_t</span> <span class="n">flush_lsn</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Step 1. åˆå§‹åŒ–flush_rbtï¼Œä¿è¯è„é¡µæŒ‰åºæ’å…¥flush list
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">buf_flush_init_flush_rbt</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Step 2. é€šè¿‡æ‰«æ Log_files_dict æ‰¾æœ€åçš„ checkpoint è®°å½•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">Log_checkpoint_location</span> <span class="n">checkpoint</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">recv_find_max_checkpoint</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="n">checkpoint</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="cm">/* Step 3. è§£æå­˜å‚¨ redo recordï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm">    1. ä» checkpoint è¯»å– redo æ–‡ä»¶æš‚å­˜åˆ° log_sys-&gt;bufï¼›
</span></span></span><span class="line"><span class="cl"><span class="cm">    2. æŒ‰ log block æ‰«æå» block head/tail å­˜åˆ° recv_sys-&gt;buf ä¸­ï¼›
</span></span></span><span class="line"><span class="cl"><span class="cm">    3. å°† recv_sys-&gt;buf ä¸­çš„è®°å½• parseï¼Œç”Ÿæˆ recv_t *recvï¼ˆå•ä¸ª recordï¼‰å’Œ recv_addr_t *recv_addrï¼ˆpage æ‰€æœ‰ record ä¸²ï¼‰ï¼›
</span></span></span><span class="line"><span class="cl"><span class="cm">    4. å­˜å‚¨ recv_addr_t åˆ° recv_sys å“ˆå¸Œè¡¨å¯¹åº”çš„ (space_id, page_no) å¤„
</span></span></span><span class="line"><span class="cl"><span class="cm">    5. ï¼ˆå¦‚æœå ç”¨å†…å­˜è¾ƒå¤§ï¼‰å°†æ‰€æœ‰å­˜å‚¨çš„ record apply åˆ° page ä¸Šï¼Œbpå†…çš„èµ° recv_recover_pageã€bpå¤–çš„èµ° buf_read_recv_pages
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span>
</span></span><span class="line"><span class="cl">  <span class="n">recv_recovery_begin</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="n">checkpoint_lsn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Step 4. åˆå§‹åŒ– log_sys çŠ¶æ€ï¼ŒåŒ…æ‹¬å„ lsn ä½ç‚¹ã€å„ buf çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">lsn_t</span> <span class="n">recovered_lsn</span> <span class="o">=</span> <span class="n">log</span><span class="p">.</span><span class="n">recovered_lsn</span> <span class="o">=</span> <span class="n">recv_sys</span><span class="o">-&gt;</span><span class="n">recovered_lsn</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">auto</span> <span class="n">check_scanned_lsn</span> <span class="o">=</span> <span class="n">log</span><span class="p">.</span><span class="n">m_scanned_lsn</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">check_scanned_lsn</span> <span class="o">%</span> <span class="n">OS_FILE_LOG_BLOCK_SIZE</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// If it is at block boundary, add header size.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">check_scanned_lsn</span> <span class="o">+=</span> <span class="n">LOG_BLOCK_HDR_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">err</span> <span class="o">=</span> <span class="n">log_start</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="n">checkpoint_lsn</span><span class="p">,</span> <span class="n">recovered_lsn</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">srv_read_only_mode</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="p">.</span><span class="n">next_checkpoint_header_no</span> <span class="o">=</span> <span class="n">log_next_checkpoint_header</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">.</span><span class="n">m_checkpoint_header_no</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">err</span> <span class="o">=</span> <span class="n">log_files_next_checkpoint</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="n">checkpoint_lsn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">mutex_enter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">recv_sys</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">recv_sys</span><span class="o">-&gt;</span><span class="n">apply_log_recs</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">mutex_exit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">recv_sys</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">DB_SUCCESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>â€ƒâ€ƒ å¯¹åº” redo çš„ä½¿ç”¨ä¸»è¦åœ¨äº parse å’Œ apply ä¸¤ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«å¯¹åº” <code>recv_parse_log_recs</code> å’Œ <code>recv_apply_log_rec</code> ä¸¤ä¸ªæ¥å£ã€‚parse é˜¶æ®µå®Œæˆå recv_sys å†… redo record hash çš„ç»“æ„å±‚æ¬¡å¦‚ä¸‹ï¼Œå­˜å‚¨çš„æ˜¯å¯¹åº” (space,page) çš„è§£æå®Œæˆçš„ redo record bodyã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">recv_sys =&gt; space_m =&gt; page_x =&gt; recv_addr_t =&gt; recv_t(data1)-&gt;recv_t(data2)-&gt;recv_t(data3)
</span></span><span class="line"><span class="cl">                    =&gt; page_y =&gt; recv_addr_t =&gt; recv_t(data1)-&gt;...
</span></span><span class="line"><span class="cl">                    =&gt; ...
</span></span><span class="line"><span class="cl">            space_n =&gt; ...
</span></span></code></pre></td></tr></table>
</div>
</div><p>â€ƒâ€ƒ è§£æçš„é€»è¾‘è¾ƒä¸ºç®€å•ï¼Œç”±äº InnoDB å¯¹äºå•ä¸ª redo record ä¸ä¼šè®°å½•é•¿åº¦ï¼Œå› æ­¤å°±æ˜¯é€šè¿‡ redo ç±»å‹ç¡®å®šèµ°ä¸åŒè§£æé€»è¾‘ç¡®å®š redo record é•¿åº¦ï¼ˆè¿™é‡Œ MariaDB è®°å½•äº†é•¿åº¦æ¥åŠ é€Ÿï¼Œå½“ç„¶å…¶ redo å†…å®¹ä¹Ÿè¿˜æœ‰è®¸å¤šå…¶ä»–ä¿®æ”¹ï¼‰ã€‚éœ€è¦æ³¨æ„çš„æ˜¯å¯¹åº”ä¸€äº›éç‰©ç† page çš„ redo (å¦‚ MLOG_FILE_EXTEND) æˆ–ç‰¹æ®Š page (å¦‚ page 0) å…ƒä¿¡æ¯ä¿®æ”¹ï¼Œåœ¨ parse é˜¶æ®µå°±ä¼šåšé¢å¤–çš„å¤„ç†å·¥ä½œæ¥ç»´æŠ¤çŠ¶æ€ã€‚</p>
<p>â€ƒâ€ƒ åº”ç”¨çš„é€»è¾‘è§¦å‘é€»è¾‘æœ‰ä¸¤ç§ï¼Œå¯¹äº bp å†…çš„ page ç›´æ¥èµ° <code>recv_recover_page</code>ï¼Œå¯¹äº bp å¤–çš„ page åœ¨è¯» I/O å®Œæˆæ—¶ <code>buf_page_io_complete</code> ä¹Ÿæ˜¯è°ƒç”¨ <code>recv_recover_page</code>ï¼ˆå”¯ä¸€ä¸åŒçš„æ˜¯åè€…ä¼šè½¬ç§» page çš„ x-latch çš„ ownership åˆ°å½“å‰çº¿ç¨‹ï¼‰ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span><span class="lnt">98
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">recv_recover_page_func</span><span class="p">(</span><span class="kt">bool</span> <span class="n">just_read_in</span><span class="p">,</span> <span class="n">buf_block_t</span> <span class="o">*</span><span class="n">block</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">mutex_enter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">recv_sys</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">recv_sys</span><span class="o">-&gt;</span><span class="n">apply_log_recs</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">mutex_exit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">recv_sys</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">recv_addr_t</span> <span class="o">*</span><span class="n">recv_addr</span> <span class="o">=</span> <span class="n">recv_get_rec</span><span class="p">(</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">space</span><span class="p">(),</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">page_no</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">recv_addr</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">||</span> <span class="n">recv_addr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">RECV_BEING_PROCESSED</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="n">recv_addr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">RECV_PROCESSED</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">mutex_exit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">recv_sys</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">recv_addr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RECV_BEING_PROCESSED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">mutex_exit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">recv_sys</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">mtr_t</span> <span class="n">mtr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">mtr_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mtr_set_log_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtr</span><span class="p">,</span> <span class="n">MTR_LOG_NONE</span><span class="p">);</span> <span class="c1">// redo åº”ç”¨ä¸åœ¨è®°å½•redo
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// è·å– page block
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">page_t</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">page_zip_des_t</span> <span class="o">*</span><span class="n">page_zip</span> <span class="o">=</span> <span class="n">buf_block_get_page_zip</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">just_read_in</span><span class="p">)</span> <span class="p">{</span> <span class="n">rw_lock_x_lock_move_ownership</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">bool</span> <span class="n">success</span> <span class="o">=</span> <span class="n">buf_page_get_known_nowait</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">RW_X_LATCH</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">Cache_hint</span><span class="o">::</span><span class="n">KEEP_OLD</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mtr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">ut_a</span><span class="p">(</span><span class="n">success</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// è·å– page lsn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">lsn_t</span> <span class="n">page_lsn</span> <span class="o">=</span> <span class="n">mach_read_from_8</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">FIL_PAGE_LSN</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">lsn_t</span> <span class="n">page_newest_lsn</span> <span class="o">=</span> <span class="n">buf_page_get_newest_modification</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">lsn_t</span> <span class="n">end_lsn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">lsn_t</span> <span class="n">start_lsn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">bool</span> <span class="n">modification_to_page</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">page_newest_lsn</span><span class="p">)</span> <span class="p">{</span> <span class="n">page_lsn</span> <span class="o">=</span> <span class="n">page_newest_lsn</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">recv</span> <span class="p">:</span> <span class="n">recv_addr</span><span class="o">-&gt;</span><span class="n">rec_list</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">end_lsn</span> <span class="o">=</span> <span class="n">recv</span><span class="o">-&gt;</span><span class="n">end_lsn</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">byte</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">recv</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">RECV_DATA_BLOCK_SIZE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">buf</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">byte</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">ut</span><span class="o">::</span><span class="n">malloc_withkey</span><span class="p">(</span><span class="n">UT_NEW_THIS_FILE_PSI_KEY</span><span class="p">,</span> <span class="n">recv</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="n">recv_data_copy_to_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">recv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">recv</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">buf</span> <span class="o">=</span> <span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">recv</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">))</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">recv_data_t</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">recv</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">MLOG_INIT_FILE_PAGE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// init page ç±»å‹å…ˆä¿®æ­£ page lsnï¼Œç›¸å½“äºç¬¬ä¸€æ¬¡ä¼šå¼ºåˆ¶åš apply
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">page_lsn</span> <span class="o">=</span> <span class="n">page_newest_lsn</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">memset</span><span class="p">(</span><span class="n">FIL_PAGE_LSN</span> <span class="o">+</span> <span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">memset</span><span class="p">(</span><span class="n">UNIV_PAGE_SIZE</span> <span class="o">-</span> <span class="n">FIL_PAGE_END_LSN_OLD_CHKSUM</span> <span class="o">+</span> <span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">page_zip</span><span class="p">)</span> <span class="n">memset</span><span class="p">(</span><span class="n">FIL_PAGE_LSN</span> <span class="o">+</span> <span class="n">page_zip</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// è¿‡æ»¤æ¡ä»¶ï¼š1. page lsn ä¸è¶…è¿‡ redo çš„ lsnï¼›2. å¯¹äº undo ç©ºé—´æ²¡æœ‰ truncate
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">recv</span><span class="o">-&gt;</span><span class="n">start_lsn</span> <span class="o">&gt;=</span> <span class="n">page_lsn</span> <span class="o">&amp;&amp;</span> <span class="n">undo</span><span class="o">::</span><span class="n">is_active</span><span class="p">(</span><span class="n">recv_addr</span><span class="o">-&gt;</span><span class="n">space</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">lsn_t</span> <span class="n">end_lsn</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf_end</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">modification_to_page</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">modification_to_page</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">start_lsn</span> <span class="o">=</span> <span class="n">recv</span><span class="o">-&gt;</span><span class="n">start_lsn</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span> <span class="n">buf_end</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">recv</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// è¿™é‡ŒæŒ‰ç…§ redo ç±»å‹å¯¹ page çœŸæ­£è¿›è¡Œæ•°æ®ä¿®æ”¹æ¢å¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">recv_parse_or_apply_log_rec_body</span><span class="p">(</span><span class="n">recv</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buf_end</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="n">recv_addr</span><span class="o">-&gt;</span><span class="n">space</span><span class="p">,</span> <span class="n">recv_addr</span><span class="o">-&gt;</span><span class="n">page_no</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="n">block</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mtr</span><span class="p">,</span> <span class="n">ULINT_UNDEFINED</span><span class="p">,</span> <span class="n">LSN_MAX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">end_lsn</span> <span class="o">=</span> <span class="n">recv</span><span class="o">-&gt;</span><span class="n">start_lsn</span> <span class="o">+</span> <span class="n">recv</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// æ›´æ–° page lsn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">mach_write_to_8</span><span class="p">(</span><span class="n">FIL_PAGE_LSN</span> <span class="o">+</span> <span class="n">page</span><span class="p">,</span> <span class="n">end_lsn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">mach_write_to_8</span><span class="p">(</span><span class="n">UNIV_PAGE_SIZE</span> <span class="o">-</span> <span class="n">FIL_PAGE_END_LSN_OLD_CHKSUM</span> <span class="o">+</span> <span class="n">page</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                      <span class="n">end_lsn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">page_zip</span><span class="p">)</span> <span class="n">mach_write_to_8</span><span class="p">(</span><span class="n">FIL_PAGE_LSN</span> <span class="o">+</span> <span class="n">page_zip</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">end_lsn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="o">++</span><span class="n">applied_recs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="o">++</span><span class="n">skipped_recs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">recv</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">RECV_DATA_BLOCK_SIZE</span><span class="p">)</span> <span class="n">ut</span><span class="o">::</span><span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// æœ‰ä¿®æ”¹è¦åŠ å…¥è„é¡µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">modification_to_page</span><span class="p">)</span> <span class="p">{</span> <span class="n">buf_flush_recv_note_modification</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">start_lsn</span><span class="p">,</span> <span class="n">end_lsn</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">mtr_commit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mtr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// æ›´æ–° recv_sys çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">mutex_enter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">recv_sys</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">recv_max_page_lsn</span> <span class="o">&lt;</span> <span class="n">page_lsn</span><span class="p">)</span> <span class="n">recv_max_page_lsn</span> <span class="o">=</span> <span class="n">page_lsn</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">recv_addr</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RECV_PROCESSED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">--</span><span class="n">recv_sys</span><span class="o">-&gt;</span><span class="n">n_addrs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">mutex_exit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">recv_sys</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<!-- copyright -->
<div class="admonition">
  <div class="admonition-content">
    <ul>
      <li>ç‰ˆæƒå£°æ˜ï¼šå¦‚éœ€è½¬è½½æˆ–å¼•ç”¨ï¼Œè¯·é™„åŠ æœ¬æ–‡é“¾æ¥å¹¶æ³¨æ˜æ¥æºã€‚</li>
    </ul>
  </div>
</div>
<!-- copyright -->

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://mzyee.github.io/tags/mysql/">MySQL</a></li>
      <li><a href="https://mzyee.github.io/tags/redo/">Redo</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://mzyee.github.io/posts/mysql/meta/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>MySQL å¦‚ä½•å‡†å¤‡å¼€å¯ä¸€ä¸ªè¡¨</span>
  </a>
  <a class="next" href="https://mzyee.github.io/posts/mysql/trx/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>InnoDB äº‹åŠ¡ç³»ç»Ÿå’Œäº‹åŠ¡æ‰§è¡Œæµç¨‹</span>
  </a>
</nav>

  </footer>
<div>
  <div class="pagination__title">
    <span class="pagination__title-h" style="font-size: 20px;">ğŸ’¬ è¯„è®º</span>
    <hr />
  </div>
  <div id="tcomment"></div>
  <script src="https://cdn.staticfile.org/twikoo/1.6.25/twikoo.all.min.js"></script>
  <script>
    twikoo.init({
      envId: "https://xxx.netlify.app/.netlify/functions/twikoo",  
      el: "#tcomment",
      lang: 'zh-CN',
      region: 'ap-hongkong',
      path: window.TWIKOO_MAGIC_PATH || window.location.pathname,
    });
  </script>
</div>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://mzyee.github.io">MZY&#39;s Blog</a></span>
    <span>
        | Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a>
    </span>
    <span id="busuanzi_container">
        | Viewer
        <span class="fa fa-user"></span> <span id="busuanzi_value_site_uv"></span>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerHTML = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerHTML = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
