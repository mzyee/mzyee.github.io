<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>MySQL äº‹åŠ¡é”ç³»ç»Ÿ | MZY&#39;s Blog</title>
<meta name="keywords" content="MySQL, Lock, Transaction">
<meta name="description" content="MySQL å¹¶å‘æ§åˆ¶ä»‹ç»å’Œäº‹åŠ¡é”ç³»ç»Ÿå­¦ä¹ ">
<meta name="author" content="Miao Zheyu">
<link rel="canonical" href="https://mzyee.github.io/posts/mysql/lock/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.78ed8947c1508d00bdf7a3061370dcaebcd4ba680f4567ec440d26a4043b4e64.css" integrity="sha256-eO2JR8FQjQC996MGE3DcrrzUumgPRWfsRA0mpAQ7TmQ=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://mzyee.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://mzyee.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://mzyee.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://mzyee.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://mzyee.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script async src="https://unpkg.com/mermaid@8.8.1/dist/mermaid.min.js"></script>


<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<meta property="og:title" content="MySQL äº‹åŠ¡é”ç³»ç»Ÿ" />
<meta property="og:description" content="MySQL å¹¶å‘æ§åˆ¶ä»‹ç»å’Œäº‹åŠ¡é”ç³»ç»Ÿå­¦ä¹ " />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mzyee.github.io/posts/mysql/lock/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-05T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-12-05T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="MySQL äº‹åŠ¡é”ç³»ç»Ÿ"/>
<meta name="twitter:description" content="MySQL å¹¶å‘æ§åˆ¶ä»‹ç»å’Œäº‹åŠ¡é”ç³»ç»Ÿå­¦ä¹ "/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://mzyee.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "MySQL",
      "item": "https://mzyee.github.io/posts/mysql/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "MySQL äº‹åŠ¡é”ç³»ç»Ÿ",
      "item": "https://mzyee.github.io/posts/mysql/lock/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "MySQL äº‹åŠ¡é”ç³»ç»Ÿ",
  "name": "MySQL äº‹åŠ¡é”ç³»ç»Ÿ",
  "description": "MySQL å¹¶å‘æ§åˆ¶ä»‹ç»å’Œäº‹åŠ¡é”ç³»ç»Ÿå­¦ä¹ ",
  "keywords": [
    "MySQL", "Lock", "Transaction"
  ],
  "articleBody": "1. å‰è¨€ æ•°æ®åº“ç³»ç»Ÿçš„å¹¶å‘æ§åˆ¶ä¸å…¶å¤šä¸ªæ¨¡å—ç›¸å…³è”ï¼Œå…¶ç”¨äºå®ç°æ— å†²çªã€ä¿æŒä¸€è‡´æ€§çš„å¤šäº‹åŠ¡å¹¶å‘æ“ä½œã€‚å¹¶å‘æ§åˆ¶æ¨¡å—éœ€è¦ä¿è¯äº‹åŠ¡å¹¶å‘æ‰§è¡Œçš„æ•ˆæœä¸è¦æ±‚çš„ä¸²è¡Œæ‰§è¡Œæ¨¡å¼çš„æ•ˆæœå®Œå…¨ç›¸åŒï¼Œä»¥è¾¾åˆ°éš”ç¦»æ€§çš„è¦æ±‚ï¼Œä¸åˆç†çš„å¹¶å‘æ§åˆ¶å¯èƒ½å¯¼è‡´æ›´æ–°ä¸¢å¤±ã€ä¸å¯é‡å¤è¯»ã€è„è¯»ã€å¹»è¯»ç­‰é—®é¢˜ã€‚\nç›®å‰å¸¸ç”¨çš„å¹¶å‘æ§åˆ¶åè®®å¯è¢«ç²—ç•¥å¹¶ä¸å®Œæ•´çš„åˆ†ä¸ºæ‚²è§‚å’Œä¹è§‚ä¸¤å¤§ç±»ï¼šæ­¤å¤„ä¹è§‚åè®®æŒ‡ç‹­ä¹‰ä¹è§‚å¹¶å‘æ§åˆ¶ï¼Œå¦‚æŒ‡åŸºäºå®Œæˆæœ‰æ•ˆæ€§éªŒè¯çš„å¹¶å‘æ§åˆ¶ï¼Œä¸»è¦ä¸ºå‰å‘ OCC å’Œåå‘ OCC ä¸¤ç±»ï¼›è€Œæ‚²è§‚åè®®åˆåˆ†ä¸ºåŸºäºé”å’Œéé”ä¸¤å¤§ç±»ï¼ŒåŸºäºé”çš„åè®®æœ‰ 2-Phase Lockingã€Altruistic Lockingã€Read/Write Tree Locking ç­‰ï¼Œéé”ç±»åè®®æœ‰åŸºäºåŸºäºäº‹åŠ¡ä¸²è¡ŒåŒ–å›¾çš„åè®®ç­‰ã€‚æ­¤å¤–ï¼Œè¿˜å¯ä»¥è¿›ä¸€æ­¥å¯ä»¥ç»“åˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMVCCï¼‰ï¼Œä»¥æé«˜æ•°æ®åº“çš„ï¼ˆè¯»ï¼‰æ€§èƒ½ã€‚\n2. InnoDB äº‹åŠ¡é” 2.1 ä¸¤é˜¶æ®µé”ï¼ˆ2PL Lockingï¼‰ è¿™é‡Œä»‹ç»æœ€å¸¸ç”¨çš„ä¸º 2PL åè®®ï¼Œè¿™ä¹Ÿæ˜¯ MySQL ä½¿ç”¨çš„æœºåˆ¶ã€‚2PL å°†äº‹åŠ¡çš„æ‰§è¡Œé˜¶æ®µåˆ†ä¸ºä¸‰ä¸ªä¸åŒçš„éƒ¨åˆ†ï¼š\n1ï¼‰ç¬¬ä¸€é˜¶æ®µï¼Œäº‹åŠ¡å¼€å§‹æ‰§è¡Œæ—¶ï¼Œäº‹åŠ¡å¼€å§‹è·å–éœ€è¦çš„é”çš„æƒé™ï¼Œä½†ä¸é‡Šæ”¾é”ï¼› 2ï¼‰ç¬¬äºŒéƒ¨åˆ†æ˜¯äº‹åŠ¡è·å–æ‰€æœ‰é”çš„è¿‡ç¨‹ï¼› 3ï¼‰å½“äº‹åŠ¡é‡Šæ”¾å®ƒçš„ç¬¬ä¸€ä¸ªé”æ—¶ï¼Œç¬¬ä¸‰é˜¶æ®µå¼€å§‹ï¼Œæ­¤é˜¶æ®µäº‹åŠ¡ä¸èƒ½è¦æ±‚ä»»ä½•æ–°é”ï¼Œåªé‡Šæ”¾è·å–çš„é”ã€‚ ä»ä¸Šå¯ä»¥çœ‹å‡º 2PL åˆ†ä¸º Growing phase å’Œ Shrinking phase ä¸¤ä¸ªé˜¶æ®µã€‚æ ¹æ®é”å®šç»†èŠ‚è¿˜å¯æ¼”åŒ–ä¸º Conservative-2PLã€Strict-2PLã€Rigorous-2PL ç­‰ã€‚2PL åè®®æä¾›äº†å¯åºåˆ—åŒ–æ€§ï¼Œä½†ä¸èƒ½ä¿è¯ä¸å‘ç”Ÿæ­»é”ï¼Œå› æ­¤éœ€è¦è¿›è¡Œæ­»é”é¢„é˜²æˆ–æ­»é”æ£€æµ‹ã€‚MySQL é‡‡ç”¨çš„æ˜¯æ­»é”æ£€æµ‹åŠ è¶…æ—¶æ¢å¤çš„æœºåˆ¶ï¼Œæ­»é”æ£€æµ‹ä¸€èˆ¬é€šè¿‡ waits-for å›¾ç»“æ„å®ç°ï¼šå›¾ä¸­ç‚¹ä»£è¡¨äº‹åŠ¡ï¼Œæœ‰å‘è¾¹ä»£è¡¨äº‹åŠ¡åœ¨ç­‰å¾…å¦ä¸€ä¸ªäº‹åŠ¡æ”¾é”ï¼Œå½“ waits-for å›¾å‡ºç°ç¯æ—¶è¯´æ˜æœ‰æ­»é”å‡ºç°ã€‚æ­¤æ—¶éœ€è¦è¿›è¡Œæ­»é”æ¢å¤ï¼Œæœ€å¸¸è§çš„è§£å†³åŠæ³•å°±æ˜¯é€‰æ‹©æ•´ä¸ªç¯ä¸­ä¸€ä¸ªäº‹åŠ¡è¿›è¡Œå›æ»šï¼Œä»¥æ‰“ç ´æ•´ä¸ªç­‰å¾…å›¾ä¸­çš„ç¯ï¼Œæ­¤æ—¶éœ€è¦è€ƒè™‘å¦‚ä½•é€‰æ‹©å›æ»šä»¥é¿å…é¥¥é¥¿å¹¶æœ€å°åŒ–ä»£ä»·ã€‚\n2.2 InnoDB ä¸­çš„ Lock ç›®å‰ InnoDB å±‚ä¸»è¦æœ‰ LOCK_TABLE å’Œ LOCK_REC ä¸¤å¤§ç±»ï¼Œåè€…æä¾›æ›´ç»†ç²’åº¦çš„é”æ“ä½œã€‚è¡Œé”ä»¥ scope åˆ’åˆ†ç»†èŠ‚ç±»å‹ï¼Œæœ‰ LOCK_ORDINARYï¼ˆnext-keyï¼Œè®°å½•åŠå…¶å‰é—´éš™çš„ç»„åˆé”ï¼‰ï¼ŒLOCK_GAPï¼ˆè®°å½•å€¼çš„å‰é—´éš™é”ï¼‰ï¼ŒLOCK_REC_NOT_GAPï¼ˆå•è®°å½•é”ï¼‰ï¼ŒLOCK_INSERT_INTENTIONï¼ˆä¸ºæ’å…¥è¡Œä¸ºçš„gapé”ï¼‰ç­‰ã€‚å…¶æ¬¡ï¼Œè¡Œé”çš„é”å®šæ¨¡å¼ä¸º LOCK_ISã€LOCK_IXã€LOCK_Sã€LOCK_Xã€LOCK_AUTO_INC ç­‰ã€‚\nInnoDB çš„æ‰€æœ‰äº‹åŠ¡é”å¯¹è±¡æŒ‚åœ¨å…¨å±€å¯¹è±¡ lock_sys_t ä¸Šï¼ŒåŒæ—¶æ¯ä¸ªäº‹åŠ¡å¯¹è±¡trx_t ä¸Šä¹Ÿç»´æŒäº†å…¶æ‹¥æœ‰çš„äº‹åŠ¡é”ï¼Œæ¯ä¸ªè¡¨å¯¹è±¡ dict_table_t ä¸Šç»´æŒäº†å…¶ä¸Šçš„è¡¨çº§é”ã€‚8.0.21 ç‰ˆæœ¬è¿˜å¯¹ record hash åš mutex åˆ†ç‰‡æ‹†å‡å°‘ç“¶é¢ˆã€‚åœ¨ä¸€ä¸ªç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªè¡¨å’Œæ¯ä¸€è¡Œéƒ½å¯ä»¥è¢«è§†ä½œä¸€ç§èµ„æºï¼Œå¹¶ä¸”äº‹åŠ¡åœ¨è¯·æ±‚èµ„æºè®¿é—®æƒé™æ—¶ä¼šæŒ‡å®šä¸€ä¸ªæ¨¡å¼ï¼ˆmodeï¼‰ï¼Œä»¥è¡¨æ˜å®ƒæ‰“ç®—å¦‚ä½•ä½¿ç”¨è¯¥èµ„æºã€‚ä¾‹å¦‚ï¼ŒLOCK_X æ¨¡å¼æ„å‘³ç€äº‹åŠ¡éœ€è¦æ’ä»–æ€§è®¿é—®ï¼Œè€Œ LOCK_S æ¨¡å¼æ„å‘³ç€äº‹åŠ¡å¯ä»¥ä¸å…¶ä»–ä½¿ç”¨ LOCK_S æ¨¡å¼çš„äº‹åŠ¡å…±äº«èµ„æºï¼Œé”å¯ä»¥æ˜¯ç­‰å¾…çŠ¶æ€ï¼ˆWAITINGï¼‰æˆ–å·²æˆäºˆçŠ¶æ€ï¼ˆGRANTEDï¼‰ã€‚é”ç³»ç»Ÿä½¿ç”¨é¡µé¢ç¼–å·ï¼ˆpage_noï¼Œå³åŒ…å«è®°å½•çš„é¡µé¢çš„æ ‡è¯†ç¬¦ï¼‰å’Œåœ¨é¡µé¢å†…éƒ¨åˆ†é…è®°å½•æ•°ç»„ä¸­çš„ä½ç½®ï¼ˆheap_noï¼‰æ¥æ ‡è¯†è¡Œè®°å½•ã€‚è¿™åœ¨ b-tree åˆå¹¶ã€åˆ†è£‚æˆ–å¯å˜é•¿åº¦è®°å½•çš„é‡æ–°åˆ†é…æ—¶å˜å¾—å¾ˆé‡è¦ï¼Œè¿™äº›æ“ä½œéƒ½éœ€è¦é€šçŸ¥é”ç³»ç»Ÿä»¥åæ˜ å˜åŒ–ã€‚\né”ç³»ç»Ÿä¸­çš„é”åŒ…å«äº†å…ƒç´ ï¼š\n1ï¼‰è¯·æ±‚é”çš„äº‹åŠ¡ï¼ˆrequesting transactionï¼‰ï¼›\n2ï¼‰èµ„æºç›®æ ‡æ ‡è¯†ï¼ˆç‰¹å®šçš„è¡Œæˆ–è¡¨å®šä½ï¼‰ï¼›\n3ï¼‰é”ç±»å‹ä¸æ¨¡å¼ï¼ˆå¦‚ LOCK_Xã€LOCK_S ç­‰ï¼‰ï¼›\n4ï¼‰é”çŠ¶æ€ï¼ˆWAITING æˆ– GRANTEDï¼‰ã€‚\né”çš„ç”Ÿå‘½å‘¨æœŸé€šå¸¸å¦‚ä¸‹ï¼š\n1ï¼‰äº‹åŠ¡è¯·æ±‚é”ï¼Œå¦‚æœæ²¡æœ‰ä¸ç°æœ‰é”å†²çªåˆ™ç«‹å³æˆäºˆï¼ˆGRANTEDï¼‰ï¼Œå¦åˆ™è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼ˆWAITINGï¼‰ï¼›\n2ï¼‰è‹¥é”å¤„äº WAITING çŠ¶æ€ï¼Œåˆ™çº¿ç¨‹ï¼ˆä¸»åŠ¨ï¼‰ä¼‘çœ ï¼›\n3ï¼‰WAITING é”è¦ä¹ˆåœ¨æ²¡æœ‰å†²çªçš„æƒ…å†µä¸‹å˜ä¸º GRANTEDï¼Œè¦ä¹ˆåœ¨å›æ»šçš„æƒ…å†µä¸‹è¢«å–æ¶ˆï¼ŒåŒæ—¶å”¤é†’åŸå…ˆç­‰å¾…çš„äº‹åŠ¡çº¿ç¨‹ï¼›\n4ï¼‰äº‹åŠ¡ç»“æŸï¼ˆæäº¤æˆ–å›æ»šï¼‰æ—¶é‡Šæ”¾å…¶æ‰€æœ‰é”ã€‚\nè¡Œé”å†²çªå…³ç³»é€šè¿‡å‡½æ•° rec_lock_check_conflict ç¡®å®šã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 static inline Conflict rec_lock_check_conflict(const trx_t *trx, ulint type_mode, const lock_t *lock2, bool lock_is_on_supremum, Trx_locks_cache \u0026trx_locks_cache) { /* é”æ¨¡å¼çš„å…¼å®¹çŸ©é˜µ IS IX S X AI IS + + + - + IX + + - - + S + - + - - X - - - - - AI + + - - - Note that for rows, InnoDB only acquires S or X locks. For tables, InnoDB normally acquires IS or IX locks, S or X table locks are only acquired for LOCK TABLES. Auto-increment (AI) locks are needed because of statement-level MySQL binlog. */ /* é”æ¨¡å¼å…¼å®¹ */ if (trx == lock2-\u003etrx || lock_mode_compatible(static_cast\u003clock_mode\u003e(LOCK_MODE_MASK \u0026 type_mode), lock_get_mode(lock2))) { return Conflict::NO_CONFLICT; } /* è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œæ–°æ¥çš„é”æ˜¯éœ€è¦å’Œå¯¹åº”é”é“¾ä¸Šæ‰€æœ‰ç›¸åŒèµ„æºç›®æ ‡çš„é”åšå…¼å®¹æ¯”è¾ƒï¼Œ åŒ…æ‹¬åŸå…ˆä¸º waiting çŠ¶æ€çš„é”ï¼Œè¿™æ ·åšé˜²æ­¢äº† X é”é¥¥é¥¿çš„é—®é¢˜ */ const bool is_hp = trx_is_high_priority(trx); /* é«˜ä¼˜å…ˆçº§æ˜¯äº‹åŠ¡å¯ä»¥å¿½ç•¥åŸå…ˆçš„ waiting çŠ¶æ€çš„ä½ä¼˜å…ˆçº§äº‹åŠ¡*/ if (is_hp \u0026\u0026 lock2-\u003eis_waiting() \u0026\u0026 !trx_is_high_priority(lock2-\u003etrx)) { return Conflict::NO_CONFLICT; } /* è¦åŠ çš„é”æ˜¯ éinsert_intentionçš„ ä¸Šç•Œ æˆ– gap é”ï¼Œå¯ä»¥å…¼å®¹ä»»ä½•é” */ if ((lock_is_on_supremum || (type_mode \u0026 LOCK_GAP)) \u0026\u0026 !(type_mode \u0026 LOCK_INSERT_INTENTION)) { return Conflict::NO_CONFLICT; } /* è¦åŠ  éinsert_intentionçš„é”ï¼Œå¯ä»¥å…¼å®¹ gap é” */ if (!(type_mode \u0026 LOCK_INSERT_INTENTION) \u0026\u0026 lock_rec_get_gap(lock2)) { return Conflict::NO_CONFLICT; } /* è¦åŠ çš„é”æ˜¯ gap é”ï¼Œå¯ä»¥å’Œ rec_not_gap å…¼å®¹ */ if ((type_mode \u0026 LOCK_GAP) \u0026\u0026 lock_rec_get_rec_not_gap(lock2)) { return Conflict::NO_CONFLICT; } /* é”é“¾ä¸Šå¾…æ¯”è¾ƒçš„é”æ˜¯ insert_intention çš„ï¼Œå¯ä»¥å…¼å®¹å…¶ä»–é” */ if (lock_rec_get_insert_intention(lock2)) { return Conflict::NO_CONFLICT; } /* insert_intention é”æœ€å¤§çš„é—®é¢˜æ˜¯åç»­æ’å…¥åä¼šæŠŠ lock åŒºé—´åˆ†è£‚ï¼Œ å¹¶ç”±å•ä¸ª lock äº§ç”Ÿä¸¤ä¸ª lockï¼Œè¿™æ ·å°±æœ‰å¯èƒ½å¯¼è‡´äº‹åŠ¡ waiting çŠ¶æ€çš„ gap æˆ– next-key lock å˜æˆä¸¤ä¸ª waiting çŠ¶æ€çš„ lockï¼Œè¿èƒŒäº‹åŠ¡æœ€ å¤šä¸€ä¸ª waiting lock çš„åŸåˆ™ */ if (!(type_mode \u0026 LOCK_INSERT_INTENTION) \u0026\u0026 lock2-\u003eis_waiting() \u0026\u0026 lock2-\u003emode() == LOCK_X \u0026\u0026 (type_mode \u0026 LOCK_MODE_MASK) == LOCK_X) { /* å¦‚æœ waiting çŠ¶æ€çš„é”æ˜¯è¢«å½“å‰ trx è‡ªå·±å·²ç» granted çš„é”ç»™é˜»å¡ï¼Œåˆ™ä¸éœ€è¦ç­‰è¿™ä¸ª waiting çŠ¶æ€çš„é” */ if (trx_locks_cache.has_granted_blocker(trx, lock2)) { return Conflict::CAN_BYPASS; } } return Conflict::HAS_TO_WAIT; } 2.2 åŠ é”é€»è¾‘ï¼ˆæ¡ˆä¾‹ï¼‰ ä»¥ sysbench è¡¨ç»“æ„ä¸ºä¾‹ï¼Œä»‹ç»å†™å…¥æ—¶çš„åŠ é”é€»è¾‘ã€‚\n1 2 3 4 5 6 7 8 CREATE TABLE `sbtest1` ( `id` int(11) NOT NULL AUTO_INCREMENT, `k` int(11) NOT NULL DEFAULT '0', `c` char(120) NOT NULL DEFAULT '', `pad` char(60) NOT NULL DEFAULT '', PRIMARY KEY (`id`), KEY `k_1` (`k`) ) ENGINE=InnoDB; è¿™é‡Œå…ˆé¢å¤–è¯´æ˜ä¸€ä¸‹ innodb åœ¨åŠ è¡Œé”æ—¶ä¸€å®š cursor å·²ç»å®šä½äº†ï¼ˆä¸ºäº†ç¡®å®šèµ„æºç›®æ ‡æ ‡è¯†ï¼Œå³ page_id å’Œ heap_noï¼‰ï¼Œå¹¶ä¸”è·å¾—äº† page é¡µé¢é”ä»¥é˜²æ­¢ä¿®æ”¹ã€‚\né¦–å…ˆè®¨è®º insert åœºæ™¯ï¼Œinsert æµç¨‹å…ˆä¸»é”®ï¼ˆrow_ins_clust_index_entryï¼‰å†äºŒçº§ç´¢å¼•ï¼ˆrow_ins_sec_index_entryï¼‰ï¼Œåœ¨æ¯ä¸ªç´¢å¼•ä¸Šæ‰§è¡Œçš„æ“ä½œæ­¥éª¤ç±»ä¼¼ï¼š\nå®šä½ cursor è‡³ç›®æ ‡ä½ç½®ï¼ˆè¿™é‡Œè¿˜å¯ä»¥è·å¾—å®šä½åŒ¹é…æƒ…å†µï¼‰ï¼› aï¼‰å¦‚æœæ˜¯å”¯ä¸€ç´¢å¼•ï¼ˆåŒ…æ‹¬ä¸»é”®ï¼‰ï¼Œå¹¶ä¸”å®šä½æ—¶å‘ç°å’Œç›®æ ‡ç´¢å¼•ä¸Šå­˜åœ¨ record å’Œå°†è¦æ’å…¥çš„è®°å½•ç‰©ç† matchï¼Œåˆ™è¦èµ°åˆ° record åˆ¤é‡é€»è¾‘ä¸­ï¼ˆrow_ins_duplicate_error_in_clust / row_ins_scan_sec_index_for_duplicateï¼‰ï¼Œå…¶ä¸­ä¼šå…ˆå¯¹åº”å»åŠ ç›®æ ‡è¡Œçš„è¡Œé”ï¼ˆlock_clust_rec_read_check_and_lock / lock_sec_rec_read_check_and_lock ä¸¤ä¸ªå‡½æ•°çš„æ‰§è¡Œé€»è¾‘åŸºæœ¬ä¸€è‡´ï¼‰ï¼Œè¿™é‡Œå¯èƒ½äº§ç”Ÿé”ç­‰å¾…ï¼Œå†åˆ¤æ–­é‡å¤æ€§æ˜¯å¦æ»¡è¶³è¦æ±‚ï¼› 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 dberr_t lock_clust_rec_read_check_and_lock( const lock_duration_t duration, const buf_block_t *block, const rec_t *rec, dict_index_t *index, const ulint *offsets, const select_mode sel_mode, const lock_mode mode, const ulint gap_mode, que_thr_t *thr) { if (srv_read_only_mode || index-\u003etable-\u003eis_temporary()) return (DB_SUCCESS); dberr_t err; ulint heap_no = page_rec_get_heap_no(rec); // éšå¼é”åˆ¤æ–­ï¼šé€šè¿‡ \"ä¸»é”®recordä¸Šé¢çš„ç³»ç»Ÿåˆ—\" å’Œ \"æ´»è·ƒäº‹åŠ¡æ•°ç»„\" åˆ¤æ–­å¯¹åº”è®°å½•æ˜¯å¦å­˜åœ¨éšå¼é”ï¼Œå¦‚æœ‰åˆ™ä¸ºå…¶åŠ ä¸Šæ˜¾ç¤ºé” // åˆ¤æ–­äºŒçº§ç´¢å¼•æ— æ³•è¿‡æ»¤æ—¶ï¼Œéœ€è¦å›è¡¨ if (heap_no != PAGE_HEAP_NO_SUPREMUM) { lock_rec_convert_impl_to_expl(block, rec, index, offsets); } { locksys::Shard_latch_guard guard{UT_LOCATION_HERE, block-\u003eget_page_id()}; if (duration == lock_duration_t::AT_LEAST_STATEMENT) { lock_protect_locks_till_statement_end(thr); } // åŠ è¡Œé”ï¼Œä¸å¯ä¸ºéšå¼é” err = lock_rec_lock(false, sel_mode, mode | gap_mode, block, heap_no, index, thr); } return (err); } bï¼‰å¦‚æœæ˜¯éå”¯ä¸€ç´¢å¼•ï¼Œæˆ–è€…æœªå‘ç°å·²å­˜åœ¨åŒ¹é… recordï¼Œåˆ™åœ¨ insert é˜¶æ®µå¯ä»¥è·³è¿‡é‡å¤æ€§æ£€æŸ¥ï¼ˆè¿›è€Œè¿™é‡Œä¹Ÿä¸å†éœ€è¦èµ°åŠ é”é€»è¾‘ï¼‰ï¼› 3. è¿›è¡ŒçœŸæ­£çš„æ’å…¥æ“ä½œï¼ˆbtr_cur_optimistic_update / btr_cur_pessimistic_update è¿™ä¸¤ä¸ªæ¥å£ä¸ºé€šè¿‡ä¿®æ”¹æ’å…¥ï¼› btr_cur_optimistic_insert / btr_cur_pessimistic_insert è¿™ä¸¤ä¸ªæ¥å£ä¸ºç›´æ¥æ’å…¥ï¼‰ï¼Œå…¶ä¸­ä¼šå¯¹åº”è¿›è¡Œè¡Œé”æ“ä½œ ï¼ˆlock_clust_rec_modify_check_and_lock / lock_sec_rec_modify_check_and_lock é€šè¿‡ä¿®æ”¹æ’å…¥ï¼› lock_rec_insert_check_and_lock ç›´æ¥æ’å…¥ï¼‰ï¼š\nä¿®æ”¹æ’å…¥ï¼ˆupdateï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 dberr_t lock_clust_rec_modify_check_and_lock( ulint flags, /*!\u003c in: if BTR_NO_LOCKING_FLAG bit is set, does nothing */ const buf_block_t *block, /*!\u003c in: buffer block of rec */ const rec_t *rec, /*!\u003c in: record which should be modified */ dict_index_t *index, /*!\u003c in: clustered index */ const ulint *offsets, /*!\u003c in: rec_get_offsets(rec, index) */ que_thr_t *thr) /*!\u003c in: query thread */ { if (flags \u0026 BTR_NO_LOCKING_FLAG) return (DB_SUCCESS); dberr_t err; ulint heap_no = rec_offs_comp(offsets) ? rec_get_heap_no_new(rec) : rec_get_heap_no_old(rec); // éšå¼é”åˆ¤æ–­ï¼šé€šè¿‡ \"ä¸»é”®recordä¸Šé¢çš„ç³»ç»Ÿåˆ—\" å’Œ \"æ´»è·ƒäº‹åŠ¡æ•°ç»„\" åˆ¤æ–­å¯¹åº”è®°å½•æ˜¯å¦å­˜åœ¨éšå¼é”ï¼Œå¦‚æœ‰åˆ™ä¸ºå…¶åŠ ä¸Šæ˜¾ç¤ºé”ï¼› // åˆ¤æ–­äºŒçº§ç´¢å¼•æ— æ³•è¿‡æ»¤æ—¶ï¼Œéœ€è¦å›è¡¨ lock_rec_convert_impl_to_expl(block, rec, index, offsets); { locksys::Shard_latch_guard guard{UT_LOCATION_HERE, block-\u003eget_page_id()}; // åŠ è¡Œé”ï¼Œå¯ä¸ºéšå¼é”ï¼Œå³æ— å†²çªæ—¶ä¸çœŸæ­£åŠ è¡Œé” err = lock_rec_lock(true, SELECT_ORDINARY, LOCK_X | LOCK_REC_NOT_GAP, block, heap_no, index, thr); } if (err == DB_SUCCESS_LOCKED_REC) err = DB_SUCCESS; return (err); } ç›´æ¥æ’å…¥ï¼ˆinsertï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 dberr_t lock_rec_insert_check_and_lock( ulint flags, /*!\u003c in: if BTR_NO_LOCKING_FLAG bit is set, does nothing */ const rec_t *rec, /*!\u003c in: record after which to insert */ buf_block_t *block, /*!\u003c in/out: buffer block of rec */ dict_index_t *index, /*!\u003c in: index */ que_thr_t *thr, /*!\u003c in: query thread */ mtr_t *mtr, /*!\u003c in/out: mini-transaction */ bool *inherit) /*!\u003c out: set to true if the new inserted record maybe should inherit LOCK_GAP locks from successor record */ { if (flags \u0026 BTR_NO_LOCKING_FLAG) return (DB_SUCCESS); dberr_t err = DB_SUCCESS; lock_t *lock; auto inherit_in = *inherit; trx_t *trx = thr_get_trx(thr); const rec_t *next_rec = page_rec_get_next_const(rec); ulint heap_no = page_rec_get_heap_no(next_rec); { locksys::Shard_latch_guard guard{UT_LOCATION_HERE, block-\u003eget_page_id()}; if (lock_rec_get_first(lock_sys-\u003erec_hash, block, heap_no) == nullptr) { // é”é“¾ä¸Šæ— é”ï¼Œç›´æ¥åŠ éšå¼é” *inherit = false; } else { *inherit = true; const ulint type_mode = LOCK_X | LOCK_GAP | LOCK_INSERT_INTENTION; // åˆ¤æ–­é”é“¾ä¸Šæ˜¯å¦å­˜åœ¨å†²çªæ¨¡å¼çš„é”ï¼šå¦‚æœå­˜åœ¨å…¶ä»–åç»§è®°å½•çš„é™¤ insert ç›®çš„å¤–çš„ gap é” const auto conflicting = lock_rec_other_has_conflicting(type_mode, block, heap_no, trx); if (conflicting.wait_for != nullptr) { RecLock rec_lock(thr, index, block, heap_no, type_mode); trx_mutex_enter(trx); // å­˜åœ¨å†²çªï¼ŒåŠ è¡Œé” err = rec_lock.add_to_waitq(conflicting.wait_for); trx_mutex_exit(trx); } } } switch (err) { case DB_SUCCESS_LOCKED_REC: err = DB_SUCCESS; case DB_SUCCESS: if (!inherit_in || index-\u003eis_clustered()) break; /* äºŒçº§ç´¢å¼•æ›´æ–° page ä¸Šçš„ max trx id æ ‡å¿— */ page_update_max_trx_id(block, buf_block_get_page_zip(block), trx-\u003eid, mtr); default: break; } return (err); } æ›´å¤šéšå¼é”ç›¸å…³å†…å®¹å¯ä»¥å‚è€ƒè¿™ç¯‡ mysql æœˆæŠ¥æ–‡ç« ã€‚\nupdate æµç¨‹ä¼šå…ˆé€šè¿‡è¯»æ¥å£æ¥å¯»æ‰¾åŸå…ˆéœ€è¦è¢«æ›´æ–°çš„è¡Œè®°å½•ï¼ˆindex_read-\u003erow_search_mvccï¼‰ï¼Œåœ¨è¯»é˜¶æ®µå°±ä¼šå¯¹ç›®æ ‡è¡Œè¿›è¡ŒåŠ é”ï¼ˆlock_clust_rec_read_check_and_lock / lock_sec_rec_read_check_and_lockï¼‰ï¼Œè¿™é‡Œçš„åŠ é”æ¥å£å’Œ insert åˆ¤é‡é˜¶æ®µä¸€è‡´ï¼Œå…·ä½“åŠ é”æ¨¡å¼è¿˜å’Œéš”ç¦»çº§åˆ«æœ‰å…³ã€‚ update ç¬¬äºŒä¸ªé˜¶æ®µä¼šçœŸæ­£å»ä¿®æ”¹æ•°æ®ï¼Œä¹Ÿæœ‰ç›´æ¥ update æ¨¡å¼å’Œ delete_mark + insert æ¨¡å¼ï¼Œåˆ° btr_cur_ å±‚çš„æ¥å£ä¸€è‡´ï¼Œå› æ­¤åŠ é”å‡½æ•°æ¥å£ä¹Ÿä¸€è‡´ã€‚\n2.3 é”çš„é‡Šæ”¾ å¤§å¤šæ•°æƒ…å†µä¸‹äº‹åŠ¡æŒæœ‰çš„æ‰€æœ‰é”ï¼ˆtrx_t::lock.trx_locksï¼‰éƒ½æ˜¯åœ¨äº‹åŠ¡æäº¤æ—¶é‡Šæ”¾(trx_release_impl_and_expl_locks-\u003elock_trx_release_locksï¼Œåœ¨ trx_commit_in_memory é˜¶æ®µçš„å¼€å§‹)ã€‚æœ‰ä¸¤ä¸ªä¾‹å¤–ï¼š\naï¼‰AUTO-INC é”ï¼ˆç”±å‚æ•° innodb_autoinc_lock_mode æ§åˆ¶ï¼‰åœ¨SQLç»“æŸæ—¶ç›´æ¥é‡Šæ”¾ï¼ˆinnobase_commit â€“\u003e lock_unlock_table_autoincï¼‰ï¼›\nbï¼‰åœ¨ RC éš”ç¦»çº§åˆ«ä¸‹æ‰§è¡Œ DML è¯­å¥æ—¶ï¼Œä»å¼•æ“å±‚è¿”å›åˆ° Server å±‚çš„è®°å½•ï¼Œå¦‚æœä¸æ»¡è¶³ where æ¡ä»¶ï¼Œåˆ™ä¼šç«‹åˆ» unlock æ‰ï¼ˆha_innobase::unlock_rowï¼‰ã€‚\nå¯¹äºè¡Œé”ï¼Œä» lock sys hash ä¸­åˆ é™¤åè¿˜éœ€è¦åˆ¤æ–­æ˜¯å¦æœ‰æ­£åœ¨ç­‰å¾…çš„ä¼šè¯å¯ä»¥è¢«å”¤é†’ï¼ˆlock_rec_dequeue_from_pageï¼‰ã€‚è¿™é‡Œé‡‡ç”¨çš„æ˜¯ CATS ç­–ç•¥å°†æ‰€æœ‰å¤„äº LOCK_WAIT çŠ¶æ€çš„é”å¯¹è±¡æŒ‰trxä¼˜å…ˆæƒã€è°ƒåº¦æƒé‡ trx-\u003elock.schedule_weight æ’åºï¼Œç„¶åä¾æ¬¡å¤„ç†ã€‚å¯¹äºæ¯ä¸ªç­‰å¾…çŠ¶æ€çš„é”å¯¹è±¡ï¼Œå¦‚æœå…¶ä¸å†ç­‰å¾…ä»»ä½•å·²æœ‰ granted çš„é”å¯¹è±¡ï¼ˆåŒ…æ‹¬è¿™æ¬¡å¾ªç¯å‰é¢ grant çš„ï¼‰ï¼Œåˆ™æ¸…ç†ç­‰å¾…äº‹åŠ¡çš„ç›¸å…³é”ç­‰å¾…çŠ¶æ€å¹¶å”¤é†’çº¿ç¨‹å·²ç»æŒ‚èµ·çš„ç­‰å¾…äº‹åŠ¡ï¼›åä¹‹ï¼Œåˆ™æ›´æ–°ç­‰å¾…å…³ç³»ã€ç»§ç»­ç­‰å¾…ã€‚\n2.4 æ­»é”æ£€æµ‹åŠCATSç­–ç•¥ å®˜æ–¹åœ¨ Bug#29882690: UNDETECTED DEADLOCK WITH GAP AND INSERT INTENTION LOCKS IS POSSIBLE ä¸­ä¿®å¤éƒ¨åˆ†åŸå…ˆæ— æ³•æ¢æµ‹çš„æ­»é”ï¼Œè¿˜å°†é”é˜»å¡ä¿¡æ¯ï¼ˆwait-forå›¾ï¼‰ä» lock è½¬ç§»åˆ° trx ä¸­ï¼Œå¹¶ä¸”å°†æ­»é”æ£€æµ‹ä»å‰å°äº‹åŠ¡çº¿ç¨‹è½¬ç§»åˆ°åå°ç›‘æ§çº¿ç¨‹ã€‚è¿™æ ·å‡è½»äº†å‰å°äº‹åŠ¡çº¿ç¨‹çš„å–é”å†²çªæ—¶çš„æ£€æµ‹ä»£ä»·ï¼›ä½†æ˜¯æ­»é”ä¼šå…ˆè¿›å…¥äº‹åŠ¡ç³»ç»Ÿï¼Œåç»­æ£€æµ‹å‡ºåå›æ»šï¼Œä¹Ÿå°±æ„å‘³ç€æ­»é”äº‹åŠ¡ä¼šå ç”¨ä¸€æ®µæ—¶é—´çš„çº¿ç¨‹ã€å†…å­˜èµ„æºã€å¯¼è‡´é”é“¾ã€äº‹åŠ¡æ•°ç»„ç­‰çš„è†¨èƒ€åï¼ˆå¯¹åº”çº¿ç¨‹å…ˆè¿›å…¥ã€ç„¶å suspend è¿›å…¥ç¡çœ ç­‰å¾…åï¼‰æ‰ä¼šè¢«å›æ»šï¼Œè‹¥æ˜¯æ­»é”æ¦‚ç‡è¾ƒé«˜çš„é«˜å†²çªåœºæ™¯è¿™å¯èƒ½ä¼šå¯¼è‡´æ•´ä½“äº‹åŠ¡ç³»ç»Ÿçš„æ€§èƒ½ä¸‹é™ã€‚æ­»é”å¤„ç†çš„é€»è¾‘åœ¨ lock_wait_timeout_thread çº¿ç¨‹ä¸­ï¼ˆlock_wait_update_schedule_and_check_for_deadlocksï¼‰ï¼Œé¡¾åæ€ä¹‰è¿™ä¸ªå‡½æ•°æ›´æ–°äº†äº‹åŠ¡æƒé‡æ¯”æ£€æŸ¥äº†æ˜¯å¦å­˜åœ¨æ­»é”ã€‚æ–°ç‰ˆæ­»é”æ£€æµ‹é€»è¾‘çš„ç†è®ºåŸºç¡€å¯ä»¥å‚è€ƒè¿™ç¯‡ mysql æœˆæŠ¥æ–‡ç« ï¼Œä¸‹é¢ä¸»è¦ä»‹ç»ä»£ç é€»è¾‘ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 /** Takes a snapshot of transactions in waiting currently in slots, updates their schedule weights, searches for deadlocks among them and resolves them. */ static void lock_wait_update_schedule_and_check_for_deadlocks() { ut::vector\u003cwaiting_trx_info_t\u003e infos; ut::vector\u003cint\u003e outgoing; ut::vector\u003ctrx_schedule_weight_t\u003e new_weights; /* ï¼ˆä»¥ä¸‹æŒæœ‰ lock_sys-\u003ewait_mutexï¼‰ å°† lock_sys ä¸­æ‰€æœ‰ waiting çŠ¶æ€çš„ trx åŠé˜»å¡å®ƒçš„ blocking_trx åŠ å…¥åˆ° infosï¼Œæ„å»º wait trx çš„ snapshotï¼› */ auto table_reservations = lock_wait_snapshot_waiting_threads(infos); /* æ„å»º waiting for graphï¼Œå®è´¨ä¸Šå°±æ˜¯å¯»æ‰¾æŸä¸ª trx çš„ blocking_trx æ˜¯å¦å­˜åœ¨åœ¨ info ä¸­ï¼Œ blocking_trx ä¹Ÿå­˜åœ¨çš„è¯é€šè¿‡ outgoing æ•°ç»„å…³è”ä½ç½®èµ·æ¥ï¼Œè¿™æ ·å°±å°†æ‰€æœ‰ä¾èµ–çš„ trx ä¸²è”èµ·æ¥ï¼Œ (å³å°†è¿™ä¸ª trx åœ¨ info ä¸­çš„ index ä½ç½®ä½œä¸º outgoing indexï¼Œ å°† blocking_trx åœ¨ info ä¸­çš„ index ä½ç½®ä½œä¸º outgoing ä¸­è¿™ä¸ª index å¯¹åº”ä½ç½®çš„å…ƒç´ ï¼‰ */ lock_wait_build_wait_for_graph(infos, outgoing); /* åˆå§‹åŒ–äº‹åŠ¡æƒé‡å€¼ï¼Œæ­£å¸¸ç­‰å¾…äº‹åŠ¡åˆå§‹ä¸º1ï¼Œè¶…æ—¶äº‹åŠ¡ä¼šåˆå§‹ä¸ºè¾ƒå¤§å€¼ï¼› é€šè¿‡å…³è”æ ‘å›¾ç®—å‡º new_weightsï¼ˆä¾èµ–å­æ ‘å…ƒç´ æ•°ç›®ï¼‰ï¼š å°†æ‰€æœ‰æ— å…¥åº¦çš„èŠ‚ç‚¹å…¥æ ˆï¼Œå†éå†æ ˆå…ƒç´ æ ¹æ®å…¶å‡ºåº¦ç¡®å®šçˆ¶èŠ‚ç‚¹å¹¶å°†è¿™ä¸ªå­èŠ‚ç‚¹çš„æƒé‡å¢åŠ åˆ°çˆ¶èŠ‚ç‚¹ä¸Šï¼Œå¹¶å‡å°‘å…¶çˆ¶èŠ‚ç‚¹å…¥åº¦è®¡æ•°ï¼› å¦‚æœå¯¹åº”çˆ¶èŠ‚ç‚¹è¿˜å­˜åœ¨æœ‰å‡ºåº¦ï¼Œå½“å…¶æ‰€æœ‰å…¥åº¦å¤„ç†å®Œæˆåï¼ˆå…¥åº¦è®¡æ•°ä¸º0ï¼Œå…¶æ‰€æœ‰å…¥åº¦å·²ç»è½¬åŒ–ä¸ºæƒé‡å€¼ï¼‰ï¼Œä½œä¸ºæ— å…¥åº¦èŠ‚ç‚¹å…¥æ ˆåŒä¸Šå¤„ç†ï¼› ç›´åˆ°æ ˆä¸­æ— ä»»ä½•å…ƒç´ ï¼ˆä¸å­˜åœ¨è¿˜æœ‰å‡ºåº¦çš„å…ƒç´ ï¼‰ NOTEï¼šå¦‚æœæœ‰ç¯å­˜åœ¨ï¼Œå…¶ä¸Šä¸€å®šä¸å­˜åœ¨æ— å…¥åº¦çš„èŠ‚ç‚¹ï¼Œå› æ­¤ä¸ä¼šåœ¨ä¸Šè¿°æ­¥éª¤å¤„ç†ï¼Œå› æ­¤å…¥åº¦è®¡æ•°ä¸ä¸º0 å°†é™¤æ­»é”ç¯å¤–çš„æ‰€æœ‰ç­‰å¾…çŠ¶æ€çš„äº‹åŠ¡æƒé‡æ›´æ–°ï¼ˆæŒæœ‰ lock_sys-\u003ewait_mutexï¼‰ */ lock_wait_compute_and_publish_weights_except_cycles(infos, table_reservations, outgoing, new_weights); if (innobase_deadlock_detect) { /* ç”¨ DFS æ–¹å¼ç¡®å®šçš„ä¸€ä¸ªæ­»é”ç¯ï¼Œå¦‚æœå­˜åœ¨çš„è¯å°±é€‰æ‹©ç›®æ ‡å¹¶å›æ»šäº‹åŠ¡ï¼ˆlock_cancel_waiting_and_releaseï¼‰ */ lock_wait_find_and_handle_deadlocks(infos, outgoing, new_weights); } } CATS ç­–ç•¥åŸºäºåå°ç”Ÿäº§çš„äº‹åŠ¡æƒé‡ï¼Œåœ¨äº‹åŠ¡æ”¾é”é€‰æ‹©æœ€åˆé€‚ç­‰å¾…äº‹åŠ¡å»å”¤é†’ï¼Œæå‡æ•´ä½“äº‹åŠ¡æ•ˆç‡ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 static void lock_rec_grant_by_heap_no(lock_t *in_lock, ulint heap_no) { const auto hash_table = in_lock-\u003ehash_table(); using LockDescriptorEx = std::pair\u003ctrx_schedule_weight_t, lock_t *\u003e; Scoped_heap heap((sizeof(lock_t *) * 3 + sizeof(LockDescriptorEx)) * 32, UT_LOCATION_HERE); RecID rec_id{in_lock, heap_no}; Locks\u003clock_t *\u003e low_priority_light{heap.get()}; Locks\u003clock_t *\u003e waiting{heap.get()}; Locks\u003clock_t *\u003e granted{heap.get()}; Locks\u003cLockDescriptorEx\u003e low_priority_heavier{heap.get()}; const auto in_trx = in_lock-\u003etrx; /* å¯¹äºé”é“¾ä¸Šæ¯ä¸ª lock åˆ’åˆ†åˆ° grantedã€waitingã€low_priority_lightã€low_priority_heavier ä¸­ï¼š granted: å·²ç»è·å–åˆ°çš„é”ï¼Œå¦‚æœç­‰å¾…é”è¢«æˆæƒï¼Œä¹Ÿä¼šä» waiting è½¬ç§»åˆ° grantedï¼› low_priority_lightï¼šä½æƒé‡çš„ waiting çŠ¶æ€é”ï¼› low_priority_heavierï¼šé«˜æƒé‡çš„ waiting çŠ¶æ€é”ï¼› waitingï¼šå¤„äº waiting çŠ¶æ€çš„é”ï¼Œæœ€ç»ˆ low_priority_light å’Œ low_priority_heavier ä¼šåˆå¹¶å…¥æ­¤æ•°ç»„ï¼› */ Lock_iter::for_each(rec_id, [\u0026](lock_t *lock) { if (!lock-\u003eis_waiting()) { granted.push_back(lock); return (true); } const auto trx = lock-\u003etrx; if (trx-\u003eerror_state == DB_DEADLOCK || trx-\u003elock.was_chosen_as_deadlock_victim) { return (true); } const auto blocking_trx = trx-\u003elock.blocking_trx.load(std::memory_order_relaxed); if (blocking_trx != in_trx) { return (true); } if (trx_is_high_priority(trx)) { waiting.push_back(lock); return (true); } /* è¿™ä¸ªç­‰å¾…çš„äº‹åŠ¡è¿˜æœ‰ç­‰å¾…å®ƒçš„äº‹åŠ¡ï¼Œè®¤ä¸ºæ˜¯é«˜æƒé‡ */ const auto schedule_weight = trx-\u003elock.schedule_weight.load(std::memory_order_relaxed); if (schedule_weight \u003c= 1) { low_priority_light.push_back(lock); } else { low_priority_heavier.push_back(LockDescriptorEx{schedule_weight, lock}); } return (true); }, hash_table); if (waiting.empty() \u0026\u0026 low_priority_light.empty() \u0026\u0026 low_priority_heavier.empty()) { return; } /* æŒ‰æƒé‡è¿›è¡Œæ’åºï¼Œé«˜æƒé‡ä¼˜å…ˆ grant */ std::stable_sort(low_priority_heavier.begin(), low_priority_heavier.end(), [](const LockDescriptorEx \u0026a, const LockDescriptorEx \u0026b) { return (a.first \u003e b.first);}); for (const auto \u0026descriptor : low_priority_heavier) {waiting.push_back(descriptor.second);} waiting.insert(waiting.end(), low_priority_light.begin(), low_priority_light.end()); const auto new_granted_index = granted.size(); granted.reserve(granted.size() + waiting.size()); for (lock_t *wait_lock : waiting) { /* å·²æˆæƒé”æ˜¯å¦ä¼šé˜»å¡å½“å‰é” */ const lock_t *blocking_lock = lock_rec_has_to_wait_for_granted(wait_lock, granted, new_granted_index); if (blocking_lock == nullptr) { lock_grant(wait_lock); lock_rec_move_granted_to_front(wait_lock, rec_id); granted.push_back(wait_lock); } else { /* ç­‰å¾…çš„é”ç­‰å¾…åŸå› å¯èƒ½æ”¹å˜ï¼Œæ›´æ–° wait_for å›¾ */ lock_update_wait_for_edge(wait_lock, blocking_lock); } } } ç‰ˆæƒå£°æ˜ï¼šå¦‚éœ€è½¬è½½æˆ–å¼•ç”¨ï¼Œè¯·é™„åŠ æœ¬æ–‡é“¾æ¥å¹¶æ³¨æ˜æ¥æºã€‚ ",
  "wordCount" : "1589",
  "inLanguage": "zh",
  "datePublished": "2023-12-05T00:00:00Z",
  "dateModified": "2023-12-05T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Miao Zheyu"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://mzyee.github.io/posts/mysql/lock/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "MZY's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://mzyee.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://mzyee.github.io" accesskey="h" title=" MZY&#39;s Blog (Alt + H)">
                <img src="https://mzyee.github.io/img/eye.jpg" alt="" aria-label="logo"
                    height="38"> MZY&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://mzyee.github.io/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://mzyee.github.io/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://mzyee.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://mzyee.github.io/contact" title="Contact">
                    <span>Contact</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://mzyee.github.io">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://mzyee.github.io/posts/">Posts</a>&nbsp;Â»&nbsp;<a href="https://mzyee.github.io/posts/mysql/">MySQL</a></div>
    <h1 class="post-title">
      MySQL äº‹åŠ¡é”ç³»ç»Ÿ
    </h1>
    <div class="post-meta"><span title='2023-12-05 00:00:00 +0000 UTC'>åäºŒæœˆ 5, 2023</span>&nbsp;Â·&nbsp;8 åˆ†é’Ÿ&nbsp;Â·&nbsp;Miao Zheyu
      &nbsp;|&nbsp;ğŸ“– &nbsp;
      <ul class="post-tags-meta">
        <a href="https://mzyee.github.io/tags/mysql/">MySQL</a>
        <a href="https://mzyee.github.io/tags/lock/">&nbsp;Lock</a>
        <a href="https://mzyee.github.io/tags/transaction/">&nbsp;Transaction</a>
      </ul>&nbsp;|&nbsp;<a href="https://github.com/mzyee/mzyee.github.io" rel="noopener noreferrer" target="_blank">Suggestions</a>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#1-%e5%89%8d%e8%a8%80" aria-label="1. å‰è¨€">1. å‰è¨€</a></li>
                    <li>
                        <a href="#2-innodb-%e4%ba%8b%e5%8a%a1%e9%94%81" aria-label="2. InnoDB äº‹åŠ¡é”">2. InnoDB äº‹åŠ¡é”</a><ul>
                            
                    <li>
                        <a href="#21-%e4%b8%a4%e9%98%b6%e6%ae%b5%e9%94%812pl-locking" aria-label="2.1 ä¸¤é˜¶æ®µé”ï¼ˆ2PL Lockingï¼‰">2.1 ä¸¤é˜¶æ®µé”ï¼ˆ2PL Lockingï¼‰</a></li>
                    <li>
                        <a href="#22-innodb-%e4%b8%ad%e7%9a%84-lock" aria-label="2.2 InnoDB ä¸­çš„ Lock">2.2 InnoDB ä¸­çš„ Lock</a></li>
                    <li>
                        <a href="#22-%e5%8a%a0%e9%94%81%e9%80%bb%e8%be%91%e6%a1%88%e4%be%8b" aria-label="2.2 åŠ é”é€»è¾‘ï¼ˆæ¡ˆä¾‹ï¼‰">2.2 åŠ é”é€»è¾‘ï¼ˆæ¡ˆä¾‹ï¼‰</a></li>
                    <li>
                        <a href="#23-%e9%94%81%e7%9a%84%e9%87%8a%e6%94%be" aria-label="2.3 é”çš„é‡Šæ”¾">2.3 é”çš„é‡Šæ”¾</a></li>
                    <li>
                        <a href="#24-%e6%ad%bb%e9%94%81%e6%a3%80%e6%b5%8b%e5%8f%8acats%e7%ad%96%e7%95%a5" aria-label="2.4 æ­»é”æ£€æµ‹åŠCATSç­–ç•¥">2.4 æ­»é”æ£€æµ‹åŠCATSç­–ç•¥</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>


  <div class="post-content"><h3 id="1-å‰è¨€">1. å‰è¨€<a hidden class="anchor" aria-hidden="true" href="#1-å‰è¨€">#</a></h3>
<p>â€ƒâ€ƒ æ•°æ®åº“ç³»ç»Ÿçš„å¹¶å‘æ§åˆ¶ä¸å…¶å¤šä¸ªæ¨¡å—ç›¸å…³è”ï¼Œå…¶ç”¨äºå®ç°æ— å†²çªã€ä¿æŒä¸€è‡´æ€§çš„å¤šäº‹åŠ¡å¹¶å‘æ“ä½œã€‚å¹¶å‘æ§åˆ¶æ¨¡å—éœ€è¦ä¿è¯äº‹åŠ¡å¹¶å‘æ‰§è¡Œçš„æ•ˆæœä¸è¦æ±‚çš„ä¸²è¡Œæ‰§è¡Œæ¨¡å¼çš„æ•ˆæœå®Œå…¨ç›¸åŒï¼Œä»¥è¾¾åˆ°éš”ç¦»æ€§çš„è¦æ±‚ï¼Œä¸åˆç†çš„å¹¶å‘æ§åˆ¶å¯èƒ½å¯¼è‡´æ›´æ–°ä¸¢å¤±ã€ä¸å¯é‡å¤è¯»ã€è„è¯»ã€å¹»è¯»ç­‰é—®é¢˜ã€‚</p>
<center><img src="cc.png" width="70%" /></center>
<p>â€ƒâ€ƒ ç›®å‰å¸¸ç”¨çš„å¹¶å‘æ§åˆ¶åè®®å¯è¢«ç²—ç•¥å¹¶ä¸å®Œæ•´çš„åˆ†ä¸ºæ‚²è§‚å’Œä¹è§‚ä¸¤å¤§ç±»ï¼šæ­¤å¤„ä¹è§‚åè®®æŒ‡ç‹­ä¹‰ä¹è§‚å¹¶å‘æ§åˆ¶ï¼Œå¦‚æŒ‡åŸºäº<em>å®Œæˆæœ‰æ•ˆæ€§éªŒè¯</em>çš„å¹¶å‘æ§åˆ¶ï¼Œä¸»è¦ä¸ºå‰å‘ OCC å’Œåå‘ OCC ä¸¤ç±»ï¼›è€Œæ‚²è§‚åè®®åˆåˆ†ä¸ºåŸºäºé”å’Œéé”ä¸¤å¤§ç±»ï¼Œ<em>åŸºäºé”çš„åè®®</em>æœ‰ 2-Phase Lockingã€Altruistic Lockingã€Read/Write Tree Locking ç­‰ï¼Œ<em>éé”ç±»åè®®</em>æœ‰åŸºäºåŸºäºäº‹åŠ¡ä¸²è¡ŒåŒ–å›¾çš„åè®®ç­‰ã€‚æ­¤å¤–ï¼Œè¿˜å¯ä»¥è¿›ä¸€æ­¥å¯ä»¥ç»“åˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMVCCï¼‰ï¼Œä»¥æé«˜æ•°æ®åº“çš„ï¼ˆè¯»ï¼‰æ€§èƒ½ã€‚</p>
<h3 id="2-innodb-äº‹åŠ¡é”">2. InnoDB äº‹åŠ¡é”<a hidden class="anchor" aria-hidden="true" href="#2-innodb-äº‹åŠ¡é”">#</a></h3>
<h4 id="21-ä¸¤é˜¶æ®µé”2pl-locking">2.1 ä¸¤é˜¶æ®µé”ï¼ˆ2PL Lockingï¼‰<a hidden class="anchor" aria-hidden="true" href="#21-ä¸¤é˜¶æ®µé”2pl-locking">#</a></h4>
<p>â€ƒâ€ƒ è¿™é‡Œä»‹ç»æœ€å¸¸ç”¨çš„ä¸º 2PL åè®®ï¼Œè¿™ä¹Ÿæ˜¯ MySQL ä½¿ç”¨çš„æœºåˆ¶ã€‚2PL å°†äº‹åŠ¡çš„æ‰§è¡Œé˜¶æ®µåˆ†ä¸ºä¸‰ä¸ªä¸åŒçš„éƒ¨åˆ†ï¼š</p>
<ul>
<li>1ï¼‰ç¬¬ä¸€é˜¶æ®µï¼Œäº‹åŠ¡å¼€å§‹æ‰§è¡Œæ—¶ï¼Œäº‹åŠ¡å¼€å§‹è·å–éœ€è¦çš„é”çš„æƒé™ï¼Œä½†ä¸é‡Šæ”¾é”ï¼›</li>
<li>2ï¼‰ç¬¬äºŒéƒ¨åˆ†æ˜¯äº‹åŠ¡è·å–æ‰€æœ‰é”çš„è¿‡ç¨‹ï¼›</li>
<li>3ï¼‰å½“äº‹åŠ¡é‡Šæ”¾å®ƒçš„ç¬¬ä¸€ä¸ªé”æ—¶ï¼Œç¬¬ä¸‰é˜¶æ®µå¼€å§‹ï¼Œæ­¤é˜¶æ®µäº‹åŠ¡ä¸èƒ½è¦æ±‚ä»»ä½•æ–°é”ï¼Œåªé‡Šæ”¾è·å–çš„é”ã€‚</li>
</ul>
<p>â€ƒâ€ƒ ä»ä¸Šå¯ä»¥çœ‹å‡º 2PL åˆ†ä¸º Growing phase å’Œ Shrinking phase ä¸¤ä¸ªé˜¶æ®µã€‚æ ¹æ®é”å®šç»†èŠ‚è¿˜å¯æ¼”åŒ–ä¸º Conservative-2PLã€Strict-2PLã€Rigorous-2PL ç­‰ã€‚2PL åè®®æä¾›äº†å¯åºåˆ—åŒ–æ€§ï¼Œä½†ä¸èƒ½ä¿è¯ä¸å‘ç”Ÿæ­»é”ï¼Œå› æ­¤éœ€è¦è¿›è¡Œæ­»é”é¢„é˜²æˆ–æ­»é”æ£€æµ‹ã€‚MySQL é‡‡ç”¨çš„æ˜¯æ­»é”æ£€æµ‹åŠ è¶…æ—¶æ¢å¤çš„æœºåˆ¶ï¼Œæ­»é”æ£€æµ‹ä¸€èˆ¬é€šè¿‡ waits-for å›¾ç»“æ„å®ç°ï¼šå›¾ä¸­ç‚¹ä»£è¡¨äº‹åŠ¡ï¼Œæœ‰å‘è¾¹ä»£è¡¨äº‹åŠ¡åœ¨ç­‰å¾…å¦ä¸€ä¸ªäº‹åŠ¡æ”¾é”ï¼Œå½“ waits-for å›¾å‡ºç°ç¯æ—¶è¯´æ˜æœ‰æ­»é”å‡ºç°ã€‚æ­¤æ—¶éœ€è¦è¿›è¡Œæ­»é”æ¢å¤ï¼Œæœ€å¸¸è§çš„è§£å†³åŠæ³•å°±æ˜¯é€‰æ‹©æ•´ä¸ªç¯ä¸­ä¸€ä¸ªäº‹åŠ¡è¿›è¡Œå›æ»šï¼Œä»¥æ‰“ç ´æ•´ä¸ªç­‰å¾…å›¾ä¸­çš„ç¯ï¼Œæ­¤æ—¶éœ€è¦è€ƒè™‘å¦‚ä½•é€‰æ‹©å›æ»šä»¥é¿å…é¥¥é¥¿å¹¶æœ€å°åŒ–ä»£ä»·ã€‚</p>
<h4 id="22-innodb-ä¸­çš„-lock">2.2 InnoDB ä¸­çš„ Lock<a hidden class="anchor" aria-hidden="true" href="#22-innodb-ä¸­çš„-lock">#</a></h4>
<p>â€ƒâ€ƒ ç›®å‰ InnoDB å±‚ä¸»è¦æœ‰ LOCK_TABLE å’Œ LOCK_REC ä¸¤å¤§ç±»ï¼Œåè€…æä¾›æ›´ç»†ç²’åº¦çš„é”æ“ä½œã€‚è¡Œé”ä»¥ scope åˆ’åˆ†ç»†èŠ‚ç±»å‹ï¼Œæœ‰ <em>LOCK_ORDINARY</em>ï¼ˆnext-keyï¼Œè®°å½•åŠå…¶å‰é—´éš™çš„ç»„åˆé”ï¼‰ï¼Œ<em>LOCK_GAP</em>ï¼ˆè®°å½•å€¼çš„å‰é—´éš™é”ï¼‰ï¼Œ<em>LOCK_REC_NOT_GAP</em>ï¼ˆå•è®°å½•é”ï¼‰ï¼Œ<em>LOCK_INSERT_INTENTION</em>ï¼ˆä¸ºæ’å…¥è¡Œä¸ºçš„gapé”ï¼‰ç­‰ã€‚å…¶æ¬¡ï¼Œè¡Œé”çš„é”å®šæ¨¡å¼ä¸º <em>LOCK_IS</em>ã€<em>LOCK_IX</em>ã€<em>LOCK_S</em>ã€<em>LOCK_X</em>ã€<em>LOCK_AUTO_INC</em> ç­‰ã€‚</p>
<p>â€ƒâ€ƒ InnoDB çš„æ‰€æœ‰äº‹åŠ¡é”å¯¹è±¡æŒ‚åœ¨å…¨å±€å¯¹è±¡ lock_sys_t ä¸Šï¼ŒåŒæ—¶æ¯ä¸ªäº‹åŠ¡å¯¹è±¡trx_t ä¸Šä¹Ÿç»´æŒäº†å…¶æ‹¥æœ‰çš„äº‹åŠ¡é”ï¼Œæ¯ä¸ªè¡¨å¯¹è±¡ dict_table_t ä¸Šç»´æŒäº†å…¶ä¸Šçš„è¡¨çº§é”ã€‚8.0.21 ç‰ˆæœ¬è¿˜å¯¹ record hash åš mutex åˆ†ç‰‡æ‹†å‡å°‘ç“¶é¢ˆã€‚åœ¨ä¸€ä¸ªç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªè¡¨å’Œæ¯ä¸€è¡Œéƒ½å¯ä»¥è¢«è§†ä½œä¸€ç§èµ„æºï¼Œå¹¶ä¸”äº‹åŠ¡åœ¨è¯·æ±‚èµ„æºè®¿é—®æƒé™æ—¶ä¼šæŒ‡å®šä¸€ä¸ªæ¨¡å¼ï¼ˆmodeï¼‰ï¼Œä»¥è¡¨æ˜å®ƒæ‰“ç®—å¦‚ä½•ä½¿ç”¨è¯¥èµ„æºã€‚ä¾‹å¦‚ï¼ŒLOCK_X æ¨¡å¼æ„å‘³ç€äº‹åŠ¡éœ€è¦æ’ä»–æ€§è®¿é—®ï¼Œè€Œ LOCK_S æ¨¡å¼æ„å‘³ç€äº‹åŠ¡å¯ä»¥ä¸å…¶ä»–ä½¿ç”¨ LOCK_S æ¨¡å¼çš„äº‹åŠ¡å…±äº«èµ„æºï¼Œé”å¯ä»¥æ˜¯ç­‰å¾…çŠ¶æ€ï¼ˆWAITINGï¼‰æˆ–å·²æˆäºˆçŠ¶æ€ï¼ˆGRANTEDï¼‰ã€‚é”ç³»ç»Ÿä½¿ç”¨é¡µé¢ç¼–å·ï¼ˆpage_noï¼Œå³åŒ…å«è®°å½•çš„é¡µé¢çš„æ ‡è¯†ç¬¦ï¼‰å’Œåœ¨é¡µé¢å†…éƒ¨åˆ†é…è®°å½•æ•°ç»„ä¸­çš„ä½ç½®ï¼ˆheap_noï¼‰æ¥æ ‡è¯†è¡Œè®°å½•ã€‚è¿™åœ¨ b-tree åˆå¹¶ã€åˆ†è£‚æˆ–å¯å˜é•¿åº¦è®°å½•çš„é‡æ–°åˆ†é…æ—¶å˜å¾—å¾ˆé‡è¦ï¼Œè¿™äº›æ“ä½œéƒ½éœ€è¦é€šçŸ¥é”ç³»ç»Ÿä»¥åæ˜ å˜åŒ–ã€‚</p>
<p>â€ƒâ€ƒ é”ç³»ç»Ÿä¸­çš„é”åŒ…å«äº†å…ƒç´ ï¼š<br>
1ï¼‰è¯·æ±‚é”çš„äº‹åŠ¡ï¼ˆrequesting transactionï¼‰ï¼›<br>
2ï¼‰èµ„æºç›®æ ‡æ ‡è¯†ï¼ˆç‰¹å®šçš„è¡Œæˆ–è¡¨å®šä½ï¼‰ï¼›<br>
3ï¼‰é”ç±»å‹ä¸æ¨¡å¼ï¼ˆå¦‚ LOCK_Xã€LOCK_S ç­‰ï¼‰ï¼›<br>
4ï¼‰é”çŠ¶æ€ï¼ˆWAITING æˆ– GRANTEDï¼‰ã€‚</p>
<p>â€ƒâ€ƒ é”çš„ç”Ÿå‘½å‘¨æœŸé€šå¸¸å¦‚ä¸‹ï¼š<br>
1ï¼‰äº‹åŠ¡è¯·æ±‚é”ï¼Œå¦‚æœæ²¡æœ‰ä¸ç°æœ‰é”å†²çªåˆ™ç«‹å³æˆäºˆï¼ˆGRANTEDï¼‰ï¼Œå¦åˆ™è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼ˆWAITINGï¼‰ï¼›<br>
2ï¼‰è‹¥é”å¤„äº WAITING çŠ¶æ€ï¼Œåˆ™çº¿ç¨‹ï¼ˆä¸»åŠ¨ï¼‰ä¼‘çœ ï¼›<br>
3ï¼‰WAITING é”è¦ä¹ˆåœ¨æ²¡æœ‰å†²çªçš„æƒ…å†µä¸‹å˜ä¸º GRANTEDï¼Œè¦ä¹ˆåœ¨å›æ»šçš„æƒ…å†µä¸‹è¢«å–æ¶ˆï¼ŒåŒæ—¶å”¤é†’åŸå…ˆç­‰å¾…çš„äº‹åŠ¡çº¿ç¨‹ï¼›<br>
4ï¼‰äº‹åŠ¡ç»“æŸï¼ˆæäº¤æˆ–å›æ»šï¼‰æ—¶é‡Šæ”¾å…¶æ‰€æœ‰é”ã€‚</p>
<p>â€ƒâ€ƒ è¡Œé”å†²çªå…³ç³»é€šè¿‡å‡½æ•° <code>rec_lock_check_conflict</code> ç¡®å®šã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="n">Conflict</span> <span class="nf">rec_lock_check_conflict</span><span class="p">(</span><span class="k">const</span> <span class="n">trx_t</span> <span class="o">*</span><span class="n">trx</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">ulint</span> <span class="n">type_mode</span><span class="p">,</span> <span class="k">const</span> <span class="n">lock_t</span> <span class="o">*</span><span class="n">lock2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="kt">bool</span> <span class="n">lock_is_on_supremum</span><span class="p">,</span> <span class="n">Trx_locks_cache</span> <span class="o">&amp;</span><span class="n">trx_locks_cache</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/* é”æ¨¡å¼çš„å…¼å®¹çŸ©é˜µ
</span></span></span><span class="line"><span class="cl"><span class="cm">        IS   IX   S   X   AI
</span></span></span><span class="line"><span class="cl"><span class="cm">    IS  +    +    +   -   +
</span></span></span><span class="line"><span class="cl"><span class="cm">    IX  +    +    -   -   +
</span></span></span><span class="line"><span class="cl"><span class="cm">    S   +    -    +   -   -
</span></span></span><span class="line"><span class="cl"><span class="cm">    X   -    -    -   -   -
</span></span></span><span class="line"><span class="cl"><span class="cm">    AI  +    +    -   -   -
</span></span></span><span class="line"><span class="cl"><span class="cm">    Note that for rows, InnoDB only acquires S or X locks.
</span></span></span><span class="line"><span class="cl"><span class="cm">    For tables, InnoDB normally acquires IS or IX locks,
</span></span></span><span class="line"><span class="cl"><span class="cm">    S or X table locks are only acquired for LOCK TABLES.
</span></span></span><span class="line"><span class="cl"><span class="cm">    Auto-increment (AI) locks are needed because of
</span></span></span><span class="line"><span class="cl"><span class="cm">    statement-level MySQL binlog.
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/* é”æ¨¡å¼å…¼å®¹ */</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">trx</span> <span class="o">==</span> <span class="n">lock2</span><span class="o">-&gt;</span><span class="n">trx</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="n">lock_mode_compatible</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">lock_mode</span><span class="o">&gt;</span><span class="p">(</span><span class="n">LOCK_MODE_MASK</span> <span class="o">&amp;</span> <span class="n">type_mode</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                           <span class="n">lock_get_mode</span><span class="p">(</span><span class="n">lock2</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Conflict</span><span class="o">::</span><span class="n">NO_CONFLICT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œæ–°æ¥çš„é”æ˜¯éœ€è¦å’Œå¯¹åº”é”é“¾ä¸Šæ‰€æœ‰ç›¸åŒèµ„æºç›®æ ‡çš„é”åšå…¼å®¹æ¯”è¾ƒï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">     åŒ…æ‹¬åŸå…ˆä¸º waiting çŠ¶æ€çš„é”ï¼Œè¿™æ ·åšé˜²æ­¢äº† X é”é¥¥é¥¿çš„é—®é¢˜ */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">bool</span> <span class="n">is_hp</span> <span class="o">=</span> <span class="n">trx_is_high_priority</span><span class="p">(</span><span class="n">trx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/* é«˜ä¼˜å…ˆçº§æ˜¯äº‹åŠ¡å¯ä»¥å¿½ç•¥åŸå…ˆçš„ waiting çŠ¶æ€çš„ä½ä¼˜å…ˆçº§äº‹åŠ¡*/</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">is_hp</span> <span class="o">&amp;&amp;</span> <span class="n">lock2</span><span class="o">-&gt;</span><span class="n">is_waiting</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">trx_is_high_priority</span><span class="p">(</span><span class="n">lock2</span><span class="o">-&gt;</span><span class="n">trx</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Conflict</span><span class="o">::</span><span class="n">NO_CONFLICT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* è¦åŠ çš„é”æ˜¯ éinsert_intentionçš„ ä¸Šç•Œ æˆ– gap é”ï¼Œå¯ä»¥å…¼å®¹ä»»ä½•é” */</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">((</span><span class="n">lock_is_on_supremum</span> <span class="o">||</span> <span class="p">(</span><span class="n">type_mode</span> <span class="o">&amp;</span> <span class="n">LOCK_GAP</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">      <span class="o">!</span><span class="p">(</span><span class="n">type_mode</span> <span class="o">&amp;</span> <span class="n">LOCK_INSERT_INTENTION</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Conflict</span><span class="o">::</span><span class="n">NO_CONFLICT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* è¦åŠ  éinsert_intentionçš„é”ï¼Œå¯ä»¥å…¼å®¹ gap é” */</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">type_mode</span> <span class="o">&amp;</span> <span class="n">LOCK_INSERT_INTENTION</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">lock_rec_get_gap</span><span class="p">(</span><span class="n">lock2</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Conflict</span><span class="o">::</span><span class="n">NO_CONFLICT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* è¦åŠ çš„é”æ˜¯ gap é”ï¼Œå¯ä»¥å’Œ rec_not_gap å…¼å®¹ */</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">((</span><span class="n">type_mode</span> <span class="o">&amp;</span> <span class="n">LOCK_GAP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">lock_rec_get_rec_not_gap</span><span class="p">(</span><span class="n">lock2</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Conflict</span><span class="o">::</span><span class="n">NO_CONFLICT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* é”é“¾ä¸Šå¾…æ¯”è¾ƒçš„é”æ˜¯ insert_intention çš„ï¼Œå¯ä»¥å…¼å®¹å…¶ä»–é” */</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">lock_rec_get_insert_intention</span><span class="p">(</span><span class="n">lock2</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Conflict</span><span class="o">::</span><span class="n">NO_CONFLICT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* insert_intention é”æœ€å¤§çš„é—®é¢˜æ˜¯åç»­æ’å…¥åä¼šæŠŠ lock åŒºé—´åˆ†è£‚ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">     å¹¶ç”±å•ä¸ª lock äº§ç”Ÿä¸¤ä¸ª lockï¼Œè¿™æ ·å°±æœ‰å¯èƒ½å¯¼è‡´äº‹åŠ¡ waiting çŠ¶æ€çš„
</span></span></span><span class="line"><span class="cl"><span class="cm">     gap æˆ– next-key lock å˜æˆä¸¤ä¸ª waiting çŠ¶æ€çš„ lockï¼Œè¿èƒŒäº‹åŠ¡æœ€
</span></span></span><span class="line"><span class="cl"><span class="cm">     å¤šä¸€ä¸ª waiting lock çš„åŸåˆ™ */</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">type_mode</span> <span class="o">&amp;</span> <span class="n">LOCK_INSERT_INTENTION</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">lock2</span><span class="o">-&gt;</span><span class="n">is_waiting</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">      <span class="n">lock2</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">()</span> <span class="o">==</span> <span class="n">LOCK_X</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">type_mode</span> <span class="o">&amp;</span> <span class="n">LOCK_MODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">LOCK_X</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* å¦‚æœ waiting çŠ¶æ€çš„é”æ˜¯è¢«å½“å‰ trx è‡ªå·±å·²ç» granted çš„é”ç»™é˜»å¡ï¼Œåˆ™ä¸éœ€è¦ç­‰è¿™ä¸ª waiting çŠ¶æ€çš„é” */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">trx_locks_cache</span><span class="p">.</span><span class="n">has_granted_blocker</span><span class="p">(</span><span class="n">trx</span><span class="p">,</span> <span class="n">lock2</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">Conflict</span><span class="o">::</span><span class="n">CAN_BYPASS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">Conflict</span><span class="o">::</span><span class="n">HAS_TO_WAIT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><!-- <div align=center>
<div class="mermaid">
  


</div>

</div> -->
<h4 id="22-åŠ é”é€»è¾‘æ¡ˆä¾‹">2.2 åŠ é”é€»è¾‘ï¼ˆæ¡ˆä¾‹ï¼‰<a hidden class="anchor" aria-hidden="true" href="#22-åŠ é”é€»è¾‘æ¡ˆä¾‹">#</a></h4>
<p>â€ƒâ€ƒ ä»¥ sysbench è¡¨ç»“æ„ä¸ºä¾‹ï¼Œä»‹ç»å†™å…¥æ—¶çš„åŠ é”é€»è¾‘ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">sbtest1</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">k</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="k">c</span><span class="o">`</span><span class="w"> </span><span class="nb">char</span><span class="p">(</span><span class="mi">120</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="k">pad</span><span class="o">`</span><span class="w"> </span><span class="nb">char</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">KEY</span><span class="w"> </span><span class="o">`</span><span class="n">k_1</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">k</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>â€ƒâ€ƒ è¿™é‡Œå…ˆé¢å¤–è¯´æ˜ä¸€ä¸‹ innodb åœ¨åŠ è¡Œé”æ—¶ä¸€å®š <strong>cursor å·²ç»å®šä½äº†</strong>ï¼ˆä¸ºäº†ç¡®å®šèµ„æºç›®æ ‡æ ‡è¯†ï¼Œå³ page_id å’Œ heap_noï¼‰ï¼Œå¹¶ä¸”è·å¾—äº† page é¡µé¢é”ä»¥é˜²æ­¢ä¿®æ”¹ã€‚</p>
<p>â€ƒâ€ƒ é¦–å…ˆè®¨è®º insert åœºæ™¯ï¼Œinsert æµç¨‹å…ˆä¸»é”®ï¼ˆrow_ins_clust_index_entryï¼‰å†äºŒçº§ç´¢å¼•ï¼ˆrow_ins_sec_index_entryï¼‰ï¼Œåœ¨æ¯ä¸ªç´¢å¼•ä¸Šæ‰§è¡Œçš„æ“ä½œæ­¥éª¤ç±»ä¼¼ï¼š</p>
<ol>
<li>å®šä½ cursor è‡³ç›®æ ‡ä½ç½®ï¼ˆè¿™é‡Œè¿˜å¯ä»¥è·å¾—å®šä½åŒ¹é…æƒ…å†µï¼‰ï¼›</li>
<li>aï¼‰å¦‚æœæ˜¯å”¯ä¸€ç´¢å¼•ï¼ˆåŒ…æ‹¬ä¸»é”®ï¼‰ï¼Œå¹¶ä¸”å®šä½æ—¶å‘ç°å’Œç›®æ ‡ç´¢å¼•ä¸Šå­˜åœ¨ record å’Œå°†è¦æ’å…¥çš„è®°å½•ç‰©ç† matchï¼Œåˆ™è¦èµ°åˆ° record åˆ¤é‡é€»è¾‘ä¸­ï¼ˆrow_ins_duplicate_error_in_clust / row_ins_scan_sec_index_for_duplicateï¼‰ï¼Œå…¶ä¸­ä¼šå…ˆå¯¹åº”å»åŠ ç›®æ ‡è¡Œçš„è¡Œé”ï¼ˆ<strong>lock_clust_rec_read_check_and_lock</strong> / <strong>lock_sec_rec_read_check_and_lock</strong> ä¸¤ä¸ªå‡½æ•°çš„æ‰§è¡Œé€»è¾‘åŸºæœ¬ä¸€è‡´ï¼‰ï¼Œè¿™é‡Œå¯èƒ½äº§ç”Ÿé”ç­‰å¾…ï¼Œå†åˆ¤æ–­é‡å¤æ€§æ˜¯å¦æ»¡è¶³è¦æ±‚ï¼›</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">dberr_t</span> <span class="nf">lock_clust_rec_read_check_and_lock</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">lock_duration_t</span> <span class="n">duration</span><span class="p">,</span> <span class="k">const</span> <span class="n">buf_block_t</span> <span class="o">*</span><span class="n">block</span><span class="p">,</span> <span class="k">const</span> <span class="n">rec_t</span> <span class="o">*</span><span class="n">rec</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">dict_index_t</span> <span class="o">*</span><span class="n">index</span><span class="p">,</span> <span class="k">const</span> <span class="n">ulint</span> <span class="o">*</span><span class="n">offsets</span><span class="p">,</span> <span class="k">const</span> <span class="n">select_mode</span> <span class="n">sel_mode</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">lock_mode</span> <span class="n">mode</span><span class="p">,</span> <span class="k">const</span> <span class="n">ulint</span> <span class="n">gap_mode</span><span class="p">,</span> <span class="n">que_thr_t</span> <span class="o">*</span><span class="n">thr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">srv_read_only_mode</span> <span class="o">||</span> <span class="n">index</span><span class="o">-&gt;</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">is_temporary</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">DB_SUCCESS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">dberr_t</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">ulint</span> <span class="n">heap_no</span> <span class="o">=</span> <span class="n">page_rec_get_heap_no</span><span class="p">(</span><span class="n">rec</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// éšå¼é”åˆ¤æ–­ï¼šé€šè¿‡ &#34;ä¸»é”®recordä¸Šé¢çš„ç³»ç»Ÿåˆ—&#34; å’Œ &#34;æ´»è·ƒäº‹åŠ¡æ•°ç»„&#34; åˆ¤æ–­å¯¹åº”è®°å½•æ˜¯å¦å­˜åœ¨éšå¼é”ï¼Œå¦‚æœ‰åˆ™ä¸ºå…¶åŠ ä¸Šæ˜¾ç¤ºé”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//           åˆ¤æ–­äºŒçº§ç´¢å¼•æ— æ³•è¿‡æ»¤æ—¶ï¼Œéœ€è¦å›è¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">heap_no</span> <span class="o">!=</span> <span class="n">PAGE_HEAP_NO_SUPREMUM</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">lock_rec_convert_impl_to_expl</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">rec</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">offsets</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">locksys</span><span class="o">::</span><span class="n">Shard_latch_guard</span> <span class="n">guard</span><span class="p">{</span><span class="n">UT_LOCATION_HERE</span><span class="p">,</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">get_page_id</span><span class="p">()};</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">duration</span> <span class="o">==</span> <span class="n">lock_duration_t</span><span class="o">::</span><span class="n">AT_LEAST_STATEMENT</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">lock_protect_locks_till_statement_end</span><span class="p">(</span><span class="n">thr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åŠ è¡Œé”ï¼Œä¸å¯ä¸ºéšå¼é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">err</span> <span class="o">=</span> <span class="n">lock_rec_lock</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="n">sel_mode</span><span class="p">,</span> <span class="n">mode</span> <span class="o">|</span> <span class="n">gap_mode</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">heap_no</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">thr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">(</span><span class="n">err</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>bï¼‰å¦‚æœæ˜¯éå”¯ä¸€ç´¢å¼•ï¼Œæˆ–è€…æœªå‘ç°å·²å­˜åœ¨åŒ¹é… recordï¼Œåˆ™åœ¨ insert é˜¶æ®µå¯ä»¥è·³è¿‡é‡å¤æ€§æ£€æŸ¥ï¼ˆè¿›è€Œè¿™é‡Œä¹Ÿä¸å†éœ€è¦èµ°åŠ é”é€»è¾‘ï¼‰ï¼›
3. è¿›è¡ŒçœŸæ­£çš„æ’å…¥æ“ä½œï¼ˆbtr_cur_optimistic_update / btr_cur_pessimistic_update è¿™ä¸¤ä¸ªæ¥å£ä¸ºé€šè¿‡ä¿®æ”¹æ’å…¥ï¼› btr_cur_optimistic_insert / btr_cur_pessimistic_insert è¿™ä¸¤ä¸ªæ¥å£ä¸ºç›´æ¥æ’å…¥ï¼‰ï¼Œå…¶ä¸­ä¼šå¯¹åº”è¿›è¡Œè¡Œé”æ“ä½œ ï¼ˆ<strong>lock_clust_rec_modify_check_and_lock</strong> / <strong>lock_sec_rec_modify_check_and_lock</strong> é€šè¿‡ä¿®æ”¹æ’å…¥ï¼› <strong>lock_rec_insert_check_and_lock</strong> ç›´æ¥æ’å…¥ï¼‰ï¼š<br>
<strong>ä¿®æ”¹æ’å…¥ï¼ˆupdateï¼‰ï¼š</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">dberr_t</span> <span class="nf">lock_clust_rec_modify_check_and_lock</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">ulint</span> <span class="n">flags</span><span class="p">,</span>              <span class="cm">/*!&lt; in: if BTR_NO_LOCKING_FLAG
</span></span></span><span class="line"><span class="cl"><span class="cm">                              bit is set, does nothing */</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">buf_block_t</span> <span class="o">*</span><span class="n">block</span><span class="p">,</span> <span class="cm">/*!&lt; in: buffer block of rec */</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">rec_t</span> <span class="o">*</span><span class="n">rec</span><span class="p">,</span>         <span class="cm">/*!&lt; in: record which should be
</span></span></span><span class="line"><span class="cl"><span class="cm">                              modified */</span>
</span></span><span class="line"><span class="cl">    <span class="n">dict_index_t</span> <span class="o">*</span><span class="n">index</span><span class="p">,</span>      <span class="cm">/*!&lt; in: clustered index */</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">ulint</span> <span class="o">*</span><span class="n">offsets</span><span class="p">,</span>     <span class="cm">/*!&lt; in: rec_get_offsets(rec, index)</span> <span class="err">*/</span>
</span></span><span class="line"><span class="cl">    <span class="n">que_thr_t</span> <span class="o">*</span><span class="n">thr</span><span class="p">)</span>           <span class="cm">/*!&lt; in: query thread */</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BTR_NO_LOCKING_FLAG</span><span class="p">)</span>  <span class="k">return</span> <span class="p">(</span><span class="n">DB_SUCCESS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">dberr_t</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">ulint</span> <span class="n">heap_no</span> <span class="o">=</span> <span class="n">rec_offs_comp</span><span class="p">(</span><span class="n">offsets</span><span class="p">)</span> <span class="o">?</span> <span class="n">rec_get_heap_no_new</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                         <span class="o">:</span> <span class="n">rec_get_heap_no_old</span><span class="p">(</span><span class="n">rec</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// éšå¼é”åˆ¤æ–­ï¼šé€šè¿‡ &#34;ä¸»é”®recordä¸Šé¢çš„ç³»ç»Ÿåˆ—&#34; å’Œ &#34;æ´»è·ƒäº‹åŠ¡æ•°ç»„&#34; åˆ¤æ–­å¯¹åº”è®°å½•æ˜¯å¦å­˜åœ¨éšå¼é”ï¼Œå¦‚æœ‰åˆ™ä¸ºå…¶åŠ ä¸Šæ˜¾ç¤ºé”ï¼›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//           åˆ¤æ–­äºŒçº§ç´¢å¼•æ— æ³•è¿‡æ»¤æ—¶ï¼Œéœ€è¦å›è¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">lock_rec_convert_impl_to_expl</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">rec</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">offsets</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">locksys</span><span class="o">::</span><span class="n">Shard_latch_guard</span> <span class="n">guard</span><span class="p">{</span><span class="n">UT_LOCATION_HERE</span><span class="p">,</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">get_page_id</span><span class="p">()};</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åŠ è¡Œé”ï¼Œå¯ä¸ºéšå¼é”ï¼Œå³æ— å†²çªæ—¶ä¸çœŸæ­£åŠ è¡Œé”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">err</span> <span class="o">=</span> <span class="n">lock_rec_lock</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="n">SELECT_ORDINARY</span><span class="p">,</span> <span class="n">LOCK_X</span> <span class="o">|</span> <span class="n">LOCK_REC_NOT_GAP</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">heap_no</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">thr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">DB_SUCCESS_LOCKED_REC</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">err</span> <span class="o">=</span> <span class="n">DB_SUCCESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">(</span><span class="n">err</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>ç›´æ¥æ’å…¥ï¼ˆinsertï¼‰ï¼š</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">dberr_t</span> <span class="nf">lock_rec_insert_check_and_lock</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">ulint</span> <span class="n">flags</span><span class="p">,</span>         <span class="cm">/*!&lt; in: if BTR_NO_LOCKING_FLAG bit is
</span></span></span><span class="line"><span class="cl"><span class="cm">                         set, does nothing */</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">rec_t</span> <span class="o">*</span><span class="n">rec</span><span class="p">,</span>    <span class="cm">/*!&lt; in: record after which to insert */</span>
</span></span><span class="line"><span class="cl">    <span class="n">buf_block_t</span> <span class="o">*</span><span class="n">block</span><span class="p">,</span>  <span class="cm">/*!&lt; in/out: buffer block of rec */</span>
</span></span><span class="line"><span class="cl">    <span class="n">dict_index_t</span> <span class="o">*</span><span class="n">index</span><span class="p">,</span> <span class="cm">/*!&lt; in: index */</span>
</span></span><span class="line"><span class="cl">    <span class="n">que_thr_t</span> <span class="o">*</span><span class="n">thr</span><span class="p">,</span>      <span class="cm">/*!&lt; in: query thread */</span>
</span></span><span class="line"><span class="cl">    <span class="n">mtr_t</span> <span class="o">*</span><span class="n">mtr</span><span class="p">,</span>          <span class="cm">/*!&lt; in/out: mini-transaction */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="o">*</span><span class="n">inherit</span><span class="p">)</span>       <span class="cm">/*!&lt; out: set to true if the new
</span></span></span><span class="line"><span class="cl"><span class="cm">                          inserted record maybe should inherit
</span></span></span><span class="line"><span class="cl"><span class="cm">                          LOCK_GAP locks from successor record */</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">BTR_NO_LOCKING_FLAG</span><span class="p">)</span> <span class="k">return</span> <span class="p">(</span><span class="n">DB_SUCCESS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">dberr_t</span> <span class="n">err</span> <span class="o">=</span> <span class="n">DB_SUCCESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">lock_t</span> <span class="o">*</span><span class="n">lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">auto</span> <span class="n">inherit_in</span> <span class="o">=</span> <span class="o">*</span><span class="n">inherit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">trx_t</span> <span class="o">*</span><span class="n">trx</span> <span class="o">=</span> <span class="n">thr_get_trx</span><span class="p">(</span><span class="n">thr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="n">rec_t</span> <span class="o">*</span><span class="n">next_rec</span> <span class="o">=</span> <span class="n">page_rec_get_next_const</span><span class="p">(</span><span class="n">rec</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">ulint</span> <span class="n">heap_no</span> <span class="o">=</span> <span class="n">page_rec_get_heap_no</span><span class="p">(</span><span class="n">next_rec</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">locksys</span><span class="o">::</span><span class="n">Shard_latch_guard</span> <span class="n">guard</span><span class="p">{</span><span class="n">UT_LOCATION_HERE</span><span class="p">,</span> <span class="n">block</span><span class="o">-&gt;</span><span class="n">get_page_id</span><span class="p">()};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">lock_rec_get_first</span><span class="p">(</span><span class="n">lock_sys</span><span class="o">-&gt;</span><span class="n">rec_hash</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">heap_no</span><span class="p">)</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// é”é“¾ä¸Šæ— é”ï¼Œç›´æ¥åŠ éšå¼é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="o">*</span><span class="n">inherit</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="o">*</span><span class="n">inherit</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="n">ulint</span> <span class="n">type_mode</span> <span class="o">=</span> <span class="n">LOCK_X</span> <span class="o">|</span> <span class="n">LOCK_GAP</span> <span class="o">|</span> <span class="n">LOCK_INSERT_INTENTION</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// åˆ¤æ–­é”é“¾ä¸Šæ˜¯å¦å­˜åœ¨å†²çªæ¨¡å¼çš„é”ï¼šå¦‚æœå­˜åœ¨å…¶ä»–åç»§è®°å½•çš„é™¤ insert ç›®çš„å¤–çš„ gap é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">const</span> <span class="k">auto</span> <span class="n">conflicting</span> <span class="o">=</span> <span class="n">lock_rec_other_has_conflicting</span><span class="p">(</span><span class="n">type_mode</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">heap_no</span><span class="p">,</span> <span class="n">trx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">conflicting</span><span class="p">.</span><span class="n">wait_for</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">RecLock</span> <span class="n">rec_lock</span><span class="p">(</span><span class="n">thr</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">heap_no</span><span class="p">,</span> <span class="n">type_mode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">trx_mutex_enter</span><span class="p">(</span><span class="n">trx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å­˜åœ¨å†²çªï¼ŒåŠ è¡Œé”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">err</span> <span class="o">=</span> <span class="n">rec_lock</span><span class="p">.</span><span class="n">add_to_waitq</span><span class="p">(</span><span class="n">conflicting</span><span class="p">.</span><span class="n">wait_for</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">trx_mutex_exit</span><span class="p">(</span><span class="n">trx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">switch</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">DB_SUCCESS_LOCKED_REC</span><span class="p">:</span> <span class="n">err</span> <span class="o">=</span> <span class="n">DB_SUCCESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">DB_SUCCESS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inherit_in</span> <span class="o">||</span> <span class="n">index</span><span class="o">-&gt;</span><span class="n">is_clustered</span><span class="p">())</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="cm">/* äºŒçº§ç´¢å¼•æ›´æ–° page ä¸Šçš„ max trx id æ ‡å¿— */</span>
</span></span><span class="line"><span class="cl">      <span class="n">page_update_max_trx_id</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">buf_block_get_page_zip</span><span class="p">(</span><span class="n">block</span><span class="p">),</span> <span class="n">trx</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">mtr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">(</span><span class="n">err</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ›´å¤šéšå¼é”ç›¸å…³å†…å®¹å¯ä»¥å‚è€ƒè¿™ç¯‡ <a href="http://mysql.taobao.org/monthly/2020/09/06/">mysql æœˆæŠ¥æ–‡ç« </a>ã€‚</p>
<p>â€ƒâ€ƒ update æµç¨‹ä¼šå…ˆé€šè¿‡è¯»æ¥å£æ¥å¯»æ‰¾åŸå…ˆéœ€è¦è¢«æ›´æ–°çš„è¡Œè®°å½•ï¼ˆindex_read-&gt;row_search_mvccï¼‰ï¼Œåœ¨è¯»é˜¶æ®µå°±ä¼šå¯¹ç›®æ ‡è¡Œè¿›è¡ŒåŠ é”ï¼ˆlock_clust_rec_read_check_and_lock / lock_sec_rec_read_check_and_lockï¼‰ï¼Œè¿™é‡Œçš„åŠ é”æ¥å£å’Œ insert åˆ¤é‡é˜¶æ®µä¸€è‡´ï¼Œå…·ä½“åŠ é”æ¨¡å¼è¿˜å’Œéš”ç¦»çº§åˆ«æœ‰å…³ã€‚ update ç¬¬äºŒä¸ªé˜¶æ®µä¼šçœŸæ­£å»ä¿®æ”¹æ•°æ®ï¼Œä¹Ÿæœ‰ç›´æ¥ update æ¨¡å¼å’Œ delete_mark + insert æ¨¡å¼ï¼Œåˆ° btr_cur_ å±‚çš„æ¥å£ä¸€è‡´ï¼Œå› æ­¤åŠ é”å‡½æ•°æ¥å£ä¹Ÿä¸€è‡´ã€‚</p>
<h4 id="23-é”çš„é‡Šæ”¾">2.3 é”çš„é‡Šæ”¾<a hidden class="anchor" aria-hidden="true" href="#23-é”çš„é‡Šæ”¾">#</a></h4>
<p>â€ƒâ€ƒ å¤§å¤šæ•°æƒ…å†µä¸‹äº‹åŠ¡æŒæœ‰çš„æ‰€æœ‰é”ï¼ˆtrx_t::lock.trx_locksï¼‰éƒ½æ˜¯åœ¨äº‹åŠ¡æäº¤æ—¶é‡Šæ”¾(trx_release_impl_and_expl_locks-&gt;lock_trx_release_locksï¼Œåœ¨ trx_commit_in_memory é˜¶æ®µçš„å¼€å§‹)ã€‚æœ‰ä¸¤ä¸ªä¾‹å¤–ï¼š<br>
aï¼‰AUTO-INC é”ï¼ˆç”±å‚æ•° innodb_autoinc_lock_mode æ§åˆ¶ï¼‰åœ¨SQLç»“æŸæ—¶ç›´æ¥é‡Šæ”¾ï¼ˆinnobase_commit &ndash;&gt; lock_unlock_table_autoincï¼‰ï¼›<br>
bï¼‰åœ¨ RC éš”ç¦»çº§åˆ«ä¸‹æ‰§è¡Œ DML è¯­å¥æ—¶ï¼Œä»å¼•æ“å±‚è¿”å›åˆ° Server å±‚çš„è®°å½•ï¼Œå¦‚æœä¸æ»¡è¶³ where æ¡ä»¶ï¼Œåˆ™ä¼šç«‹åˆ» unlock æ‰ï¼ˆha_innobase::unlock_rowï¼‰ã€‚</p>
<p>â€ƒâ€ƒ å¯¹äºè¡Œé”ï¼Œä» lock sys hash ä¸­åˆ é™¤åè¿˜éœ€è¦åˆ¤æ–­æ˜¯å¦æœ‰æ­£åœ¨ç­‰å¾…çš„ä¼šè¯å¯ä»¥è¢«å”¤é†’ï¼ˆlock_rec_dequeue_from_pageï¼‰ã€‚è¿™é‡Œé‡‡ç”¨çš„æ˜¯ CATS ç­–ç•¥å°†æ‰€æœ‰å¤„äº LOCK_WAIT çŠ¶æ€çš„é”å¯¹è±¡æŒ‰trxä¼˜å…ˆæƒã€è°ƒåº¦æƒé‡ trx-&gt;lock.schedule_weight æ’åºï¼Œç„¶åä¾æ¬¡å¤„ç†ã€‚å¯¹äºæ¯ä¸ªç­‰å¾…çŠ¶æ€çš„é”å¯¹è±¡ï¼Œå¦‚æœå…¶ä¸å†ç­‰å¾…ä»»ä½•å·²æœ‰ granted çš„é”å¯¹è±¡ï¼ˆåŒ…æ‹¬è¿™æ¬¡å¾ªç¯å‰é¢ grant çš„ï¼‰ï¼Œåˆ™æ¸…ç†ç­‰å¾…äº‹åŠ¡çš„ç›¸å…³é”ç­‰å¾…çŠ¶æ€å¹¶å”¤é†’çº¿ç¨‹å·²ç»æŒ‚èµ·çš„ç­‰å¾…äº‹åŠ¡ï¼›åä¹‹ï¼Œåˆ™æ›´æ–°ç­‰å¾…å…³ç³»ã€ç»§ç»­ç­‰å¾…ã€‚</p>
<h4 id="24-æ­»é”æ£€æµ‹åŠcatsç­–ç•¥">2.4 æ­»é”æ£€æµ‹åŠCATSç­–ç•¥<a hidden class="anchor" aria-hidden="true" href="#24-æ­»é”æ£€æµ‹åŠcatsç­–ç•¥">#</a></h4>
<p>â€ƒâ€ƒ å®˜æ–¹åœ¨ Bug#29882690: UNDETECTED DEADLOCK WITH GAP AND INSERT INTENTION LOCKS IS POSSIBLE ä¸­ä¿®å¤éƒ¨åˆ†åŸå…ˆæ— æ³•æ¢æµ‹çš„æ­»é”ï¼Œè¿˜å°†é”é˜»å¡ä¿¡æ¯ï¼ˆwait-forå›¾ï¼‰ä» lock è½¬ç§»åˆ° trx ä¸­ï¼Œå¹¶ä¸”å°†æ­»é”æ£€æµ‹ä»å‰å°äº‹åŠ¡çº¿ç¨‹è½¬ç§»åˆ°åå°ç›‘æ§çº¿ç¨‹ã€‚è¿™æ ·å‡è½»äº†å‰å°äº‹åŠ¡çº¿ç¨‹çš„å–é”å†²çªæ—¶çš„æ£€æµ‹ä»£ä»·ï¼›ä½†æ˜¯æ­»é”ä¼šå…ˆè¿›å…¥äº‹åŠ¡ç³»ç»Ÿï¼Œåç»­æ£€æµ‹å‡ºåå›æ»šï¼Œä¹Ÿå°±æ„å‘³ç€æ­»é”äº‹åŠ¡ä¼šå ç”¨ä¸€æ®µæ—¶é—´çš„çº¿ç¨‹ã€å†…å­˜èµ„æºã€å¯¼è‡´é”é“¾ã€äº‹åŠ¡æ•°ç»„ç­‰çš„è†¨èƒ€åï¼ˆå¯¹åº”çº¿ç¨‹å…ˆè¿›å…¥ã€ç„¶å suspend è¿›å…¥ç¡çœ ç­‰å¾…åï¼‰æ‰ä¼šè¢«å›æ»šï¼Œè‹¥æ˜¯æ­»é”æ¦‚ç‡è¾ƒé«˜çš„é«˜å†²çªåœºæ™¯è¿™å¯èƒ½ä¼šå¯¼è‡´æ•´ä½“äº‹åŠ¡ç³»ç»Ÿçš„æ€§èƒ½ä¸‹é™ã€‚æ­»é”å¤„ç†çš„é€»è¾‘åœ¨ lock_wait_timeout_thread çº¿ç¨‹ä¸­ï¼ˆlock_wait_update_schedule_and_check_for_deadlocksï¼‰ï¼Œé¡¾åæ€ä¹‰è¿™ä¸ªå‡½æ•°æ›´æ–°äº†äº‹åŠ¡æƒé‡æ¯”æ£€æŸ¥äº†æ˜¯å¦å­˜åœ¨æ­»é”ã€‚æ–°ç‰ˆæ­»é”æ£€æµ‹é€»è¾‘çš„ç†è®ºåŸºç¡€å¯ä»¥å‚è€ƒè¿™ç¯‡ <a href="http://mysql.taobao.org/monthly/2021/05/02/">mysql æœˆæŠ¥æ–‡ç« </a>ï¼Œä¸‹é¢ä¸»è¦ä»‹ç»ä»£ç é€»è¾‘ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cm">/** Takes a snapshot of transactions in waiting currently in slots, updates
</span></span></span><span class="line"><span class="cl"><span class="cm">their schedule weights, searches for deadlocks among them and resolves them. */</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">lock_wait_update_schedule_and_check_for_deadlocks</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">ut</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">waiting_trx_info_t</span><span class="o">&gt;</span> <span class="n">infos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">ut</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">outgoing</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">ut</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">trx_schedule_weight_t</span><span class="o">&gt;</span> <span class="n">new_weights</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">    ï¼ˆä»¥ä¸‹æŒæœ‰ lock_sys-&gt;wait_mutexï¼‰
</span></span></span><span class="line"><span class="cl"><span class="cm">    å°† lock_sys ä¸­æ‰€æœ‰ waiting çŠ¶æ€çš„ trx åŠé˜»å¡å®ƒçš„ blocking_trx åŠ å…¥åˆ° infosï¼Œæ„å»º wait trx çš„ snapshotï¼›
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span>
</span></span><span class="line"><span class="cl">  <span class="k">auto</span> <span class="n">table_reservations</span> <span class="o">=</span> <span class="n">lock_wait_snapshot_waiting_threads</span><span class="p">(</span><span class="n">infos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">    æ„å»º waiting for graphï¼Œå®è´¨ä¸Šå°±æ˜¯å¯»æ‰¾æŸä¸ª trx çš„ blocking_trx æ˜¯å¦å­˜åœ¨åœ¨ info ä¸­ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">    blocking_trx ä¹Ÿå­˜åœ¨çš„è¯é€šè¿‡ outgoing æ•°ç»„å…³è”ä½ç½®èµ·æ¥ï¼Œè¿™æ ·å°±å°†æ‰€æœ‰ä¾èµ–çš„ trx ä¸²è”èµ·æ¥ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">    (å³å°†è¿™ä¸ª trx åœ¨ info ä¸­çš„ index ä½ç½®ä½œä¸º outgoing indexï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">     å°† blocking_trx åœ¨ info ä¸­çš„ index ä½ç½®ä½œä¸º outgoing ä¸­è¿™ä¸ª index å¯¹åº”ä½ç½®çš„å…ƒç´ ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span>
</span></span><span class="line"><span class="cl">  <span class="n">lock_wait_build_wait_for_graph</span><span class="p">(</span><span class="n">infos</span><span class="p">,</span> <span class="n">outgoing</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">    åˆå§‹åŒ–äº‹åŠ¡æƒé‡å€¼ï¼Œæ­£å¸¸ç­‰å¾…äº‹åŠ¡åˆå§‹ä¸º1ï¼Œè¶…æ—¶äº‹åŠ¡ä¼šåˆå§‹ä¸ºè¾ƒå¤§å€¼ï¼›
</span></span></span><span class="line"><span class="cl"><span class="cm">    é€šè¿‡å…³è”æ ‘å›¾ç®—å‡º new_weightsï¼ˆä¾èµ–å­æ ‘å…ƒç´ æ•°ç›®ï¼‰ï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm">      å°†æ‰€æœ‰æ— å…¥åº¦çš„èŠ‚ç‚¹å…¥æ ˆï¼Œå†éå†æ ˆå…ƒç´ æ ¹æ®å…¶å‡ºåº¦ç¡®å®šçˆ¶èŠ‚ç‚¹å¹¶å°†è¿™ä¸ªå­èŠ‚ç‚¹çš„æƒé‡å¢åŠ åˆ°çˆ¶èŠ‚ç‚¹ä¸Šï¼Œå¹¶å‡å°‘å…¶çˆ¶èŠ‚ç‚¹å…¥åº¦è®¡æ•°ï¼›
</span></span></span><span class="line"><span class="cl"><span class="cm">      å¦‚æœå¯¹åº”çˆ¶èŠ‚ç‚¹è¿˜å­˜åœ¨æœ‰å‡ºåº¦ï¼Œå½“å…¶æ‰€æœ‰å…¥åº¦å¤„ç†å®Œæˆåï¼ˆå…¥åº¦è®¡æ•°ä¸º0ï¼Œå…¶æ‰€æœ‰å…¥åº¦å·²ç»è½¬åŒ–ä¸ºæƒé‡å€¼ï¼‰ï¼Œä½œä¸ºæ— å…¥åº¦èŠ‚ç‚¹å…¥æ ˆåŒä¸Šå¤„ç†ï¼›
</span></span></span><span class="line"><span class="cl"><span class="cm">      ç›´åˆ°æ ˆä¸­æ— ä»»ä½•å…ƒç´ ï¼ˆä¸å­˜åœ¨è¿˜æœ‰å‡ºåº¦çš„å…ƒç´ ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="cm">      NOTEï¼šå¦‚æœæœ‰ç¯å­˜åœ¨ï¼Œå…¶ä¸Šä¸€å®šä¸å­˜åœ¨æ— å…¥åº¦çš„èŠ‚ç‚¹ï¼Œå› æ­¤ä¸ä¼šåœ¨ä¸Šè¿°æ­¥éª¤å¤„ç†ï¼Œå› æ­¤å…¥åº¦è®¡æ•°ä¸ä¸º0
</span></span></span><span class="line"><span class="cl"><span class="cm">    å°†é™¤æ­»é”ç¯å¤–çš„æ‰€æœ‰ç­‰å¾…çŠ¶æ€çš„äº‹åŠ¡æƒé‡æ›´æ–°ï¼ˆæŒæœ‰ lock_sys-&gt;wait_mutexï¼‰
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span>
</span></span><span class="line"><span class="cl">  <span class="n">lock_wait_compute_and_publish_weights_except_cycles</span><span class="p">(</span><span class="n">infos</span><span class="p">,</span> <span class="n">table_reservations</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                      <span class="n">outgoing</span><span class="p">,</span> <span class="n">new_weights</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">innobase_deadlock_detect</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">      ç”¨ DFS æ–¹å¼ç¡®å®šçš„ä¸€ä¸ªæ­»é”ç¯ï¼Œå¦‚æœå­˜åœ¨çš„è¯å°±é€‰æ‹©ç›®æ ‡å¹¶å›æ»šäº‹åŠ¡ï¼ˆlock_cancel_waiting_and_releaseï¼‰
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="n">lock_wait_find_and_handle_deadlocks</span><span class="p">(</span><span class="n">infos</span><span class="p">,</span> <span class="n">outgoing</span><span class="p">,</span> <span class="n">new_weights</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>â€ƒâ€ƒ CATS ç­–ç•¥åŸºäºåå°ç”Ÿäº§çš„äº‹åŠ¡æƒé‡ï¼Œåœ¨äº‹åŠ¡æ”¾é”é€‰æ‹©æœ€åˆé€‚ç­‰å¾…äº‹åŠ¡å»å”¤é†’ï¼Œæå‡æ•´ä½“äº‹åŠ¡æ•ˆç‡ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">lock_rec_grant_by_heap_no</span><span class="p">(</span><span class="n">lock_t</span> <span class="o">*</span><span class="n">in_lock</span><span class="p">,</span> <span class="n">ulint</span> <span class="n">heap_no</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="k">auto</span> <span class="n">hash_table</span> <span class="o">=</span> <span class="n">in_lock</span><span class="o">-&gt;</span><span class="n">hash_table</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">using</span> <span class="n">LockDescriptorEx</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">trx_schedule_weight_t</span><span class="p">,</span> <span class="n">lock_t</span> <span class="o">*&gt;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">Scoped_heap</span> <span class="n">heap</span><span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="n">lock_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">LockDescriptorEx</span><span class="p">))</span> <span class="o">*</span> <span class="mi">32</span><span class="p">,</span> <span class="n">UT_LOCATION_HERE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">RecID</span> <span class="n">rec_id</span><span class="p">{</span><span class="n">in_lock</span><span class="p">,</span> <span class="n">heap_no</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="n">Locks</span><span class="o">&lt;</span><span class="n">lock_t</span> <span class="o">*&gt;</span> <span class="n">low_priority_light</span><span class="p">{</span><span class="n">heap</span><span class="p">.</span><span class="n">get</span><span class="p">()};</span>
</span></span><span class="line"><span class="cl">  <span class="n">Locks</span><span class="o">&lt;</span><span class="n">lock_t</span> <span class="o">*&gt;</span> <span class="n">waiting</span><span class="p">{</span><span class="n">heap</span><span class="p">.</span><span class="n">get</span><span class="p">()};</span>
</span></span><span class="line"><span class="cl">  <span class="n">Locks</span><span class="o">&lt;</span><span class="n">lock_t</span> <span class="o">*&gt;</span> <span class="n">granted</span><span class="p">{</span><span class="n">heap</span><span class="p">.</span><span class="n">get</span><span class="p">()};</span>
</span></span><span class="line"><span class="cl">  <span class="n">Locks</span><span class="o">&lt;</span><span class="n">LockDescriptorEx</span><span class="o">&gt;</span> <span class="n">low_priority_heavier</span><span class="p">{</span><span class="n">heap</span><span class="p">.</span><span class="n">get</span><span class="p">()};</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="k">auto</span> <span class="n">in_trx</span> <span class="o">=</span> <span class="n">in_lock</span><span class="o">-&gt;</span><span class="n">trx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/*  å¯¹äºé”é“¾ä¸Šæ¯ä¸ª lock åˆ’åˆ†åˆ° grantedã€waitingã€low_priority_lightã€low_priority_heavier ä¸­ï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm">    granted: å·²ç»è·å–åˆ°çš„é”ï¼Œå¦‚æœç­‰å¾…é”è¢«æˆæƒï¼Œä¹Ÿä¼šä» waiting è½¬ç§»åˆ° grantedï¼›
</span></span></span><span class="line"><span class="cl"><span class="cm">    low_priority_lightï¼šä½æƒé‡çš„ waiting çŠ¶æ€é”ï¼›
</span></span></span><span class="line"><span class="cl"><span class="cm">    low_priority_heavierï¼šé«˜æƒé‡çš„ waiting çŠ¶æ€é”ï¼›
</span></span></span><span class="line"><span class="cl"><span class="cm">    waitingï¼šå¤„äº waiting çŠ¶æ€çš„é”ï¼Œæœ€ç»ˆ low_priority_light å’Œ low_priority_heavier ä¼šåˆå¹¶å…¥æ­¤æ•°ç»„ï¼›
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Lock_iter</span><span class="o">::</span><span class="n">for_each</span><span class="p">(</span><span class="n">rec_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">lock_t</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">is_waiting</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">granted</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="k">auto</span> <span class="n">trx</span> <span class="o">=</span> <span class="n">lock</span><span class="o">-&gt;</span><span class="n">trx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">trx</span><span class="o">-&gt;</span><span class="n">error_state</span> <span class="o">==</span> <span class="n">DB_DEADLOCK</span> <span class="o">||</span> <span class="n">trx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">.</span><span class="n">was_chosen_as_deadlock_victim</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="k">auto</span> <span class="n">blocking_trx</span> <span class="o">=</span> <span class="n">trx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">.</span><span class="n">blocking_trx</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_relaxed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">blocking_trx</span> <span class="o">!=</span> <span class="n">in_trx</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="nb">true</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">trx_is_high_priority</span><span class="p">(</span><span class="n">trx</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">waiting</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="cm">/* è¿™ä¸ªç­‰å¾…çš„äº‹åŠ¡è¿˜æœ‰ç­‰å¾…å®ƒçš„äº‹åŠ¡ï¼Œè®¤ä¸ºæ˜¯é«˜æƒé‡ */</span>
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="k">auto</span> <span class="n">schedule_weight</span> <span class="o">=</span> <span class="n">trx</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">.</span><span class="n">schedule_weight</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_relaxed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">schedule_weight</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">low_priority_light</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">low_priority_heavier</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">LockDescriptorEx</span><span class="p">{</span><span class="n">schedule_weight</span><span class="p">,</span> <span class="n">lock</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="n">hash_table</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">waiting</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">low_priority_light</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">low_priority_heavier</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* æŒ‰æƒé‡è¿›è¡Œæ’åºï¼Œé«˜æƒé‡ä¼˜å…ˆ grant */</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">stable_sort</span><span class="p">(</span><span class="n">low_priority_heavier</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">low_priority_heavier</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                   <span class="p">[](</span><span class="k">const</span> <span class="n">LockDescriptorEx</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="n">LockDescriptorEx</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                     <span class="k">return</span> <span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">first</span> <span class="o">&gt;</span> <span class="n">b</span><span class="p">.</span><span class="n">first</span><span class="p">);});</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span> <span class="o">&amp;</span><span class="nl">descriptor</span> <span class="p">:</span> <span class="n">low_priority_heavier</span><span class="p">)</span> <span class="p">{</span><span class="n">waiting</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">descriptor</span><span class="p">.</span><span class="n">second</span><span class="p">);}</span>
</span></span><span class="line"><span class="cl">  <span class="n">waiting</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">waiting</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">low_priority_light</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">low_priority_light</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="k">auto</span> <span class="n">new_granted_index</span> <span class="o">=</span> <span class="n">granted</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">granted</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">granted</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">+</span> <span class="n">waiting</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="n">lock_t</span> <span class="o">*</span><span class="nl">wait_lock</span> <span class="p">:</span> <span class="n">waiting</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* å·²æˆæƒé”æ˜¯å¦ä¼šé˜»å¡å½“å‰é” */</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">lock_t</span> <span class="o">*</span><span class="n">blocking_lock</span> <span class="o">=</span> <span class="n">lock_rec_has_to_wait_for_granted</span><span class="p">(</span><span class="n">wait_lock</span><span class="p">,</span> <span class="n">granted</span><span class="p">,</span> <span class="n">new_granted_index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">blocking_lock</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">lock_grant</span><span class="p">(</span><span class="n">wait_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">lock_rec_move_granted_to_front</span><span class="p">(</span><span class="n">wait_lock</span><span class="p">,</span> <span class="n">rec_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">granted</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">wait_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="cm">/* ç­‰å¾…çš„é”ç­‰å¾…åŸå› å¯èƒ½æ”¹å˜ï¼Œæ›´æ–° wait_for å›¾ */</span>
</span></span><span class="line"><span class="cl">      <span class="n">lock_update_wait_for_edge</span><span class="p">(</span><span class="n">wait_lock</span><span class="p">,</span> <span class="n">blocking_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<!-- copyright -->
<div class="admonition">
  <div class="admonition-content">
    <ul>
      <li>ç‰ˆæƒå£°æ˜ï¼šå¦‚éœ€è½¬è½½æˆ–å¼•ç”¨ï¼Œè¯·é™„åŠ æœ¬æ–‡é“¾æ¥å¹¶æ³¨æ˜æ¥æºã€‚</li>
    </ul>
  </div>
</div>
<!-- copyright -->

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://mzyee.github.io/tags/mysql/">MySQL</a></li>
      <li><a href="https://mzyee.github.io/tags/lock/">Lock</a></li>
      <li><a href="https://mzyee.github.io/tags/transaction/">Transaction</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="https://mzyee.github.io/posts/mysql/meta/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>MySQL å¦‚ä½•å‡†å¤‡å¼€å¯ä¸€ä¸ªè¡¨</span>
  </a>
</nav>

  </footer>
<div>
  <div class="pagination__title">
    <span class="pagination__title-h" style="font-size: 20px;">ğŸ’¬ è¯„è®º</span>
    <hr />
  </div>
  <div id="tcomment"></div>
  <script src="https://cdn.staticfile.org/twikoo/1.6.25/twikoo.all.min.js"></script>
  <script>
    twikoo.init({
      envId: "https://mzyeee.netlify.app/.netlify/functions/twikoo",  
      el: "#tcomment",
      lang: 'zh-CN',
      region: 'ap-hongkong',
      path: window.TWIKOO_MAGIC_PATH || window.location.pathname,
    });
  </script>
</div>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://mzyee.github.io">MZY&#39;s Blog</a></span>
    <span>
        | Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a>
    </span>
    <span id="busuanzi_container">
        | Viewer
        <span class="fa fa-user"></span> <span id="busuanzi_value_site_uv"></span>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerHTML = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerHTML = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
