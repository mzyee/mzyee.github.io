<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>MySQL å¦‚ä½•å‡†å¤‡å¼€å¯ä¸€ä¸ªè¡¨ | MZY&#39;s Blog</title>
<meta name="keywords" content="MySQL, DD">
<meta name="description" content="MySQL å…ƒä¿¡æ¯ç®¡ç†åŠå¼€è¡¨æµç¨‹ä»£ç å­¦ä¹ ">
<meta name="author" content="Miao Zheyu">
<link rel="canonical" href="https://mzyee.github.io/posts/mysql/meta/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.78ed8947c1508d00bdf7a3061370dcaebcd4ba680f4567ec440d26a4043b4e64.css" integrity="sha256-eO2JR8FQjQC996MGE3DcrrzUumgPRWfsRA0mpAQ7TmQ=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://mzyee.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://mzyee.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://mzyee.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://mzyee.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://mzyee.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script async src="https://unpkg.com/mermaid@8.8.1/dist/mermaid.min.js"></script>


<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<meta property="og:title" content="MySQL å¦‚ä½•å‡†å¤‡å¼€å¯ä¸€ä¸ªè¡¨" />
<meta property="og:description" content="MySQL å…ƒä¿¡æ¯ç®¡ç†åŠå¼€è¡¨æµç¨‹ä»£ç å­¦ä¹ " />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mzyee.github.io/posts/mysql/meta/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-05T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-11-05T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="MySQL å¦‚ä½•å‡†å¤‡å¼€å¯ä¸€ä¸ªè¡¨"/>
<meta name="twitter:description" content="MySQL å…ƒä¿¡æ¯ç®¡ç†åŠå¼€è¡¨æµç¨‹ä»£ç å­¦ä¹ "/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://mzyee.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "MySQL",
      "item": "https://mzyee.github.io/posts/mysql/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "MySQL å¦‚ä½•å‡†å¤‡å¼€å¯ä¸€ä¸ªè¡¨",
      "item": "https://mzyee.github.io/posts/mysql/meta/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "MySQL å¦‚ä½•å‡†å¤‡å¼€å¯ä¸€ä¸ªè¡¨",
  "name": "MySQL å¦‚ä½•å‡†å¤‡å¼€å¯ä¸€ä¸ªè¡¨",
  "description": "MySQL å…ƒä¿¡æ¯ç®¡ç†åŠå¼€è¡¨æµç¨‹ä»£ç å­¦ä¹ ",
  "keywords": [
    "MySQL", "DD"
  ],
  "articleBody": "1. å‰è¨€ å¤§å®¶éƒ½çŸ¥é“å…ƒæ•°æ®ï¼ˆMetadataï¼‰æ˜¯ç”¨æ¥æè¿°æ•°æ®çš„æ•°æ®ï¼Œæ²¡æœ‰å…ƒæ•°æ®çš„æƒ…å†µä¸‹æˆ‘ä»¬å°±æ²¡åŠæ³•ç†è§£ã€ä½¿ç”¨æ•°æ®åº“ä¸­å­˜å‚¨çš„æ•°æ®ã€‚æœ¬æ–‡é€šè¿‡ InnoDB å¼€å¯ä¸€ä¸ªè¡¨çš„æµç¨‹æ¥è®¨è®º InnoDB çš„å…ƒä¿¡æ¯ç®¡ç†å’Œç›¸å…³å¼€è¡¨æµç¨‹ä»£ç ã€‚\n2. å…ƒæ•°æ®ç®¡ç† 2.1 å…ƒæ•°æ®çš„ç‰©ç†å­˜å‚¨ åœ¨ MySQL 8.0 ä¹‹å‰ï¼ŒServer å±‚å’Œå­˜å‚¨å¼•æ“å±‚ä¼šå„è‡ªä¿ç•™ä¸€ä»½å…ƒæ•°æ®ï¼ˆschema name, table definition ç­‰ï¼‰ï¼Œä¸ä»…åœ¨ä¿¡æ¯å­˜å‚¨ä¸Šæœ‰ç€é‡å¤å†—ä½™ï¼Œè€Œä¸”å¯èƒ½å­˜åœ¨ä¸¤è€…ä¹‹é—´å­˜å‚¨çš„å…ƒæ•°æ®ä¸åŒæ­¥çš„ç°è±¡ã€‚MySQL åœ¨ 8.0 ä¸­å¼•å…¥äº† data dictionary æ¥è¿›è¡Œ Server å±‚å’Œä¸åŒå¼•æ“é—´ç»Ÿä¸€çš„å…ƒæ•°æ®ç®¡ç†ï¼Œè¿™äº›å…ƒæ•°æ®éƒ½å­˜å‚¨åœ¨ InnoDB å¼•æ“çš„è¡¨ä¸­ï¼ŒServer å±‚å’Œå¼•æ“å±‚å…±äº«ä¸€ä»½å…ƒæ•°æ®ï¼Œä¸”æ”¯æŒåŸå­æ€§ã€‚\nè¿™äº›å…ƒæ•°æ®å¯¹åº”çš„ InnoDB å¼•æ“è¡¨æˆ‘ä»¬ä¸€èˆ¬ç§°ä¸ºç³»ç»Ÿè¡¨ï¼Œå…¶è¡¨ç»“æ„æ˜¯å›ºå®šçš„ç›´æ¥å®šä¹‰åœ¨ä»£ç ç±»ç»“æ„ä¸­ï¼ˆå› æ­¤ä¸å†éœ€è¦è®°å½•é¢å¤–çš„å…ƒæ•°æ®ï¼Œè¦ä¸ç„¶å°±å¥—å¨ƒäº†ï¼‰ï¼Œå¯¹åº”è¡¨æ–‡ä»¶åœ¨æ•´ä¸ª MySQL è¿›è¡Œåˆå§‹åŒ–æ—¶å°±å»ºç«‹äº†ï¼Œæœ‰å¦‚ tablesã€columnsã€indexesã€foreign_keysç­‰ç³»ç»Ÿè¡¨ã€‚å¯ä»¥é€šè¿‡ä¸‹é¢çš„ SQL åœ¨ debug ç‰ˆæœ¬æŸ¥çœ‹æ‰€æœ‰ç³»ç»Ÿè¡¨ï¼š\n1 2 3 4 5 6 7 8 SET SESSION debug='+d,skip_dd_table_access_check'; SELECT id, name, schema_id, hidden FROM mysql.tables WHERE hidden='System' AND type='BASE TABLE'; å¯¹äºæŸå¼ ç”¨æˆ·è¡¨æ¥è¯´ï¼Œå…¶å…ƒæ•°æ®å°±æ˜¯é€šè¿‡è¿™äº›ç³»ç»Ÿè¡¨å¯¹åº”çš„è¡Œå†…å®¹è®°å½•æ„æˆã€‚å„å…ƒæ•°æ®è¡¨çš„é€»è¾‘å…³ç³»å¯ä»¥è¿‘ä¼¼çœ‹æˆæ˜¯ä¸€é¢—æ ‘å…³è”ç»“æ„ã€‚å…¶é¡¶å±‚å…¥å£æ˜¯ table è¡¨ï¼ˆmysql.tablesï¼‰ä¸­çš„å¯¹åº”å”¯ä¸€è®°å½•ï¼Œå†é€šè¿‡è®°å½•çš„ table id ç­‰ç´¢å¼•é¡¹å…³è”åˆ°å¦‚ columnsã€indexes ç­‰å„å…ƒæ•°æ®ç³»ç»Ÿè¡¨ï¼Œè¿›è€Œè·å–è¿™ä¸ªè¡¨å¯¹åº”çš„æ‰€æœ‰å…ƒæ•°æ®çš„è®°å½•å†…å®¹ã€‚\ngraph TD; tables--`name`--\u003ecatalogs; catalogs--`catalog_id``name`--\u003eschemata; tables--`table_id``name`--\u003ecolumns; tables--`table_id``name`--\u003eindexes; tables--`...`--\u003e...; 2.2 å…ƒæ•°æ®çš„å†…å­˜ç»“æ„ åœ¨æ˜ç¡®äº† DD å…ƒä¿¡æ¯åœ¨ç‰©ç†å±‚é¢çš„å­˜å‚¨æ ¼å¼åï¼Œæˆ‘ä»¬èƒ½å¤Ÿå¾ˆæ¸…æ¥šçš„çŸ¥é“ï¼Œå½“éœ€è¦æ„å»ºä¸€å¼ ç”¨æˆ·è¡¨çš„å…ƒæ•°æ®æ—¶ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦è®¿é—®æ‰€æœ‰éœ€è¦çš„ç³»ç»Ÿè¡¨ï¼ˆå…ƒæ•°æ®è¡¨ï¼‰ï¼Œå¹¶ä¾æ¬¡åœ¨å„ç³»ç»Ÿè¡¨å†…æ‰¾åˆ°å¯¹åº”è¿™å¼ ç”¨æˆ·è¡¨çš„ç›¸åº”è®°å½•ï¼Œç„¶åç”¨è¿™äº›å…ƒæ•°æ®è®°å½•æ„å»ºå‡ºç”¨æˆ·è¡¨çš„å†…å­˜å¯¹è±¡ã€‚\nå…ƒæ•°æ®è¡¨æœ¬èº«å¯¹åº”çš„å†…å­˜å¯¹è±¡ç»“æ„æ˜¯ä» Object_table ç±»ä»æ´¾ç”Ÿå‡ºæ¥çš„ï¼Œæœ‰ Entity_object_table_impl å’Œ Object_table_impl ä¸¤å¤§ç±»ã€‚å‰è€…å¯¹åº”æŒä¹…åŒ–æœ‰å¯¹åº”å…·ä½“é”®å¯¹è±¡çš„åŸºæœ¬ DD è¡¨ï¼Œè€Œåè€…å¯¹åº”ç€ä¸å•ç‹¬å­˜åœ¨éœ€è¦é€šè¿‡å‰è€…å…³è”è®¿é—®çš„ DD è¡¨ï¼ˆä¸èƒ½ç›´æ¥è¢« createï¼Œsearchï¼Œdropï¼‰ï¼Œä¾‹å¦‚ä¸¤è€…åˆ†åˆ«å¯¹åº”æ´¾ç”Ÿå‡º Tablesã€Tablespacesã€â€¦ å’Œ Columnsã€Indexesã€â€¦ ç­‰å…·ä½“å†…å­˜ç»“æ„ä½“ï¼Œä¸€ä¸€å¯¹åº”å„å…ƒæ•°æ®ç³»ç»Ÿè¡¨ã€‚\nå€¼å¾—ä¸€æï¼Œä¸Šé¢è¯´çš„è¿™äº›å†…å­˜å¯¹è±¡æ˜¯å…ƒæ•°æ®è¡¨æœ¬èº«çš„å†…å­˜å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è®¿é—®å…ƒæ•°æ®è¡¨æ‰€ä½¿ç”¨çš„å†…å­˜å¯¹è±¡ï¼Œè€ŒéæŸä¸€å¼ ç”¨æˆ·è¡¨çš„å†…å­˜å¯¹è±¡ã€‚ç±»ä¼¼çš„ï¼Œå¯¹äºä¸€å¼ ç”¨æˆ·è¡¨ï¼Œä¹Ÿæ˜¯é€šè¿‡å¯¹åº”çš„å…ƒæ•°æ®è®°å½•æ„å»ºå…¶å†…å­˜å¯¹è±¡ç»“æ„ã€‚ä¸€èˆ¬ä» Entity_object_impl ç±»ä»æ´¾ç”Ÿå‡ºæ¥çš„ï¼Œåƒå¸¸ç”¨çš„ Table_impl å’Œ View_impl åˆ†åˆ«è¡¨ç¤ºç”¨æˆ·è¡¨å’Œè§†å›¾å¯¹åº”å…ƒæ•°æ®çš„å†…å­˜å¯¹è±¡ã€‚\nå½“ç¼“å­˜ç©¿é€æ—¶ï¼Œè¿™äº› objects çš„åº•å±‚æ“ä½œé€»è¾‘è¢«å°è£…åœ¨ Storage_adapter ä¸­ï¼Œé€šè¿‡æä¾›çš„ get() / drop() / store() ç­‰æ¥å£ï¼Œéå†æŸ¥è¯¢æˆ–ä¿®æ”¹æ‰€æœ‰æ‰€éœ€å…ƒæ•°æ®è¡¨ï¼ˆbtree ç»“æ„ï¼‰ä¸­å¯¹åº”çš„ recordï¼Œæ„å»ºæˆ–æŒä¹…æ€§ç›¸åº”çš„ object å†…å­˜å¯¹è±¡ç”±/åˆ°å¼•æ“å±‚ã€‚\n2.3 å…ƒæ•°æ®çš„ cache ç¼“å­˜ ä»ä¸Šè¿°æ“ä½œä¸­å¯ä»¥çœ‹å‡ºï¼Œç›´æ¥ä»å…ƒæ•°æ®è¡¨æ„å»º DD object å†…å­˜å¯¹è±¡æ˜¯å¼€é”€ååˆ†å·¨å¤§çš„ï¼Œè¿‡ç¨‹ä¸­éœ€è¦ç‰©ç†è®¿é—®å¹¶ç´¢å¼•å¤šä¸ª Btree ç´¢å¼•ã€‚å› æ­¤ MySQL å»ºç«‹äº†å¤šå±‚çš„ DD Cache æ¥å°±å¯èƒ½å‡å°å…ƒæ•°æ®çš„è®¿é—®å¼€é”€ï¼Œä¸€èˆ¬ç§°ä¸ºå…ƒæ•°æ®çš„ 3 å±‚ç¼“å­˜æ¶æ„ï¼š\næ¯ä¸ª client çš„ç‹¬äº«ç¼“å­˜ï¼Œå³çº¿ç¨‹ THD ç‹¬å çš„ Dictionary_client ç»“æ„ï¼Œå…¶ä¸­æœ‰ committedã€uncommittedã€dropped ä¸‰ç±» objects mapï¼Œæœ€åˆ acquire çš„ object ä¼šè¢«åŠ å…¥åˆ°committed map ä¸­ï¼Œclient è°ƒç”¨ store æˆ– update æ¥å£æ—¶å°† object æ”¾åˆ° uncommitted map ä¸­ï¼Œç„¶ååœ¨äº‹åŠ¡æäº¤åå°†ç›¸åº” objects ä» uncommitted map ç§»åˆ° committed map ä¸­ï¼Œè€Œè°ƒç”¨ drop æ¥å£ä¼šå°† objects åŠ å…¥ dropped mapã€‚å½“è®¿é—® Dictionary_client ç©¿é€æ—¶ï¼Œä» Shared_dictionary_cache è·å–ï¼› Server å…¨å±€å”¯ä¸€çš„å…±äº«ç¼“å­˜ï¼Œä½¿ç”¨å•ä¾‹ Shared_dictionary_cache æ¥å®ç°ï¼Œå…¶å®è´¨ä¸Šä¹Ÿæ˜¯ objects map é›†åˆã€‚åœ¨æ­¤ç¼“å­˜å±‚ç›¸åŒ key å¯¹åº”çš„ DD objects å¯¹è±¡å”¯ä¸€ï¼Œè¿™é‡Œçš„ key å…¶å®å°±æ˜¯å¯¹åº”å…ƒæ•°æ®è¡¨çš„ç´¢å¼• keyã€‚å½“ Shared_dictionary_cache ç©¿é€æ—¶ï¼Œé€šè¿‡ Storage_adapter ä» InnoDB handler è¯»å–å…ƒæ•°æ®è¡¨è®°å½•ã€‚ å­˜å‚¨å¼•æ“å±‚ï¼ˆå…ƒæ•°æ®è¡¨æ•°æ®ç›´æ¥ BP ç¼“å­˜ï¼‰ï¼Œç³»ç»Ÿè¡¨çš„è®¿é—®æ¨¡å¼å’Œæ™®é€šç”¨æˆ·è¡¨åŸºæœ¬ä¸€è‡´ï¼Œæ³¨æ„é‡‡ç”¨çš„æ˜¯ READ_COMMITTED éš”ç¦»çº§åˆ«ã€‚ 3. å…ƒæ•°æ®çš„ä½¿ç”¨ 3.1 Server å±‚å…ƒæ•°æ®çš„ä½¿ç”¨ å®ç°äº† DD å…ƒæ•°æ®çš„ç®¡ç†ï¼ŒMySQL å°±èƒ½å¤Ÿé€šè¿‡ä½¿ç”¨å…ƒæ•°æ®æ„å»ºè®¿é—®ç”¨æˆ·è¡¨çš„ç¯å¢ƒï¼Œè¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„â€œå¼€è¡¨â€é€»è¾‘ã€‚å‰é¢å·²ç»ä»‹ç»äº†å…ƒæ•°æ®è¡¨æœ¬èº«çš„å†…å­˜å¯¹è±¡ï¼Œé€šè¿‡è®¿é—®å…ƒæ•°æ®è¡¨ç›¸åº”è®°å½•ï¼Œç±»ä¼¼çš„å¯ä»¥æ„å»ºç”¨æˆ·è¡¨ï¼ˆæˆ–å…¶ä»–å†…å®¹ï¼Œå¦‚è§†å›¾ç­‰ï¼‰çš„å†…å­˜å¯¹è±¡ã€‚\næˆ‘ä»¬éœ€è¦çŸ¥é“ Server å±‚çš„ä¸¤ä¸ªå…³é”®ç»“æ„ä½“ TABLE_SHARE å’Œ TABLE:\nä¸€å¼ è¡¨è¢«åˆæ¬¡è®¿é—®æ—¶ï¼ŒMySQL ä¼šå…¶å»ºç«‹ä¸€ä¸ª TABLE_SHARE å¯¹è±¡ï¼Œä¸å…¶ä¸å¼•æ“å±‚ä¸­çš„å¯¹åº”è¡¨ dict_table_t ç›¸å¯¹åº”å…³è”ã€‚TABLE_SHARE æ˜¯é™æ€çš„ï¼Œä¸èƒ½ä¿®æ”¹çš„ï¼Œä¸”ä¸€å¼ è¡¨åªå­˜åœ¨ä¸€ä»½ï¼Œå…¶ä¸­è®°å½•è¡¨å®šä¹‰ç›¸å…³çš„ä¸€äº› DD ä¿¡æ¯ï¼Œå¦‚åŒ…å«çš„å­—æ®µç­‰ã€‚TABLE_SHARE åªæœ‰åœ¨è¡¨ç»“æ„è¢«ä¿®æ”¹åæ‰ä¼šåˆ é™¤ï¼Œæˆ–è€…ç¼“å­˜ä½¿ç”¨æ»¡äº†ä¼šæ·˜æ±°ã€‚ç®€å•çš„è¯´ï¼ŒTABLE_SHARE å°±æ˜¯æŸå¼ è¡¨å®šä¹‰çš„å®ä½“åŒ–å¯¹è±¡ã€‚ å¯¹æ¯ä¸€ä¸ªä¼šè¯æŸ¥è¯¢ä¸­æ¶‰åŠçš„è¡¨ï¼ŒMySQL ä¼šé€šè¿‡ TABLE_SHARE ä¸ºæ¯ä¸ªè¡¨å»ºä¸€ä¸ª TABLE å®ä½“å¯¹è±¡ï¼Œè¿™ä¸€è¿‡ç¨‹å«è¡¨ç»“æ„å®ä¾‹åŒ–ã€‚å¦‚æœæ˜¯ InnoDB è¡¨è¿˜ä¼šåˆ›å»º InnoDB çš„ handlerï¼Œserver å±‚ä¼šè¯é€šè¿‡ TABLE å¯¹è±¡ç»å¼•æ“å±‚æ“ä½œè¡¨æ–‡ä»¶å®ä½“ã€‚å¯ä»¥å°† TABLE å¯¹è±¡çœ‹åšè¡¨åœ¨ server å±‚çš„æ˜ å°„ï¼Œå°† handler çœ‹åšå…¶ä¸ºæ“ä½œåº•å±‚æ•°æ®æ–‡ä»¶è€Œåœ¨å¼•æ“å±‚åˆ›å»ºçš„å¥æŸ„ã€‚ â€œå¼€è¡¨â€é€»è¾‘å°±æ˜¯é€šè¿‡è®¿é—®å…ƒæ•°æ®æ¥è·å– TABLE_SHARE å’Œæ„å»º TABLE å®ä½“å¯¹è±¡çš„è¿‡ç¨‹ã€‚æˆ‘ä»¬å…·ä½“çœ‹ä¸‹ open_table çš„ä»£ç é€»è¾‘ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 bool open_table(THD *thd, Table_ref *table_list, Open_table_context *ot_ctx) { // Step 0. åšä¸€äº›å‰ç½®æ£€æŸ¥... // Step 1. é™¤ç‰¹æ®Š DD è¡¨ç­‰åœºæ™¯ï¼ŒLOCK TABLES mode(LTM)ä¸‹æ ¡éªŒæ˜¯å¦è¡¨å¯¹è±¡éƒ½æ˜¯ pre-opened çš„ï¼› // Step 2. é LTM æ¨¡å¼ï¼ˆé€šå¸¸çš„æ¨¡å¼ï¼‰ï¼Œæ ¹æ® mdl è¯·æ±‚æ¨¡å¼è·å– mdl é”ï¼› if ((flags \u0026 (MYSQL_OPEN_HAS_MDL_LOCK | MYSQL_OPEN_SECONDARY_ENGINE)) == 0) { // å¦‚æœéœ€è¦ write_lock mdlï¼Œè¿˜è¦è·å– global read lock ä¿è¯æ­£ç¡®å†²çªæ€§ // ... if (open_table_get_mdl_lock(thd, ot_ctx, table_list, flags, \u0026mdl_ticket) || mdl_ticket == nullptr) { return true; } } else { /* caller è·å–è¿‡ MDL é” */ mdl_ticket = table_list-\u003emdl_request.ticket; } // Step 3. æ£€æŸ¥ç›®æ ‡è¡¨çš„å­˜åœ¨æ€§ï¼› if (table_list-\u003eopen_strategy == Table_ref::OPEN_IF_EXISTS || table_list-\u003eopen_strategy == Table_ref::OPEN_FOR_CREATE) { bool exists; if (check_if_table_exists(thd, table_list, \u0026exists)) return true; /* ç©ºè¯» */ if (!exists) { /* table ä¸å­˜åœ¨äº DDï¼Œå‡çº§åˆ° EXCLUSIVE MDL lock. */ if (table_list-\u003eopen_strategy == Table_ref::OPEN_FOR_CREATE \u0026\u0026 !(flags \u0026 (MYSQL_OPEN_FORCE_SHARED_MDL | MYSQL_OPEN_FORCE_SHARED_HIGH_PRIO_MDL))) { MDL_deadlock_handler mdl_deadlock_handler(ot_ctx); thd-\u003epush_internal_handler(\u0026mdl_deadlock_handler); bool wait_result = thd-\u003emdl_context.upgrade_shared_lock( table_list-\u003emdl_request.ticket, MDL_EXCLUSIVE, thd-\u003evariables.lock_wait_timeout); thd-\u003epop_internal_handler(); /* Deadlock or timeout occurred while upgrading the lock. */ if (wait_result) return true; } return false; } } else if (table_list-\u003eopen_strategy == Table_ref::OPEN_STUB) /* åº•å±‚ä¸çœŸæ‰“å¼€ */ return false; // Step 4. Table å­˜åœ¨ï¼Œå°è¯•å¼€è¡¨ï¼Œé¦–å…ˆä» table_cache_manager è¿™ä¸ªç¼“å­˜æ‰¾ retry_share : { Table_cache *tc = table_cache_manager.get_cache(thd); tc-\u003elock(); if (!table_list-\u003eis_view()) table = tc-\u003eget_table(thd, key, key_length, \u0026share); if (table) { /* Case 1. æ‰¾åˆ°æœªä½¿ç”¨çš„ TABLE object */ if (!(flags \u0026 MYSQL_OPEN_IGNORE_FLUSH)) { /* æ£€æŸ¥ DD çš„ç‰ˆæœ¬æ˜¯å¦è¿‡è€æˆ–ä¸ä¸€è‡´ */ if (thd-\u003eopen_tables \u0026\u0026 thd-\u003eopen_tables-\u003es-\u003eversion() != share-\u003eversion()) { // æ¸…ç†æ“ä½œ ... return true; } } tc-\u003eunlock(); table-\u003efile-\u003erebind_psi(); table-\u003efile-\u003eha_extra(HA_EXTRA_RESET_STATE); thd-\u003estatus_var.table_open_cache_hits++; goto table_found; } else if (share) { /* Case 2. æ— æœªä½¿ç”¨ TABLE å¯¹è±¡ï¼Œä½†æ˜¯æ‰¾åˆ°è¡¨çš„ TABLE_SHARE */ mysql_mutex_lock(\u0026LOCK_open); tc-\u003eunlock(); share-\u003eincrement_ref_count(); goto share_found; } else { /* Case 3. æ— æœªä½¿ç”¨ TABLE å¯¹è±¡ï¼Œä¹Ÿæ— è¡¨çš„ TABLE_SHARE */ tc-\u003eunlock(); } } mysql_mutex_lock(\u0026LOCK_open); // Step 5. è·å– TABLE_SHAREï¼š // é¦–å…ˆä» table_def_cache ç¼“å­˜é‡Œæ‰¾ï¼Œ // ç©¿é€æƒ…å†µä¸‹ç¡®è®¤ schema MDL é”åå»ºç«‹æ–° TABLE_SHAREï¼Œå¹¶ä»å…ƒæ•°æ®è¡¨è¯»å–è®°å½•å¡«å……ã€‚ if (!(share = get_table_share_with_discover( thd, table_list, key, key_length, flags \u0026 MYSQL_OPEN_SECONDARY_ENGINE, \u0026error))) { // å¤±è´¥æ¸…ç†æ“ä½œ ... return true; } if (table_list-\u003eis_view() || share-\u003eis_view) { /* å¦‚æœæ˜¯ view å¯¹è±¡æƒ…å†µä¸‹çš„å¤„ç† */ // ... // return ... } share_found: if (!(flags \u0026 MYSQL_OPEN_IGNORE_FLUSH)) { if (share-\u003ehas_old_version()) { // é‡Šæ”¾å¯¹ shard çš„ referenceï¼Œç­‰å¾…è€ç‰ˆæœ¬ table share æ›´æ–° release_table_share(share); mysql_mutex_unlock(\u0026LOCK_open); MDL_deadlock_handler mdl_deadlock_handler(ot_ctx); bool wait_result; thd-\u003epush_internal_handler(\u0026mdl_deadlock_handler); uint deadlock_weight = ot_ctx-\u003ecan_back_off() ? MDL_wait_for_subgraph::DEADLOCK_WEIGHT_DML : mdl_ticket-\u003eget_deadlock_weight(); wait_result = tdc_wait_for_old_version(thd, table_list-\u003edb, table_list-\u003etable_name, ot_ctx-\u003eget_timeout(), deadlock_weight); thd-\u003epop_internal_handler(); if (wait_result) return true; goto retry_share; } if (thd-\u003eopen_tables \u0026\u0026 thd-\u003eopen_tables-\u003es-\u003eversion() != share-\u003eversion()) { /* å¦‚æœ version æ”¹å˜ï¼Œè®©æ­¥åé‡æ–°å¼€è¡¨ */ // æ¸…ç†æ“ä½œ ... return true; } } mysql_mutex_unlock(\u0026LOCK_open); // Step 6. ç”± TABLE_SHARE æ„å»º TABLE å¯¹è±¡ { dd::cache::Dictionary_client::Auto_releaser releaser(thd-\u003edd_client()); const dd::Table *table_def = nullptr; if (!(flags \u0026 MYSQL_OPEN_NO_NEW_TABLE_IN_SE) \u0026\u0026 thd-\u003edd_client()-\u003eacquire(share-\u003edb.str, share-\u003etable_name.str, \u0026table_def)) { goto err_lock; } if (table_def \u0026\u0026 table_def-\u003ehidden() == dd::Abstract_table::HT_HIDDEN_SE) { my_error(ER_NO_SUCH_TABLE, MYF(0), table_list-\u003edb, table_list-\u003etable_name); goto err_lock; } /* make a new table */ if (!(table = (TABLE *)my_malloc(key_memory_TABLE, sizeof(*table), MYF(MY_WME)))) goto err_lock; error = open_table_from_share( thd, share, alias, ((flags \u0026 MYSQL_OPEN_NO_NEW_TABLE_IN_SE) ? 0 : ((uint)(HA_OPEN_KEYFILE | HA_OPEN_RNDFILE | HA_GET_INDEX | HA_TRY_READ_ONLY))), EXTRA_RECORD, thd-\u003eopen_options, table, false, table_def); if (error) { // æ¸…ç†æ“ä½œ ... goto err_lock; } else if (share-\u003ecrashed) { switch (thd-\u003elex-\u003esql_command) { case SQLCOM_ALTER_TABLE: case SQLCOM_REPAIR: case SQLCOM_CHECK: case SQLCOM_SHOW_CREATE: break; // å¯ä»¥å¤„ç†çš„ case default: // æ¸…ç†æ“ä½œ ... goto err_lock; } } /* Finalize the process of TABLE creation by loading table triggers */ if (open_table_entry_fini(thd, share, table_def, table)) { // æ¸…ç†æ“ä½œ ... goto err_lock; } } // Step 7. å°†æ–°ç”Ÿæˆçš„ TABLE å¯¹è±¡åŠ å…¥å½“å‰è¿æ¥çš„ table cache { Table_cache *tc = table_cache_manager.get_cache(thd); tc-\u003elock(); if (tc-\u003eadd_used_table(thd, table)) { tc-\u003eunlock(); goto err_lock; } tc-\u003eunlock(); } thd-\u003estatus_var.table_open_cache_misses++; table_found: // å½“å‰æœ‰äº† TABLE å¯¹è±¡ table-\u003emdl_ticket = mdl_ticket; table-\u003enext = thd-\u003eopen_tables; /* Link into simple list */ thd-\u003eset_open_tables(table); table-\u003ereginfo.lock_type = TL_READ; /* Assume read */ reset: // æˆåŠŸï¼Œåˆå§‹åŒ–è¿”å› table-\u003ereset(); table-\u003eset_created(); table_list-\u003eset_updatable(); table_list-\u003eset_insertable(); table_list-\u003etable = table; // skipping partitions bitmap setting in MYSQL_OPEN_NO_NEW_TABLE_IN_SE // ... table-\u003einit(thd, table_list); return false; err_lock: // å¤±è´¥ mysql_mutex_lock(\u0026LOCK_open); release_table_share(share); mysql_mutex_unlock(\u0026LOCK_open); return true; } è€ƒè™‘æ‰€æœ‰ cache éƒ½ç©¿é€çš„æƒ…å†µï¼Œåˆ™æ­¤æ—¶åœ¨ get_table_share ä¸­ï¼Œé€šè¿‡ DD æ¥å£ä»å…ƒæ•°æ®è¡¨è¯»å–ç›¸åº”ï¼ˆè¡¨ï¼‰å¯¹è±¡çš„å…ƒæ•°æ®è®°å½•ï¼Œå†ä»¥ä¹‹å¡«å……æ–°ç”Ÿæˆçš„ TABLE_SHAREã€‚\n3.2 Server å±‚è¡¨å¯¹è±¡ç¼“å­˜ ä»å‰é¢ open_tableä»£ç å¯è§ï¼Œè·å– TABLE_SHARE å’Œæ„å»º TABLE å®ä½“å¯¹è±¡è¿‡ç¨‹ä¸­ä¹Ÿæ¶‰åŠå¤šå±‚ cache ç¼“å­˜æœºåˆ¶ã€‚é¦–å…ˆæ˜¯ Table_cache_manager ç¼“å­˜äº† TABLE å¯¹è±¡ï¼Œç»´æŠ¤äº†æ‰€æœ‰æ­£åœ¨ä½¿ç”¨æˆ–æ›¾ç»æ‰“å¼€è¿‡çš„ TABLE å¯¹è±¡ï¼Œå…¶å¤§å°ç”± table_cache_size ç»´æŠ¤ï¼Œå†…éƒ¨æŒ‰ THD åˆ†ç‰‡ä¸º table_cache_instances ä¸ª Table_cacheã€‚æ¯ä¸ª Table_cache å†…éƒ¨ç”± object nameï¼ˆä¾‹å¦‚æŸå¼ ç”¨æˆ·è¡¨ï¼‰ æ˜ å°„åˆ° Table_cache_elementï¼Œå¯è§ Table_cache_element å”¯ä¸€å¯¹åº”ä¸€ä¸ª objectï¼Œå› æ­¤ä¹Ÿå”¯ä¸€å¯¹åº”ä¸€ä¸ª TABLE_SHAREï¼Œå…¶å†…éƒ¨é“¾æ¥äº†è¿™ä¸ªç¼“å­˜åˆ†ç‰‡å†…ä¸­çš„æ‰€æœ‰ç”±æ­¤ TABLE_SHARE ç”Ÿæˆçš„ TABLE å®ä¾‹ã€‚\nå¦‚æœ Table_cache_manager ç¼“å­˜ç©¿é€ï¼Œåˆ™ä¼šå» Table_definition_cache ç¼“å­˜å¯»æ‰¾æ˜¯å¦æœ‰å­˜åœ¨ TABLE_SHARE å¯¹è±¡ï¼Œå…¶å¤§å°è®¾ç½®ä¸º min(400 + table_cache_size / 2, 2000)ã€‚ å¦‚æœ Table_definition_cache è¿›ä¸€æ­¥ç©¿é€ï¼Œåˆ™ä¼šå» InnoDB å±‚è¯»å–å…ƒæ•°æ®æ„å»º TABLE_SHAREã€‚\nå¦å¤–ï¼Œåœ¨ InnoDB ä¹Ÿä¸ºæ¯ä¸€ä¸ª InnoDB è¡¨åŠ è½½ä¸€ä¸ªæ•°æ®å­—å…¸å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡çš„é›†åˆå°±æ˜¯ InnoDB ä¸­çš„ data dictionaryã€‚InnoDB çš„ dictionary system ä»¥ å…¨å±€ dict_sys_t ç®¡ç†ï¼Œè€Œå•ä¸ªè¡¨å¯¹è±¡å¯¹åº” dict_table_tï¼Œç±»ä¼¼çš„ï¼Œç´¢å¼•å¯¹è±¡å¯¹åº” dict_index_tï¼Œåˆ—å¯¹è±¡å¯¹åº” dict_col_t ç­‰ã€‚InnoDB åŒæ ·é€šè¿‡è¯»å–å…ƒæ•°æ®è¡¨è®°å½•æ¥æ„å»º dict_table_t å¯¹è±¡ï¼Œå¹¶ä¸” dict_sys_t ä¸­ä¹Ÿæœ‰ä¸¤ä¸ª dict_table_t ç¼“å­˜ï¼Œåˆ†åˆ«ä»¥ table name å’Œ table id è¿›è¡Œæ˜ å°„å…³è”ï¼Œå…¶æœ€å¤§å®¹é‡é™åˆ¶å’Œ Table_definition_cache ä¸€è‡´ã€‚\nç‰ˆæƒå£°æ˜ï¼šå¦‚éœ€è½¬è½½æˆ–å¼•ç”¨ï¼Œè¯·é™„åŠ æœ¬æ–‡é“¾æ¥å¹¶æ³¨æ˜æ¥æºã€‚ ",
  "wordCount" : "1177",
  "inLanguage": "zh",
  "datePublished": "2023-11-05T00:00:00Z",
  "dateModified": "2023-11-05T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Miao Zheyu"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://mzyee.github.io/posts/mysql/meta/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "MZY's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://mzyee.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://mzyee.github.io" accesskey="h" title=" MZY&#39;s Blog (Alt + H)">
                <img src="https://mzyee.github.io/img/eye.jpg" alt="" aria-label="logo"
                    height="38"> MZY&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://mzyee.github.io/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://mzyee.github.io/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://mzyee.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://mzyee.github.io/contact" title="Contact">
                    <span>Contact</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://mzyee.github.io">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://mzyee.github.io/posts/">Posts</a>&nbsp;Â»&nbsp;<a href="https://mzyee.github.io/posts/mysql/">MySQL</a></div>
    <h1 class="post-title">
      MySQL å¦‚ä½•å‡†å¤‡å¼€å¯ä¸€ä¸ªè¡¨
    </h1>
    <div class="post-meta"><span title='2023-11-05 00:00:00 +0000 UTC'>åä¸€æœˆ 5, 2023</span>&nbsp;Â·&nbsp;6 åˆ†é’Ÿ&nbsp;Â·&nbsp;Miao Zheyu
      &nbsp;|&nbsp;ğŸ“– &nbsp;
      <ul class="post-tags-meta">
        <a href="https://mzyee.github.io/tags/mysql/">MySQL</a>
        <a href="https://mzyee.github.io/tags/dd/">&nbsp;DD</a>
      </ul>&nbsp;|&nbsp;<a href="https://github.com/mzyee/mzyee.github.io" rel="noopener noreferrer" target="_blank">Suggestions</a>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#1-%e5%89%8d%e8%a8%80" aria-label="1. å‰è¨€">1. å‰è¨€</a></li>
                    <li>
                        <a href="#2-%e5%85%83%e6%95%b0%e6%8d%ae%e7%ae%a1%e7%90%86" aria-label="2. å…ƒæ•°æ®ç®¡ç†">2. å…ƒæ•°æ®ç®¡ç†</a><ul>
                            
                    <li>
                        <a href="#21-%e5%85%83%e6%95%b0%e6%8d%ae%e7%9a%84%e7%89%a9%e7%90%86%e5%ad%98%e5%82%a8" aria-label="2.1 å…ƒæ•°æ®çš„ç‰©ç†å­˜å‚¨">2.1 å…ƒæ•°æ®çš„ç‰©ç†å­˜å‚¨</a></li>
                    <li>
                        <a href="#22-%e5%85%83%e6%95%b0%e6%8d%ae%e7%9a%84%e5%86%85%e5%ad%98%e7%bb%93%e6%9e%84" aria-label="2.2 å…ƒæ•°æ®çš„å†…å­˜ç»“æ„">2.2 å…ƒæ•°æ®çš„å†…å­˜ç»“æ„</a></li>
                    <li>
                        <a href="#23-%e5%85%83%e6%95%b0%e6%8d%ae%e7%9a%84-cache-%e7%bc%93%e5%ad%98" aria-label="2.3 å…ƒæ•°æ®çš„ cache ç¼“å­˜">2.3 å…ƒæ•°æ®çš„ cache ç¼“å­˜</a></li></ul>
                    </li>
                    <li>
                        <a href="#3-%e5%85%83%e6%95%b0%e6%8d%ae%e7%9a%84%e4%bd%bf%e7%94%a8" aria-label="3. å…ƒæ•°æ®çš„ä½¿ç”¨">3. å…ƒæ•°æ®çš„ä½¿ç”¨</a><ul>
                            
                    <li>
                        <a href="#31-server-%e5%b1%82%e5%85%83%e6%95%b0%e6%8d%ae%e7%9a%84%e4%bd%bf%e7%94%a8" aria-label="3.1 Server å±‚å…ƒæ•°æ®çš„ä½¿ç”¨">3.1 Server å±‚å…ƒæ•°æ®çš„ä½¿ç”¨</a></li>
                    <li>
                        <a href="#32-server-%e5%b1%82%e8%a1%a8%e5%af%b9%e8%b1%a1%e7%bc%93%e5%ad%98" aria-label="3.2 Server å±‚è¡¨å¯¹è±¡ç¼“å­˜">3.2 Server å±‚è¡¨å¯¹è±¡ç¼“å­˜</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>


  <div class="post-content"><h3 id="1-å‰è¨€">1. å‰è¨€<a hidden class="anchor" aria-hidden="true" href="#1-å‰è¨€">#</a></h3>
<p>â€ƒâ€ƒ å¤§å®¶éƒ½çŸ¥é“å…ƒæ•°æ®ï¼ˆMetadataï¼‰æ˜¯ç”¨æ¥æè¿°æ•°æ®çš„æ•°æ®ï¼Œæ²¡æœ‰å…ƒæ•°æ®çš„æƒ…å†µä¸‹æˆ‘ä»¬å°±æ²¡åŠæ³•ç†è§£ã€ä½¿ç”¨æ•°æ®åº“ä¸­å­˜å‚¨çš„æ•°æ®ã€‚æœ¬æ–‡é€šè¿‡ InnoDB å¼€å¯ä¸€ä¸ªè¡¨çš„æµç¨‹æ¥è®¨è®º InnoDB çš„å…ƒä¿¡æ¯ç®¡ç†å’Œç›¸å…³å¼€è¡¨æµç¨‹ä»£ç ã€‚</p>
<h3 id="2-å…ƒæ•°æ®ç®¡ç†">2. å…ƒæ•°æ®ç®¡ç†<a hidden class="anchor" aria-hidden="true" href="#2-å…ƒæ•°æ®ç®¡ç†">#</a></h3>
<h4 id="21-å…ƒæ•°æ®çš„ç‰©ç†å­˜å‚¨">2.1 å…ƒæ•°æ®çš„ç‰©ç†å­˜å‚¨<a hidden class="anchor" aria-hidden="true" href="#21-å…ƒæ•°æ®çš„ç‰©ç†å­˜å‚¨">#</a></h4>
<p>â€ƒâ€ƒ åœ¨ MySQL 8.0 ä¹‹å‰ï¼ŒServer å±‚å’Œå­˜å‚¨å¼•æ“å±‚ä¼šå„è‡ªä¿ç•™ä¸€ä»½å…ƒæ•°æ®ï¼ˆschema name, table definition ç­‰ï¼‰ï¼Œä¸ä»…åœ¨ä¿¡æ¯å­˜å‚¨ä¸Šæœ‰ç€é‡å¤å†—ä½™ï¼Œè€Œä¸”å¯èƒ½å­˜åœ¨ä¸¤è€…ä¹‹é—´å­˜å‚¨çš„å…ƒæ•°æ®ä¸åŒæ­¥çš„ç°è±¡ã€‚MySQL åœ¨ 8.0 ä¸­å¼•å…¥äº† data dictionary æ¥è¿›è¡Œ Server å±‚å’Œä¸åŒå¼•æ“é—´ç»Ÿä¸€çš„å…ƒæ•°æ®ç®¡ç†ï¼Œè¿™äº›å…ƒæ•°æ®éƒ½å­˜å‚¨åœ¨ InnoDB å¼•æ“çš„è¡¨ä¸­ï¼ŒServer å±‚å’Œå¼•æ“å±‚å…±äº«ä¸€ä»½å…ƒæ•°æ®ï¼Œä¸”æ”¯æŒåŸå­æ€§ã€‚</p>
<p>â€ƒâ€ƒ è¿™äº›å…ƒæ•°æ®å¯¹åº”çš„ InnoDB å¼•æ“è¡¨æˆ‘ä»¬ä¸€èˆ¬ç§°ä¸ºç³»ç»Ÿè¡¨ï¼Œå…¶è¡¨ç»“æ„æ˜¯å›ºå®šçš„ç›´æ¥å®šä¹‰åœ¨ä»£ç ç±»ç»“æ„ä¸­ï¼ˆå› æ­¤ä¸å†éœ€è¦è®°å½•é¢å¤–çš„å…ƒæ•°æ®ï¼Œè¦ä¸ç„¶å°±å¥—å¨ƒäº†ï¼‰ï¼Œå¯¹åº”è¡¨æ–‡ä»¶åœ¨æ•´ä¸ª MySQL è¿›è¡Œåˆå§‹åŒ–æ—¶å°±å»ºç«‹äº†ï¼Œæœ‰å¦‚ <code>tables</code>ã€<code>columns</code>ã€<code>indexes</code>ã€<code>foreign_keys</code>ç­‰ç³»ç»Ÿè¡¨ã€‚å¯ä»¥é€šè¿‡ä¸‹é¢çš„ SQL åœ¨ debug ç‰ˆæœ¬æŸ¥çœ‹æ‰€æœ‰ç³»ç»Ÿè¡¨ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SET</span><span class="w"> </span><span class="k">SESSION</span><span class="w"> </span><span class="n">debug</span><span class="o">=</span><span class="s1">&#39;+d,skip_dd_table_access_check&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">schema_id</span><span class="p">,</span><span class="w"> </span><span class="n">hidden</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">mysql</span><span class="p">.</span><span class="n">tables</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">hidden</span><span class="o">=</span><span class="s1">&#39;System&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="k">type</span><span class="o">=</span><span class="s1">&#39;BASE TABLE&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>â€ƒâ€ƒ å¯¹äºæŸå¼ ç”¨æˆ·è¡¨æ¥è¯´ï¼Œå…¶å…ƒæ•°æ®å°±æ˜¯é€šè¿‡è¿™äº›ç³»ç»Ÿè¡¨å¯¹åº”çš„è¡Œå†…å®¹è®°å½•æ„æˆã€‚å„å…ƒæ•°æ®è¡¨çš„é€»è¾‘å…³ç³»å¯ä»¥è¿‘ä¼¼çœ‹æˆæ˜¯ä¸€é¢—æ ‘å…³è”ç»“æ„ã€‚å…¶é¡¶å±‚å…¥å£æ˜¯ table è¡¨ï¼ˆmysql.tablesï¼‰ä¸­çš„å¯¹åº”å”¯ä¸€è®°å½•ï¼Œå†é€šè¿‡è®°å½•çš„ table id ç­‰ç´¢å¼•é¡¹å…³è”åˆ°å¦‚ columnsã€indexes ç­‰å„å…ƒæ•°æ®ç³»ç»Ÿè¡¨ï¼Œè¿›è€Œè·å–è¿™ä¸ªè¡¨å¯¹åº”çš„æ‰€æœ‰å…ƒæ•°æ®çš„è®°å½•å†…å®¹ã€‚</p>
<!-- <center><img loading="lazy" src="DD_store.png" width="70%" /></center> -->
<div align=center>
<div class="mermaid">
  
graph TD;
    tables--`name`-->catalogs;
    catalogs--`catalog_id``name`-->schemata;
    tables--`table_id``name`-->columns;
    tables--`table_id``name`-->indexes;
    tables--`...`-->...;

</div>

</div>
<h4 id="22-å…ƒæ•°æ®çš„å†…å­˜ç»“æ„">2.2 å…ƒæ•°æ®çš„å†…å­˜ç»“æ„<a hidden class="anchor" aria-hidden="true" href="#22-å…ƒæ•°æ®çš„å†…å­˜ç»“æ„">#</a></h4>
<p>â€ƒâ€ƒ åœ¨æ˜ç¡®äº† DD å…ƒä¿¡æ¯åœ¨ç‰©ç†å±‚é¢çš„å­˜å‚¨æ ¼å¼åï¼Œæˆ‘ä»¬èƒ½å¤Ÿå¾ˆæ¸…æ¥šçš„çŸ¥é“ï¼Œå½“éœ€è¦æ„å»ºä¸€å¼ ç”¨æˆ·è¡¨çš„å…ƒæ•°æ®æ—¶ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦è®¿é—®æ‰€æœ‰éœ€è¦çš„ç³»ç»Ÿè¡¨ï¼ˆå…ƒæ•°æ®è¡¨ï¼‰ï¼Œå¹¶ä¾æ¬¡åœ¨å„ç³»ç»Ÿè¡¨å†…æ‰¾åˆ°å¯¹åº”è¿™å¼ ç”¨æˆ·è¡¨çš„ç›¸åº”è®°å½•ï¼Œç„¶åç”¨è¿™äº›å…ƒæ•°æ®è®°å½•æ„å»ºå‡ºç”¨æˆ·è¡¨çš„å†…å­˜å¯¹è±¡ã€‚</p>
<p>â€ƒâ€ƒ å…ƒæ•°æ®è¡¨æœ¬èº«å¯¹åº”çš„å†…å­˜å¯¹è±¡ç»“æ„æ˜¯ä» <code>Object_table</code> ç±»ä»æ´¾ç”Ÿå‡ºæ¥çš„ï¼Œæœ‰ <code>Entity_object_table_impl</code> å’Œ <code>Object_table_impl</code> ä¸¤å¤§ç±»ã€‚å‰è€…å¯¹åº”æŒä¹…åŒ–æœ‰å¯¹åº”å…·ä½“é”®å¯¹è±¡çš„åŸºæœ¬ DD è¡¨ï¼Œè€Œåè€…å¯¹åº”ç€ä¸å•ç‹¬å­˜åœ¨éœ€è¦é€šè¿‡å‰è€…å…³è”è®¿é—®çš„ DD è¡¨ï¼ˆä¸èƒ½ç›´æ¥è¢« createï¼Œsearchï¼Œdropï¼‰ï¼Œä¾‹å¦‚ä¸¤è€…åˆ†åˆ«å¯¹åº”æ´¾ç”Ÿå‡º <code>Tables</code>ã€<code>Tablespaces</code>ã€&hellip; å’Œ <code>Columns</code>ã€<code>Indexes</code>ã€&hellip; ç­‰å…·ä½“å†…å­˜ç»“æ„ä½“ï¼Œä¸€ä¸€å¯¹åº”å„å…ƒæ•°æ®ç³»ç»Ÿè¡¨ã€‚</p>
<p>â€ƒâ€ƒ å€¼å¾—ä¸€æï¼Œä¸Šé¢è¯´çš„è¿™äº›å†…å­˜å¯¹è±¡æ˜¯å…ƒæ•°æ®è¡¨æœ¬èº«çš„å†…å­˜å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è®¿é—®å…ƒæ•°æ®è¡¨æ‰€ä½¿ç”¨çš„å†…å­˜å¯¹è±¡ï¼Œè€ŒéæŸä¸€å¼ ç”¨æˆ·è¡¨çš„å†…å­˜å¯¹è±¡ã€‚ç±»ä¼¼çš„ï¼Œå¯¹äºä¸€å¼ ç”¨æˆ·è¡¨ï¼Œä¹Ÿæ˜¯é€šè¿‡å¯¹åº”çš„å…ƒæ•°æ®è®°å½•æ„å»ºå…¶å†…å­˜å¯¹è±¡ç»“æ„ã€‚ä¸€èˆ¬ä» <code>Entity_object_impl</code> ç±»ä»æ´¾ç”Ÿå‡ºæ¥çš„ï¼Œåƒå¸¸ç”¨çš„ <code>Table_impl</code> å’Œ <code>View_impl</code> åˆ†åˆ«è¡¨ç¤ºç”¨æˆ·è¡¨å’Œè§†å›¾å¯¹åº”å…ƒæ•°æ®çš„å†…å­˜å¯¹è±¡ã€‚</p>
<p>â€ƒâ€ƒ å½“ç¼“å­˜ç©¿é€æ—¶ï¼Œè¿™äº› objects çš„åº•å±‚æ“ä½œé€»è¾‘è¢«å°è£…åœ¨ <code>Storage_adapter</code> ä¸­ï¼Œé€šè¿‡æä¾›çš„ get() / drop() / store() ç­‰æ¥å£ï¼Œéå†æŸ¥è¯¢æˆ–ä¿®æ”¹æ‰€æœ‰æ‰€éœ€å…ƒæ•°æ®è¡¨ï¼ˆbtree ç»“æ„ï¼‰ä¸­å¯¹åº”çš„ recordï¼Œæ„å»ºæˆ–æŒä¹…æ€§ç›¸åº”çš„ object å†…å­˜å¯¹è±¡ç”±/åˆ°å¼•æ“å±‚ã€‚</p>
<h4 id="23-å…ƒæ•°æ®çš„-cache-ç¼“å­˜">2.3 å…ƒæ•°æ®çš„ cache ç¼“å­˜<a hidden class="anchor" aria-hidden="true" href="#23-å…ƒæ•°æ®çš„-cache-ç¼“å­˜">#</a></h4>
<p>â€ƒâ€ƒ ä»ä¸Šè¿°æ“ä½œä¸­å¯ä»¥çœ‹å‡ºï¼Œç›´æ¥ä»å…ƒæ•°æ®è¡¨æ„å»º DD object å†…å­˜å¯¹è±¡æ˜¯å¼€é”€ååˆ†å·¨å¤§çš„ï¼Œè¿‡ç¨‹ä¸­éœ€è¦ç‰©ç†è®¿é—®å¹¶ç´¢å¼•å¤šä¸ª Btree ç´¢å¼•ã€‚å› æ­¤ MySQL å»ºç«‹äº†å¤šå±‚çš„ DD Cache æ¥å°±å¯èƒ½å‡å°å…ƒæ•°æ®çš„è®¿é—®å¼€é”€ï¼Œä¸€èˆ¬ç§°ä¸ºå…ƒæ•°æ®çš„ 3 å±‚ç¼“å­˜æ¶æ„ï¼š</p>
<ul>
<li>æ¯ä¸ª client çš„ç‹¬äº«ç¼“å­˜ï¼Œå³çº¿ç¨‹ THD ç‹¬å çš„ <code>Dictionary_client</code> ç»“æ„ï¼Œå…¶ä¸­æœ‰ <em>committedã€uncommittedã€dropped ä¸‰ç±» objects map</em>ï¼Œæœ€åˆ <strong>acquire</strong> çš„ object ä¼šè¢«åŠ å…¥åˆ°committed map ä¸­ï¼Œclient è°ƒç”¨ <strong>store</strong> æˆ– <strong>update</strong> æ¥å£æ—¶å°† object æ”¾åˆ° uncommitted map ä¸­ï¼Œç„¶ååœ¨äº‹åŠ¡æäº¤åå°†ç›¸åº” objects ä» uncommitted map ç§»åˆ° committed map ä¸­ï¼Œè€Œè°ƒç”¨ <strong>drop</strong> æ¥å£ä¼šå°† objects åŠ å…¥ dropped mapã€‚å½“è®¿é—® Dictionary_client ç©¿é€æ—¶ï¼Œä» Shared_dictionary_cache è·å–ï¼›</li>
<li>Server å…¨å±€å”¯ä¸€çš„å…±äº«ç¼“å­˜ï¼Œä½¿ç”¨å•ä¾‹ <code>Shared_dictionary_cache</code> æ¥å®ç°ï¼Œå…¶å®è´¨ä¸Šä¹Ÿæ˜¯ objects map é›†åˆã€‚åœ¨æ­¤ç¼“å­˜å±‚ç›¸åŒ key å¯¹åº”çš„ DD objects å¯¹è±¡å”¯ä¸€ï¼Œè¿™é‡Œçš„ key å…¶å®å°±æ˜¯å¯¹åº”å…ƒæ•°æ®è¡¨çš„ç´¢å¼• keyã€‚å½“ Shared_dictionary_cache ç©¿é€æ—¶ï¼Œé€šè¿‡ <code>Storage_adapter</code> ä» InnoDB handler è¯»å–å…ƒæ•°æ®è¡¨è®°å½•ã€‚</li>
<li>å­˜å‚¨å¼•æ“å±‚ï¼ˆå…ƒæ•°æ®è¡¨æ•°æ®ç›´æ¥ BP ç¼“å­˜ï¼‰ï¼Œç³»ç»Ÿè¡¨çš„è®¿é—®æ¨¡å¼å’Œæ™®é€šç”¨æˆ·è¡¨åŸºæœ¬ä¸€è‡´ï¼Œæ³¨æ„é‡‡ç”¨çš„æ˜¯ <strong>READ_COMMITTED</strong> éš”ç¦»çº§åˆ«ã€‚</li>
</ul>
<h3 id="3-å…ƒæ•°æ®çš„ä½¿ç”¨">3. å…ƒæ•°æ®çš„ä½¿ç”¨<a hidden class="anchor" aria-hidden="true" href="#3-å…ƒæ•°æ®çš„ä½¿ç”¨">#</a></h3>
<h4 id="31-server-å±‚å…ƒæ•°æ®çš„ä½¿ç”¨">3.1 Server å±‚å…ƒæ•°æ®çš„ä½¿ç”¨<a hidden class="anchor" aria-hidden="true" href="#31-server-å±‚å…ƒæ•°æ®çš„ä½¿ç”¨">#</a></h4>
<p>â€ƒâ€ƒ å®ç°äº† DD å…ƒæ•°æ®çš„ç®¡ç†ï¼ŒMySQL å°±èƒ½å¤Ÿé€šè¿‡ä½¿ç”¨å…ƒæ•°æ®æ„å»ºè®¿é—®ç”¨æˆ·è¡¨çš„ç¯å¢ƒï¼Œè¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„â€œå¼€è¡¨â€é€»è¾‘ã€‚å‰é¢å·²ç»ä»‹ç»äº†å…ƒæ•°æ®è¡¨æœ¬èº«çš„å†…å­˜å¯¹è±¡ï¼Œé€šè¿‡è®¿é—®å…ƒæ•°æ®è¡¨ç›¸åº”è®°å½•ï¼Œç±»ä¼¼çš„å¯ä»¥æ„å»ºç”¨æˆ·è¡¨ï¼ˆæˆ–å…¶ä»–å†…å®¹ï¼Œå¦‚è§†å›¾ç­‰ï¼‰çš„å†…å­˜å¯¹è±¡ã€‚</p>
<p>â€ƒâ€ƒ æˆ‘ä»¬éœ€è¦çŸ¥é“ Server å±‚çš„ä¸¤ä¸ªå…³é”®ç»“æ„ä½“ <code>TABLE_SHARE</code> å’Œ <code>TABLE</code>:</p>
<ul>
<li>ä¸€å¼ è¡¨è¢«åˆæ¬¡è®¿é—®æ—¶ï¼ŒMySQL ä¼šå…¶å»ºç«‹ä¸€ä¸ª <strong>TABLE_SHARE</strong> å¯¹è±¡ï¼Œä¸å…¶ä¸å¼•æ“å±‚ä¸­çš„å¯¹åº”è¡¨ <code>dict_table_t</code> ç›¸å¯¹åº”å…³è”ã€‚TABLE_SHARE æ˜¯é™æ€çš„ï¼Œä¸èƒ½ä¿®æ”¹çš„ï¼Œä¸”ä¸€å¼ è¡¨åªå­˜åœ¨ä¸€ä»½ï¼Œå…¶ä¸­è®°å½•è¡¨å®šä¹‰ç›¸å…³çš„ä¸€äº› DD ä¿¡æ¯ï¼Œå¦‚åŒ…å«çš„å­—æ®µç­‰ã€‚TABLE_SHARE åªæœ‰åœ¨è¡¨ç»“æ„è¢«ä¿®æ”¹åæ‰ä¼šåˆ é™¤ï¼Œæˆ–è€…ç¼“å­˜ä½¿ç”¨æ»¡äº†ä¼šæ·˜æ±°ã€‚ç®€å•çš„è¯´ï¼ŒTABLE_SHARE å°±æ˜¯æŸå¼ è¡¨å®šä¹‰çš„å®ä½“åŒ–å¯¹è±¡ã€‚</li>
<li>å¯¹æ¯ä¸€ä¸ªä¼šè¯æŸ¥è¯¢ä¸­æ¶‰åŠçš„è¡¨ï¼ŒMySQL ä¼šé€šè¿‡ TABLE_SHARE ä¸ºæ¯ä¸ªè¡¨å»ºä¸€ä¸ª <strong>TABLE</strong> å®ä½“å¯¹è±¡ï¼Œè¿™ä¸€è¿‡ç¨‹å«è¡¨ç»“æ„å®ä¾‹åŒ–ã€‚å¦‚æœæ˜¯ InnoDB è¡¨è¿˜ä¼šåˆ›å»º InnoDB çš„ handlerï¼Œserver å±‚ä¼šè¯é€šè¿‡ TABLE å¯¹è±¡ç»å¼•æ“å±‚æ“ä½œè¡¨æ–‡ä»¶å®ä½“ã€‚å¯ä»¥å°† TABLE å¯¹è±¡çœ‹åšè¡¨åœ¨ server å±‚çš„æ˜ å°„ï¼Œå°† handler çœ‹åšå…¶ä¸ºæ“ä½œåº•å±‚æ•°æ®æ–‡ä»¶è€Œåœ¨å¼•æ“å±‚åˆ›å»ºçš„å¥æŸ„ã€‚</li>
</ul>
<p>â€ƒâ€ƒ â€œå¼€è¡¨â€é€»è¾‘å°±æ˜¯é€šè¿‡è®¿é—®å…ƒæ•°æ®æ¥è·å– TABLE_SHARE å’Œæ„å»º TABLE å®ä½“å¯¹è±¡çš„è¿‡ç¨‹ã€‚æˆ‘ä»¬å…·ä½“çœ‹ä¸‹ <code>open_table</code> çš„ä»£ç é€»è¾‘ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">bool</span> <span class="nf">open_table</span><span class="p">(</span><span class="n">THD</span> <span class="o">*</span><span class="n">thd</span><span class="p">,</span> <span class="n">Table_ref</span> <span class="o">*</span><span class="n">table_list</span><span class="p">,</span> <span class="n">Open_table_context</span> <span class="o">*</span><span class="n">ot_ctx</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Step 0. åšä¸€äº›å‰ç½®æ£€æŸ¥...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// Step 1. é™¤ç‰¹æ®Š DD è¡¨ç­‰åœºæ™¯ï¼ŒLOCK TABLES mode(LTM)ä¸‹æ ¡éªŒæ˜¯å¦è¡¨å¯¹è±¡éƒ½æ˜¯ pre-opened çš„ï¼›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// Step 2. é LTM æ¨¡å¼ï¼ˆé€šå¸¸çš„æ¨¡å¼ï¼‰ï¼Œæ ¹æ® mdl è¯·æ±‚æ¨¡å¼è·å– mdl é”ï¼›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MYSQL_OPEN_HAS_MDL_LOCK</span> <span class="o">|</span> <span class="n">MYSQL_OPEN_SECONDARY_ENGINE</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœéœ€è¦ write_lock mdlï¼Œè¿˜è¦è·å– global read lock ä¿è¯æ­£ç¡®å†²çªæ€§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">open_table_get_mdl_lock</span><span class="p">(</span><span class="n">thd</span><span class="p">,</span> <span class="n">ot_ctx</span><span class="p">,</span> <span class="n">table_list</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdl_ticket</span><span class="p">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="n">mdl_ticket</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* caller è·å–è¿‡ MDL é” */</span>
</span></span><span class="line"><span class="cl">    <span class="n">mdl_ticket</span> <span class="o">=</span> <span class="n">table_list</span><span class="o">-&gt;</span><span class="n">mdl_request</span><span class="p">.</span><span class="n">ticket</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Step 3. æ£€æŸ¥ç›®æ ‡è¡¨çš„å­˜åœ¨æ€§ï¼›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">table_list</span><span class="o">-&gt;</span><span class="n">open_strategy</span> <span class="o">==</span> <span class="n">Table_ref</span><span class="o">::</span><span class="n">OPEN_IF_EXISTS</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="n">table_list</span><span class="o">-&gt;</span><span class="n">open_strategy</span> <span class="o">==</span> <span class="n">Table_ref</span><span class="o">::</span><span class="n">OPEN_FOR_CREATE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">exists</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">check_if_table_exists</span><span class="p">(</span><span class="n">thd</span><span class="p">,</span> <span class="n">table_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exists</span><span class="p">))</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span> <span class="cm">/* ç©ºè¯» */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">exists</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* table ä¸å­˜åœ¨äº DDï¼Œå‡çº§åˆ° EXCLUSIVE MDL lock. */</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">table_list</span><span class="o">-&gt;</span><span class="n">open_strategy</span> <span class="o">==</span> <span class="n">Table_ref</span><span class="o">::</span><span class="n">OPEN_FOR_CREATE</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">          <span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MYSQL_OPEN_FORCE_SHARED_MDL</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl">                     <span class="n">MYSQL_OPEN_FORCE_SHARED_HIGH_PRIO_MDL</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">MDL_deadlock_handler</span> <span class="n">mdl_deadlock_handler</span><span class="p">(</span><span class="n">ot_ctx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">thd</span><span class="o">-&gt;</span><span class="n">push_internal_handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdl_deadlock_handler</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">bool</span> <span class="n">wait_result</span> <span class="o">=</span> <span class="n">thd</span><span class="o">-&gt;</span><span class="n">mdl_context</span><span class="p">.</span><span class="n">upgrade_shared_lock</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">table_list</span><span class="o">-&gt;</span><span class="n">mdl_request</span><span class="p">.</span><span class="n">ticket</span><span class="p">,</span> <span class="n">MDL_EXCLUSIVE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">thd</span><span class="o">-&gt;</span><span class="n">variables</span><span class="p">.</span><span class="n">lock_wait_timeout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">thd</span><span class="o">-&gt;</span><span class="n">pop_internal_handler</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* Deadlock or timeout occurred while upgrading the lock. */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">wait_result</span><span class="p">)</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">table_list</span><span class="o">-&gt;</span><span class="n">open_strategy</span> <span class="o">==</span> <span class="n">Table_ref</span><span class="o">::</span><span class="n">OPEN_STUB</span><span class="p">)</span> <span class="cm">/* åº•å±‚ä¸çœŸæ‰“å¼€ */</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Step 4. Table å­˜åœ¨ï¼Œå°è¯•å¼€è¡¨ï¼Œé¦–å…ˆä» table_cache_manager è¿™ä¸ªç¼“å­˜æ‰¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">retry_share</span> <span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Table_cache</span> <span class="o">*</span><span class="n">tc</span> <span class="o">=</span> <span class="n">table_cache_manager</span><span class="p">.</span><span class="n">get_cache</span><span class="p">(</span><span class="n">thd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">tc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">table_list</span><span class="o">-&gt;</span><span class="n">is_view</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">table</span> <span class="o">=</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">get_table</span><span class="p">(</span><span class="n">thd</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">key_length</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">share</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">table</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Case 1. æ‰¾åˆ°æœªä½¿ç”¨çš„ TABLE object */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MYSQL_OPEN_IGNORE_FLUSH</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="cm">/* æ£€æŸ¥ DD çš„ç‰ˆæœ¬æ˜¯å¦è¿‡è€æˆ–ä¸ä¸€è‡´ */</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">thd</span><span class="o">-&gt;</span><span class="n">open_tables</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">          <span class="n">thd</span><span class="o">-&gt;</span><span class="n">open_tables</span><span class="o">-&gt;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">()</span> <span class="o">!=</span> <span class="n">share</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ¸…ç†æ“ä½œ ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">tc</span><span class="o">-&gt;</span><span class="n">unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">table</span><span class="o">-&gt;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">rebind_psi</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">table</span><span class="o">-&gt;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">ha_extra</span><span class="p">(</span><span class="n">HA_EXTRA_RESET_STATE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">thd</span><span class="o">-&gt;</span><span class="n">status_var</span><span class="p">.</span><span class="n">table_open_cache_hits</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">table_found</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">share</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Case 2. æ— æœªä½¿ç”¨ TABLE å¯¹è±¡ï¼Œä½†æ˜¯æ‰¾åˆ°è¡¨çš„ TABLE_SHARE */</span>
</span></span><span class="line"><span class="cl">    <span class="n">mysql_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">LOCK_open</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">tc</span><span class="o">-&gt;</span><span class="n">unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">share</span><span class="o">-&gt;</span><span class="n">increment_ref_count</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">share_found</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* Case 3. æ— æœªä½¿ç”¨ TABLE å¯¹è±¡ï¼Œä¹Ÿæ— è¡¨çš„ TABLE_SHARE */</span>
</span></span><span class="line"><span class="cl">    <span class="n">tc</span><span class="o">-&gt;</span><span class="n">unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">mysql_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">LOCK_open</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Step 5. è·å– TABLE_SHAREï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1">// é¦–å…ˆä» table_def_cache ç¼“å­˜é‡Œæ‰¾ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1">// ç©¿é€æƒ…å†µä¸‹ç¡®è®¤ schema MDL é”åå»ºç«‹æ–° TABLE_SHAREï¼Œå¹¶ä»å…ƒæ•°æ®è¡¨è¯»å–è®°å½•å¡«å……ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">share</span> <span class="o">=</span> <span class="n">get_table_share_with_discover</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">thd</span><span class="p">,</span> <span class="n">table_list</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">key_length</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MYSQL_OPEN_SECONDARY_ENGINE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¤±è´¥æ¸…ç†æ“ä½œ ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">table_list</span><span class="o">-&gt;</span><span class="n">is_view</span><span class="p">()</span> <span class="o">||</span> <span class="n">share</span><span class="o">-&gt;</span><span class="n">is_view</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* å¦‚æœæ˜¯ view å¯¹è±¡æƒ…å†µä¸‹çš„å¤„ç† */</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// return ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">share_found</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MYSQL_OPEN_IGNORE_FLUSH</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">share</span><span class="o">-&gt;</span><span class="n">has_old_version</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// é‡Šæ”¾å¯¹ shard çš„ referenceï¼Œç­‰å¾…è€ç‰ˆæœ¬ table share æ›´æ–°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">release_table_share</span><span class="p">(</span><span class="n">share</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">mysql_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">LOCK_open</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">MDL_deadlock_handler</span> <span class="n">mdl_deadlock_handler</span><span class="p">(</span><span class="n">ot_ctx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kt">bool</span> <span class="n">wait_result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">thd</span><span class="o">-&gt;</span><span class="n">push_internal_handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdl_deadlock_handler</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">uint</span> <span class="n">deadlock_weight</span> <span class="o">=</span> <span class="n">ot_ctx</span><span class="o">-&gt;</span><span class="n">can_back_off</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                                 <span class="o">?</span> <span class="n">MDL_wait_for_subgraph</span><span class="o">::</span><span class="nl">DEADLOCK_WEIGHT_DML</span>
</span></span><span class="line"><span class="cl">                                 <span class="p">:</span> <span class="n">mdl_ticket</span><span class="o">-&gt;</span><span class="n">get_deadlock_weight</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="n">wait_result</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">          <span class="n">tdc_wait_for_old_version</span><span class="p">(</span><span class="n">thd</span><span class="p">,</span> <span class="n">table_list</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">,</span> <span class="n">table_list</span><span class="o">-&gt;</span><span class="n">table_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">ot_ctx</span><span class="o">-&gt;</span><span class="n">get_timeout</span><span class="p">(),</span> <span class="n">deadlock_weight</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">thd</span><span class="o">-&gt;</span><span class="n">pop_internal_handler</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">wait_result</span><span class="p">)</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">goto</span> <span class="n">retry_share</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">thd</span><span class="o">-&gt;</span><span class="n">open_tables</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="n">thd</span><span class="o">-&gt;</span><span class="n">open_tables</span><span class="o">-&gt;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">()</span> <span class="o">!=</span> <span class="n">share</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="cm">/* å¦‚æœ version æ”¹å˜ï¼Œè®©æ­¥åé‡æ–°å¼€è¡¨ */</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// æ¸…ç†æ“ä½œ ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">mysql_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">LOCK_open</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Step 6. ç”± TABLE_SHARE æ„å»º TABLE å¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">dd</span><span class="o">::</span><span class="n">cache</span><span class="o">::</span><span class="n">Dictionary_client</span><span class="o">::</span><span class="n">Auto_releaser</span> <span class="n">releaser</span><span class="p">(</span><span class="n">thd</span><span class="o">-&gt;</span><span class="n">dd_client</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">dd</span><span class="o">::</span><span class="n">Table</span> <span class="o">*</span><span class="n">table_def</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MYSQL_OPEN_NO_NEW_TABLE_IN_SE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="n">thd</span><span class="o">-&gt;</span><span class="n">dd_client</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">acquire</span><span class="p">(</span><span class="n">share</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">.</span><span class="n">str</span><span class="p">,</span> <span class="n">share</span><span class="o">-&gt;</span><span class="n">table_name</span><span class="p">.</span><span class="n">str</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="o">&amp;</span><span class="n">table_def</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">goto</span> <span class="n">err_lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">table_def</span> <span class="o">&amp;&amp;</span> <span class="n">table_def</span><span class="o">-&gt;</span><span class="n">hidden</span><span class="p">()</span> <span class="o">==</span> <span class="n">dd</span><span class="o">::</span><span class="n">Abstract_table</span><span class="o">::</span><span class="n">HT_HIDDEN_SE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">my_error</span><span class="p">(</span><span class="n">ER_NO_SUCH_TABLE</span><span class="p">,</span> <span class="n">MYF</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">table_list</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="n">table_list</span><span class="o">-&gt;</span><span class="n">table_name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">goto</span> <span class="n">err_lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* make a new table */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">table</span> <span class="o">=</span> <span class="p">(</span><span class="n">TABLE</span> <span class="o">*</span><span class="p">)</span><span class="n">my_malloc</span><span class="p">(</span><span class="n">key_memory_TABLE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">table</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                     <span class="n">MYF</span><span class="p">(</span><span class="n">MY_WME</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">      <span class="k">goto</span> <span class="n">err_lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">error</span> <span class="o">=</span> <span class="n">open_table_from_share</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">thd</span><span class="p">,</span> <span class="n">share</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MYSQL_OPEN_NO_NEW_TABLE_IN_SE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">             <span class="o">?</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">             <span class="o">:</span> <span class="p">((</span><span class="n">uint</span><span class="p">)(</span><span class="n">HA_OPEN_KEYFILE</span> <span class="o">|</span> <span class="n">HA_OPEN_RNDFILE</span> <span class="o">|</span> <span class="n">HA_GET_INDEX</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl">                       <span class="n">HA_TRY_READ_ONLY</span><span class="p">))),</span>
</span></span><span class="line"><span class="cl">        <span class="n">EXTRA_RECORD</span><span class="p">,</span> <span class="n">thd</span><span class="o">-&gt;</span><span class="n">open_options</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">table_def</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// æ¸…ç†æ“ä½œ ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">goto</span> <span class="n">err_lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">share</span><span class="o">-&gt;</span><span class="n">crashed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">switch</span> <span class="p">(</span><span class="n">thd</span><span class="o">-&gt;</span><span class="n">lex</span><span class="o">-&gt;</span><span class="n">sql_command</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SQLCOM_ALTER_TABLE</span><span class="p">:</span> <span class="k">case</span> <span class="nl">SQLCOM_REPAIR</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">SQLCOM_CHECK</span><span class="p">:</span> <span class="k">case</span> <span class="nl">SQLCOM_SHOW_CREATE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">          <span class="k">break</span><span class="p">;</span> <span class="c1">// å¯ä»¥å¤„ç†çš„ case
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// æ¸…ç†æ“ä½œ ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="k">goto</span> <span class="n">err_lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* Finalize the process of TABLE creation by loading table triggers */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">open_table_entry_fini</span><span class="p">(</span><span class="n">thd</span><span class="p">,</span> <span class="n">share</span><span class="p">,</span> <span class="n">table_def</span><span class="p">,</span> <span class="n">table</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// æ¸…ç†æ“ä½œ ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">goto</span> <span class="n">err_lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Step 7. å°†æ–°ç”Ÿæˆçš„ TABLE å¯¹è±¡åŠ å…¥å½“å‰è¿æ¥çš„ table cache
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Table_cache</span> <span class="o">*</span><span class="n">tc</span> <span class="o">=</span> <span class="n">table_cache_manager</span><span class="p">.</span><span class="n">get_cache</span><span class="p">(</span><span class="n">thd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">tc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">add_used_table</span><span class="p">(</span><span class="n">thd</span><span class="p">,</span> <span class="n">table</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">tc</span><span class="o">-&gt;</span><span class="n">unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="k">goto</span> <span class="n">err_lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">tc</span><span class="o">-&gt;</span><span class="n">unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">thd</span><span class="o">-&gt;</span><span class="n">status_var</span><span class="p">.</span><span class="n">table_open_cache_misses</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">table_found</span><span class="p">:</span> <span class="c1">// å½“å‰æœ‰äº† TABLE å¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">table</span><span class="o">-&gt;</span><span class="n">mdl_ticket</span> <span class="o">=</span> <span class="n">mdl_ticket</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">table</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">thd</span><span class="o">-&gt;</span><span class="n">open_tables</span><span class="p">;</span> <span class="cm">/* Link into simple list */</span>
</span></span><span class="line"><span class="cl">  <span class="n">thd</span><span class="o">-&gt;</span><span class="n">set_open_tables</span><span class="p">(</span><span class="n">table</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">table</span><span class="o">-&gt;</span><span class="n">reginfo</span><span class="p">.</span><span class="n">lock_type</span> <span class="o">=</span> <span class="n">TL_READ</span><span class="p">;</span> <span class="cm">/* Assume read */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">reset</span><span class="p">:</span> <span class="c1">// æˆåŠŸï¼Œåˆå§‹åŒ–è¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">table</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">table</span><span class="o">-&gt;</span><span class="n">set_created</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">table_list</span><span class="o">-&gt;</span><span class="n">set_updatable</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">table_list</span><span class="o">-&gt;</span><span class="n">set_insertable</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">table_list</span><span class="o">-&gt;</span><span class="n">table</span> <span class="o">=</span> <span class="n">table</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// skipping partitions bitmap setting in MYSQL_OPEN_NO_NEW_TABLE_IN_SE
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">table</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">thd</span><span class="p">,</span> <span class="n">table_list</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">err_lock</span><span class="p">:</span> <span class="c1">// å¤±è´¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">mysql_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">LOCK_open</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">release_table_share</span><span class="p">(</span><span class="n">share</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">mysql_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">LOCK_open</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>â€ƒâ€ƒ è€ƒè™‘æ‰€æœ‰ cache éƒ½ç©¿é€çš„æƒ…å†µï¼Œåˆ™æ­¤æ—¶åœ¨ <code>get_table_share</code> ä¸­ï¼Œé€šè¿‡ DD æ¥å£ä»å…ƒæ•°æ®è¡¨è¯»å–ç›¸åº”ï¼ˆè¡¨ï¼‰å¯¹è±¡çš„å…ƒæ•°æ®è®°å½•ï¼Œå†ä»¥ä¹‹å¡«å……æ–°ç”Ÿæˆçš„ TABLE_SHAREã€‚</p>
<h4 id="32-server-å±‚è¡¨å¯¹è±¡ç¼“å­˜">3.2 Server å±‚è¡¨å¯¹è±¡ç¼“å­˜<a hidden class="anchor" aria-hidden="true" href="#32-server-å±‚è¡¨å¯¹è±¡ç¼“å­˜">#</a></h4>
<p>â€ƒâ€ƒ ä»å‰é¢ <code>open_table</code>ä»£ç å¯è§ï¼Œè·å– TABLE_SHARE å’Œæ„å»º TABLE å®ä½“å¯¹è±¡è¿‡ç¨‹ä¸­ä¹Ÿæ¶‰åŠå¤šå±‚ cache ç¼“å­˜æœºåˆ¶ã€‚é¦–å…ˆæ˜¯ <code>Table_cache_manager</code> ç¼“å­˜äº† TABLE å¯¹è±¡ï¼Œç»´æŠ¤äº†æ‰€æœ‰æ­£åœ¨ä½¿ç”¨æˆ–æ›¾ç»æ‰“å¼€è¿‡çš„ TABLE å¯¹è±¡ï¼Œå…¶å¤§å°ç”± table_cache_size ç»´æŠ¤ï¼Œå†…éƒ¨æŒ‰ THD åˆ†ç‰‡ä¸º table_cache_instances ä¸ª <code>Table_cache</code>ã€‚æ¯ä¸ª <code>Table_cache</code> å†…éƒ¨ç”± object nameï¼ˆä¾‹å¦‚æŸå¼ ç”¨æˆ·è¡¨ï¼‰ æ˜ å°„åˆ° <code>Table_cache_element</code>ï¼Œå¯è§ <code>Table_cache_element</code> å”¯ä¸€å¯¹åº”ä¸€ä¸ª objectï¼Œå› æ­¤ä¹Ÿå”¯ä¸€å¯¹åº”ä¸€ä¸ª TABLE_SHAREï¼Œå…¶å†…éƒ¨é“¾æ¥äº†è¿™ä¸ªç¼“å­˜åˆ†ç‰‡å†…ä¸­çš„æ‰€æœ‰ç”±æ­¤ TABLE_SHARE ç”Ÿæˆçš„ TABLE å®ä¾‹ã€‚</p>
<p>â€ƒâ€ƒ å¦‚æœ <code>Table_cache_manager</code> ç¼“å­˜ç©¿é€ï¼Œåˆ™ä¼šå» <code>Table_definition_cache</code> ç¼“å­˜å¯»æ‰¾æ˜¯å¦æœ‰å­˜åœ¨ TABLE_SHARE å¯¹è±¡ï¼Œå…¶å¤§å°è®¾ç½®ä¸º <code>min(400 + table_cache_size / 2, 2000)</code>ã€‚ å¦‚æœ <code>Table_definition_cache</code> è¿›ä¸€æ­¥ç©¿é€ï¼Œåˆ™ä¼šå» InnoDB å±‚è¯»å–å…ƒæ•°æ®æ„å»º TABLE_SHAREã€‚</p>
<p>â€ƒâ€ƒ å¦å¤–ï¼Œåœ¨ InnoDB ä¹Ÿä¸ºæ¯ä¸€ä¸ª InnoDB è¡¨åŠ è½½ä¸€ä¸ªæ•°æ®å­—å…¸å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡çš„é›†åˆå°±æ˜¯ InnoDB ä¸­çš„ data dictionaryã€‚InnoDB çš„ dictionary system ä»¥ å…¨å±€ <code>dict_sys_t</code> ç®¡ç†ï¼Œè€Œå•ä¸ªè¡¨å¯¹è±¡å¯¹åº” <code>dict_table_t</code>ï¼Œç±»ä¼¼çš„ï¼Œç´¢å¼•å¯¹è±¡å¯¹åº” <code>dict_index_t</code>ï¼Œåˆ—å¯¹è±¡å¯¹åº” <code>dict_col_t</code> ç­‰ã€‚InnoDB åŒæ ·é€šè¿‡è¯»å–å…ƒæ•°æ®è¡¨è®°å½•æ¥æ„å»º <code>dict_table_t</code> å¯¹è±¡ï¼Œå¹¶ä¸” <code>dict_sys_t</code> ä¸­ä¹Ÿæœ‰ä¸¤ä¸ª <code>dict_table_t</code> ç¼“å­˜ï¼Œåˆ†åˆ«ä»¥ table name å’Œ table id è¿›è¡Œæ˜ å°„å…³è”ï¼Œå…¶æœ€å¤§å®¹é‡é™åˆ¶å’Œ <code>Table_definition_cache</code> ä¸€è‡´ã€‚</p>
<center><img loading="lazy" src="DD_cache.png" width="100%" /></center>
<hr>
<!-- copyright -->
<div class="admonition">
  <div class="admonition-content">
    <ul>
      <li>ç‰ˆæƒå£°æ˜ï¼šå¦‚éœ€è½¬è½½æˆ–å¼•ç”¨ï¼Œè¯·é™„åŠ æœ¬æ–‡é“¾æ¥å¹¶æ³¨æ˜æ¥æºã€‚</li>
    </ul>
  </div>
</div>
<!-- copyright -->

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://mzyee.github.io/tags/mysql/">MySQL</a></li>
      <li><a href="https://mzyee.github.io/tags/dd/">DD</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="https://mzyee.github.io/posts/mysql/redo/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>InnoDB Redo æ—¥å¿—ç³»ç»Ÿ</span>
  </a>
</nav>

  </footer>
<div>
  <div class="pagination__title">
    <span class="pagination__title-h" style="font-size: 20px;">ğŸ’¬ è¯„è®º</span>
    <hr />
  </div>
  <div id="tcomment"></div>
  <script src="https://cdn.staticfile.org/twikoo/1.6.25/twikoo.all.min.js"></script>
  <script>
    twikoo.init({
      envId: "https://mzyeee.netlify.app/.netlify/functions/twikoo",  
      el: "#tcomment",
      lang: 'zh-CN',
      region: 'ap-hongkong',
      path: window.TWIKOO_MAGIC_PATH || window.location.pathname,
    });
  </script>
</div>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://mzyee.github.io">MZY&#39;s Blog</a></span>
    <span>
        | Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a>
    </span>
    <span id="busuanzi_container">
        | Viewer
        <span class="fa fa-user"></span> <span id="busuanzi_value_site_uv"></span>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerHTML = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerHTML = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
