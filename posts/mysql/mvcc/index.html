<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>InnoDB MVCC é€»è¾‘å­¦ä¹  | MZY&#39;s Blog</title>
<meta name="keywords" content="MySQL, Undo, MVCC">
<meta name="description" content="InnoDB MVCC é€»è¾‘å­¦ä¹ ">
<meta name="author" content="Miao Zheyu">
<link rel="canonical" href="https://mzyee.github.io/posts/mysql/mvcc/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.78ed8947c1508d00bdf7a3061370dcaebcd4ba680f4567ec440d26a4043b4e64.css" integrity="sha256-eO2JR8FQjQC996MGE3DcrrzUumgPRWfsRA0mpAQ7TmQ=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://mzyee.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://mzyee.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://mzyee.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://mzyee.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://mzyee.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<meta property="og:title" content="InnoDB MVCC é€»è¾‘å­¦ä¹ " />
<meta property="og:description" content="InnoDB MVCC é€»è¾‘å­¦ä¹ " />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mzyee.github.io/posts/mysql/mvcc/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-05-01T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-05-01T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="InnoDB MVCC é€»è¾‘å­¦ä¹ "/>
<meta name="twitter:description" content="InnoDB MVCC é€»è¾‘å­¦ä¹ "/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://mzyee.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "MySQL",
      "item": "https://mzyee.github.io/posts/mysql/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "InnoDB MVCC é€»è¾‘å­¦ä¹ ",
      "item": "https://mzyee.github.io/posts/mysql/mvcc/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "InnoDB MVCC é€»è¾‘å­¦ä¹ ",
  "name": "InnoDB MVCC é€»è¾‘å­¦ä¹ ",
  "description": "InnoDB MVCC é€»è¾‘å­¦ä¹ ",
  "keywords": [
    "MySQL", "Undo", "MVCC"
  ],
  "articleBody": "è¡Œè®°å½•å¤šç‰ˆæœ¬çš„å®ç°é€»è¾‘ åœ¨åˆæ­¥äº†è§£ undo ç³»ç»Ÿ å’Œ purge ç³»ç»Ÿåï¼Œæˆ‘ä»¬æ¥è¿›ä¸€æ­¥äº†è§£ InnoDB MVCC é€»è¾‘ã€‚\nInnoDB MVCC åŸºäº Undo log å®ç°ï¼Œé€šè¿‡ä¸»é”®è®°å½•ä¸Šç”± roll_ptr ä¸²è”çš„ undo reocrd æ¥æ„å»ºè®¿é—®éœ€è¦çš„å†å² record ç‰ˆæœ¬ã€‚InnoDB è¡¨æ•°æ®ç»„ç»‡æ–¹å¼æ˜¯ä¸»é”®èšç°‡ç´¢å¼•ï¼Œé€šè¿‡ undo æ„å»ºè€ç‰ˆæœ¬çš„é€»è¾‘ä¹Ÿåªæ˜¯å¯¹äºä¸»é”®ç´¢å¼•è€Œè¨€çš„ï¼ŒäºŒçº§ç´¢å¼•ä¸å­˜åœ¨å¯¹åº” undo recordã€‚InnoDB äºŒçº§ç´¢å¼•é€šè¿‡ç´¢å¼•é”®å€¼åŠ ä¸»é”®å€¼ç»„åˆæ¥å”¯ä¸€ç¡®å®šä¸€æ¡è®°å½•ï¼Œå› æ­¤å¯¹äºä¸€æ¡äºŒçº§ç´¢å¼•è®°å½•ï¼ˆåŒ…æ‹¬ delete_mark çŠ¶æ€çš„ï¼‰ï¼Œå…¶å¯¹åº”äº†ä¸€æ¡ undo è¦†ç›–å†å²èŒƒå›´å­˜åœ¨çš„ä¸»é”®è®°å½•ï¼ˆå¯èƒ½æ˜¯å½“å‰å­˜åœ¨çš„ç‰ˆæœ¬ï¼Œä¹Ÿå¯èƒ½æ˜¯æ„å»ºçš„å†å²ç‰ˆæœ¬ï¼‰ã€‚\nåŒæ—¶ï¼Œè®¿é—®é€šè¿‡ ReadView æ¥åˆ¤æ–­å†å²ç‰ˆæœ¬çš„æ•°æ®å¯è§æ€§ã€‚å¯¹äºä¸»é”®è®°å½•å®é™…ä¸Šæ˜¯åˆ¤æ–­å†å²ä¸»é”® record ä¸Šçš„ tidï¼‰ã€‚å› æ­¤ï¼Œå½“äºŒçº§ç´¢å¼•è®°å½•æ— æ³•é€šè¿‡å…¶ page ä¸Šçš„ max tid è¿‡æ»¤æ—¶ï¼Œéœ€è¦æ‰¾åˆ°ï¼ˆå¯èƒ½éœ€è¦é€šè¿‡ undo æ„å»ºï¼‰å…¶å¯¹åº”çš„ä¸»é”®è®°å½•ç‰ˆæœ¬å†æ¥åˆ¤æ–­å¯è§æ€§ã€‚\nInnoDB é€šè¿‡å‡½æ•° trx_undo_prev_version_build æ„å»ºèšé›†ç´¢å¼•è®°å½•çš„å‰ä¸€ä¸ªç‰ˆæœ¬ï¼Œè¿™ä¸ªå‡½æ•°ä¼šä½¿ç”¨åœ¨ï¼š MVCC è¯»å–è·¯å¾„ï¼ˆrow_vers_build_for_[semi_]consistent_readï¼‰ï¼› Purge/Undo è·¯å¾„ï¼ˆrow_vers_old_has_index_entryï¼‰ï¼› äºŒçº§ç´¢å¼•éšå¼é”åˆ¤æ–­ï¼ˆrow_vers_find_matchingï¼‰ç­‰è·¯å¾„ä¸Šã€‚\næ„å»ºè€ç‰ˆæœ¬è®°å½• trx_undo_prev_version_build ç”¨æ¥æ„å»ºå‰ä¸€ä¸ªç‰ˆæœ¬çš„ä¸»é”®ç´¢å¼•è®°å½•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 /** æ„å»ºèšé›†ç´¢å¼•è®°å½•æŸä¸ªç‰ˆæœ¬ rec çš„å†å‰ä¸€ä¸ªç‰ˆæœ¬ã€‚ è°ƒç”¨è€…å¿…é¡»æŒæœ‰èšé›†ç´¢å¼•è®°å½•ç´¢å¼•é¡µçš„é”ã€‚*/ bool trx_undo_prev_version_build(const rec_t *index_rec, mtr_t *index_mtr, const rec_t *rec, const dict_index_t *index, ulint *offsets, mem_heap_t *heap, rec_t **old_vers, mem_heap_t *v_heap, const dtuple_t **vrow, ulint v_status, lob::undo_vers_t *lob_undo) { trx_undo_rec_t *undo_rec = nullptr; dtuple_t *entry; trx_id_t rec_trx_id; ulint type; undo_no_t undo_no; table_id_t table_id; trx_id_t trx_id; roll_ptr_t roll_ptr; upd_t *update = nullptr; byte *ptr; ulint info_bits; ulint cmpl_info; bool dummy_extern; byte *buf; roll_ptr = row_get_rec_roll_ptr(rec, index, offsets); *old_vers = nullptr; /* insert undoï¼ˆè¯´æ˜æ˜¯ä¸²ä¸Šç¬¬ä¸€ä¸ªè®°å½•ï¼‰*/ if (trx_undo_roll_ptr_is_insert(roll_ptr)) { return true;} rec_trx_id = row_get_rec_trx_id(rec, index, offsets); bool is_temp = index-\u003etable-\u003eis_temporary(); // è·å– undo_rec æ—¶ä¼šåˆ¤æ–­ rec_trx_id æ˜¯å¦è¢« purge_sys-\u003eview å¯è§ if (trx_undo_get_undo_rec(roll_ptr, rec_trx_id, heap, is_temp, index-\u003etable-\u003ename, \u0026undo_rec)) { // å½“å‰ rec_trx_id åœ¨ purge_sys-\u003eview å¯è§ï¼Œæ›´è€çš„ï¼ˆprevï¼‰undo å¯èƒ½ç‰ˆæœ¬éƒ½è¢«å¤„ç†äº† if (v_status \u0026 TRX_UNDO_PREV_IN_PURGE) { /* å‡½æ•°è¢« purge æµç¨‹ä¸­è°ƒç”¨çš„ç‰¹æ®Šæƒ…å†µï¼Œç”¨äº virtual row å¤„ç† */ undo_rec = trx_undo_get_undo_rec_low(roll_ptr, heap, is_temp); } else { /* æ­£å¸¸æƒ…å†µï¼Œæ›´è€ä¸€ä¸ªç‰ˆæœ¬çš„ undo ä¸å®‰å…¨ï¼Œåˆ°å½“å‰ç‰ˆæœ¬ä¸ºæ­¢ */ return false; } } // è§£æè·å–åˆ°çš„å¯¹åº”ä¸Šä¸€ç‰ˆæœ¬çš„ undo rec type_cmpl_t type_cmpl; ptr = trx_undo_rec_get_pars(undo_rec, \u0026type, \u0026cmpl_info, \u0026dummy_extern, \u0026undo_no, \u0026table_id, type_cmpl); if (table_id != index-\u003etable-\u003eid) return true; /*table è¢«é‡å»ºï¼Œpurge é‡åˆ°è€ id çš„ undo*/ ptr = trx_undo_update_rec_get_sys_cols(ptr, \u0026trx_id, \u0026roll_ptr, \u0026info_bits); ptr = trx_undo_rec_skip_row_ref(ptr, index); // é€šè¿‡ undo æ„å»º upd_t *update ptr = trx_undo_update_rec_get_update(ptr, index, type, trx_id, roll_ptr, info_bits, heap, \u0026update, lob_undo, type_cmpl); ut_a(ptr); if (row_upd_changes_field_size_or_external(index, offsets, update)) { /* å¦‚æœå‰ä¸€ä¸ªç‰ˆæœ¬è®°å½•æ˜¯è¢«æ ‡è®°åˆ é™¤çš„ï¼Œå¹¶ä¸”å­˜åœ¨ disowned çš„ blobï¼Œ åˆ™éœ€è¦åˆ¤æ–­å¯è§æ€§è¿™ä¸ªç‰ˆæœ¬è®°å½•çš„å¯è§æ€§ï¼Œ å¦‚æœ purge å¯è§ï¼Œå°†å…¶è§†ä¸º missing history å¤„ç†ï¼Œ è¿™æ˜¯å› ä¸ºä¸Šä¸€ç‰ˆæœ¬è®°å½• disowned çš„ blob å¯èƒ½å·²ç»è¢« purge äº†ã€‚ å¯ä»¥çœç•¥ row_upd_changes_disowned_external(update) è°ƒç”¨ï¼Œ ä½†è¿™æ · purge_sys-\u003elatch åŠ é”æ›´å¤šï¼Œæ€§èƒ½å¼€é”€å¯æ›´é«˜ã€‚*/ if ((update-\u003einfo_bits \u0026 REC_INFO_DELETED_FLAG) \u0026\u0026 row_upd_changes_disowned_external(update)) { bool missing_ext; rw_lock_s_lock(\u0026purge_sys-\u003elatch, UT_LOCATION_HERE); missing_ext = purge_sys-\u003eview.changes_visible(trx_id, index-\u003etable-\u003ename); rw_lock_s_unlock(\u0026purge_sys-\u003elatch); if (missing_ext) { /* treat as a fresh insert, not to cause assertion error at the caller. */ if (update != nullptr) { update-\u003ereset(); } return true; } } // é€šè¿‡ undo è¿˜åŸ entry = row_rec_to_index_entry(rec, index, offsets, heap); row_upd_index_replace_new_col_vals(entry, index, update, heap); buf = static_cast\u003cbyte *\u003e(mem_heap_alloc(heap, rec_get_converted_size(index, entry))); *old_vers = rec_convert_dtuple_to_rec(buf, index, entry); } else { buf = static_cast\u003cbyte *\u003e(mem_heap_alloc(heap, rec_offs_size(offsets))); *old_vers = rec_copy(buf, rec, offsets); // é€šè¿‡ undo è¿˜åŸ row_upd_rec_in_place(*old_vers, index, offsets, update, nullptr); } /* Set the old value (which is the after image of an update) in the update vector to dtuple vrow */ if (v_status \u0026 TRX_UNDO_GET_OLD_V_VALUE) row_upd_replace_vcol((dtuple_t *)*vrow, index-\u003etable, update, false, nullptr, nullptr); if (vrow \u0026\u0026 !(cmpl_info \u0026 UPD_NODE_NO_ORD_CHANGE)) { // æ„å»ºè€ç‰ˆæœ¬çš„ virtual row // ... } if (update != nullptr) { update-\u003ereset(); } return true; } MVCC ä¸€è‡´æ€§è¯»å–è·¯å¾„ ä»¥ row_search_mvcc æŸ¥è¯¢ä¸ºä¾‹ï¼Œå½“ cursor å®šä½åˆ°ç¡®åˆ‡ user_record ä¸Šåï¼Œå¦‚æœæ˜¯æ— é”ä¸€è‡´æ€§ MVCC è¯»å¹¶ä¸”éš”ç¦»çº§åˆ«å¤§äº READ_UNCOMMITTED æ—¶ï¼Œæ­¤æ—¶ä¼šé€šè¿‡æŸ¥è¯¢æ‰€æŒæœ‰çš„ readview åˆ¤æ–­å¯¹åº”è®°å½•æ˜¯å¦å¯è§ï¼ˆlock_clust/sec_rec_cons_read_seesï¼‰ï¼Œå¯¹äºäºŒçº§ç´¢å¼•æ— æ³•åˆ¤æ–­æ˜¯è¿˜éœ€è¦å›è¡¨åˆ°ä¸»é”®ä¸Šå¤„ç†ï¼Œå¯¹äºä¸»é”®ç´¢å¼•å¦‚æœæ­¤è®°å½•ä¸å¯è§ï¼Œåˆ™ä¼šé€šè¿‡ row_vers_build_for_consistent_read æ„å»ºç›®æ ‡ readview å¯è§çš„å†å²è¡Œè®°å½•ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 /** æ„å»ºä¸€è‡´æ€§è¯»å–åº”è¯¥çœ‹åˆ°çš„èšé›†ç´¢å¼•è®°å½•çš„ç‰ˆæœ¬ã€‚ å‡½æ•°å‡è®¾å½“å‰ rec ä¸Šçš„äº‹åŠ¡ id æ˜¯ä¸€è‡´æ€§è¯»å–ä¸åº”è¯¥çœ‹åˆ°çš„ã€‚*/ dberr_t row_vers_build_for_consistent_read( const rec_t *rec, // èšé›†ç´¢å¼•ä¸­çš„è®°å½•ï¼Œè°ƒç”¨è€…å¿…é¡»æŒæœ‰ page latchï¼Œå³è¯¥è®°å½•ç‰ˆæœ¬å †æ ˆçš„é¡¶éƒ¨ mtr_t *mtr, // æŒæœ‰ rec ä¸Šé”çš„ mtrï¼Œå¹¶ä¸”è¿˜å°†æŒæœ‰ purge_view ä¸Šçš„é” dict_index_t *index, ulint **offsets, ReadView *view, // ç›®æ ‡è§†å›¾ mem_heap_t **offset_heap, mem_heap_t *in_heap, rec_t **old_vers, const dtuple_t **vrow, lob::undo_vers_t *lob_undo // å¦‚æœéœ€è¦åº”ç”¨ blob çš„ undo log ) { const rec_t *version; rec_t *prev_version; trx_id_t trx_id; mem_heap_t *heap = nullptr; byte *buf; dberr_t err; trx_id = row_get_rec_trx_id(rec, index, *offsets); if (lob_undo != nullptr) { lob_undo-\u003ereset(); } version = rec; for (;;) { mem_heap_t *prev_heap = heap; heap = mem_heap_create(1024, UT_LOCATION_HERE); if (vrow) { *vrow = nullptr; } bool purge_sees = trx_undo_prev_version_build(rec, mtr, version, index, *offsets, heap, \u0026prev_version, nullptr, vrow, 0, lob_undo); err = (purge_sees) ? DB_SUCCESS : DB_MISSING_HISTORY; // purge viewï¼ˆä¹Ÿæ˜¯æœ€è€çš„ readviewï¼‰å¯è§ï¼Œå› æ­¤ undo å¯èƒ½è¢« purge if (prev_heap != nullptr) { mem_heap_free(prev_heap); } if (prev_version == nullptr) { /* ä¸å­˜åœ¨æ›´è€çš„å¯¹åº”ä¸»é”®ç‰ˆæœ¬ */ *old_vers = nullptr; break; } *offsets = rec_get_offsets(prev_version, index, *offsets, ULINT_UNDEFINED, UT_LOCATION_HERE, offset_heap); trx_id = row_get_rec_trx_id(prev_version, index, *offsets); if (view-\u003echanges_visible(trx_id, index-\u003etable-\u003ename)) { /* ä¸€ç›´æ‰¾åˆ°ç¬¬ä¸€ä¸ª view å¯è§çš„ç›®æ ‡å†å²è¡Œè®°å½•å copy å¹¶é€€å‡º */ buf = static_cast\u003cbyte *\u003e(mem_heap_alloc(in_heap, rec_offs_size(*offsets))); *old_vers = rec_copy(buf, prev_version, *offsets); if (vrow \u0026\u0026 *vrow) { *vrow = dtuple_copy(*vrow, in_heap); dtuple_dup_v_fld(*vrow, in_heap); } break; } version = prev_version; } mem_heap_free(heap); return err; } Purge/Undo è·¯å¾„ å½“éœ€è¦ä»äºŒçº§ç´¢å¼• purge æ ‡è®°åˆ é™¤çš„è¡Œæ—¶ï¼Œä¼šæ£€æŸ¥æ˜¯å¦å­˜åœ¨ä¸€ä¸ªæœªè¢«æ ‡è®°åˆ é™¤çš„ã€å¤§äºç­‰äº purge view èŒƒå›´çš„ã€ä¸”ä¸ purge ç›®æ ‡äºŒçº§ç´¢å¼•è®°å½•å­—ç¬¦é›†æ’åºç›¸ç­‰çš„ä¸»é”®è¡Œè®°å½•ç‰ˆæœ¬ï¼Œå¦‚æœå­˜åœ¨ï¼ˆå½“å‰äºŒçº§ç´¢å¼•è¿˜ä¼šä½¿ç”¨ï¼‰ï¼Œåˆ™ä¸ä¼š purge è¿™ä¸ªäºŒçº§ç´¢å¼•è®°å½•ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 /** æ£€æŸ¥æ˜¯å¦å­˜åœ¨æŸä¸ªå¤§äºç­‰äº purge view çš„éæ ‡è®°åˆ é™¤è¡Œè®°å½•ç‰ˆæœ¬ï¼ˆä¸å¯æ¸…ç†ï¼‰å’Œç›®æ ‡äºŒçº§ç´¢å¼•ä¸€è‡´ */ bool row_vers_old_has_index_entry( bool also_curr, /*!\u003c in: true if also rec is included in the versions to search; otherwise only versions prior to it are searched */ const rec_t *rec, /*!\u003c in: record in the clustered index; the caller must have a latch on the page */ mtr_t *mtr, /*!\u003c in: mtr holding the latch on rec; it will also hold the latch on purge_view */ dict_index_t *index, /*!\u003c in: the secondary index */ const dtuple_t *ientry, /*!\u003c in: the secondary index entry */ roll_ptr_t roll_ptr, /*!\u003c in: roll_ptr for the purge record */ trx_id_t trx_id) /*!\u003c in: transaction ID on the purging record */ { const rec_t *version; rec_t *prev_version; dict_index_t *clust_index; ulint *clust_offsets; mem_heap_t *heap; mem_heap_t *heap2; dtuple_t *row; const dtuple_t *entry; ulint comp; const dtuple_t *vrow = nullptr; mem_heap_t *v_heap = nullptr; const dtuple_t *cur_vrow = nullptr; clust_index = index-\u003etable-\u003efirst_index(); comp = page_rec_is_comp(rec); heap = mem_heap_create(1024, UT_LOCATION_HERE); clust_offsets = rec_get_offsets(rec, clust_index, nullptr, ULINT_UNDEFINED, UT_LOCATION_HERE, \u0026heap); if (dict_index_has_virtual(index)) v_heap = mem_heap_create(100, UT_LOCATION_HERE); // also_curr == trueï¼Œæ£€æŸ¥é delete_mark çš„å½“å‰ rec æ˜¯å¦å’ŒäºŒçº§ç´¢å¼•åŒ¹é… if (also_curr \u0026\u0026 !rec_get_deleted_flag(rec, comp)) { row_ext_t *ext; row = row_build(ROW_COPY_POINTERS, clust_index, rec, clust_offsets, nullptr, nullptr, nullptr, \u0026ext, heap); if (dict_index_has_virtual(index)) { // å­˜åœ¨ virtual row å¤„ç† ... } else { // æ„å»ºäºŒçº§ç´¢å¼•å¯¹åº” dtuple_t *entry entry = row_build_index_entry(row, ext, index, heap); // å­—ç¬¦é›†ï¼ˆébinaryï¼‰æ¯”è¾ƒè¾“å…¥ç›®æ ‡ ientry å’Œä¸»é”®äºŒçº§ç´¢å¼•éƒ¨åˆ†æ˜¯å¦ä¸€è‡´ if (entry \u0026\u0026 dtuple_coll_eq(entry, ientry)) { mem_heap_free(heap); if (v_heap) { mem_heap_free(v_heap); } return true; } } } else if (dict_index_has_virtual(index)) { // å­˜åœ¨ virtual row å¤„ç† ... } version = rec; // æ£€æŸ¥æ˜¯å¦å­˜åœ¨é delete_mark çš„è€ç‰ˆæœ¬ rec å’ŒäºŒçº§ç´¢å¼•åŒ¹é… for (;;) { heap2 = heap; heap = mem_heap_create(1024, UT_LOCATION_HERE); vrow = nullptr; // æ„å»ºå‰ä¸€ä¸ªç‰ˆæœ¬è¡Œè®°å½• trx_undo_prev_version_build( rec, mtr, version, clust_index, clust_offsets, heap, \u0026prev_version, nullptr, dict_index_has_virtual(index) ? \u0026vrow : nullptr, 0, nullptr); mem_heap_free(heap2); if (!prev_version) { /* ä¸å­˜åœ¨æ›´è€çš„ï¼ˆpurge å®‰å…¨ï¼‰ç‰ˆæœ¬ */ mem_heap_free(heap); if (v_heap) mem_heap_free(v_heap); return false; } clust_offsets = rec_get_offsets(prev_version, clust_index, nullptr, ULINT_UNDEFINED, UT_LOCATION_HERE, \u0026heap); if (dict_index_has_virtual(index)) { /* å­˜åœ¨ virtual row å¤„ç† ... */ } if (!rec_get_deleted_flag(prev_version, comp)) { row_ext_t *ext; row = row_build(ROW_COPY_POINTERS, clust_index, prev_version, clust_offsets, nullptr, nullptr, nullptr, \u0026ext, heap); if (dict_index_has_virtual(index)) {/* å­˜åœ¨ virtual row å¤„ç† ... */} // æ„å»ºäºŒçº§ç´¢å¼•å¯¹åº” dtuple_t *entry entry = row_build_index_entry(row, ext, index, heap); /* If entry == NULL, the record contains unset BLOB pointers. This cheated be a freshly inserted record that can ignore. */ // å­—ç¬¦é›†ï¼ˆébinaryï¼‰æ¯”è¾ƒè¾“å…¥ç›®æ ‡ ientry å’Œä¸»é”®äºŒçº§ç´¢å¼•éƒ¨åˆ†æ˜¯å¦ä¸€è‡´ if (entry \u0026\u0026 dtuple_coll_eq(entry, ientry)) { mem_heap_free(heap); if (v_heap) { mem_heap_free(v_heap); } return true; } } version = prev_version; } } äºŒçº§ç´¢å¼•éšå¼é”åˆ¤æ–­ åœ¨åšäºŒçº§ç´¢å¼•è®°å½•å¯è§ä¸‹åˆ¤æ–­æ—¶ï¼Œå½“æ— æ³•ä½¿ç”¨äºŒçº§ç´¢å¼• page max tid åšè¿‡æ»¤æ—¶ï¼Œéœ€è¦å›è¡¨ä¸»é”®å»æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä¸€ä¸ªæ´»è·ƒäº‹åŠ¡æ’å…¥æˆ–ä¿®æ”¹äº†å¯¹åº”çš„äºŒçº§ç´¢å¼•è®°å½•ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 /* æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨ match/unmatch çš„ä¸»é”®è®°å½•ç‰ˆæœ¬ï¼Œ ç›®å‰å¦‚æœ sec rec æ˜¯æ ‡è®°åˆ é™¤çš„åˆ™å¯»æ‰¾æ˜¯å¦æœ‰ match çš„è®°å½•ç‰ˆæœ¬ï¼Œ å¦‚æœ sec rec æ˜¯éæ ‡è®°åˆ é™¤çš„åˆ™å»å¯»æ‰¾æ˜¯å¦æœ‰é match çš„è®°å½•ç‰ˆæœ¬ */ static bool row_vers_find_matching( bool looking_for_match, const dict_index_t *const clust_index, const rec_t *const clust_rec, ulint *\u0026clust_offsets, const dict_index_t *const sec_index, const rec_t *const sec_rec, const ulint *const sec_offsets, const bool comp, const trx_id_t trx_id, // å½“å‰ cluster rec å¯¹åº”çš„ tidï¼Œå¿…ç„¶æ˜¯æ´»è·ƒçš„ mtr_t *const mtr, mem_heap_t *\u0026heap) { const rec_t *version = clust_rec; trx_id_t version_trx_id = trx_id; // è¿™é‡Œæ˜¯å›è¡¨åˆ°çš„å½“å‰ç´¢å¼•ä¸Š cluster_rec å¯¹åº” tid è¿˜æ´»è·ƒï¼Œä½†æ˜¯ sec_rec å¯èƒ½å’Œä¸æ˜¯è¿™ä¸ª tid äº§ç”Ÿçš„ï¼Œä»è¦è¿›ä¸€æ­¥åˆ¤æ–­ // åªéœ€è¦å¯»æ‰¾å½“å‰ç´¢å¼• cluster_rec å¯¹åº” tid äº§ç”Ÿçš„è®°å½•ï¼Œå¦‚æœæ˜¯æ›´è€çš„ tid äº§ç”Ÿçš„è¿™ä¸ª sec_recï¼Œç”±äºè¿™ä¸ªè¡Œè®°å½•å¯ä»¥è¢«åç»­ tid ä¿®æ”¹ï¼Œå…¶ä¸€å®šå·²ç»ä¸æ´»è·ƒäº† while (version_trx_id == trx_id) { mem_heap_t *old_heap = heap; const dtuple_t *clust_vrow = nullptr; rec_t *prev_version = nullptr; heap = mem_heap_create(1024, UT_LOCATION_HERE); // å¯»æ‰¾å‰ä¸€ä¸ªä¸»é”®è®°å½•ç‰ˆæœ¬ trx_undo_prev_version_build( clust_rec, mtr, version, clust_index, clust_offsets, heap, \u0026prev_version, nullptr, dict_index_has_virtual(sec_index) ? \u0026clust_vrow : nullptr, 0, nullptr); mem_heap_free(old_heap); version = prev_version; if (version == nullptr) { version_trx_id = 0; } else { clust_offsets = rec_get_offsets(version, clust_index, nullptr, ULINT_UNDEFINED, UT_LOCATION_HERE, \u0026heap); version_trx_id = row_get_rec_trx_id(version, clust_index, clust_offsets); } /* ï¼è¿™é‡Œéœ€è¦åˆ¤æ–­æ˜¯å¦ç”±å¯¹åº”ç‰ˆæœ¬ä¸»é”® prev version åˆ°è¿™ä¸ªç‰ˆæœ¬è¿™æ¬¡ â€œä¿®æ”¹â€ è€Œäº§ç”Ÿçš„ sec_recï¼š sec_rec æ˜¯ non-delete markedï¼ˆlooking_for_match = falseï¼‰ï¼š å¦‚æœå‘ç° prev version æ˜¯ delete mark çš„æˆ– version äºŒçº§ç´¢å¼•éƒ¨åˆ†ä¸ sec_rec ä¸ä¸€è‡´ï¼ˆä¸ matchï¼‰ï¼Œ è¯´æ˜æ˜¯ç”±è¿™ä¸ªç‰ˆæœ¬ version ä¿®æ”¹äº§ç”Ÿçš„è¿™ä¸ª sec_recï¼ˆè€ç‰ˆæœ¬è¢«æ›´æ–°è¿‡ï¼‰ï¼Œ å› æ­¤ä»æ´»è·ƒã€‚ ï¼ˆsec_rec æ´»è·ƒï¼Œprev version éæ´»è·ƒ æˆ– ä¸ä¸€è‡´ æ—¶ï¼Œåˆ™è¯´æ˜å¯¹ prev version çš„ä¿®æ”¹å¯¼è‡´æ­¤ sec_rec äº§ç”Ÿï¼‰ sec_rec æ˜¯ delete markedï¼ˆlooking_for_match = trueï¼‰ï¼š å¦‚æœå‘ç° prev version æ˜¯ é delete mark ä¸” version äºŒçº§ç´¢å¼•éƒ¨åˆ†ä¸ sec_rec ä¸€è‡´ï¼ˆmatchï¼‰ï¼Œ è¯´æ˜æ˜¯ç”±è¿™ä¸ªç‰ˆæœ¬ version ä¿®æ”¹äº§ç”Ÿçš„è¿™ä¸ª sec_recï¼ˆè€ç‰ˆæœ¬è¢«æ›´æ–°è¿‡ï¼‰ï¼Œ å› æ­¤ä»æ´»è·ƒã€‚ï¼Œ ï¼ˆsec_rec éæ´»è·ƒï¼Œprev version æ´»è·ƒ ä¸” ä¸€è‡´ æ—¶ï¼Œåˆ™è¯´æ˜å¯¹ prev version çš„ä¿®æ”¹å¯¼è‡´æ­¤ sec_rec äº§ç”Ÿï¼‰ */ if (row_clust_vers_matches_sec( clust_index, version, clust_vrow, clust_offsets, sec_index, sec_rec, sec_offsets, comp, looking_for_match, heap) == looking_for_match) { return true; } } return false; } ç‰ˆæƒå£°æ˜ï¼šå¦‚éœ€è½¬è½½æˆ–å¼•ç”¨ï¼Œè¯·é™„åŠ æœ¬æ–‡é“¾æ¥å¹¶æ³¨æ˜æ¥æºã€‚ ",
  "wordCount" : "1699",
  "inLanguage": "zh",
  "datePublished": "2024-05-01T00:00:00Z",
  "dateModified": "2024-05-01T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Miao Zheyu"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://mzyee.github.io/posts/mysql/mvcc/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "MZY's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://mzyee.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://mzyee.github.io" accesskey="h" title=" MZY&#39;s Blog (Alt + H)">
                <img src="https://mzyee.github.io/img/eye.jpg" alt="" aria-label="logo"
                    height="38"> MZY&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://mzyee.github.io/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://mzyee.github.io/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://mzyee.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://mzyee.github.io/contact" title="Contact">
                    <span>Contact</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://mzyee.github.io">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://mzyee.github.io/posts/">Posts</a>&nbsp;Â»&nbsp;<a href="https://mzyee.github.io/posts/mysql/">MySQL</a></div>
    <h1 class="post-title">
      InnoDB MVCC é€»è¾‘å­¦ä¹ 
    </h1>
    <div class="post-meta"><span title='2024-05-01 00:00:00 +0000 UTC'>äº”æœˆ 1, 2024</span>&nbsp;Â·&nbsp;8 åˆ†é’Ÿ&nbsp;Â·&nbsp;Miao Zheyu
      &nbsp;|&nbsp;ğŸ“– &nbsp;
      <ul class="post-tags-meta">
        <a href="https://mzyee.github.io/tags/mysql/">MySQL</a>
        <a href="https://mzyee.github.io/tags/undo/">&nbsp;Undo</a>
        <a href="https://mzyee.github.io/tags/mvcc/">&nbsp;MVCC</a>
      </ul>&nbsp;|&nbsp;<a href="https://github.com/mzyee/mzyee.github.io" rel="noopener noreferrer" target="_blank">Suggestions</a>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e8%a1%8c%e8%ae%b0%e5%bd%95%e5%a4%9a%e7%89%88%e6%9c%ac%e7%9a%84%e5%ae%9e%e7%8e%b0%e9%80%bb%e8%be%91" aria-label="è¡Œè®°å½•å¤šç‰ˆæœ¬çš„å®ç°é€»è¾‘">è¡Œè®°å½•å¤šç‰ˆæœ¬çš„å®ç°é€»è¾‘</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>


  <div class="post-content"><h3 id="è¡Œè®°å½•å¤šç‰ˆæœ¬çš„å®ç°é€»è¾‘">è¡Œè®°å½•å¤šç‰ˆæœ¬çš„å®ç°é€»è¾‘<a hidden class="anchor" aria-hidden="true" href="#è¡Œè®°å½•å¤šç‰ˆæœ¬çš„å®ç°é€»è¾‘">#</a></h3>
<p>â€ƒâ€ƒ åœ¨åˆæ­¥äº†è§£ <a href="/posts/mysql/undo">undo ç³»ç»Ÿ</a> å’Œ <a href="/posts/mysql/purge">purge ç³»ç»Ÿ</a>åï¼Œæˆ‘ä»¬æ¥è¿›ä¸€æ­¥äº†è§£ InnoDB MVCC é€»è¾‘ã€‚</p>
<p>â€ƒâ€ƒ InnoDB MVCC åŸºäº Undo log å®ç°ï¼Œé€šè¿‡ä¸»é”®è®°å½•ä¸Šç”± roll_ptr ä¸²è”çš„ undo reocrd æ¥æ„å»ºè®¿é—®éœ€è¦çš„å†å² record ç‰ˆæœ¬ã€‚InnoDB è¡¨æ•°æ®ç»„ç»‡æ–¹å¼æ˜¯ä¸»é”®èšç°‡ç´¢å¼•ï¼Œé€šè¿‡ undo æ„å»ºè€ç‰ˆæœ¬çš„é€»è¾‘ä¹Ÿåªæ˜¯å¯¹äºä¸»é”®ç´¢å¼•è€Œè¨€çš„ï¼ŒäºŒçº§ç´¢å¼•ä¸å­˜åœ¨å¯¹åº” undo recordã€‚InnoDB äºŒçº§ç´¢å¼•é€šè¿‡ç´¢å¼•é”®å€¼åŠ ä¸»é”®å€¼ç»„åˆæ¥å”¯ä¸€ç¡®å®šä¸€æ¡è®°å½•ï¼Œå› æ­¤å¯¹äºä¸€æ¡äºŒçº§ç´¢å¼•è®°å½•ï¼ˆåŒ…æ‹¬ delete_mark çŠ¶æ€çš„ï¼‰ï¼Œå…¶å¯¹åº”äº†ä¸€æ¡ undo è¦†ç›–å†å²èŒƒå›´å­˜åœ¨çš„ä¸»é”®è®°å½•ï¼ˆå¯èƒ½æ˜¯å½“å‰å­˜åœ¨çš„ç‰ˆæœ¬ï¼Œä¹Ÿå¯èƒ½æ˜¯æ„å»ºçš„å†å²ç‰ˆæœ¬ï¼‰ã€‚</p>
<center><img src="phy_undo2.png" width="100%" /></center>
<p>â€ƒâ€ƒ åŒæ—¶ï¼Œè®¿é—®é€šè¿‡ ReadView æ¥åˆ¤æ–­å†å²ç‰ˆæœ¬çš„æ•°æ®å¯è§æ€§ã€‚å¯¹äºä¸»é”®è®°å½•å®é™…ä¸Šæ˜¯åˆ¤æ–­å†å²ä¸»é”® record ä¸Šçš„ tidï¼‰ã€‚å› æ­¤ï¼Œå½“äºŒçº§ç´¢å¼•è®°å½•æ— æ³•é€šè¿‡å…¶ page ä¸Šçš„ max tid è¿‡æ»¤æ—¶ï¼Œéœ€è¦æ‰¾åˆ°ï¼ˆå¯èƒ½éœ€è¦é€šè¿‡ undo æ„å»ºï¼‰å…¶å¯¹åº”çš„ä¸»é”®è®°å½•ç‰ˆæœ¬å†æ¥åˆ¤æ–­å¯è§æ€§ã€‚</p>
<p>â€ƒâ€ƒ InnoDB é€šè¿‡å‡½æ•° trx_undo_prev_version_build æ„å»ºèšé›†ç´¢å¼•è®°å½•çš„å‰ä¸€ä¸ªç‰ˆæœ¬ï¼Œè¿™ä¸ªå‡½æ•°ä¼šä½¿ç”¨åœ¨ï¼š
MVCC è¯»å–è·¯å¾„ï¼ˆ<code>row_vers_build_for_[semi_]consistent_read</code>ï¼‰ï¼›
Purge/Undo è·¯å¾„ï¼ˆ<code>row_vers_old_has_index_entry</code>ï¼‰ï¼›
äºŒçº§ç´¢å¼•éšå¼é”åˆ¤æ–­ï¼ˆ<code>row_vers_find_matching</code>ï¼‰ç­‰è·¯å¾„ä¸Šã€‚</p>
<ol start="0">
<li><strong>æ„å»ºè€ç‰ˆæœ¬è®°å½•</strong></li>
</ol>
<p><code>trx_undo_prev_version_build</code> ç”¨æ¥æ„å»ºå‰ä¸€ä¸ªç‰ˆæœ¬çš„ä¸»é”®ç´¢å¼•è®°å½•</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cm">/** æ„å»ºèšé›†ç´¢å¼•è®°å½•æŸä¸ªç‰ˆæœ¬ rec çš„å†å‰ä¸€ä¸ªç‰ˆæœ¬ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">  è°ƒç”¨è€…å¿…é¡»æŒæœ‰èšé›†ç´¢å¼•è®°å½•ç´¢å¼•é¡µçš„é”ã€‚*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="nf">trx_undo_prev_version_build</span><span class="p">(</span><span class="k">const</span> <span class="n">rec_t</span> <span class="o">*</span><span class="n">index_rec</span><span class="p">,</span> <span class="n">mtr_t</span> <span class="o">*</span><span class="n">index_mtr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                 <span class="k">const</span> <span class="n">rec_t</span> <span class="o">*</span><span class="n">rec</span><span class="p">,</span> <span class="k">const</span> <span class="n">dict_index_t</span> <span class="o">*</span><span class="n">index</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                 <span class="n">ulint</span> <span class="o">*</span><span class="n">offsets</span><span class="p">,</span> <span class="n">mem_heap_t</span> <span class="o">*</span><span class="n">heap</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                 <span class="n">rec_t</span> <span class="o">**</span><span class="n">old_vers</span><span class="p">,</span> <span class="n">mem_heap_t</span> <span class="o">*</span><span class="n">v_heap</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                 <span class="k">const</span> <span class="n">dtuple_t</span> <span class="o">**</span><span class="n">vrow</span><span class="p">,</span> <span class="n">ulint</span> <span class="n">v_status</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                 <span class="n">lob</span><span class="o">::</span><span class="n">undo_vers_t</span> <span class="o">*</span><span class="n">lob_undo</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">trx_undo_rec_t</span> <span class="o">*</span><span class="n">undo_rec</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">dtuple_t</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">trx_id_t</span> <span class="n">rec_trx_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">ulint</span> <span class="n">type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">undo_no_t</span> <span class="n">undo_no</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">table_id_t</span> <span class="n">table_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">trx_id_t</span> <span class="n">trx_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">roll_ptr_t</span> <span class="n">roll_ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">upd_t</span> <span class="o">*</span><span class="n">update</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">byte</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">ulint</span> <span class="n">info_bits</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">ulint</span> <span class="n">cmpl_info</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">bool</span> <span class="n">dummy_extern</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">byte</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">roll_ptr</span> <span class="o">=</span> <span class="n">row_get_rec_roll_ptr</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">offsets</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">old_vers</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* insert undoï¼ˆè¯´æ˜æ˜¯ä¸²ä¸Šç¬¬ä¸€ä¸ªè®°å½•ï¼‰*/</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">trx_undo_roll_ptr_is_insert</span><span class="p">(</span><span class="n">roll_ptr</span><span class="p">))</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">rec_trx_id</span> <span class="o">=</span> <span class="n">row_get_rec_trx_id</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">offsets</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">bool</span> <span class="n">is_temp</span> <span class="o">=</span> <span class="n">index</span><span class="o">-&gt;</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">is_temporary</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// è·å– undo_rec æ—¶ä¼šåˆ¤æ–­ rec_trx_id æ˜¯å¦è¢« purge_sys-&gt;view å¯è§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">trx_undo_get_undo_rec</span><span class="p">(</span><span class="n">roll_ptr</span><span class="p">,</span> <span class="n">rec_trx_id</span><span class="p">,</span> <span class="n">heap</span><span class="p">,</span> <span class="n">is_temp</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">index</span><span class="o">-&gt;</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">undo_rec</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å½“å‰ rec_trx_id åœ¨ purge_sys-&gt;view å¯è§ï¼Œæ›´è€çš„ï¼ˆprevï¼‰undo å¯èƒ½ç‰ˆæœ¬éƒ½è¢«å¤„ç†äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">v_status</span> <span class="o">&amp;</span> <span class="n">TRX_UNDO_PREV_IN_PURGE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="cm">/* å‡½æ•°è¢« purge æµç¨‹ä¸­è°ƒç”¨çš„ç‰¹æ®Šæƒ…å†µï¼Œç”¨äº virtual row å¤„ç† */</span>
</span></span><span class="line"><span class="cl">      <span class="n">undo_rec</span> <span class="o">=</span> <span class="n">trx_undo_get_undo_rec_low</span><span class="p">(</span><span class="n">roll_ptr</span><span class="p">,</span> <span class="n">heap</span><span class="p">,</span> <span class="n">is_temp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="cm">/* æ­£å¸¸æƒ…å†µï¼Œæ›´è€ä¸€ä¸ªç‰ˆæœ¬çš„ undo ä¸å®‰å…¨ï¼Œåˆ°å½“å‰ç‰ˆæœ¬ä¸ºæ­¢ */</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// è§£æè·å–åˆ°çš„å¯¹åº”ä¸Šä¸€ç‰ˆæœ¬çš„ undo rec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">type_cmpl_t</span> <span class="n">type_cmpl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">ptr</span> <span class="o">=</span> <span class="n">trx_undo_rec_get_pars</span><span class="p">(</span><span class="n">undo_rec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmpl_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy_extern</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="o">&amp;</span><span class="n">undo_no</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">table_id</span><span class="p">,</span> <span class="n">type_cmpl</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">table_id</span> <span class="o">!=</span> <span class="n">index</span><span class="o">-&gt;</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span> <span class="cm">/*table è¢«é‡å»ºï¼Œpurge é‡åˆ°è€ id çš„ undo*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">ptr</span> <span class="o">=</span> <span class="n">trx_undo_update_rec_get_sys_cols</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trx_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">roll_ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info_bits</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">ptr</span> <span class="o">=</span> <span class="n">trx_undo_rec_skip_row_ref</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// é€šè¿‡ undo æ„å»º upd_t *update
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">ptr</span> <span class="o">=</span> <span class="n">trx_undo_update_rec_get_update</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">trx_id</span><span class="p">,</span> <span class="n">roll_ptr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="n">info_bits</span><span class="p">,</span> <span class="n">heap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">update</span><span class="p">,</span> <span class="n">lob_undo</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="n">type_cmpl</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">ut_a</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">row_upd_changes_field_size_or_external</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">offsets</span><span class="p">,</span> <span class="n">update</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* å¦‚æœå‰ä¸€ä¸ªç‰ˆæœ¬è®°å½•æ˜¯è¢«æ ‡è®°åˆ é™¤çš„ï¼Œå¹¶ä¸”å­˜åœ¨ disowned çš„ blobï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">      åˆ™éœ€è¦åˆ¤æ–­å¯è§æ€§è¿™ä¸ªç‰ˆæœ¬è®°å½•çš„å¯è§æ€§ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">      å¦‚æœ purge å¯è§ï¼Œå°†å…¶è§†ä¸º missing history å¤„ç†ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">      è¿™æ˜¯å› ä¸ºä¸Šä¸€ç‰ˆæœ¬è®°å½• disowned çš„ blob å¯èƒ½å·²ç»è¢« purge äº†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">      å¯ä»¥çœç•¥ row_upd_changes_disowned_external(update) è°ƒç”¨ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">      ä½†è¿™æ · purge_sys-&gt;latch åŠ é”æ›´å¤šï¼Œæ€§èƒ½å¼€é”€å¯æ›´é«˜ã€‚*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">((</span><span class="n">update</span><span class="o">-&gt;</span><span class="n">info_bits</span> <span class="o">&amp;</span> <span class="n">REC_INFO_DELETED_FLAG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">         <span class="n">row_upd_changes_disowned_external</span><span class="p">(</span><span class="n">update</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kt">bool</span> <span class="n">missing_ext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">rw_lock_s_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">purge_sys</span><span class="o">-&gt;</span><span class="n">latch</span><span class="p">,</span> <span class="n">UT_LOCATION_HERE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">missing_ext</span> <span class="o">=</span> <span class="n">purge_sys</span><span class="o">-&gt;</span><span class="n">view</span><span class="p">.</span><span class="n">changes_visible</span><span class="p">(</span><span class="n">trx_id</span><span class="p">,</span> <span class="n">index</span><span class="o">-&gt;</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">rw_lock_s_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">purge_sys</span><span class="o">-&gt;</span><span class="n">latch</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">missing_ext</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* treat as a fresh insert, not to cause assertion error at the caller. */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">update</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">update</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// é€šè¿‡ undo è¿˜åŸ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">entry</span> <span class="o">=</span> <span class="n">row_rec_to_index_entry</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">offsets</span><span class="p">,</span> <span class="n">heap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">row_upd_index_replace_new_col_vals</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="n">heap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">buf</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">byte</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">mem_heap_alloc</span><span class="p">(</span><span class="n">heap</span><span class="p">,</span> <span class="n">rec_get_converted_size</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">entry</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">old_vers</span> <span class="o">=</span> <span class="n">rec_convert_dtuple_to_rec</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">buf</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">byte</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">mem_heap_alloc</span><span class="p">(</span><span class="n">heap</span><span class="p">,</span> <span class="n">rec_offs_size</span><span class="p">(</span><span class="n">offsets</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">old_vers</span> <span class="o">=</span> <span class="n">rec_copy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">rec</span><span class="p">,</span> <span class="n">offsets</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// é€šè¿‡ undo è¿˜åŸ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">row_upd_rec_in_place</span><span class="p">(</span><span class="o">*</span><span class="n">old_vers</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">offsets</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* Set the old value (which is the after image of an update) in the
</span></span></span><span class="line"><span class="cl"><span class="cm">  update vector to dtuple vrow */</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">v_status</span> <span class="o">&amp;</span> <span class="n">TRX_UNDO_GET_OLD_V_VALUE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">row_upd_replace_vcol</span><span class="p">((</span><span class="n">dtuple_t</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">vrow</span><span class="p">,</span> <span class="n">index</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">vrow</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">cmpl_info</span> <span class="o">&amp;</span> <span class="n">UPD_NODE_NO_ORD_CHANGE</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ„å»ºè€ç‰ˆæœ¬çš„ virtual row
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">update</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">update</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li><strong>MVCC ä¸€è‡´æ€§è¯»å–è·¯å¾„</strong></li>
</ol>
<p>ä»¥ row_search_mvcc æŸ¥è¯¢ä¸ºä¾‹ï¼Œå½“ cursor å®šä½åˆ°ç¡®åˆ‡ user_record ä¸Šåï¼Œå¦‚æœæ˜¯æ— é”ä¸€è‡´æ€§ MVCC è¯»å¹¶ä¸”éš”ç¦»çº§åˆ«å¤§äº READ_UNCOMMITTED æ—¶ï¼Œæ­¤æ—¶ä¼šé€šè¿‡æŸ¥è¯¢æ‰€æŒæœ‰çš„ readview åˆ¤æ–­å¯¹åº”è®°å½•æ˜¯å¦å¯è§ï¼ˆ<code>lock_clust/sec_rec_cons_read_sees</code>ï¼‰ï¼Œå¯¹äºäºŒçº§ç´¢å¼•æ— æ³•åˆ¤æ–­æ˜¯è¿˜éœ€è¦å›è¡¨åˆ°ä¸»é”®ä¸Šå¤„ç†ï¼Œå¯¹äºä¸»é”®ç´¢å¼•å¦‚æœæ­¤è®°å½•ä¸å¯è§ï¼Œåˆ™ä¼šé€šè¿‡ <code>row_vers_build_for_consistent_read</code> æ„å»ºç›®æ ‡ readview å¯è§çš„å†å²è¡Œè®°å½•ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cm">/** æ„å»ºä¸€è‡´æ€§è¯»å–åº”è¯¥çœ‹åˆ°çš„èšé›†ç´¢å¼•è®°å½•çš„ç‰ˆæœ¬ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">   å‡½æ•°å‡è®¾å½“å‰ rec ä¸Šçš„äº‹åŠ¡ id æ˜¯ä¸€è‡´æ€§è¯»å–ä¸åº”è¯¥çœ‹åˆ°çš„ã€‚*/</span>
</span></span><span class="line"><span class="cl"><span class="n">dberr_t</span> <span class="nf">row_vers_build_for_consistent_read</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">rec_t</span> <span class="o">*</span><span class="n">rec</span><span class="p">,</span> <span class="c1">// èšé›†ç´¢å¼•ä¸­çš„è®°å½•ï¼Œè°ƒç”¨è€…å¿…é¡»æŒæœ‰ page latchï¼Œå³è¯¥è®°å½•ç‰ˆæœ¬å †æ ˆçš„é¡¶éƒ¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mtr_t</span> <span class="o">*</span><span class="n">mtr</span><span class="p">,</span> <span class="c1">// æŒæœ‰ rec ä¸Šé”çš„ mtrï¼Œå¹¶ä¸”è¿˜å°†æŒæœ‰ purge_view ä¸Šçš„é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">dict_index_t</span> <span class="o">*</span><span class="n">index</span><span class="p">,</span> <span class="n">ulint</span> <span class="o">**</span><span class="n">offsets</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">ReadView</span> <span class="o">*</span><span class="n">view</span><span class="p">,</span> <span class="c1">// ç›®æ ‡è§†å›¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mem_heap_t</span> <span class="o">**</span><span class="n">offset_heap</span><span class="p">,</span> <span class="n">mem_heap_t</span> <span class="o">*</span><span class="n">in_heap</span><span class="p">,</span> <span class="n">rec_t</span> <span class="o">**</span><span class="n">old_vers</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">dtuple_t</span> <span class="o">**</span><span class="n">vrow</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">lob</span><span class="o">::</span><span class="n">undo_vers_t</span> <span class="o">*</span><span class="n">lob_undo</span> <span class="c1">// å¦‚æœéœ€è¦åº”ç”¨ blob çš„ undo log
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="n">rec_t</span> <span class="o">*</span><span class="n">version</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">rec_t</span> <span class="o">*</span><span class="n">prev_version</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">trx_id_t</span> <span class="n">trx_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">mem_heap_t</span> <span class="o">*</span><span class="n">heap</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">byte</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">dberr_t</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">trx_id</span> <span class="o">=</span> <span class="n">row_get_rec_trx_id</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">*</span><span class="n">offsets</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">lob_undo</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span> <span class="n">lob_undo</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">();</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">version</span> <span class="o">=</span> <span class="n">rec</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">mem_heap_t</span> <span class="o">*</span><span class="n">prev_heap</span> <span class="o">=</span> <span class="n">heap</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">heap</span> <span class="o">=</span> <span class="n">mem_heap_create</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="n">UT_LOCATION_HERE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">vrow</span><span class="p">)</span> <span class="p">{</span> <span class="o">*</span><span class="n">vrow</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">purge_sees</span> <span class="o">=</span> <span class="n">trx_undo_prev_version_build</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">mtr</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">*</span><span class="n">offsets</span><span class="p">,</span> <span class="n">heap</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                  <span class="o">&amp;</span><span class="n">prev_version</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span> <span class="n">vrow</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lob_undo</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="n">purge_sees</span><span class="p">)</span> <span class="o">?</span> <span class="nl">DB_SUCCESS</span> <span class="p">:</span> <span class="n">DB_MISSING_HISTORY</span><span class="p">;</span> <span class="c1">// purge viewï¼ˆä¹Ÿæ˜¯æœ€è€çš„ readviewï¼‰å¯è§ï¼Œå› æ­¤ undo å¯èƒ½è¢« purge
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">prev_heap</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span> <span class="n">mem_heap_free</span><span class="p">(</span><span class="n">prev_heap</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">prev_version</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="cm">/* ä¸å­˜åœ¨æ›´è€çš„å¯¹åº”ä¸»é”®ç‰ˆæœ¬ */</span>
</span></span><span class="line"><span class="cl">      <span class="o">*</span><span class="n">old_vers</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">offsets</span> <span class="o">=</span> <span class="n">rec_get_offsets</span><span class="p">(</span><span class="n">prev_version</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">*</span><span class="n">offsets</span><span class="p">,</span> <span class="n">ULINT_UNDEFINED</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="n">UT_LOCATION_HERE</span><span class="p">,</span> <span class="n">offset_heap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">trx_id</span> <span class="o">=</span> <span class="n">row_get_rec_trx_id</span><span class="p">(</span><span class="n">prev_version</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">*</span><span class="n">offsets</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">view</span><span class="o">-&gt;</span><span class="n">changes_visible</span><span class="p">(</span><span class="n">trx_id</span><span class="p">,</span> <span class="n">index</span><span class="o">-&gt;</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="cm">/* ä¸€ç›´æ‰¾åˆ°ç¬¬ä¸€ä¸ª view å¯è§çš„ç›®æ ‡å†å²è¡Œè®°å½•å copy å¹¶é€€å‡º */</span>
</span></span><span class="line"><span class="cl">      <span class="n">buf</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">byte</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">mem_heap_alloc</span><span class="p">(</span><span class="n">in_heap</span><span class="p">,</span> <span class="n">rec_offs_size</span><span class="p">(</span><span class="o">*</span><span class="n">offsets</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="o">*</span><span class="n">old_vers</span> <span class="o">=</span> <span class="n">rec_copy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">prev_version</span><span class="p">,</span> <span class="o">*</span><span class="n">offsets</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">vrow</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">vrow</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">vrow</span> <span class="o">=</span> <span class="n">dtuple_copy</span><span class="p">(</span><span class="o">*</span><span class="n">vrow</span><span class="p">,</span> <span class="n">in_heap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">dtuple_dup_v_fld</span><span class="p">(</span><span class="o">*</span><span class="n">vrow</span><span class="p">,</span> <span class="n">in_heap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">version</span> <span class="o">=</span> <span class="n">prev_version</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">mem_heap_free</span><span class="p">(</span><span class="n">heap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li><strong>Purge/Undo è·¯å¾„</strong>
å½“éœ€è¦ä»äºŒçº§ç´¢å¼• purge æ ‡è®°åˆ é™¤çš„è¡Œæ—¶ï¼Œä¼šæ£€æŸ¥æ˜¯å¦å­˜åœ¨ä¸€ä¸ªæœªè¢«æ ‡è®°åˆ é™¤çš„ã€å¤§äºç­‰äº purge view èŒƒå›´çš„ã€ä¸”ä¸ purge ç›®æ ‡äºŒçº§ç´¢å¼•è®°å½•å­—ç¬¦é›†æ’åºç›¸ç­‰çš„ä¸»é”®è¡Œè®°å½•ç‰ˆæœ¬ï¼Œå¦‚æœå­˜åœ¨ï¼ˆå½“å‰äºŒçº§ç´¢å¼•è¿˜ä¼šä½¿ç”¨ï¼‰ï¼Œåˆ™ä¸ä¼š purge è¿™ä¸ªäºŒçº§ç´¢å¼•è®°å½•ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cm">/** æ£€æŸ¥æ˜¯å¦å­˜åœ¨æŸä¸ªå¤§äºç­‰äº purge view çš„éæ ‡è®°åˆ é™¤è¡Œè®°å½•ç‰ˆæœ¬ï¼ˆä¸å¯æ¸…ç†ï¼‰å’Œç›®æ ‡äºŒçº§ç´¢å¼•ä¸€è‡´ */</span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">row_vers_old_has_index_entry</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">also_curr</span><span class="p">,</span>         <span class="cm">/*!&lt; in: true if also rec is included in the
</span></span></span><span class="line"><span class="cl"><span class="cm">                           versions to search; otherwise only versions
</span></span></span><span class="line"><span class="cl"><span class="cm">                           prior to it are searched */</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">rec_t</span> <span class="o">*</span><span class="n">rec</span><span class="p">,</span>       <span class="cm">/*!&lt; in: record in the clustered index; the
</span></span></span><span class="line"><span class="cl"><span class="cm">                            caller must have a latch on the page */</span>
</span></span><span class="line"><span class="cl">    <span class="n">mtr_t</span> <span class="o">*</span><span class="n">mtr</span><span class="p">,</span>             <span class="cm">/*!&lt; in: mtr holding the latch on rec; it will
</span></span></span><span class="line"><span class="cl"><span class="cm">                            also hold the latch on purge_view */</span>
</span></span><span class="line"><span class="cl">    <span class="n">dict_index_t</span> <span class="o">*</span><span class="n">index</span><span class="p">,</span>    <span class="cm">/*!&lt; in: the secondary index */</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">dtuple_t</span> <span class="o">*</span><span class="n">ientry</span><span class="p">,</span> <span class="cm">/*!&lt; in: the secondary index entry */</span>
</span></span><span class="line"><span class="cl">    <span class="n">roll_ptr_t</span> <span class="n">roll_ptr</span><span class="p">,</span>    <span class="cm">/*!&lt; in: roll_ptr for the purge record */</span>
</span></span><span class="line"><span class="cl">    <span class="n">trx_id_t</span> <span class="n">trx_id</span><span class="p">)</span>        <span class="cm">/*!&lt; in: transaction ID on the purging record */</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="n">rec_t</span> <span class="o">*</span><span class="n">version</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">rec_t</span> <span class="o">*</span><span class="n">prev_version</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">dict_index_t</span> <span class="o">*</span><span class="n">clust_index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">ulint</span> <span class="o">*</span><span class="n">clust_offsets</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">mem_heap_t</span> <span class="o">*</span><span class="n">heap</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">mem_heap_t</span> <span class="o">*</span><span class="n">heap2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">dtuple_t</span> <span class="o">*</span><span class="n">row</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="n">dtuple_t</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">ulint</span> <span class="n">comp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="n">dtuple_t</span> <span class="o">*</span><span class="n">vrow</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">mem_heap_t</span> <span class="o">*</span><span class="n">v_heap</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="n">dtuple_t</span> <span class="o">*</span><span class="n">cur_vrow</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">clust_index</span> <span class="o">=</span> <span class="n">index</span><span class="o">-&gt;</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">first_index</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">comp</span> <span class="o">=</span> <span class="n">page_rec_is_comp</span><span class="p">(</span><span class="n">rec</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">heap</span> <span class="o">=</span> <span class="n">mem_heap_create</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="n">UT_LOCATION_HERE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">clust_offsets</span> <span class="o">=</span> <span class="n">rec_get_offsets</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">clust_index</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span> <span class="n">ULINT_UNDEFINED</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">UT_LOCATION_HERE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">heap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">dict_index_has_virtual</span><span class="p">(</span><span class="n">index</span><span class="p">))</span> <span class="n">v_heap</span> <span class="o">=</span> <span class="n">mem_heap_create</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">UT_LOCATION_HERE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// also_curr == trueï¼Œæ£€æŸ¥é delete_mark çš„å½“å‰ rec æ˜¯å¦å’ŒäºŒçº§ç´¢å¼•åŒ¹é…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">also_curr</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rec_get_deleted_flag</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">comp</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">row_ext_t</span> <span class="o">*</span><span class="n">ext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">row</span> <span class="o">=</span> <span class="n">row_build</span><span class="p">(</span><span class="n">ROW_COPY_POINTERS</span><span class="p">,</span> <span class="n">clust_index</span><span class="p">,</span> <span class="n">rec</span><span class="p">,</span> <span class="n">clust_offsets</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="k">nullptr</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ext</span><span class="p">,</span> <span class="n">heap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">dict_index_has_virtual</span><span class="p">(</span><span class="n">index</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// å­˜åœ¨ virtual row å¤„ç† ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// æ„å»ºäºŒçº§ç´¢å¼•å¯¹åº” dtuple_t *entry
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">entry</span> <span class="o">=</span> <span class="n">row_build_index_entry</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">heap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// å­—ç¬¦é›†ï¼ˆébinaryï¼‰æ¯”è¾ƒè¾“å…¥ç›®æ ‡ ientry å’Œä¸»é”®äºŒçº§ç´¢å¼•éƒ¨åˆ†æ˜¯å¦ä¸€è‡´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">&amp;&amp;</span> <span class="n">dtuple_coll_eq</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">ientry</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">mem_heap_free</span><span class="p">(</span><span class="n">heap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">v_heap</span><span class="p">)</span> <span class="p">{</span> <span class="n">mem_heap_free</span><span class="p">(</span><span class="n">v_heap</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">dict_index_has_virtual</span><span class="p">(</span><span class="n">index</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å­˜åœ¨ virtual row å¤„ç† ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">version</span> <span class="o">=</span> <span class="n">rec</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// æ£€æŸ¥æ˜¯å¦å­˜åœ¨é delete_mark çš„è€ç‰ˆæœ¬ rec å’ŒäºŒçº§ç´¢å¼•åŒ¹é…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">heap2</span> <span class="o">=</span> <span class="n">heap</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">heap</span> <span class="o">=</span> <span class="n">mem_heap_create</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="n">UT_LOCATION_HERE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">vrow</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æ„å»ºå‰ä¸€ä¸ªç‰ˆæœ¬è¡Œè®°å½•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">trx_undo_prev_version_build</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="n">rec</span><span class="p">,</span> <span class="n">mtr</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">clust_index</span><span class="p">,</span> <span class="n">clust_offsets</span><span class="p">,</span> <span class="n">heap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prev_version</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="k">nullptr</span><span class="p">,</span> <span class="n">dict_index_has_virtual</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">?</span> <span class="o">&amp;</span><span class="nl">vrow</span> <span class="p">:</span> <span class="k">nullptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">mem_heap_free</span><span class="p">(</span><span class="n">heap2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prev_version</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="cm">/* ä¸å­˜åœ¨æ›´è€çš„ï¼ˆpurge å®‰å…¨ï¼‰ç‰ˆæœ¬ */</span>
</span></span><span class="line"><span class="cl">      <span class="n">mem_heap_free</span><span class="p">(</span><span class="n">heap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">v_heap</span><span class="p">)</span> <span class="n">mem_heap_free</span><span class="p">(</span><span class="n">v_heap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">clust_offsets</span> <span class="o">=</span> <span class="n">rec_get_offsets</span><span class="p">(</span><span class="n">prev_version</span><span class="p">,</span> <span class="n">clust_index</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">ULINT_UNDEFINED</span><span class="p">,</span> <span class="n">UT_LOCATION_HERE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">heap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">dict_index_has_virtual</span><span class="p">(</span><span class="n">index</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* å­˜åœ¨ virtual row å¤„ç† ... */</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rec_get_deleted_flag</span><span class="p">(</span><span class="n">prev_version</span><span class="p">,</span> <span class="n">comp</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">row_ext_t</span> <span class="o">*</span><span class="n">ext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">row</span> <span class="o">=</span> <span class="n">row_build</span><span class="p">(</span><span class="n">ROW_COPY_POINTERS</span><span class="p">,</span> <span class="n">clust_index</span><span class="p">,</span> <span class="n">prev_version</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                      <span class="n">clust_offsets</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ext</span><span class="p">,</span> <span class="n">heap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">dict_index_has_virtual</span><span class="p">(</span><span class="n">index</span><span class="p">))</span> <span class="p">{</span><span class="cm">/* å­˜åœ¨ virtual row å¤„ç† ... */</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// æ„å»ºäºŒçº§ç´¢å¼•å¯¹åº” dtuple_t *entry
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">entry</span> <span class="o">=</span> <span class="n">row_build_index_entry</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">heap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="cm">/* If entry == NULL, the record contains unset BLOB pointers.
</span></span></span><span class="line"><span class="cl"><span class="cm">        This cheated be a freshly inserted record that can ignore. */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// å­—ç¬¦é›†ï¼ˆébinaryï¼‰æ¯”è¾ƒè¾“å…¥ç›®æ ‡ ientry å’Œä¸»é”®äºŒçº§ç´¢å¼•éƒ¨åˆ†æ˜¯å¦ä¸€è‡´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">&amp;&amp;</span> <span class="n">dtuple_coll_eq</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">ientry</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">mem_heap_free</span><span class="p">(</span><span class="n">heap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">v_heap</span><span class="p">)</span> <span class="p">{</span> <span class="n">mem_heap_free</span><span class="p">(</span><span class="n">v_heap</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">version</span> <span class="o">=</span> <span class="n">prev_version</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li><strong>äºŒçº§ç´¢å¼•éšå¼é”åˆ¤æ–­</strong>
åœ¨åšäºŒçº§ç´¢å¼•è®°å½•å¯è§ä¸‹åˆ¤æ–­æ—¶ï¼Œå½“æ— æ³•ä½¿ç”¨äºŒçº§ç´¢å¼• page max tid åšè¿‡æ»¤æ—¶ï¼Œéœ€è¦å›è¡¨ä¸»é”®å»æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä¸€ä¸ªæ´»è·ƒäº‹åŠ¡æ’å…¥æˆ–ä¿®æ”¹äº†å¯¹åº”çš„äºŒçº§ç´¢å¼•è®°å½•ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cm">/* æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨ match/unmatch çš„ä¸»é”®è®°å½•ç‰ˆæœ¬ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">  ç›®å‰å¦‚æœ sec rec æ˜¯æ ‡è®°åˆ é™¤çš„åˆ™å¯»æ‰¾æ˜¯å¦æœ‰ match çš„è®°å½•ç‰ˆæœ¬ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">  å¦‚æœ sec rec æ˜¯éæ ‡è®°åˆ é™¤çš„åˆ™å»å¯»æ‰¾æ˜¯å¦æœ‰é match çš„è®°å½•ç‰ˆæœ¬ */</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">bool</span> <span class="nf">row_vers_find_matching</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">looking_for_match</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">dict_index_t</span> <span class="o">*</span><span class="k">const</span> <span class="n">clust_index</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">rec_t</span> <span class="o">*</span><span class="k">const</span> <span class="n">clust_rec</span><span class="p">,</span> <span class="n">ulint</span> <span class="o">*&amp;</span><span class="n">clust_offsets</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">dict_index_t</span> <span class="o">*</span><span class="k">const</span> <span class="n">sec_index</span><span class="p">,</span> <span class="k">const</span> <span class="n">rec_t</span> <span class="o">*</span><span class="k">const</span> <span class="n">sec_rec</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">ulint</span> <span class="o">*</span><span class="k">const</span> <span class="n">sec_offsets</span><span class="p">,</span> <span class="k">const</span> <span class="kt">bool</span> <span class="n">comp</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">trx_id_t</span> <span class="n">trx_id</span><span class="p">,</span> <span class="c1">// å½“å‰ cluster rec å¯¹åº”çš„ tidï¼Œå¿…ç„¶æ˜¯æ´»è·ƒçš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mtr_t</span> <span class="o">*</span><span class="k">const</span> <span class="n">mtr</span><span class="p">,</span> <span class="n">mem_heap_t</span> <span class="o">*&amp;</span><span class="n">heap</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="n">rec_t</span> <span class="o">*</span><span class="n">version</span> <span class="o">=</span> <span class="n">clust_rec</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">trx_id_t</span> <span class="n">version_trx_id</span> <span class="o">=</span> <span class="n">trx_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// è¿™é‡Œæ˜¯å›è¡¨åˆ°çš„å½“å‰ç´¢å¼•ä¸Š cluster_rec å¯¹åº” tid è¿˜æ´»è·ƒï¼Œä½†æ˜¯ sec_rec å¯èƒ½å’Œä¸æ˜¯è¿™ä¸ª tid äº§ç”Ÿçš„ï¼Œä»è¦è¿›ä¸€æ­¥åˆ¤æ–­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// åªéœ€è¦å¯»æ‰¾å½“å‰ç´¢å¼• cluster_rec å¯¹åº” tid äº§ç”Ÿçš„è®°å½•ï¼Œå¦‚æœæ˜¯æ›´è€çš„ tid äº§ç”Ÿçš„è¿™ä¸ª sec_recï¼Œç”±äºè¿™ä¸ªè¡Œè®°å½•å¯ä»¥è¢«åç»­ tid ä¿®æ”¹ï¼Œå…¶ä¸€å®šå·²ç»ä¸æ´»è·ƒäº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">while</span> <span class="p">(</span><span class="n">version_trx_id</span> <span class="o">==</span> <span class="n">trx_id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">mem_heap_t</span> <span class="o">*</span><span class="n">old_heap</span> <span class="o">=</span> <span class="n">heap</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">dtuple_t</span> <span class="o">*</span><span class="n">clust_vrow</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">rec_t</span> <span class="o">*</span><span class="n">prev_version</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">heap</span> <span class="o">=</span> <span class="n">mem_heap_create</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="n">UT_LOCATION_HERE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¯»æ‰¾å‰ä¸€ä¸ªä¸»é”®è®°å½•ç‰ˆæœ¬
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">trx_undo_prev_version_build</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">clust_rec</span><span class="p">,</span> <span class="n">mtr</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">clust_index</span><span class="p">,</span> <span class="n">clust_offsets</span><span class="p">,</span> <span class="n">heap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prev_version</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="k">nullptr</span><span class="p">,</span> <span class="n">dict_index_has_virtual</span><span class="p">(</span><span class="n">sec_index</span><span class="p">)</span> <span class="o">?</span> <span class="o">&amp;</span><span class="nl">clust_vrow</span> <span class="p">:</span> <span class="k">nullptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">mem_heap_free</span><span class="p">(</span><span class="n">old_heap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">version</span> <span class="o">=</span> <span class="n">prev_version</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">version_trx_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">clust_offsets</span> <span class="o">=</span> <span class="n">rec_get_offsets</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">clust_index</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                      <span class="n">ULINT_UNDEFINED</span><span class="p">,</span> <span class="n">UT_LOCATION_HERE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">heap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">version_trx_id</span> <span class="o">=</span> <span class="n">row_get_rec_trx_id</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">clust_index</span><span class="p">,</span> <span class="n">clust_offsets</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* ï¼è¿™é‡Œéœ€è¦åˆ¤æ–­æ˜¯å¦ç”±å¯¹åº”ç‰ˆæœ¬ä¸»é”® prev version åˆ°è¿™ä¸ªç‰ˆæœ¬è¿™æ¬¡ â€œä¿®æ”¹â€ è€Œäº§ç”Ÿçš„ sec_recï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">      sec_rec æ˜¯ non-delete markedï¼ˆlooking_for_match = falseï¼‰ï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm">        å¦‚æœå‘ç° prev version æ˜¯ delete mark çš„æˆ– version äºŒçº§ç´¢å¼•éƒ¨åˆ†ä¸ sec_rec ä¸ä¸€è‡´ï¼ˆä¸ matchï¼‰ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">        è¯´æ˜æ˜¯ç”±è¿™ä¸ªç‰ˆæœ¬ version ä¿®æ”¹äº§ç”Ÿçš„è¿™ä¸ª sec_recï¼ˆè€ç‰ˆæœ¬è¢«æ›´æ–°è¿‡ï¼‰ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">        å› æ­¤ä»æ´»è·ƒã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">      ï¼ˆsec_rec æ´»è·ƒï¼Œprev version éæ´»è·ƒ æˆ– ä¸ä¸€è‡´ æ—¶ï¼Œåˆ™è¯´æ˜å¯¹ prev version çš„ä¿®æ”¹å¯¼è‡´æ­¤ sec_rec äº§ç”Ÿï¼‰
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">      sec_rec æ˜¯ delete markedï¼ˆlooking_for_match = trueï¼‰ï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm">        å¦‚æœå‘ç° prev version æ˜¯ é delete mark ä¸” version äºŒçº§ç´¢å¼•éƒ¨åˆ†ä¸ sec_rec ä¸€è‡´ï¼ˆmatchï¼‰ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">        è¯´æ˜æ˜¯ç”±è¿™ä¸ªç‰ˆæœ¬ version ä¿®æ”¹äº§ç”Ÿçš„è¿™ä¸ª sec_recï¼ˆè€ç‰ˆæœ¬è¢«æ›´æ–°è¿‡ï¼‰ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">        å› æ­¤ä»æ´»è·ƒã€‚ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">       ï¼ˆsec_rec éæ´»è·ƒï¼Œprev version æ´»è·ƒ ä¸” ä¸€è‡´ æ—¶ï¼Œåˆ™è¯´æ˜å¯¹ prev version çš„ä¿®æ”¹å¯¼è‡´æ­¤ sec_rec äº§ç”Ÿï¼‰
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">row_clust_vers_matches_sec</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">clust_index</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">clust_vrow</span><span class="p">,</span> <span class="n">clust_offsets</span><span class="p">,</span> <span class="n">sec_index</span><span class="p">,</span> <span class="n">sec_rec</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">sec_offsets</span><span class="p">,</span> <span class="n">comp</span><span class="p">,</span> <span class="n">looking_for_match</span><span class="p">,</span> <span class="n">heap</span><span class="p">)</span> <span class="o">==</span> <span class="n">looking_for_match</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<!-- copyright -->
<div class="admonition">
  <div class="admonition-content">
    <ul>
      <li>ç‰ˆæƒå£°æ˜ï¼šå¦‚éœ€è½¬è½½æˆ–å¼•ç”¨ï¼Œè¯·é™„åŠ æœ¬æ–‡é“¾æ¥å¹¶æ³¨æ˜æ¥æºã€‚</li>
    </ul>
  </div>
</div>
<!-- copyright -->

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://mzyee.github.io/tags/mysql/">MySQL</a></li>
      <li><a href="https://mzyee.github.io/tags/undo/">Undo</a></li>
      <li><a href="https://mzyee.github.io/tags/mvcc/">MVCC</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="https://mzyee.github.io/posts/mysql/lock/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>MySQL äº‹åŠ¡é”ç³»ç»Ÿ</span>
  </a>
</nav>

  </footer>
<div>
  <div class="pagination__title">
    <span class="pagination__title-h" style="font-size: 20px;">ğŸ’¬ è¯„è®º</span>
    <hr />
  </div>
  <div id="tcomment"></div>
  <script src="https://cdn.staticfile.org/twikoo/1.6.25/twikoo.all.min.js"></script>
  <script>
    twikoo.init({
      envId: "https://mzyeee.netlify.app/.netlify/functions/twikoo",  
      el: "#tcomment",
      lang: 'zh-CN',
      region: 'ap-hongkong',
      path: window.TWIKOO_MAGIC_PATH || window.location.pathname,
    });
  </script>
</div>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://mzyee.github.io">MZY&#39;s Blog</a></span>
    <span>
        | Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a>
    </span>
    <span id="busuanzi_container">
        | Viewer
        <span class="fa fa-user"></span> <span id="busuanzi_value_site_uv"></span>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerHTML = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerHTML = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
