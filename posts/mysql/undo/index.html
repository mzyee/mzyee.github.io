<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>InnoDB Undo Log ä»£ç å­¦ä¹  | MZY&#39;s Blog</title>
<meta name="keywords" content="MySQL, Undo">
<meta name="description" content="InnoDB Undo Log ç›¸å…³ä»£ç å­¦ä¹ ">
<meta name="author" content="Miao Zheyu">
<link rel="canonical" href="https://mzyee.github.io/posts/mysql/undo/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.78ed8947c1508d00bdf7a3061370dcaebcd4ba680f4567ec440d26a4043b4e64.css" integrity="sha256-eO2JR8FQjQC996MGE3DcrrzUumgPRWfsRA0mpAQ7TmQ=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://mzyee.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://mzyee.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://mzyee.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://mzyee.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://mzyee.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<meta property="og:title" content="InnoDB Undo Log ä»£ç å­¦ä¹ " />
<meta property="og:description" content="InnoDB Undo Log ç›¸å…³ä»£ç å­¦ä¹ " />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mzyee.github.io/posts/mysql/undo/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-10-13T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-10-13T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="InnoDB Undo Log ä»£ç å­¦ä¹ "/>
<meta name="twitter:description" content="InnoDB Undo Log ç›¸å…³ä»£ç å­¦ä¹ "/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://mzyee.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "MySQL",
      "item": "https://mzyee.github.io/posts/mysql/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "InnoDB Undo Log ä»£ç å­¦ä¹ ",
      "item": "https://mzyee.github.io/posts/mysql/undo/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "InnoDB Undo Log ä»£ç å­¦ä¹ ",
  "name": "InnoDB Undo Log ä»£ç å­¦ä¹ ",
  "description": "InnoDB Undo Log ç›¸å…³ä»£ç å­¦ä¹ ",
  "keywords": [
    "MySQL", "Undo"
  ],
  "articleBody": "1. å‰è¨€ å·²ç»æœ‰ä¸å°‘æ–‡ç« å¯¹ InnoDB çš„ undo ç³»ç»Ÿè¿›è¡Œäº†å…¨é¢ä»‹ç»ï¼Œæ¯”å¦‚ï¼š\nInnoDB undo log æ¼«æ¸¸ InnoDBä¹‹UNDO LOGä»‹ç» åº–ä¸è§£InnoDBä¹‹UNDO LOG æœ¬æ–‡ä¸»è¦å…³æ³¨ä¸€äº› Undo ç³»ç»Ÿè®¾è®¡/ä»£ç å®ç°æ˜ å°„ï¼Œä»¥åŠéƒ¨åˆ†ç¬”è€…å…³å¿ƒçš„ä»£ç ç»†èŠ‚ï¼Œå»ºè®®ç»“åˆé˜…è¯»ä¸Šè¿°æ–‡ç« ã€‚\n2. Undoçš„ç‰©ç†ç»„ç»‡ é¦–å…ˆè¦æ˜ç¡®çš„ä¸€ç‚¹æ˜¯ InnoDB çš„ undo log å®é™…ä¸Šæ˜¯ä»¥è¡¨æ•°æ®æ ¼å¼è®°å½•çš„ï¼ˆæ‰€ä»¥å« undo tablespaceï¼‰ï¼Œå¹¶ä¸”é™¤äº† temporary table çš„ undoï¼Œæ­£å¸¸ç”¨æˆ·è¡¨ undo éƒ½é€šè¿‡ redo æ¥ç»´æŠ¤æŒä¹…æ€§ã€‚\nç”±äºé€šè¿‡è¡¨ç©ºé—´å­˜å‚¨ undo logï¼Œæ‰€ä»¥ undo æ–‡ä»¶çš„åŸºç¡€ç»„ç»‡å½¢å¼æ˜¯ç±»ä¼¼ InnoDB çš„ ibd æ–‡ä»¶ï¼Œå†…éƒ¨æœ‰å¦‚ File Segment ç­‰æ¦‚å¿µã€æœ‰å„ç§æ–‡ä»¶ç»´æŠ¤ç»“æ„çš„ listã€æœ‰ page ä¸Šæ–‡ä»¶ç»´æŠ¤ç»“æ„ç›¸å…³çš„ metaï¼Œç­‰ç­‰ã€‚å¹¶ä¸”åˆ†é… undo page æ—¶å€™ä¹Ÿæ˜¯é€šè¿‡ fsp_reserve_free_extents è¿™ä¸€æ¥å£å»ç”³è¯·ç©ºé—²æ•°æ®é¡µã€‚\næ¯ä¸ª Undo Tablespace æœ‰æœ€å¤š128ä¸ªå¯ç”¨çš„ Rollback Segmentï¼ŒUndo Tablespace ç¬¬ä¸‰ä¸ªé¡µæœ‰128ä¸ª Rollback Segment çš„ç›®å½•ï¼ˆRollback Segment Headerâ€™s Arraryï¼‰ï¼Œå…¶ä¸­æ¯ä¸ªå…ƒç´ æŒ‡å‘å„ä¸ª Rollback Segment Header æ‰€åœ¨çš„ page numberã€‚åˆå§‹åŒ–æ—¶å€™ä¼šå¤„ç†æ‰€æœ‰ Rollback Segmentï¼Œå¦‚æœæœªä½¿ç”¨åˆ™ä¸º FIL_NULLï¼Œé€šè¿‡ innodb_rollback_segments å‚æ•°æ§åˆ¶å®é™…ä½¿ç”¨æ•°ç›®ã€‚\nä¸€ä¸ª Rollback Segment Header åŒ…å«1024ä¸ª slotï¼ˆå››å­—èŠ‚ï¼‰ï¼Œæ¯ä¸ª slot æŒ‡å‘ Undo Segment çš„ first page numberï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ª Undo Segment çš„ Undo Header Pageã€‚æ¯ä¸€æ—¶åˆ»ï¼Œæ¯ä¸ªä½¿ç”¨çš„ Undo Segment éƒ½è¢«ä¸€ä¸ªäº‹åŠ¡ç‹¬å ï¼Œè€Œæ¯ä¸ªå†™äº‹åŠ¡éƒ½ä¼šæŒæœ‰è‡³å°‘ä¸€ä¸ªUndo Segmentï¼Œå› æ­¤è¢«ä½¿ç”¨çš„ Undo Header Page ä¸­åªæœ‰ä¸€ä¸ªæœªæäº¤äº‹åŠ¡çš„ Undo Segment Headerï¼Œå½“æ´»è·ƒäº‹åŠ¡äº§ç”Ÿçš„ undo è¶…è¿‡ Undo Header Page å®¹é‡åä¼šè¢«åˆ†é…æ–°çš„ Undo Normal Pageã€‚\nå†™äº‹åŠ¡åœ¨ä¿®æ”¹æ•°æ®å‰ï¼Œä¼šå…ˆé€šè¿‡ Undo Log è®°å½•ä¿®æ”¹å‰çš„ï¼ˆä¸»é”®ï¼‰æ•°æ®ï¼Œå¹¶ä¸” undo åˆ†ä¸º insert (UNDO_INSERT) å’Œ update (UNDO_UPD_EXISTã€UNDO_DEL_MARKã€UNDO_UPD_DEL) ä¸¤ç±»ã€‚è®°å½• undo log å‰ä¼šå…ˆå†™å…¥ Undo Log Header ç”¨äºæ ‡è®°å’Œå®šä½ï¼Œç„¶åé€æ¡å†™å…¥ Undo Recordã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 File Segment |- File Segment Header Rollback Segment |- Rollback Segment Header Undo Segment |- Undo Segment Header Undo Page |- Undo Page Header Undo Header Page Undo Normal Page Undo Log |- Undo Log Header Undo Record |- head, body, tail å¯ä»¥é€šè¿‡å‚è€ƒèµ„æ–™ä¸­çš„è¿™ä¸ªå›¾æ¥æŸ¥çœ‹ä¸Šè¿°ç‰©ç†ç»“æ„çš„é€»è¾‘å…³ç³»ï¼Œæ›´å…·ä½“çš„ç»†èŠ‚ç»“æ„å®šä¹‰å¯ä»¥æŸ¥çœ‹trx0undo.hæ–‡ä»¶ã€‚\n3. ç”ŸæˆUndoçš„ä»£ç é€»è¾‘ åˆ†é…å›æ»šæ®µ å¯¹äºåªè¯»äº‹åŠ¡ï¼Œå½“äº‹åŠ¡æ¶‰åŠåˆ°å¯¹ä¸´æ—¶è¡¨çš„è¯»å†™æ—¶ï¼Œä¼šä¸ºå…¶åˆ†é…ä¸€ä¸ªå›æ»šæ®µå¯¹å…¶äº§ç”Ÿçš„ undo log record è¿›è¡Œè®°å½•ï¼š\n1 2 trx_assign_rseg_temp() -\u003e get_next_temp_rseg() å¯¹äºè¯»å†™äº‹åŠ¡ï¼Œå½“äº‹åŠ¡è¿›å…¥è¯»å†™æ¨¡å¼æ—¶ï¼Œä¼šä¸ºå…¶åˆ†é… trx_id ä»¥åŠå›æ»šæ®µï¼š\n1 2 3 trx_assign_rseg_durable() -\u003e get_next_redo_rseg() -\u003e get_next_redo_rseg_from_trx_sys() / get_next_redo_rseg_from_undo_spaces() åˆ†é…è¡Œä¸ºåªæ˜¯ä¸€ä¸ªåŸºäºè½®è¯¢çš„å†…å­˜æ“ä½œï¼Œé¡ºåºä¸º[(space0, rseg0), (space1, rseg0), â€¦ (spaceN, rseg0), (space1, rseg0)â€¦]ï¼Œæœ€ç»ˆä¼šä¸º trx è¿”å›ä¸€ä¸ªæœ‰æ•ˆçš„ trx_rseg_tï¼ˆå›æ»šæ®µçš„å†…å­˜ç»“æ„ï¼‰ã€‚ä¸€ä¸ªäº‹åŠ¡æœ€å¤šä¼šæœ‰2ä¸ª rollback segmentï¼ˆtemp/durableåŒºåˆ†ï¼‰å’Œ 4ä¸ª undo segmentï¼ˆinsert/updateå†æ¬¡åŒºåˆ†ï¼‰ã€‚\nåˆ†é…Undo 1 2 3 4 5 6 7 8 trx_undo_report_row_operation() \u003c- | Path1: btr_cur_ins_lock_and_undo (btr_cur_optimistic_insert / btr_cur_pessimistic_insert) | Path2: btr_cur_upd_lock_and_undo (btr_cur_update_in_place / btr_cur_optimistic_update / btr_cur_pessimistic_update) | Path3: btr_cur_del_mark_set_clust_rec |\u003c- è¡Œçº§åˆ«æ“ä½œæ¥å£ // é€šè¿‡ BTR_NO_UNDO_LOG_FLAG æ ‡è®°å†³å®šæ˜¯å¦è®°å½• undo å‡½æ•°trx_undo_report_row_operationæ˜¯å†™å…¥undoçš„ä»£ç æ¥å£ï¼Œé¦–å…ˆä¼šå¦‚æœå½“å‰äº‹åŠ¡æ²¡æœ‰åˆ†é…è¿‡æ‰€éœ€ç±»å‹çš„ undo segmentï¼Œåˆ™ä¼šé€šè¿‡trx_undo_assign_undoåˆ†é… undo segment/pageï¼ˆtrx_undo_tç»“æ„ï¼‰ï¼Œé¦–å…ˆå°è¯•ä»å½“å‰ trx_rseg_t çš„ insert/update cacheä¸­å–ï¼ˆæ¥å£ä¸ºtrx_undo_reuse_cachedï¼Œcache å†…æ˜¯å¦‚æœå¯¹åº”undoäº‹åŠ¡ç»“æŸæ—¶å€™æ‰€ä½¿ç”¨çš„ undo page æ‰€ç”¨ç©ºé—´å°äº3/4åˆ™è¢«åŠ å…¥çš„ï¼‰ï¼Œcache ä¸­æ²¡æœ‰åˆ™åœ¨ç©ºé—´æ€»é‡æ–°åˆ†é…ä¸€ä¸ªundo segmentï¼ˆæ¥å£ä¸ºtrx_undo_createï¼‰ã€‚åˆ†é…å¥½ undo page ä»ç©ºé—²ä½ç½®å¼€å§‹å¯¹åº”å†™å…¥ Undo Recordï¼Œå¦‚æœ undo page çš„å‰©ä½™ç©ºé—´ä¸æ»¡è¶³è¦æ±‚åˆ™é€šè¿‡trx_undo_add_pageåŠ ä¸€ä¸ªç©ºç™½çš„ normal page è®°å½• Undo Recordã€‚\næ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œé™¤äº†ç‰©ç† undo page æ›´æ–°åŠé€šè¿‡ redo æŒä¹…åŒ–ï¼Œè¿˜ç»´æŠ¤äº†å†…å­˜ä¸­çš„å½“å‰äº‹åŠ¡æ‰€ä½¿ç”¨çš„ trx_undo_t ç»“æ„ä½“ï¼ˆtrx-\u003ersegs.m_redo/ m_noredo.insert_undo/ update_undoï¼‰ï¼ŒåŒ…æ‹¬ header pageã€log headerã€top undo page/offsetç­‰ä¿¡æ¯ã€‚\nå†™å…¥Undo Reocrd 1 2 3 4 5 6 7 8 9 10 11 12 // Insertç±»å‹ï¼šTRX_UNDO_INSERT_REC /*-------- header ------*/ Next_record_offset 2B Type_flags 1B Undo_no compressed Table_id compressed /*-------- key field ------*/ Key_field_1_len compressed Key_field_1_data compressed ...(ä»¥ä¸Š dict_index_get_n_unique ä¸ª field) /*-------- tail ------*/ Next_record_offset 2B 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 // Updateç±»å‹ï¼šTRX_UNDO_UPD_EXIST_RECã€TRX_UNDO_DEL_MARK_RECã€TRX_UNDO_UPD_DEL_REC /*-------- header ------*/ Next_record_offset 2B Type_flags 1B Undo_no compressed Table_id compressed Rec_info 1B Trx_id compressed Roll_ptr compressed //æŒ‡å‘çš„æ˜¯è¯¥è®°å½•çš„ä¸Šä¸€ä¸ªç‰ˆæœ¬çš„ä½ç½® /*-------- key field ------*/ Key_field_1_len compressed Key_field_1_data len ...(ä»¥ä¸Š dict_index_get_n_unique ä¸ª field) Update_field_num compressed // ä¿®æ”¹çš„fieldæ•°ç›® Update_field_1_pos compressed Update_field_1_len compressed Update_field_1_ctx len //è¿™æ¬¡ä¿®æ”¹å‰çš„fieldä¿¡æ¯ï¼Œåº”ç”¨è¿™ä¸ªå¯ä»¥è¿”å›åˆ°ä¿®æ”¹ä¹‹å‰åˆ°å€¼ ...(ä»¥ä¸Š upd_t ä¸­ä¸ª field æ•°ç›®) /*-------- tail ------*/ Next_record_offset 2B Undo Recordçš„å†…å®¹æ ¼å¼å¦‚ä¸Šæ‰€ç¤ºï¼Œè¿™é‡Œå†é¢å¤–è¯´æ˜ä¸‹ï¼š\nå¯¹äº insert undoï¼Œè®°å½•çš„æ˜¯æ’å…¥çš„ entry çš„ key éƒ¨åˆ†ï¼Œç”¨äºå›æ»šæ—¶å®šä½å¯»æ‰¾å¹¶åˆ é™¤ï¼Œinsert æ“ä½œä¸å­˜åœ¨å¯è§æ€§åˆ¤è¯»å› æ­¤æ²¡æœ‰è®°å½•Trx_idï¼› å¯¹äº update undoï¼Œä¼ å…¥çš„å‚æ•°æ—¶ index_recordï¼ˆrec_tï¼‰å’Œ updateï¼ˆupd_tï¼‰è¿™ä¸ªå†…å­˜ç»“æ„ï¼Œå®é™…è®°å½•çš„æ˜¯ record key å’Œè¦è¢«ä¿®æ”¹çš„ fieldï¼Œå‰è€…ç”¨äºå®šä½ï¼Œåè€…ç”¨äºè¿˜åŸåˆ°åŸå§‹ç‰ˆæœ¬ã€‚ å¯¹ä¸»é”®æ•°æ®ç”Ÿæˆ undo åå°±äº§ç”Ÿäº† roll_ptr å¹¶å¯¹æ–° record è¿›è¡Œæ›´æ–°ï¼Œå°±æ˜¯é€šè¿‡ roll_ptr å°† record çš„æ‰€æœ‰ç‰ˆæœ¬é“¾æ¥èµ·æ¥ã€‚ äº‹åŠ¡æäº¤æ—¶çš„Undoå¤„ç† åœ¨ trx_commit çš„æ—¶å€™ï¼Œå¦‚æœäº‹åŠ¡å‘ç”Ÿä¿®æ”¹å¹¶äº§ç”Ÿäº† undoï¼š\nè®¾ç½® undo åç»­å¤„ç†çŠ¶æ€ï¼š undo ä½¿ç”¨å•ä¸ª page ä¸”ä½¿ç”¨é‡å°äº 3/4 çš„ä¼šè¢«è®¾ç½®ä¸º TRX_UNDO_CACHED çŠ¶æ€ï¼›å…¶ä½™çš„ insert undo çŠ¶æ€è¢«è®¾ç½®ä¸º TRX_UNDO_TO_FREEï¼Œupdate undo çŠ¶æ€è¢«è®¾ç½®ä¸º TRX_UNDO_TO_PURGEï¼› ç»™äº‹åŠ¡åˆ†é…æäº¤é¡ºåº trx_noï¼› å¯¹ update undo å›æ»šæ®µçš„å†…å­˜ç»“æ„ï¼ŒåŠ å…¥ purge_sys-\u003epurge_queue è¿™ä¸€é˜Ÿåˆ—ï¼ˆå…¶å†…æŒ‰äº‹åŠ¡æäº¤æ—¶çš„ trx-\u003eno æ’åˆ—ï¼‰ä»¥ç»™ purge ç³»ç»Ÿå®šä½å›æ”¶ï¼› å°† trx-\u003eno å†™å…¥ rseg/undo headerï¼Œå¹¶ undo header å°†åŠ å…¥åˆ° rseg header ä¸­ history list çš„å¼€å§‹ï¼› å¯¹ update undoï¼Œå†…å­˜ç»“æ„ trx_undo_t æŒ‰çŠ¶æ€åŠ å…¥ rseg-\u003eupdate_undo_cached æˆ– trx_undo_mem_freeï¼› å¯¹ insert undoï¼Œå†…å­˜ç»“æ„ trx_undo_t æŒ‰çŠ¶æ€åŠ å…¥ rseg-\u003einsert_undo_list æˆ– trx_undo_mem_freeï¼Œå¹¶ä¸”åœ¨ rollback segment ä¸­æ¸…ç†ä¸åœ¨ history çš„ undo log segmentï¼ˆtrx_undo_seg_freeï¼‰ï¼› 4. åº”ç”¨Undoçš„ä»£ç é€»è¾‘ åº”ç”¨ undo ä¸»è¦æ˜¯åœ¨ mvcc å’Œ rollback è¿‡ç¨‹ä¸­ï¼Œè€Œ rollback åˆå¯ä»¥åˆ†ä¸ºç”¨æˆ· rollback å’Œå¥”æºƒæ¢å¤ rollbackã€‚æœ¬æ–‡ä¸»è¦è®¨è®º rollback è¿‡ç¨‹ï¼Œå¯¹äº mvcc æ“ä½œä¼šå¼€å¦å¤–çš„æ–‡ç« ä¸“é—¨è®¨è®ºã€‚\nå¥”æºƒæ¢å¤æ—¶Rollback å¯¹äºå¥”æºƒæ¢å¤è¿‡ç¨‹ä¸­çš„ Rollbackï¼Œé¦–å…ˆéœ€è¦æ¢å¤ undo ç›¸å…³ä¿¡æ¯ï¼š\né€šè¿‡ redoï¼Œåœ¨å¯åŠ¨çš„recv_recovery_from_checkpoint_start-\u003erecv_recovery_beginé˜¶æ®µæ¢å¤undoæ•°æ®ï¼› é€šè¿‡æ¢å¤çš„ undo æ•°æ®ï¼Œåœ¨å¯åŠ¨çš„trx_sys_init_at_db_starté˜¶æ®µæ¢å¤æ‰€æœ‰å›æ»šæ®µçš„å†…å­˜ç»“æ„ï¼Œtrx_sys çš„æ´»è·ƒäº‹ç‰©ã€‚æ´»è·ƒäº‹ç‰©é€šè¿‡trx_resurrectåˆ†åˆ«æ‰«ærseg-\u003einsert_undo_list/update_undo_listï¼Œç”Ÿæˆåå°trxå¯¹è±¡å¹¶åˆå§‹åŒ–ç›¸å…³å‚æ•°å¹¶åŠ å…¥trx_sys-\u003erw_trx_setï¼Œå†æŒ‰çŠ¶æ€åŠ å…¥ trx_sys-\u003erw_trx_idsï¼ˆæ´»è·ƒï¼‰å’Œ trx_sys-\u003erw_trx_listï¼ˆæ‰€æœ‰ï¼‰ã€‚ åœ¨ dict_recover DICT_RECOVERY_RESTART_SERVER é˜¶æ®µï¼Œsrv_dict_recover_on_restart ä¸­ä¼šåŠ ä¸Šè¡¨é”å¹¶ä»… rollback DD ç›¸å…³äº‹åŠ¡ï¼› åœ¨ post_recover é˜¶æ®µæœ«å°¾ï¼Œsrv_start_threads_after_ddl_recovery å¼€å¯åå°å›æ»šçº¿ç¨‹ï¼Œæ‰«æ trx_sys-\u003erw_trx_listï¼Œå¯¹æ¢å¤çš„äº‹åŠ¡ï¼Œå›æ»šTRX_STATE_ACTIVEäº‹åŠ¡ï¼ˆtrx_rollback_activeï¼‰ã€æ¸…ç†COMMITTED_IN_MEMORYäº‹åŠ¡ï¼ˆtrx_free_resurrectedï¼‰ã€‚ åå°å›æ»šçº¿ç¨‹trx_recovery_rollback_threadæœ€ç»ˆé€šè¿‡trx_rollback_activeåå‘åº”ç”¨ trx undo log åæäº¤ï¼ˆrollbackæœ¬èº«ä¹Ÿæ˜¯é€šè¿‡trx_commitè¡¨ç¤ºäº‹åŠ¡å®Œæˆï¼‰æ¥å›æ»šæ´»è·ƒäº‹åŠ¡ã€‚ è¿™é‡Œå¯ä»¥çœ‹åˆ°åœ¨ recovery çš„å‰å‘ redo æ˜¯ä¸ä¼šä½¿ç”¨åˆ° undo çš„ï¼Œå·²ç»æŒä¹…åŒ–çš„ redo å¯¹åº”éœ€è¦çš„ undo è‚¯å®šå·²ç»è¢«æŒä¹…åŒ–ï¼Œå‰å‘ redo æœ¬èº«ä¹Ÿä¸åœ¨äº§ç”Ÿé¢å¤– undoã€‚æ­¤å¤–ä¹Ÿå†æ¬¡å¯è§ï¼Œundo å†…å®¹æ˜¯ä»¥æ•°æ®æ¨¡å¼è®°å½•çš„ã€‚\nåº”ç”¨Undo å®é™…åº”ç”¨ undo æ˜¯åœ¨ row_undo_step ä¸­:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 row_undo_step() -\u003e ... | row_undo_ins // undo insert type | row_undo_ins_parse_undo_rec(undo_node_t) // å°† insert undo ä¸­çš„å†…å®¹ parseå‡ºæ¥ä¾›åç»­undoä½¿ç”¨ | trx_undo_rec_get_pars() // è§£æå¸¸è§„å‚æ•°ï¼šæ˜¯å¦æœ‰LOB field updateï¼Œtype compilation infoï¼Œundo no | trx_undo_rec_get_row_ref() // æ„å»º row referenceï¼ˆdtuple_tï¼Œå³index recordçš„å†…å­˜å¯¹è±¡ï¼‰ | row_undo_search_clust_to_pcur() // åœ¨ä¸»é”®ä¸Šç´¢å¼•row referenceï¼Œåˆ¤æ–­æ˜¯å¦æ‰¾åˆ°çš„ä¸»é”®æ˜¯éœ€è¦undoçš„ä¸»é”®ï¼ˆå®šä½ undo_node_t-\u003epcurï¼‰ï¼Œç³»ç»Ÿåˆ—ç­‰ä¹Ÿéœ€è¦ä¸€è‡´ | row_undo_ins_remove_sec_rec(undo_node_t, que_thr_t) // å…ˆ åˆ é™¤ æ‰€æœ‰äºŒçº§ç´¢å¼•ï¼ˆå’Œæ­£å‘è·¯å¾„ç›¸åæ–¹å‘ï¼‰ | row_undo_ins_remove_clust_rec(undo_node_t) // å† åˆ é™¤ ä¸»é”®çº§ç´¢å¼• | row_undo_mod // undo undo type | row_undo_mod_parse_undo_rec() | trx_undo_rec_get_pars() | trx_undo_update_rec_get_sys_cols() // è·å–è€ç‰ˆæœ¬recordçš„ç³»ç»Ÿåˆ— | trx_undo_rec_get_row_ref() | trx_undo_update_rec_get_update() // æ„å»ºè€ç‰ˆæœ¬recordçš„update vectorç”¨äºåç»­updateä½¿ç”¨ | row_undo_search_clust_to_pcur() | row_undo_mod_upd_exist_sec() / row_undo_mod_del_mark_sec() / row_undo_mod_upd_del_sec() // å…ˆ æ›´æ–° äºŒçº§ç´¢å¼• | row_undo_mod_clust() // å† æ›´æ–° ä¸»é”®ç´¢å¼• é¦–å…ˆè§£æéœ€è¦è¢«åº”ç”¨çš„ undoï¼Œè¿™é‡Œæ¶‰åŠå¼€ innodb è¡¨ï¼Œä¸”åœ¨åå°å›æ»šæƒ…å†µä¸‹è¿™é‡Œå†éœ€è¦åŠ ä¸Š DD çš„ MDL é”ï¼› åœ¨row_undo_search_clust_to_pcuré€šè¿‡ undo é‡Œé¢çš„ key ä¿¡æ¯åœ¨ä¸»é”®ä¸Šç´¢å¼• row referenceï¼Œå¹¶æ ¹æ® roll_ptr åˆ¤æ–­æ‰¾åˆ°çš„ä¸»é”®æ˜¯å¦æ˜¯éœ€è¦undoçš„ä¸»é”®ã€‚å¦‚æœæ‰¾åˆ°åˆ™æ„å»ºå¹¶å­˜å‚¨æ‰¾åˆ°çš„ index record çš„å†…å­˜ç»“æ„ dtuple_tï¼Œå¦‚æœæ˜¯ updateï¼Œè¿˜éœ€æ„å»ºå‡ºæ¥ update ä¹‹å‰çš„ç‰ˆæœ¬ï¼ˆå³åº”ç”¨äº†undoåè¿˜åŸçš„åŸå…ˆç‰ˆæœ¬ï¼‰ï¼› å¯¹äº insert çš„ undo è¾ƒä¸ºç®€å•ï¼Œä»äºŒçº§ç´¢å¼•åˆ°ä¸»é”®åˆ é™¤ç›®æ ‡ recordï¼› å¯¹äº update çš„ undoï¼Œåœ¨äºŒçº§ç´¢å¼•ä¸Šï¼Œï¼ˆæ³¨æ„ä¸‰ç§ undo ç±»å‹æ˜¯å¯¹ä¸»é”®ç´¢å¼• rec æ¥è¯´çš„æ“ä½œç±»å‹ï¼‰ UPD_EXISTï¼ˆåŸæ“ä½œä¸º update ä¸»é”®è®°å½•ï¼‰çš„ undoï¼Œä¼šåˆ¤æ–­ undo é“¾ä¸Šæ˜¯å¦æœ‰æ›´æ–°é delete mark ä¸»é”®ä¾èµ–è¿™ä¸ªäºŒçº§ç´¢å¼•è®°å½•ï¼Œæœ‰åˆ™æ ‡è®°åˆ é™¤ æˆ– æ— åˆ™ç‰©ç†åˆ é™¤ ç°æœ‰äºŒçº§ç´¢å¼•è®°å½•ï¼Œå† æ›´æ–° æˆ– æ’å…¥ undone çš„è€ recordï¼› DEL_MARKï¼ˆåŸæ“ä½œä¸º delete mark ä¸»é”®è®°å½•ï¼‰çš„ undoï¼Œä¼š å»é™¤åˆ é™¤æ ‡è®° ç°æœ‰äºŒçº§ç´¢å¼•è®°å½•ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ é‡æ–°æ’å…¥ï¼› UPD_DELï¼ˆåŸæ“ä½œä¸º undelete markï¼Œå¯èƒ½ update field å·²æ ‡è®°åˆ é™¤çš„ä¸»é”®è®°å½•ï¼‰çš„ undoï¼Œä¼šæ ¹æ®å¯è§æ€§ æ ‡è®°åˆ é™¤ æˆ– ç‰©ç†åˆ é™¤ ç°æœ‰äºŒçº§ç´¢å¼•è®°å½•ã€‚ å¯¹äº update çš„ undoï¼Œåœ¨ä¸»é”®ä¸Šåˆ™èµ° btr_cur çš„ update é€»è¾‘è¿›è¡Œæ›´æ–°ï¼Œå¯¹äº UPD_DEL è¿˜ä¼šä¸»åŠ¨å°è¯•æ¸…ç†æ ‡è®°åˆ é™¤çš„ä¸»é”® recordã€‚ å€¼å¾—ä¸€ä½“çš„æ˜¯åœ¨å´©æºƒæ¢å¤çš„ undo äº‹åŠ¡ï¼Œäº‹åŠ¡é”åœ¨åˆå§‹çŠ¶æ€ä¸‹éƒ½æ˜¯éšå¼é”ï¼Œæ˜¯é€šè¿‡å…¶ä»–å†²çªäº‹åŠ¡åœ¨åŠ é”æ—¶é€šè¿‡lock_rec_convert_impl_to_expl æˆ– undo åº”ç”¨é˜¶æ®µé€šè¿‡ row_convert_impl_to_expl_if_needed åŠ ä¸Šäº‹åŠ¡é”ã€‚æ­¤è¿‡ç¨‹ä¸­åŠ çš„éƒ½æ˜¯ record lockï¼Œè¿™æ˜¯ç”±äºåå° undo ä¸è¢«ç”¨æˆ·æ‰€è§ï¼Œå…¶æœ¬èº«ä¸å…·å¤‡å¯è§æ€§è¦æ±‚å› æ­¤ä¸ä¼šåŠ ä¸Š next key lockã€‚\n5. å›æ”¶Undoçš„ä»£ç é€»è¾‘ åœ¨ innobase_post_recover ä¸­ ddlæ¢å¤å®Œæˆåï¼Œä¿è¯ InnoDB metadata å’Œ file system ä¸€è‡´åçš„é˜¶æ®µï¼Œç³»ç»Ÿä¼šå¯åŠ¨ srv_purge_coordinator_thread å’Œ srv_worker_thread æ¥purge undoï¼Œç›¸å…³å†…å®¹ä¼šåœ¨ purge ç³»ç»Ÿä¸­ä»‹ç»ã€‚\nç‰ˆæƒå£°æ˜ï¼šå¦‚éœ€è½¬è½½æˆ–å¼•ç”¨ï¼Œè¯·é™„åŠ æœ¬æ–‡é“¾æ¥å¹¶æ³¨æ˜æ¥æºã€‚ ",
  "wordCount" : "839",
  "inLanguage": "zh",
  "datePublished": "2023-10-13T00:00:00Z",
  "dateModified": "2023-10-13T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Miao Zheyu"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://mzyee.github.io/posts/mysql/undo/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "MZY's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://mzyee.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://mzyee.github.io" accesskey="h" title=" MZY&#39;s Blog (Alt + H)">
                <img src="https://mzyee.github.io/img/eye.jpg" alt="" aria-label="logo"
                    height="38"> MZY&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://mzyee.github.io/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://mzyee.github.io/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://mzyee.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://mzyee.github.io/contact" title="Contact">
                    <span>Contact</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://mzyee.github.io">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://mzyee.github.io/posts/">Posts</a>&nbsp;Â»&nbsp;<a href="https://mzyee.github.io/posts/mysql/">MySQL</a></div>
    <h1 class="post-title">
      InnoDB Undo Log ä»£ç å­¦ä¹ 
    </h1>
    <div class="post-meta"><span title='2023-10-13 00:00:00 +0000 UTC'>åæœˆ 13, 2023</span>&nbsp;Â·&nbsp;4 åˆ†é’Ÿ&nbsp;Â·&nbsp;Miao Zheyu
      &nbsp;|&nbsp;ğŸ“– &nbsp;
      <ul class="post-tags-meta">
        <a href="https://mzyee.github.io/tags/mysql/">MySQL</a>
        <a href="https://mzyee.github.io/tags/undo/">&nbsp;Undo</a>
      </ul>&nbsp;|&nbsp;<a href="https://github.com/mzyee/mzyee.github.io" rel="noopener noreferrer" target="_blank">Suggestions</a>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#1-%e5%89%8d%e8%a8%80" aria-label="1. å‰è¨€">1. å‰è¨€</a></li>
                    <li>
                        <a href="#2-undo%e7%9a%84%e7%89%a9%e7%90%86%e7%bb%84%e7%bb%87" aria-label="2. Undoçš„ç‰©ç†ç»„ç»‡">2. Undoçš„ç‰©ç†ç»„ç»‡</a></li>
                    <li>
                        <a href="#3-%e7%94%9f%e6%88%90undo%e7%9a%84%e4%bb%a3%e7%a0%81%e9%80%bb%e8%be%91" aria-label="3. ç”ŸæˆUndoçš„ä»£ç é€»è¾‘">3. ç”ŸæˆUndoçš„ä»£ç é€»è¾‘</a><ul>
                            
                    <li>
                        <a href="#%e5%88%86%e9%85%8d%e5%9b%9e%e6%bb%9a%e6%ae%b5" aria-label="åˆ†é…å›æ»šæ®µ">åˆ†é…å›æ»šæ®µ</a></li>
                    <li>
                        <a href="#%e5%88%86%e9%85%8dundo" aria-label="åˆ†é…Undo">åˆ†é…Undo</a></li>
                    <li>
                        <a href="#%e5%86%99%e5%85%a5undo-reocrd" aria-label="å†™å…¥Undo Reocrd">å†™å…¥Undo Reocrd</a></li>
                    <li>
                        <a href="#%e4%ba%8b%e5%8a%a1%e6%8f%90%e4%ba%a4%e6%97%b6%e7%9a%84undo%e5%a4%84%e7%90%86" aria-label="äº‹åŠ¡æäº¤æ—¶çš„Undoå¤„ç†">äº‹åŠ¡æäº¤æ—¶çš„Undoå¤„ç†</a></li></ul>
                    </li>
                    <li>
                        <a href="#4-%e5%ba%94%e7%94%a8undo%e7%9a%84%e4%bb%a3%e7%a0%81%e9%80%bb%e8%be%91" aria-label="4. åº”ç”¨Undoçš„ä»£ç é€»è¾‘">4. åº”ç”¨Undoçš„ä»£ç é€»è¾‘</a><ul>
                            
                    <li>
                        <a href="#%e5%a5%94%e6%ba%83%e6%81%a2%e5%a4%8d%e6%97%b6rollback" aria-label="å¥”æºƒæ¢å¤æ—¶Rollback">å¥”æºƒæ¢å¤æ—¶Rollback</a></li>
                    <li>
                        <a href="#%e5%ba%94%e7%94%a8undo" aria-label="åº”ç”¨Undo">åº”ç”¨Undo</a></li></ul>
                    </li>
                    <li>
                        <a href="#5-%e5%9b%9e%e6%94%b6undo%e7%9a%84%e4%bb%a3%e7%a0%81%e9%80%bb%e8%be%91" aria-label="5. å›æ”¶Undoçš„ä»£ç é€»è¾‘">5. å›æ”¶Undoçš„ä»£ç é€»è¾‘</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>


  <div class="post-content"><h3 id="1-å‰è¨€">1. å‰è¨€<a hidden class="anchor" aria-hidden="true" href="#1-å‰è¨€">#</a></h3>
<p>â€ƒâ€ƒ å·²ç»æœ‰ä¸å°‘æ–‡ç« å¯¹ InnoDB çš„ undo ç³»ç»Ÿè¿›è¡Œäº†å…¨é¢ä»‹ç»ï¼Œæ¯”å¦‚ï¼š</p>
<ul>
<li><a href="http://mysql.taobao.org/monthly/2015/04/01/">InnoDB undo log æ¼«æ¸¸</a></li>
<li><a href="http://mysql.taobao.org/monthly/2021/12/02/">InnoDBä¹‹UNDO LOGä»‹ç»</a></li>
<li><a href="http://mysql.taobao.org/monthly/2021/10/01/">åº–ä¸è§£InnoDBä¹‹UNDO LOG</a></li>
</ul>
<p>â€ƒâ€ƒ æœ¬æ–‡ä¸»è¦å…³æ³¨ä¸€äº› Undo ç³»ç»Ÿè®¾è®¡/ä»£ç å®ç°æ˜ å°„ï¼Œä»¥åŠéƒ¨åˆ†ç¬”è€…å…³å¿ƒçš„ä»£ç ç»†èŠ‚ï¼Œå»ºè®®ç»“åˆé˜…è¯»ä¸Šè¿°æ–‡ç« ã€‚</p>
<!-- undo ç‰©ç†ç»„ç»‡ -->
<h3 id="2-undoçš„ç‰©ç†ç»„ç»‡">2. Undoçš„ç‰©ç†ç»„ç»‡<a hidden class="anchor" aria-hidden="true" href="#2-undoçš„ç‰©ç†ç»„ç»‡">#</a></h3>
<p>â€ƒâ€ƒ é¦–å…ˆè¦æ˜ç¡®çš„ä¸€ç‚¹æ˜¯ InnoDB çš„ undo log å®é™…ä¸Šæ˜¯ä»¥è¡¨æ•°æ®æ ¼å¼è®°å½•çš„ï¼ˆæ‰€ä»¥å« undo tablespaceï¼‰ï¼Œå¹¶ä¸”é™¤äº† temporary table çš„ undoï¼Œæ­£å¸¸ç”¨æˆ·è¡¨ undo éƒ½é€šè¿‡ redo æ¥ç»´æŠ¤æŒä¹…æ€§ã€‚</p>
<p>â€ƒâ€ƒ ç”±äºé€šè¿‡è¡¨ç©ºé—´å­˜å‚¨ undo logï¼Œæ‰€ä»¥ undo æ–‡ä»¶çš„åŸºç¡€ç»„ç»‡å½¢å¼æ˜¯ç±»ä¼¼ InnoDB çš„ ibd æ–‡ä»¶ï¼Œå†…éƒ¨æœ‰å¦‚ <strong>File Segment</strong> ç­‰æ¦‚å¿µã€æœ‰å„ç§æ–‡ä»¶ç»´æŠ¤ç»“æ„çš„ listã€æœ‰ page ä¸Šæ–‡ä»¶ç»´æŠ¤ç»“æ„ç›¸å…³çš„ metaï¼Œç­‰ç­‰ã€‚å¹¶ä¸”åˆ†é… undo page æ—¶å€™ä¹Ÿæ˜¯é€šè¿‡ <code>fsp_reserve_free_extents</code> è¿™ä¸€æ¥å£å»ç”³è¯·ç©ºé—²æ•°æ®é¡µã€‚</p>
<p>â€ƒâ€ƒ æ¯ä¸ª Undo Tablespace æœ‰æœ€å¤š128ä¸ªå¯ç”¨çš„ <strong>Rollback Segment</strong>ï¼ŒUndo Tablespace ç¬¬ä¸‰ä¸ªé¡µæœ‰128ä¸ª Rollback Segment çš„ç›®å½•ï¼ˆRollback Segment Header&rsquo;s Arraryï¼‰ï¼Œå…¶ä¸­æ¯ä¸ªå…ƒç´ æŒ‡å‘å„ä¸ª Rollback Segment Header æ‰€åœ¨çš„ page numberã€‚åˆå§‹åŒ–æ—¶å€™ä¼šå¤„ç†æ‰€æœ‰ Rollback Segmentï¼Œå¦‚æœæœªä½¿ç”¨åˆ™ä¸º FIL_NULLï¼Œé€šè¿‡ innodb_rollback_segments å‚æ•°æ§åˆ¶å®é™…ä½¿ç”¨æ•°ç›®ã€‚</p>
<p>â€ƒâ€ƒ ä¸€ä¸ª Rollback Segment Header åŒ…å«1024ä¸ª slotï¼ˆå››å­—èŠ‚ï¼‰ï¼Œæ¯ä¸ª slot æŒ‡å‘ <strong>Undo Segment</strong> çš„ first page numberï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ª Undo Segment çš„ <strong>Undo Header Page</strong>ã€‚æ¯ä¸€æ—¶åˆ»ï¼Œæ¯ä¸ªä½¿ç”¨çš„ Undo Segment éƒ½è¢«ä¸€ä¸ªäº‹åŠ¡ç‹¬å ï¼Œè€Œæ¯ä¸ªå†™äº‹åŠ¡éƒ½ä¼šæŒæœ‰è‡³å°‘ä¸€ä¸ªUndo Segmentï¼Œå› æ­¤è¢«ä½¿ç”¨çš„ Undo Header Page ä¸­åªæœ‰ä¸€ä¸ªæœªæäº¤äº‹åŠ¡çš„ Undo Segment Headerï¼Œå½“æ´»è·ƒäº‹åŠ¡äº§ç”Ÿçš„ undo è¶…è¿‡ Undo Header Page å®¹é‡åä¼šè¢«åˆ†é…æ–°çš„ <strong>Undo Normal Page</strong>ã€‚</p>
<p>â€ƒâ€ƒ å†™äº‹åŠ¡åœ¨ä¿®æ”¹æ•°æ®å‰ï¼Œä¼šå…ˆé€šè¿‡ <strong>Undo Log</strong> è®°å½•ä¿®æ”¹å‰çš„ï¼ˆä¸»é”®ï¼‰æ•°æ®ï¼Œå¹¶ä¸” undo åˆ†ä¸º insert (UNDO_INSERT) å’Œ update (UNDO_UPD_EXISTã€UNDO_DEL_MARKã€UNDO_UPD_DEL) ä¸¤ç±»ã€‚è®°å½• undo log å‰ä¼šå…ˆå†™å…¥ Undo Log Header ç”¨äºæ ‡è®°å’Œå®šä½ï¼Œç„¶åé€æ¡å†™å…¥ <strong>Undo Record</strong>ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">  File Segment       |- File Segment Header
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Rollback Segment   |- Rollback Segment Header
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Undo Segment       |- Undo Segment Header
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Undo Page          |- Undo Page Header
</span></span><span class="line"><span class="cl">    Undo Header Page
</span></span><span class="line"><span class="cl">    Undo Normal Page
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Undo Log           |- Undo Log Header
</span></span><span class="line"><span class="cl">    Undo Record      |- head, body, tail
</span></span></code></pre></td></tr></table>
</div>
</div><p>â€ƒâ€ƒ å¯ä»¥é€šè¿‡å‚è€ƒèµ„æ–™ä¸­çš„è¿™ä¸ªå›¾æ¥æŸ¥çœ‹ä¸Šè¿°ç‰©ç†ç»“æ„çš„é€»è¾‘å…³ç³»ï¼Œæ›´å…·ä½“çš„ç»†èŠ‚ç»“æ„å®šä¹‰å¯ä»¥æŸ¥çœ‹<code>trx0undo.h</code>æ–‡ä»¶ã€‚</p>
<center><img loading="lazy" src="phy_undo.png" width="100%" /></center>
<!-- undo ä»£ç é€»è¾‘ -->
<h3 id="3-ç”Ÿæˆundoçš„ä»£ç é€»è¾‘">3. ç”ŸæˆUndoçš„ä»£ç é€»è¾‘<a hidden class="anchor" aria-hidden="true" href="#3-ç”Ÿæˆundoçš„ä»£ç é€»è¾‘">#</a></h3>
<h4 id="åˆ†é…å›æ»šæ®µ">åˆ†é…å›æ»šæ®µ<a hidden class="anchor" aria-hidden="true" href="#åˆ†é…å›æ»šæ®µ">#</a></h4>
<p>â€ƒâ€ƒ å¯¹äºåªè¯»äº‹åŠ¡ï¼Œå½“äº‹åŠ¡æ¶‰åŠåˆ°å¯¹ä¸´æ—¶è¡¨çš„è¯»å†™æ—¶ï¼Œä¼šä¸ºå…¶åˆ†é…ä¸€ä¸ªå›æ»šæ®µå¯¹å…¶äº§ç”Ÿçš„ undo log record è¿›è¡Œè®°å½•ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">trx_assign_rseg_temp</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">-&gt;</span> <span class="n">get_next_temp_rseg</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>â€ƒâ€ƒ å¯¹äºè¯»å†™äº‹åŠ¡ï¼Œå½“äº‹åŠ¡è¿›å…¥è¯»å†™æ¨¡å¼æ—¶ï¼Œä¼šä¸ºå…¶åˆ†é… trx_id ä»¥åŠå›æ»šæ®µï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">trx_assign_rseg_durable</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">-&gt;</span> <span class="n">get_next_redo_rseg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">-&gt;</span> <span class="n">get_next_redo_rseg_from_trx_sys</span><span class="p">()</span> <span class="o">/</span> <span class="n">get_next_redo_rseg_from_undo_spaces</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>â€ƒâ€ƒ åˆ†é…è¡Œä¸ºåªæ˜¯ä¸€ä¸ªåŸºäºè½®è¯¢çš„å†…å­˜æ“ä½œï¼Œé¡ºåºä¸º[(space0, rseg0), (space1, rseg0), &hellip; (spaceN, rseg0), (space1, rseg0)&hellip;]ï¼Œæœ€ç»ˆä¼šä¸º trx è¿”å›ä¸€ä¸ªæœ‰æ•ˆçš„ trx_rseg_tï¼ˆå›æ»šæ®µçš„å†…å­˜ç»“æ„ï¼‰ã€‚ä¸€ä¸ªäº‹åŠ¡æœ€å¤šä¼šæœ‰2ä¸ª rollback segmentï¼ˆtemp/durableåŒºåˆ†ï¼‰å’Œ 4ä¸ª undo segmentï¼ˆinsert/updateå†æ¬¡åŒºåˆ†ï¼‰ã€‚</p>
<h4 id="åˆ†é…undo">åˆ†é…Undo<a hidden class="anchor" aria-hidden="true" href="#åˆ†é…undo">#</a></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">  <span class="n">trx_undo_report_row_operation</span><span class="p">()</span> <span class="o">&lt;-</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="nl">Path1</span><span class="p">:</span> <span class="n">btr_cur_ins_lock_and_undo</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="n">btr_cur_optimistic_insert</span> <span class="o">/</span> <span class="n">btr_cur_pessimistic_insert</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="nl">Path2</span><span class="p">:</span> <span class="n">btr_cur_upd_lock_and_undo</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="n">btr_cur_update_in_place</span> <span class="o">/</span> <span class="n">btr_cur_optimistic_update</span> <span class="o">/</span> <span class="n">btr_cur_pessimistic_update</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="nl">Path3</span><span class="p">:</span> <span class="n">btr_cur_del_mark_set_clust_rec</span>
</span></span><span class="line"><span class="cl">        <span class="o">|&lt;-</span> <span class="err">è¡Œçº§åˆ«æ“ä½œæ¥å£</span>
</span></span><span class="line"><span class="cl"><span class="c1">// é€šè¿‡ BTR_NO_UNDO_LOG_FLAG æ ‡è®°å†³å®šæ˜¯å¦è®°å½• undo
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>â€ƒâ€ƒ å‡½æ•°<code>trx_undo_report_row_operation</code>æ˜¯å†™å…¥undoçš„ä»£ç æ¥å£ï¼Œé¦–å…ˆä¼šå¦‚æœå½“å‰äº‹åŠ¡æ²¡æœ‰åˆ†é…è¿‡æ‰€éœ€ç±»å‹çš„ undo segmentï¼Œåˆ™ä¼šé€šè¿‡<code>trx_undo_assign_undo</code>åˆ†é… undo segment/pageï¼ˆ<code>trx_undo_t</code>ç»“æ„ï¼‰ï¼Œé¦–å…ˆå°è¯•ä»å½“å‰ trx_rseg_t çš„ insert/update cacheä¸­å–ï¼ˆæ¥å£ä¸º<code>trx_undo_reuse_cached</code>ï¼Œcache å†…æ˜¯å¦‚æœå¯¹åº”undoäº‹åŠ¡ç»“æŸæ—¶å€™æ‰€ä½¿ç”¨çš„ undo page æ‰€ç”¨ç©ºé—´å°äº3/4åˆ™è¢«åŠ å…¥çš„ï¼‰ï¼Œcache ä¸­æ²¡æœ‰åˆ™åœ¨ç©ºé—´æ€»é‡æ–°åˆ†é…ä¸€ä¸ªundo segmentï¼ˆæ¥å£ä¸º<code>trx_undo_create</code>ï¼‰ã€‚åˆ†é…å¥½ undo page ä»ç©ºé—²ä½ç½®å¼€å§‹å¯¹åº”å†™å…¥ Undo Recordï¼Œå¦‚æœ undo page çš„å‰©ä½™ç©ºé—´ä¸æ»¡è¶³è¦æ±‚åˆ™é€šè¿‡<code>trx_undo_add_page</code>åŠ ä¸€ä¸ªç©ºç™½çš„ normal page è®°å½• Undo Recordã€‚</p>
<p>â€ƒâ€ƒ æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œé™¤äº†ç‰©ç† undo page æ›´æ–°åŠé€šè¿‡ redo æŒä¹…åŒ–ï¼Œè¿˜ç»´æŠ¤äº†å†…å­˜ä¸­çš„å½“å‰äº‹åŠ¡æ‰€ä½¿ç”¨çš„ trx_undo_t ç»“æ„ä½“ï¼ˆtrx-&gt;rsegs.m_redo/ m_noredo.insert_undo/ update_undoï¼‰ï¼ŒåŒ…æ‹¬ header pageã€log headerã€top undo page/offsetç­‰ä¿¡æ¯ã€‚</p>
<h4 id="å†™å…¥undo-reocrd">å†™å…¥Undo Reocrd<a hidden class="anchor" aria-hidden="true" href="#å†™å…¥undo-reocrd">#</a></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// Insertç±»å‹ï¼šTRX_UNDO_INSERT_REC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="cm">/*-------- header ------*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">Next_record_offset</span>  <span class="mi">2</span><span class="n">B</span>
</span></span><span class="line"><span class="cl">  <span class="n">Type_flags</span>          <span class="mi">1</span><span class="n">B</span>
</span></span><span class="line"><span class="cl">  <span class="n">Undo_no</span>             <span class="n">compressed</span>
</span></span><span class="line"><span class="cl">  <span class="n">Table_id</span>            <span class="n">compressed</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/*-------- key field ------*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">Key_field_1_len</span>     <span class="n">compressed</span>
</span></span><span class="line"><span class="cl">  <span class="n">Key_field_1_data</span>    <span class="n">compressed</span>
</span></span><span class="line"><span class="cl">  <span class="p">...(</span><span class="err">ä»¥ä¸Š</span> <span class="n">dict_index_get_n_unique</span> <span class="err">ä¸ª</span> <span class="n">field</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/*-------- tail ------*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">Next_record_offset</span>  <span class="mi">2</span><span class="n">B</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// Updateç±»å‹ï¼šTRX_UNDO_UPD_EXIST_RECã€TRX_UNDO_DEL_MARK_RECã€TRX_UNDO_UPD_DEL_REC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="cm">/*-------- header ------*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">Next_record_offset</span>  <span class="mi">2</span><span class="n">B</span>
</span></span><span class="line"><span class="cl">  <span class="n">Type_flags</span>          <span class="mi">1</span><span class="n">B</span>
</span></span><span class="line"><span class="cl">  <span class="n">Undo_no</span>             <span class="n">compressed</span>
</span></span><span class="line"><span class="cl">  <span class="n">Table_id</span>            <span class="n">compressed</span>
</span></span><span class="line"><span class="cl">  <span class="n">Rec_info</span>            <span class="mi">1</span><span class="n">B</span>
</span></span><span class="line"><span class="cl">  <span class="n">Trx_id</span>              <span class="n">compressed</span>
</span></span><span class="line"><span class="cl">  <span class="n">Roll_ptr</span>            <span class="n">compressed</span> <span class="c1">//æŒ‡å‘çš„æ˜¯è¯¥è®°å½•çš„ä¸Šä¸€ä¸ªç‰ˆæœ¬çš„ä½ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="cm">/*-------- key field ------*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">Key_field_1_len</span>     <span class="n">compressed</span>
</span></span><span class="line"><span class="cl">  <span class="n">Key_field_1_data</span>    <span class="n">len</span>
</span></span><span class="line"><span class="cl">  <span class="p">...(</span><span class="err">ä»¥ä¸Š</span> <span class="n">dict_index_get_n_unique</span> <span class="err">ä¸ª</span> <span class="n">field</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">Update_field_num</span>    <span class="n">compressed</span>  <span class="c1">// ä¿®æ”¹çš„fieldæ•°ç›®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">Update_field_1_pos</span>  <span class="n">compressed</span>
</span></span><span class="line"><span class="cl">  <span class="n">Update_field_1_len</span>  <span class="n">compressed</span>
</span></span><span class="line"><span class="cl">  <span class="n">Update_field_1_ctx</span>  <span class="n">len</span> <span class="c1">//è¿™æ¬¡ä¿®æ”¹å‰çš„fieldä¿¡æ¯ï¼Œåº”ç”¨è¿™ä¸ªå¯ä»¥è¿”å›åˆ°ä¿®æ”¹ä¹‹å‰åˆ°å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">...(</span><span class="err">ä»¥ä¸Š</span> <span class="n">upd_t</span> <span class="err">ä¸­ä¸ª</span> <span class="n">field</span> <span class="err">æ•°ç›®</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/*-------- tail ------*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">Next_record_offset</span>  <span class="mi">2</span><span class="n">B</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>â€ƒâ€ƒ Undo Recordçš„å†…å®¹æ ¼å¼å¦‚ä¸Šæ‰€ç¤ºï¼Œè¿™é‡Œå†é¢å¤–è¯´æ˜ä¸‹ï¼š</p>
<ul>
<li>å¯¹äº insert undoï¼Œè®°å½•çš„æ˜¯æ’å…¥çš„ entry çš„ key éƒ¨åˆ†ï¼Œç”¨äºå›æ»šæ—¶å®šä½å¯»æ‰¾å¹¶åˆ é™¤ï¼Œinsert æ“ä½œä¸å­˜åœ¨å¯è§æ€§åˆ¤è¯»å› æ­¤æ²¡æœ‰è®°å½•Trx_idï¼›</li>
<li>å¯¹äº update undoï¼Œä¼ å…¥çš„å‚æ•°æ—¶ index_recordï¼ˆrec_tï¼‰å’Œ updateï¼ˆupd_tï¼‰è¿™ä¸ªå†…å­˜ç»“æ„ï¼Œå®é™…è®°å½•çš„æ˜¯ record key å’Œè¦è¢«ä¿®æ”¹çš„ fieldï¼Œå‰è€…ç”¨äºå®šä½ï¼Œåè€…ç”¨äºè¿˜åŸåˆ°åŸå§‹ç‰ˆæœ¬ã€‚</li>
<li>å¯¹ä¸»é”®æ•°æ®ç”Ÿæˆ undo åå°±äº§ç”Ÿäº† roll_ptr å¹¶å¯¹æ–° record è¿›è¡Œæ›´æ–°ï¼Œå°±æ˜¯é€šè¿‡ roll_ptr å°† record çš„æ‰€æœ‰ç‰ˆæœ¬é“¾æ¥èµ·æ¥ã€‚</li>
</ul>
<h4 id="äº‹åŠ¡æäº¤æ—¶çš„undoå¤„ç†">äº‹åŠ¡æäº¤æ—¶çš„Undoå¤„ç†<a hidden class="anchor" aria-hidden="true" href="#äº‹åŠ¡æäº¤æ—¶çš„undoå¤„ç†">#</a></h4>
<p>â€ƒâ€ƒ åœ¨ <code>trx_commit</code> çš„æ—¶å€™ï¼Œå¦‚æœäº‹åŠ¡å‘ç”Ÿä¿®æ”¹å¹¶äº§ç”Ÿäº† undoï¼š</p>
<ul>
<li>è®¾ç½® undo åç»­å¤„ç†çŠ¶æ€ï¼š undo ä½¿ç”¨å•ä¸ª page ä¸”ä½¿ç”¨é‡å°äº 3/4 çš„ä¼šè¢«è®¾ç½®ä¸º TRX_UNDO_CACHED çŠ¶æ€ï¼›å…¶ä½™çš„ insert undo çŠ¶æ€è¢«è®¾ç½®ä¸º TRX_UNDO_TO_FREEï¼Œupdate undo çŠ¶æ€è¢«è®¾ç½®ä¸º TRX_UNDO_TO_PURGEï¼›</li>
<li>ç»™äº‹åŠ¡åˆ†é…æäº¤é¡ºåº trx_noï¼›</li>
<li>å¯¹ update undo å›æ»šæ®µçš„å†…å­˜ç»“æ„ï¼ŒåŠ å…¥ purge_sys-&gt;purge_queue è¿™ä¸€é˜Ÿåˆ—ï¼ˆå…¶å†…æŒ‰äº‹åŠ¡æäº¤æ—¶çš„ trx-&gt;no æ’åˆ—ï¼‰ä»¥ç»™ purge ç³»ç»Ÿå®šä½å›æ”¶ï¼›</li>
<li>å°† trx-&gt;no å†™å…¥ rseg/undo headerï¼Œå¹¶ undo header å°†åŠ å…¥åˆ° rseg header ä¸­ history list çš„å¼€å§‹ï¼›</li>
<li>å¯¹ update undoï¼Œå†…å­˜ç»“æ„ trx_undo_t æŒ‰çŠ¶æ€åŠ å…¥ rseg-&gt;update_undo_cached æˆ– trx_undo_mem_freeï¼›</li>
<li>å¯¹ insert undoï¼Œå†…å­˜ç»“æ„ trx_undo_t æŒ‰çŠ¶æ€åŠ å…¥ rseg-&gt;insert_undo_list æˆ– trx_undo_mem_freeï¼Œå¹¶ä¸”åœ¨ rollback segment ä¸­æ¸…ç†ä¸åœ¨ history çš„ undo log segmentï¼ˆtrx_undo_seg_freeï¼‰ï¼›</li>
</ul>
<h3 id="4-åº”ç”¨undoçš„ä»£ç é€»è¾‘">4. åº”ç”¨Undoçš„ä»£ç é€»è¾‘<a hidden class="anchor" aria-hidden="true" href="#4-åº”ç”¨undoçš„ä»£ç é€»è¾‘">#</a></h3>
<p>â€ƒâ€ƒ åº”ç”¨ undo ä¸»è¦æ˜¯åœ¨ mvcc å’Œ rollback è¿‡ç¨‹ä¸­ï¼Œè€Œ rollback åˆå¯ä»¥åˆ†ä¸ºç”¨æˆ· rollback å’Œå¥”æºƒæ¢å¤ rollbackã€‚æœ¬æ–‡ä¸»è¦è®¨è®º rollback è¿‡ç¨‹ï¼Œå¯¹äº mvcc æ“ä½œä¼šå¼€å¦å¤–çš„æ–‡ç« ä¸“é—¨è®¨è®ºã€‚</p>
<h4 id="å¥”æºƒæ¢å¤æ—¶rollback">å¥”æºƒæ¢å¤æ—¶Rollback<a hidden class="anchor" aria-hidden="true" href="#å¥”æºƒæ¢å¤æ—¶rollback">#</a></h4>
<p>â€ƒâ€ƒ å¯¹äºå¥”æºƒæ¢å¤è¿‡ç¨‹ä¸­çš„ Rollbackï¼Œé¦–å…ˆéœ€è¦æ¢å¤ undo ç›¸å…³ä¿¡æ¯ï¼š</p>
<ul>
<li>é€šè¿‡ redoï¼Œåœ¨å¯åŠ¨çš„<strong>recv_recovery_from_checkpoint_start-&gt;recv_recovery_begin</strong>é˜¶æ®µæ¢å¤undoæ•°æ®ï¼›</li>
<li>é€šè¿‡æ¢å¤çš„ undo æ•°æ®ï¼Œåœ¨å¯åŠ¨çš„<strong>trx_sys_init_at_db_start</strong>é˜¶æ®µæ¢å¤æ‰€æœ‰å›æ»šæ®µçš„å†…å­˜ç»“æ„ï¼Œtrx_sys çš„æ´»è·ƒäº‹ç‰©ã€‚æ´»è·ƒäº‹ç‰©é€šè¿‡<code>trx_resurrect</code>åˆ†åˆ«æ‰«ærseg-&gt;insert_undo_list/update_undo_listï¼Œç”Ÿæˆåå°trxå¯¹è±¡å¹¶åˆå§‹åŒ–ç›¸å…³å‚æ•°å¹¶åŠ å…¥trx_sys-&gt;rw_trx_setï¼Œå†æŒ‰çŠ¶æ€åŠ å…¥ trx_sys-&gt;rw_trx_idsï¼ˆæ´»è·ƒï¼‰å’Œ trx_sys-&gt;rw_trx_listï¼ˆæ‰€æœ‰ï¼‰ã€‚</li>
<li>åœ¨ dict_recover DICT_RECOVERY_RESTART_SERVER é˜¶æ®µï¼Œ<strong>srv_dict_recover_on_restart</strong> ä¸­ä¼šåŠ ä¸Šè¡¨é”å¹¶ä»… rollback <strong>DD</strong> ç›¸å…³äº‹åŠ¡ï¼›</li>
<li>åœ¨ post_recover é˜¶æ®µæœ«å°¾ï¼Œ<strong>srv_start_threads_after_ddl_recovery</strong> å¼€å¯åå°å›æ»šçº¿ç¨‹ï¼Œæ‰«æ trx_sys-&gt;rw_trx_listï¼Œå¯¹æ¢å¤çš„äº‹åŠ¡ï¼Œå›æ»šTRX_STATE_ACTIVEäº‹åŠ¡ï¼ˆtrx_rollback_activeï¼‰ã€æ¸…ç†COMMITTED_IN_MEMORYäº‹åŠ¡ï¼ˆtrx_free_resurrectedï¼‰ã€‚</li>
<li>åå°å›æ»šçº¿ç¨‹<strong>trx_recovery_rollback_thread</strong>æœ€ç»ˆé€šè¿‡<strong>trx_rollback_active</strong>åå‘åº”ç”¨ trx undo log åæäº¤ï¼ˆrollbackæœ¬èº«ä¹Ÿæ˜¯é€šè¿‡trx_commitè¡¨ç¤ºäº‹åŠ¡å®Œæˆï¼‰æ¥å›æ»šæ´»è·ƒäº‹åŠ¡ã€‚</li>
</ul>
<p>â€ƒâ€ƒ è¿™é‡Œå¯ä»¥çœ‹åˆ°åœ¨ recovery çš„å‰å‘ redo æ˜¯ä¸ä¼šä½¿ç”¨åˆ° undo çš„ï¼Œå·²ç»æŒä¹…åŒ–çš„ redo å¯¹åº”éœ€è¦çš„ undo è‚¯å®šå·²ç»è¢«æŒä¹…åŒ–ï¼Œå‰å‘ redo æœ¬èº«ä¹Ÿä¸åœ¨äº§ç”Ÿé¢å¤– undoã€‚æ­¤å¤–ä¹Ÿå†æ¬¡å¯è§ï¼Œundo å†…å®¹æ˜¯ä»¥æ•°æ®æ¨¡å¼è®°å½•çš„ã€‚</p>
<h4 id="åº”ç”¨undo">åº”ç”¨Undo<a hidden class="anchor" aria-hidden="true" href="#åº”ç”¨undo">#</a></h4>
<p>â€ƒâ€ƒ å®é™…åº”ç”¨ undo æ˜¯åœ¨ <code>row_undo_step</code> ä¸­:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">row_undo_step</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="n">row_undo_ins</span>  <span class="c1">// undo insert type
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="o">|</span> <span class="n">row_undo_ins_parse_undo_rec</span><span class="p">(</span><span class="n">undo_node_t</span><span class="p">)</span>  <span class="c1">// å°† insert undo ä¸­çš„å†…å®¹ parseå‡ºæ¥ä¾›åç»­undoä½¿ç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">|</span> <span class="n">trx_undo_rec_get_pars</span><span class="p">()</span> <span class="c1">// è§£æå¸¸è§„å‚æ•°ï¼šæ˜¯å¦æœ‰LOB field updateï¼Œtype compilation infoï¼Œundo no
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">|</span> <span class="n">trx_undo_rec_get_row_ref</span><span class="p">()</span>  <span class="c1">// æ„å»º row referenceï¼ˆdtuple_tï¼Œå³index recordçš„å†…å­˜å¯¹è±¡ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">|</span> <span class="n">row_undo_search_clust_to_pcur</span><span class="p">()</span> <span class="c1">// åœ¨ä¸»é”®ä¸Šç´¢å¼•row referenceï¼Œåˆ¤æ–­æ˜¯å¦æ‰¾åˆ°çš„ä¸»é”®æ˜¯éœ€è¦undoçš„ä¸»é”®ï¼ˆå®šä½ undo_node_t-&gt;pcurï¼‰ï¼Œç³»ç»Ÿåˆ—ç­‰ä¹Ÿéœ€è¦ä¸€è‡´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="o">|</span> <span class="n">row_undo_ins_remove_sec_rec</span><span class="p">(</span><span class="n">undo_node_t</span><span class="p">,</span> <span class="n">que_thr_t</span><span class="p">)</span> <span class="c1">// å…ˆ åˆ é™¤ æ‰€æœ‰äºŒçº§ç´¢å¼•ï¼ˆå’Œæ­£å‘è·¯å¾„ç›¸åæ–¹å‘ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="o">|</span> <span class="n">row_undo_ins_remove_clust_rec</span><span class="p">(</span><span class="n">undo_node_t</span><span class="p">)</span> <span class="c1">// å† åˆ é™¤ ä¸»é”®çº§ç´¢å¼•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="n">row_undo_mod</span>  <span class="c1">// undo undo type
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="o">|</span> <span class="n">row_undo_mod_parse_undo_rec</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span> <span class="n">trx_undo_rec_get_pars</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span> <span class="n">trx_undo_update_rec_get_sys_cols</span><span class="p">()</span> <span class="c1">// è·å–è€ç‰ˆæœ¬recordçš„ç³»ç»Ÿåˆ—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">|</span> <span class="n">trx_undo_rec_get_row_ref</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span> <span class="n">trx_undo_update_rec_get_update</span><span class="p">()</span> <span class="c1">// æ„å»ºè€ç‰ˆæœ¬recordçš„update vectorç”¨äºåç»­updateä½¿ç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">|</span> <span class="n">row_undo_search_clust_to_pcur</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="o">|</span> <span class="n">row_undo_mod_upd_exist_sec</span><span class="p">()</span> <span class="o">/</span> <span class="n">row_undo_mod_del_mark_sec</span><span class="p">()</span> <span class="o">/</span> <span class="n">row_undo_mod_upd_del_sec</span><span class="p">()</span> <span class="c1">// å…ˆ æ›´æ–° äºŒçº§ç´¢å¼•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="o">|</span> <span class="n">row_undo_mod_clust</span><span class="p">()</span> <span class="c1">// å† æ›´æ–° ä¸»é”®ç´¢å¼•
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>é¦–å…ˆè§£æéœ€è¦è¢«åº”ç”¨çš„ undoï¼Œè¿™é‡Œæ¶‰åŠå¼€ innodb è¡¨ï¼Œä¸”åœ¨åå°å›æ»šæƒ…å†µä¸‹è¿™é‡Œå†éœ€è¦åŠ ä¸Š DD çš„ MDL é”ï¼›</li>
<li>åœ¨<code>row_undo_search_clust_to_pcur</code>é€šè¿‡ undo é‡Œé¢çš„ key ä¿¡æ¯åœ¨ä¸»é”®ä¸Šç´¢å¼• row referenceï¼Œå¹¶æ ¹æ® roll_ptr åˆ¤æ–­æ‰¾åˆ°çš„ä¸»é”®æ˜¯å¦æ˜¯éœ€è¦undoçš„ä¸»é”®ã€‚å¦‚æœæ‰¾åˆ°åˆ™æ„å»ºå¹¶å­˜å‚¨æ‰¾åˆ°çš„ index record çš„å†…å­˜ç»“æ„ dtuple_tï¼Œå¦‚æœæ˜¯ updateï¼Œè¿˜éœ€æ„å»ºå‡ºæ¥ update ä¹‹å‰çš„ç‰ˆæœ¬ï¼ˆå³åº”ç”¨äº†undoåè¿˜åŸçš„åŸå…ˆç‰ˆæœ¬ï¼‰ï¼›</li>
<li>å¯¹äº insert çš„ undo è¾ƒä¸ºç®€å•ï¼Œä»äºŒçº§ç´¢å¼•åˆ°ä¸»é”®åˆ é™¤ç›®æ ‡ recordï¼›</li>
<li>å¯¹äº update çš„ undoï¼Œåœ¨äºŒçº§ç´¢å¼•ä¸Šï¼Œï¼ˆæ³¨æ„ä¸‰ç§ undo ç±»å‹æ˜¯å¯¹ä¸»é”®ç´¢å¼• rec æ¥è¯´çš„æ“ä½œç±»å‹ï¼‰
<ul>
<li><strong>UPD_EXIST</strong>ï¼ˆåŸæ“ä½œä¸º update ä¸»é”®è®°å½•ï¼‰çš„ undoï¼Œä¼šåˆ¤æ–­ undo é“¾ä¸Šæ˜¯å¦æœ‰æ›´æ–°é delete mark ä¸»é”®ä¾èµ–è¿™ä¸ªäºŒçº§ç´¢å¼•è®°å½•ï¼Œæœ‰åˆ™<strong>æ ‡è®°åˆ é™¤</strong> æˆ– æ— åˆ™<strong>ç‰©ç†åˆ é™¤</strong> ç°æœ‰äºŒçº§ç´¢å¼•è®°å½•ï¼Œå† <strong>æ›´æ–°</strong> æˆ– <strong>æ’å…¥</strong> undone çš„è€ recordï¼›</li>
<li><strong>DEL_MARK</strong>ï¼ˆåŸæ“ä½œä¸º delete mark ä¸»é”®è®°å½•ï¼‰çš„ undoï¼Œä¼š <strong>å»é™¤åˆ é™¤æ ‡è®°</strong> ç°æœ‰äºŒçº§ç´¢å¼•è®°å½•ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ <strong>é‡æ–°æ’å…¥</strong>ï¼›</li>
<li><strong>UPD_DEL</strong>ï¼ˆåŸæ“ä½œä¸º undelete markï¼Œå¯èƒ½ update field å·²æ ‡è®°åˆ é™¤çš„ä¸»é”®è®°å½•ï¼‰çš„ undoï¼Œä¼šæ ¹æ®å¯è§æ€§ <strong>æ ‡è®°åˆ é™¤</strong> æˆ– <strong>ç‰©ç†åˆ é™¤</strong> ç°æœ‰äºŒçº§ç´¢å¼•è®°å½•ã€‚</li>
</ul>
</li>
<li>å¯¹äº update çš„ undoï¼Œåœ¨ä¸»é”®ä¸Šåˆ™èµ° btr_cur çš„ update é€»è¾‘è¿›è¡Œæ›´æ–°ï¼Œå¯¹äº UPD_DEL è¿˜ä¼šä¸»åŠ¨å°è¯•æ¸…ç†æ ‡è®°åˆ é™¤çš„ä¸»é”® recordã€‚</li>
</ul>
<p>â€ƒâ€ƒ å€¼å¾—ä¸€ä½“çš„æ˜¯åœ¨å´©æºƒæ¢å¤çš„ undo äº‹åŠ¡ï¼Œäº‹åŠ¡é”åœ¨åˆå§‹çŠ¶æ€ä¸‹éƒ½æ˜¯<strong>éšå¼é”</strong>ï¼Œæ˜¯é€šè¿‡å…¶ä»–å†²çªäº‹åŠ¡åœ¨åŠ é”æ—¶é€šè¿‡<code>lock_rec_convert_impl_to_expl</code> æˆ– undo åº”ç”¨é˜¶æ®µé€šè¿‡ <code>row_convert_impl_to_expl_if_needed</code> åŠ ä¸Šäº‹åŠ¡é”ã€‚æ­¤è¿‡ç¨‹ä¸­åŠ çš„éƒ½æ˜¯ record lockï¼Œè¿™æ˜¯ç”±äºåå° undo ä¸è¢«ç”¨æˆ·æ‰€è§ï¼Œå…¶æœ¬èº«ä¸å…·å¤‡å¯è§æ€§è¦æ±‚å› æ­¤ä¸ä¼šåŠ ä¸Š next key lockã€‚</p>
<h3 id="5-å›æ”¶undoçš„ä»£ç é€»è¾‘">5. å›æ”¶Undoçš„ä»£ç é€»è¾‘<a hidden class="anchor" aria-hidden="true" href="#5-å›æ”¶undoçš„ä»£ç é€»è¾‘">#</a></h3>
<p>â€ƒâ€ƒ åœ¨ innobase_post_recover ä¸­ ddlæ¢å¤å®Œæˆåï¼Œä¿è¯ InnoDB metadata å’Œ file system ä¸€è‡´åçš„é˜¶æ®µï¼Œç³»ç»Ÿä¼šå¯åŠ¨ srv_purge_coordinator_thread å’Œ srv_worker_thread æ¥purge undoï¼Œç›¸å…³å†…å®¹ä¼šåœ¨ <a href="/posts/mysql/purge">purge ç³»ç»Ÿ</a>ä¸­ä»‹ç»ã€‚</p>
<hr>
<!-- copyright -->
<div class="admonition">
  <div class="admonition-content">
    <ul>
      <li>ç‰ˆæƒå£°æ˜ï¼šå¦‚éœ€è½¬è½½æˆ–å¼•ç”¨ï¼Œè¯·é™„åŠ æœ¬æ–‡é“¾æ¥å¹¶æ³¨æ˜æ¥æºã€‚</li>
    </ul>
  </div>
</div>
<!-- copyright -->

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://mzyee.github.io/tags/mysql/">MySQL</a></li>
      <li><a href="https://mzyee.github.io/tags/undo/">Undo</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://mzyee.github.io/posts/mysql/purge/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>InnoDB Purge System ä»£ç å­¦ä¹ </span>
  </a>
  <a class="next" href="https://mzyee.github.io/posts/usebpf/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>é€šè¿‡ eBPF å·¥å…·è¿›è¡Œæ€§èƒ½åˆ†æ</span>
  </a>
</nav>

  </footer>
<div>
  <div class="pagination__title">
    <span class="pagination__title-h" style="font-size: 20px;">ğŸ’¬ è¯„è®º</span>
    <hr />
  </div>
  <div id="tcomment"></div>
  <script src="https://cdn.staticfile.org/twikoo/1.6.25/twikoo.all.min.js"></script>
  <script>
    twikoo.init({
      envId: "https://mzyeee.netlify.app/.netlify/functions/twikoo",  
      el: "#tcomment",
      lang: 'zh-CN',
      region: 'ap-hongkong',
      path: window.TWIKOO_MAGIC_PATH || window.location.pathname,
    });
  </script>
</div>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://mzyee.github.io">MZY&#39;s Blog</a></span>
    <span>
        | Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a>
    </span>
    <span id="busuanzi_container">
        | Viewer
        <span class="fa fa-user"></span> <span id="busuanzi_value_site_uv"></span>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerHTML = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerHTML = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
