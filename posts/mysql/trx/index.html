<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>InnoDB 事务系统和事务执行流程 | MZY&#39;s Blog</title>
<meta name="keywords" content="mysql, transaction">
<meta name="description" content="InnoDB 事务系统和事务流程代码学习">
<meta name="author" content="Miao Zheyu">
<link rel="canonical" href="https://mzyee.github.io/posts/mysql/trx/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.5cfc680b1eeaeef9efbced92d46c2a9e876b72ee14fba85846afc4cff9e6e6f8.css" integrity="sha256-XPxoCx7q7vnvvO2S1Gwqnodrcu4U&#43;6hYRq/Ez/nm5vg=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://mzyee.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://mzyee.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://mzyee.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://mzyee.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://mzyee.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="InnoDB 事务系统和事务执行流程" />
<meta property="og:description" content="InnoDB 事务系统和事务流程代码学习" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mzyee.github.io/posts/mysql/trx/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-10-30T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-10-30T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="InnoDB 事务系统和事务执行流程"/>
<meta name="twitter:description" content="InnoDB 事务系统和事务流程代码学习"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://mzyee.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "MySQL",
      "item": "https://mzyee.github.io/posts/mysql/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "InnoDB 事务系统和事务执行流程",
      "item": "https://mzyee.github.io/posts/mysql/trx/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "InnoDB 事务系统和事务执行流程",
  "name": "InnoDB 事务系统和事务执行流程",
  "description": "InnoDB 事务系统和事务流程代码学习",
  "keywords": [
    "mysql", "transaction"
  ],
  "articleBody": "前言 事务系统是 InnoDB 实现 MVCC 及 ACID、进行事务并发控制的核心模块。本文主要讨论事务系统结构和一个事务的执行流程（基于 MySQL 8.0.30），需要涉及到对 redo、undo 系统的相关知识。本文还会涉及一部分 MVCC 和 事务锁的讨论，但是更详细内容会在对 Concurrency Control 讨论的文章中给出。\n事务和事务系统的内存结构 事务和事务系统对应的内存结构分别是 trx_t 和 trx_sys_t。每个 session 连接持有一个 trx_t，其在创建连接执行第一个事务开始整个结构体就在 innobase_trx_allocate 初始化了，后续这个连接的所有事务一直复用此数据结构，直到连接断开。\n事务启动后不管读写，把这个结构体加入到全局事务链表中 (trx_sys-\u003emysql_trx_list)； 如果转换为读写事务，还会加入到全局读写事务链表中 (trx_sys-\u003erw_trx_list)；同时，读写事务在开启时（更确切的说是在分配回滚段时）通过全局 id 产生器产生以区分不同的写事务（这里 trx_id 只读事务为0，只读事务只需要通过指针地址来获取区分，如果只读事务需要写临时表，也会分配）；同时，还会分配回滚段给 trx_t 以供记录 undo record。 在事务内存提交的时候，还会加入到全局提交事务链表中(trx_sys-\u003eserialisation_list)。同时，在 trx 提交时 (trx_commit_low 的 trx_write_serialisation_history) trx_no 字段通过全局产生器产生并加入 serialisation_list，这样可以确定事务提交的顺序，保证加入到 purge_queue 和 history list 中的 update undo 有序。然后在提交的最后阶段 (trx_commit_low 的 trx_commit_in_memory)，删除 serialisation_list、释放所有事务锁、清理 insert undo、等待刷完 redo log。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 struct trx_t { mutable TrxMutex mutex; /* 保护 `state` 和 `lock` */ trx_id_t id; /* 事务 id，在开启读写事务或分配回滚段时赋予 */ trx_id_t no; /* 事务 number，在事务提交阶段赋予 */ /* 事务的可能状态: TRX_STATE_NOT_STARTED TRX_STATE_FORCED_ROLLBACK TRX_STATE_ACTIVE TRX_STATE_PREPARED TRX_STATE_COMMITTED_IN_MEMORY (alias below COMMITTED) 有效的状态转移模式: 1. Regular transactions: * NOT_STARTED -\u003e ACTIVE -\u003e COMMITTED -\u003e NOT_STARTED 2. Auto-commit non-locking read-only: * NOT_STARTED -\u003e ACTIVE -\u003e NOT_STARTED 3. XA (2PC): * NOT_STARTED -\u003e ACTIVE -\u003e PREPARED -\u003e COMMITTED -\u003e NOT_STARTED 4. Recovered XA: * NOT_STARTED -\u003e PREPARED -\u003e COMMITTED -\u003e (freed) 5. XA (2PC) (shutdown or disconnect before ROLLBACK or COMMIT): * NOT_STARTED -\u003e PREPARED -\u003e (freed) 6. Disconnected XA can become recovered: * ... -\u003e ACTIVE -\u003e PREPARED (connected) -\u003e PREPARED (disconnected) */ std::atomic\u003ctrx_state_t\u003e state; /* 一致性读所使用的 read view，里面记录了启动时刻系统的活跃事务状态： 1. trx ids 的全可见（up_to）上界/ 全不可见（low_from）下界 2. trx no 的 undo 需求下界，小于此的 undo 不被需要 3. 所有活跃事务 trx_id 的数组 */ ReadView *read_view; UT_LIST_NODE_T(trx_t) trx_list; /* rw_trx_list 节点，读写事务 */ UT_LIST_NODE_T(trx_t) no_list; /* serialisation_list 节点，提交事务 */ UT_LIST_NODE_T(trx_t) mysql_trx_list; /* mysql_trx_list 节点，所有事务 */ trx_lock_t lock; /* 事务锁信息 */ isolation_level_t isolation_level; /* 隔离等级 */ std::atomic\u003cstd:🧵:id\u003e killed_by; /*------------------------------*/ trx_dict_op_t dict_operation; /* 是否修改 data dictionary */ lsn_t commit_lsn; /* commit 时的 lsn */ /*------------------------------*/ /*----------- Undo 相关信息 -------------*/ UT_LIST_BASE_NODE_T_EXTERN(trx_named_savept_t, trx_savepoints) trx_savepoints{}; UndoMutex undo_mutex; undo_no_t undo_no; /* 每个事务独立连续的 undo record number */ space_id_t undo_rseg_space; trx_savept_t last_sql_stat_start; trx_rsegs_t rsegs; /* rollback segments for undo logging */ undo_no_t roll_limit; ulint pages_undone; /*------------------------------*/ /* 一些事务状态，例如： 是启动后台恢复的事务； 是否修改 dd table； 是否需要 gap lock； 是否需要滞后刷写 redo log； 当前执行状态 ... */ // something... /* 如果有事务正给当前事务加隐式锁会增加这个标记， 加完后减少，事务在提交放锁前需要保证标记为 0， 避免事务锁加给提交事务 */ lint n_ref; uint32_t in_depth; /* 事务进入 innodb 层执行 */ uint32_t in_innodb; bool abort; /* 事务被中断 */ std::atomic_uint64_t version; trx_mod_tables_t mod_tables; /* 所有修改的 tables */ /* Xid信息 */ // something... }; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 struct trx_sys_t { /* 存储所有的 readview，包括 active 和 free 的对象 */ MVCC *mvcc; /* 所有的 undo 回滚段的内存对象 */ Rsegs rsegs; Rsegs tmp_rsegs; /* history list 的长度 */ std::atomic\u003cuint64_t\u003e rseg_history_len; /* 最小的未分配 trx id */ std::atomic\u003ctrx_id_t\u003e next_trx_id_or_no; /* 事务提交时的全局有序队列 */ TrxSysMutex serialisation_mutex; UT_LIST_BASE_NODE_T(trx_t, no_list) serialisation_list; std::atomic\u003ctrx_id_t\u003e serialisation_min_trx_no; TrxSysMutex mutex; /* 读写事务队列 */ UT_LIST_BASE_NODE_T(trx_t, trx_list) rw_trx_list; /* 所有开启事务队列 */ UT_LIST_BASE_NODE_T(trx_t, mysql_trx_list) mysql_trx_list; /* 当前活跃读写事务的 trx id 数组，在分配 trx id 时加入； 用于给 ReadView 创建 snapshot 记录事务启动时刻全局事务状态，来判断可见性； 另外就是 purge 时候 clone_oldest 来 purge 限制位点； */ trx_ids_t rw_trx_ids; /* trx id 到 trx_t 的映射 map，用于事务活跃性判断 */ Trx_shard shards[TRX_SHARDS_N]; ulint n_prepared_trx; /* XA PREPARED 阶段事务数目 */ bool found_prepared_trx; }; MySQL 的事务有如下四种隔离级别，不同的级别下事务的事务锁加锁逻辑不同。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 enum isolation_level_t { /* 执行非锁定 SELECT 语句时，不查看记录可能存在的早期一致性版本 */ READ_UNCOMMITTED, /* 范围 UPDATE 和 DELETE 会加 next-key locks 避免幻读； 执行锁定 SELECT 语句时，只加 record 锁不加 gap 锁； 一致性非锁定 SELECT 语句，语句级别 snapshot 实现 */ READ_COMMITTED, /* 执行锁定 SELECT 语句时，加 next-key 锁锁定 gap； 一致性非锁定 SELECT 语句，事务级别 snapshot 实现 */ REPEATABLE_READ, /* 所有 SELECT 语句以锁定模式执行 */ SERIALIZABLE }; 事务开启 用户可以通过 START TRANSACTION [READ WRITE] / [WITH CONSISTENT SNAPSHOT] / [READ ONLY] 等语句显示开启（不同特性的）事务 (trans_begin)。显式开启事务的行为都会隐式的将上一条事务提交掉。只有通过 WITH CONSISTENT SNAPSHOT 的方式才会在开启时就进入InnoDB层，（调用 innobase_start_trx_and_assign_read_view）去开启一个 trx 并通过 trx_assign_read_view 分配 readview，否则会在事务第一次需要进行一执行读的时候分配 readview。\n对于 InnoDB 通过 trx_start_low 在存储层真正配置 trx_t 对象，将事务设置 TRX_STATE_ACTIVE 及相关读写状态，对于读写事务还会（或切换为读写事务 trx_set_rw_mode）：\n分配 undo 回滚段， trx_assign_rseg_durable，通过轮询方式从 undospace 中分配一个有效的回滚段； 分配 trx id，并将其加入全局的活跃事务id数组 trx_ids_t、读写事务队列 rw_trx_list 和 活跃事务对象哈希表 shards。 事务提交 事务的提交分为两种方式，一种是隐式提交，一种是显式提交。显式开启一个新的事务，或者执行一条非临时表的DDL语句时，就会隐式的将上一个事务提交掉。另外一种就是显式的执行“COMMIT” 语句来提交事务。 在 MySQL 的 server 层有两个提交函数 trans_commit_stmt 和 trans_commit，前者在每个语句执行完成时都会调用，而后者是在整个事务真正提交时候调用。\n再往前进一层到 handler 接口处，为了保证分布式/多事务引擎事务的一致性，MySQL 实现了经典的 XA 标准，使用两阶段提交 2PC 协议来保证一个全局事务在所有参与节点要么都提交，要么都中止。如果不需要实现分布事务的能力，则不会进行 XA 实际操作。\nMySQL的 XA 事务支持包括内部 XA 和外部 XA。内部 XA 事务主要指单节点实例内部，一个事务跨多个存储引擎进行读写，那么就会产生内部XA事务；另外，若打开 binlog 需要保证 binlog 与引擎修改的一致性，即使事务只涉及一个引擎，MySQL 内部也会启动 XA 事务。外部 XA 事务与内部 XA 事务核心逻辑类似，提供给用户一套 XA 事务的操作命令，包括 XA start，XA end，XA prepre 和 XA commit等，可以支持跨多个节点的 XA 事务。外部 XA 的协调者是用户的应用，参与者是 MySQL 节点，需要应用持久化协调信息，解决事务一致性问题。无论外部XA事务还是内部XA事务，存储引擎实现的都是同一 prepare 和 commit 接口。\n在开启 binlog 情况下，则 XA 控制对象（TC_LOG）为 MYSQL_BIN_LOG；若关闭了binlog，且存在不止一种事务引擎时，则 XA 控制对象（TC_LOG）为 TC_LOG_MMAP；若没有 XA 需求则实际上无需任何协调者，使用的是 TC_LOG_DUMMY。这里下文不对 XA 控制流程做进一步的讨论，主要讨论 InnoDB 层在事务提交时的操作。\n在 tc_log-\u003ecommit 阶段会调用引擎层的事务提交接口，InnoDB 的接口函数为 innobase_commit。trans_commit_stmt 和 trans_commit 两者最后都会走到 innobase_commit 中，但其有一个参数 commit_trx 来进一步控制是否真的进行存储引擎层的提交处理，trans_commit_stmt 会设置 commit_trx 为 0 而 trans_commit 会设置为 1。只有当 commit_trx = 1 或者设置 autocommit = 1 的情况下，才会真正进入事务提交逻辑。\n顺便一提在知乎上看到过一个很有意思的说法，有人通过下面这个图来总结出：“结果MySQL的默认表现竟然是允许部分成功的事务提交（写入一条，丢弃一条），也就是丧失了原子性。 没有原子性就没有一致性”。这个说法如果是对数据库原理，或者数据库实现源码了解不太深入的人很容易混淆，它错误的将语句和事务概念混淆，导致了错误的结论。另外，实际业务中应用端是需要对 DB 的操作返回状态进行判断处理的，这也是 rollback 操作存在的意义之一。 InnoDB 的事务提交 trx_commit_low 主要分成两个部分 trx_write_serialisation_history 和 trx_commit_in_memory。\ntrx_write_serialisation_history 主要是处理事务所使用的 insert / update 回滚段 对于 undo 只使用单个 page 且使用量小于 3/4 的会被设置为 TRX_UNDO_CACHED 状态；其余的 insert undo 状态被设置为 TRX_UNDO_TO_FREE，update undo 状态被设置为 TRX_UNDO_TO_PURGE； 给 trx 分配提交顺序 trx_no，并且加入 serialisation_list； 将使用过的 undo 回滚段内存结构加入 purge_sys-\u003epurge_queue 这一队列（其内按事务提交时的 trx-\u003eno 排列）以给 purge 系统定位回收； 将 trx-\u003eno 写入 rseg/undo header，并 undo header 将加入到 rseg header 中 history list 的开始； 对 update undo，内存结构 trx_undo_t 按状态加入 rseg-\u003eupdate_undo_cached 或释放 trx_undo_mem_free； trx_commit_in_memory 处理事务锁、Readview、savepoint 等 在 trx_sys 系统中清理当前事务，等到没有隐式锁引用后释放所有事务锁并尝试唤醒阻塞事务； 对 insert undo，内存结构 trx_undo_t 按状态加入 rseg-\u003einsert_undo_list 或释放 trx_undo_mem_free，并且在 rollback segment 中清理不在 history 的 insert undo segment（trx_undo_seg_free）； 非 2PC 时等待 redo 落盘； 清理所有 savepoint 事务回滚 当由于各种原因（例如死锁，或者显式回滚）需要将事务回滚时，会调用接口 trans_rollback，进而调用 InnoDB 函数 trx_rollback_for_mysql 来回滚事务。另外类似 commit 逻辑分为语句级别和事务级别，如果 SQL 语句级别的执行失败，就会进行语句级别的回滚操作 trx_rollback_last_sql_stat_for_mysql 来回滚语句。两种最终又会通过 trx_rollback_to_savepoint 回滚到对应的 savepoint，而 savepoint 是通过 undo_no 来标记回滚到哪个事务状态。\n构建一个回滚用的执行图节点，启动执行图，首先通过 QUE_NODE_ROLLBACK 类型用 trx 上的相关信息构建其内执行的 undo 执行节点（undo_node_t 类型）； 再以 QUE_NODE_UNDO 类型进行具体的数据回滚操作（这块操作可以参见 Undo Log 代码学习 这一章节）。 版权声明：如需转载或引用，请附加本文链接并注明来源。 ",
  "wordCount" : "924",
  "inLanguage": "zh",
  "datePublished": "2023-10-30T00:00:00Z",
  "dateModified": "2023-10-30T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Miao Zheyu"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://mzyee.github.io/posts/mysql/trx/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "MZY's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://mzyee.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://mzyee.github.io" accesskey="h" title="MZY&#39;s Blog (Alt + H)">MZY&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://mzyee.github.io/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://mzyee.github.io/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://mzyee.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://mzyee.github.io/contact" title="Contact">
                    <span>Contact</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://mzyee.github.io">主页</a>&nbsp;»&nbsp;<a href="https://mzyee.github.io/posts/">Posts</a>&nbsp;»&nbsp;<a href="https://mzyee.github.io/posts/mysql/">MySQL</a></div>
    <h1 class="post-title">
      InnoDB 事务系统和事务执行流程
    </h1>
    <div class="post-meta"><span title='2023-10-30 00:00:00 +0000 UTC'>十月 30, 2023</span>&nbsp;·&nbsp;5 分钟&nbsp;·&nbsp;Miao Zheyu&nbsp;|&nbsp;<a href="https://github.com/mzyee/mzyee.github.io" rel="noopener noreferrer" target="_blank">Suggestions</a>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e5%89%8d%e8%a8%80" aria-label="前言">前言</a></li>
                <li>
                    <a href="#%e4%ba%8b%e5%8a%a1%e5%92%8c%e4%ba%8b%e5%8a%a1%e7%b3%bb%e7%bb%9f%e7%9a%84%e5%86%85%e5%ad%98%e7%bb%93%e6%9e%84" aria-label="事务和事务系统的内存结构">事务和事务系统的内存结构</a></li>
                <li>
                    <a href="#%e4%ba%8b%e5%8a%a1%e5%bc%80%e5%90%af" aria-label="事务开启">事务开启</a></li>
                <li>
                    <a href="#%e4%ba%8b%e5%8a%a1%e6%8f%90%e4%ba%a4" aria-label="事务提交">事务提交</a></li>
                <li>
                    <a href="#%e4%ba%8b%e5%8a%a1%e5%9b%9e%e6%bb%9a" aria-label="事务回滚">事务回滚</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h3 id="前言">前言<a hidden class="anchor" aria-hidden="true" href="#前言">#</a></h3>
<p>   事务系统是 InnoDB 实现 MVCC 及 ACID、进行事务并发控制的核心模块。本文主要讨论事务系统结构和一个事务的执行流程（基于 MySQL 8.0.30），需要涉及到对 redo、undo 系统的相关知识。本文还会涉及一部分 MVCC 和 事务锁的讨论，但是更详细内容会在对 Concurrency Control 讨论的文章中给出。</p>
<h3 id="事务和事务系统的内存结构">事务和事务系统的内存结构<a hidden class="anchor" aria-hidden="true" href="#事务和事务系统的内存结构">#</a></h3>
<p>   事务和事务系统对应的内存结构分别是 <code>trx_t</code> 和 <code>trx_sys_t</code>。每个 session 连接持有一个 <code>trx_t</code>，其在创建连接执行第一个事务开始整个结构体就在 <code>innobase_trx_allocate</code> 初始化了，后续这个连接的所有事务一直复用此数据结构，直到连接断开。</p>
<ul>
<li>事务启动后不管读写，把这个结构体加入到全局事务链表中 (trx_sys-&gt;mysql_trx_list)；</li>
<li>如果转换为读写事务，还会加入到全局读写事务链表中 (trx_sys-&gt;rw_trx_list)；同时，读写事务在开启时（更确切的说是在分配回滚段时）通过全局 id 产生器产生以区分不同的写事务（这里 trx_id 只读事务为0，只读事务只需要通过指针地址来获取区分，如果只读事务需要写临时表，也会分配）；同时，还会分配回滚段给 trx_t 以供记录 undo record。</li>
<li>在事务内存提交的时候，还会加入到全局提交事务链表中(trx_sys-&gt;serialisation_list)。同时，在 trx 提交时 (<code>trx_commit_low</code> 的 <code>trx_write_serialisation_history</code>) trx_no 字段通过全局产生器产生并加入 serialisation_list，这样可以确定事务提交的顺序，保证加入到 purge_queue 和 history list 中的 update undo 有序。然后在提交的最后阶段 (<code>trx_commit_low</code> 的 <code>trx_commit_in_memory</code>)，删除 serialisation_list、释放所有事务锁、清理 insert undo、等待刷完 redo log。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">trx_t</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">mutable</span> <span class="n">TrxMutex</span> <span class="n">mutex</span><span class="p">;</span> <span class="cm">/* 保护 `state` 和 `lock` */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">trx_id_t</span> <span class="n">id</span><span class="p">;</span> <span class="cm">/* 事务 id，在开启读写事务或分配回滚段时赋予 */</span>
</span></span><span class="line"><span class="cl">  <span class="n">trx_id_t</span> <span class="n">no</span><span class="p">;</span> <span class="cm">/* 事务 number，在事务提交阶段赋予 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* 事务的可能状态:
</span></span></span><span class="line"><span class="cl"><span class="cm">    TRX_STATE_NOT_STARTED
</span></span></span><span class="line"><span class="cl"><span class="cm">    TRX_STATE_FORCED_ROLLBACK
</span></span></span><span class="line"><span class="cl"><span class="cm">    TRX_STATE_ACTIVE
</span></span></span><span class="line"><span class="cl"><span class="cm">    TRX_STATE_PREPARED
</span></span></span><span class="line"><span class="cl"><span class="cm">    TRX_STATE_COMMITTED_IN_MEMORY (alias below COMMITTED)
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">  有效的状态转移模式:
</span></span></span><span class="line"><span class="cl"><span class="cm">    1. Regular transactions:
</span></span></span><span class="line"><span class="cl"><span class="cm">      * NOT_STARTED -&gt; ACTIVE -&gt; COMMITTED -&gt; NOT_STARTED
</span></span></span><span class="line"><span class="cl"><span class="cm">    2. Auto-commit non-locking read-only:
</span></span></span><span class="line"><span class="cl"><span class="cm">      * NOT_STARTED -&gt; ACTIVE -&gt; NOT_STARTED
</span></span></span><span class="line"><span class="cl"><span class="cm">    3. XA (2PC):
</span></span></span><span class="line"><span class="cl"><span class="cm">      * NOT_STARTED -&gt; ACTIVE -&gt; PREPARED -&gt; COMMITTED -&gt; NOT_STARTED
</span></span></span><span class="line"><span class="cl"><span class="cm">    4. Recovered XA:
</span></span></span><span class="line"><span class="cl"><span class="cm">      * NOT_STARTED -&gt; PREPARED -&gt; COMMITTED -&gt; (freed)
</span></span></span><span class="line"><span class="cl"><span class="cm">    5. XA (2PC) (shutdown or disconnect before ROLLBACK or COMMIT):
</span></span></span><span class="line"><span class="cl"><span class="cm">      * NOT_STARTED -&gt; PREPARED -&gt; (freed)
</span></span></span><span class="line"><span class="cl"><span class="cm">    6. Disconnected XA can become recovered:
</span></span></span><span class="line"><span class="cl"><span class="cm">      * ... -&gt; ACTIVE -&gt; PREPARED (connected) -&gt; PREPARED (disconnected)
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="n">trx_state_t</span><span class="o">&gt;</span> <span class="n">state</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* 一致性读所使用的 read view，里面记录了启动时刻系统的活跃事务状态：
</span></span></span><span class="line"><span class="cl"><span class="cm">    1. trx ids 的全可见（up_to）上界/ 全不可见（low_from）下界
</span></span></span><span class="line"><span class="cl"><span class="cm">    2. trx no 的 undo 需求下界，小于此的 undo 不被需要
</span></span></span><span class="line"><span class="cl"><span class="cm">    3. 所有活跃事务 trx_id 的数组 */</span>
</span></span><span class="line"><span class="cl">  <span class="n">ReadView</span> <span class="o">*</span><span class="n">read_view</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">UT_LIST_NODE_T</span><span class="p">(</span><span class="n">trx_t</span><span class="p">)</span> <span class="n">trx_list</span><span class="p">;</span> <span class="cm">/* rw_trx_list 节点，读写事务 */</span>
</span></span><span class="line"><span class="cl">  <span class="n">UT_LIST_NODE_T</span><span class="p">(</span><span class="n">trx_t</span><span class="p">)</span> <span class="n">no_list</span><span class="p">;</span> <span class="cm">/* serialisation_list 节点，提交事务 */</span>
</span></span><span class="line"><span class="cl">  <span class="n">UT_LIST_NODE_T</span><span class="p">(</span><span class="n">trx_t</span><span class="p">)</span> <span class="n">mysql_trx_list</span><span class="p">;</span> <span class="cm">/* mysql_trx_list 节点，所有事务 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">trx_lock_t</span> <span class="n">lock</span><span class="p">;</span> <span class="cm">/* 事务锁信息 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">isolation_level_t</span> <span class="n">isolation_level</span><span class="p">;</span> <span class="cm">/* 隔离等级 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="nl">std</span><span class="p">:</span><span class="err">🧵</span><span class="o">:</span><span class="n">id</span><span class="o">&gt;</span> <span class="n">killed_by</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/*------------------------------*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">trx_dict_op_t</span> <span class="n">dict_operation</span><span class="p">;</span> <span class="cm">/* 是否修改 data dictionary */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">lsn_t</span> <span class="n">commit_lsn</span><span class="p">;</span> <span class="cm">/* commit 时的 lsn */</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/*------------------------------*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/*----------- Undo 相关信息 -------------*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">UT_LIST_BASE_NODE_T_EXTERN</span><span class="p">(</span><span class="n">trx_named_savept_t</span><span class="p">,</span> <span class="n">trx_savepoints</span><span class="p">)</span> <span class="n">trx_savepoints</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">  <span class="n">UndoMutex</span> <span class="n">undo_mutex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">undo_no_t</span> <span class="n">undo_no</span><span class="p">;</span>    <span class="cm">/* 每个事务独立连续的 undo record number */</span>
</span></span><span class="line"><span class="cl">  <span class="n">space_id_t</span> <span class="n">undo_rseg_space</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">trx_savept_t</span> <span class="n">last_sql_stat_start</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">trx_rsegs_t</span> <span class="n">rsegs</span><span class="p">;</span>    <span class="cm">/* rollback segments for undo logging */</span>
</span></span><span class="line"><span class="cl">  <span class="n">undo_no_t</span> <span class="n">roll_limit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">ulint</span> <span class="n">pages_undone</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/*------------------------------*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* 一些事务状态，例如：
</span></span></span><span class="line"><span class="cl"><span class="cm">    是启动后台恢复的事务；
</span></span></span><span class="line"><span class="cl"><span class="cm">    是否修改 dd table；
</span></span></span><span class="line"><span class="cl"><span class="cm">    是否需要 gap lock；
</span></span></span><span class="line"><span class="cl"><span class="cm">    是否需要滞后刷写 redo log；
</span></span></span><span class="line"><span class="cl"><span class="cm">    当前执行状态
</span></span></span><span class="line"><span class="cl"><span class="cm">    ... */</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// something...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="cm">/* 如果有事务正给当前事务加隐式锁会增加这个标记，
</span></span></span><span class="line"><span class="cl"><span class="cm">    加完后减少，事务在提交放锁前需要保证标记为 0，
</span></span></span><span class="line"><span class="cl"><span class="cm">    避免事务锁加给提交事务 */</span>
</span></span><span class="line"><span class="cl">  <span class="n">lint</span> <span class="n">n_ref</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">uint32_t</span> <span class="n">in_depth</span><span class="p">;</span> <span class="cm">/* 事务进入 innodb 层执行 */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint32_t</span> <span class="n">in_innodb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">bool</span> <span class="n">abort</span><span class="p">;</span> <span class="cm">/* 事务被中断 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">atomic_uint64_t</span> <span class="n">version</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">trx_mod_tables_t</span> <span class="n">mod_tables</span><span class="p">;</span> <span class="cm">/* 所有修改的 tables */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* Xid信息 */</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// something...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">trx_sys_t</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/* 存储所有的 readview，包括 active 和 free 的对象 */</span>
</span></span><span class="line"><span class="cl">  <span class="n">MVCC</span> <span class="o">*</span><span class="n">mvcc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* 所有的 undo 回滚段的内存对象 */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Rsegs</span> <span class="n">rsegs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">Rsegs</span> <span class="n">tmp_rsegs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* history list 的长度 */</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="o">&gt;</span> <span class="n">rseg_history_len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* 最小的未分配 trx id */</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="n">trx_id_t</span><span class="o">&gt;</span> <span class="n">next_trx_id_or_no</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* 事务提交时的全局有序队列 */</span>
</span></span><span class="line"><span class="cl">  <span class="n">TrxSysMutex</span> <span class="n">serialisation_mutex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">UT_LIST_BASE_NODE_T</span><span class="p">(</span><span class="n">trx_t</span><span class="p">,</span> <span class="n">no_list</span><span class="p">)</span> <span class="n">serialisation_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="n">trx_id_t</span><span class="o">&gt;</span> <span class="n">serialisation_min_trx_no</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">TrxSysMutex</span> <span class="n">mutex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* 读写事务队列 */</span>
</span></span><span class="line"><span class="cl">  <span class="n">UT_LIST_BASE_NODE_T</span><span class="p">(</span><span class="n">trx_t</span><span class="p">,</span> <span class="n">trx_list</span><span class="p">)</span> <span class="n">rw_trx_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/* 所有开启事务队列 */</span>
</span></span><span class="line"><span class="cl">  <span class="n">UT_LIST_BASE_NODE_T</span><span class="p">(</span><span class="n">trx_t</span><span class="p">,</span> <span class="n">mysql_trx_list</span><span class="p">)</span> <span class="n">mysql_trx_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* 当前活跃读写事务的 trx id 数组，在分配 trx id 时加入；
</span></span></span><span class="line"><span class="cl"><span class="cm">    用于给 ReadView 创建 snapshot 记录事务启动时刻全局事务状态，来判断可见性；
</span></span></span><span class="line"><span class="cl"><span class="cm">    另外就是 purge 时候 clone_oldest 来 purge 限制位点；
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl">  <span class="n">trx_ids_t</span> <span class="n">rw_trx_ids</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* trx id 到 trx_t 的映射 map，用于事务活跃性判断 */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Trx_shard</span> <span class="n">shards</span><span class="p">[</span><span class="n">TRX_SHARDS_N</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">ulint</span> <span class="n">n_prepared_trx</span><span class="p">;</span> <span class="cm">/* XA PREPARED 阶段事务数目 */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">bool</span> <span class="n">found_prepared_trx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>   MySQL 的事务有如下四种隔离级别，不同的级别下事务的事务锁加锁逻辑不同。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">enum</span> <span class="nc">isolation_level_t</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/* 执行非锁定 SELECT 语句时，不查看记录可能存在的早期一致性版本 */</span>
</span></span><span class="line"><span class="cl">  <span class="n">READ_UNCOMMITTED</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* 范围 UPDATE 和 DELETE 会加 next-key locks 避免幻读；
</span></span></span><span class="line"><span class="cl"><span class="cm">     执行锁定 SELECT 语句时，只加 record 锁不加 gap 锁；
</span></span></span><span class="line"><span class="cl"><span class="cm">     一致性非锁定 SELECT 语句，语句级别 snapshot 实现 */</span>
</span></span><span class="line"><span class="cl">  <span class="n">READ_COMMITTED</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* 执行锁定 SELECT 语句时，加 next-key 锁锁定 gap；
</span></span></span><span class="line"><span class="cl"><span class="cm">    一致性非锁定 SELECT 语句，事务级别 snapshot 实现 */</span>
</span></span><span class="line"><span class="cl">  <span class="n">REPEATABLE_READ</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* 所有 SELECT 语句以锁定模式执行 */</span>
</span></span><span class="line"><span class="cl">  <span class="n">SERIALIZABLE</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="事务开启">事务开启<a hidden class="anchor" aria-hidden="true" href="#事务开启">#</a></h3>
<p>   用户可以通过 START TRANSACTION [READ WRITE] / [WITH CONSISTENT SNAPSHOT] / [READ ONLY] 等语句显示开启（不同特性的）事务 (<code>trans_begin</code>)。显式开启事务的行为都会隐式的将上一条事务提交掉。只有通过 WITH CONSISTENT SNAPSHOT 的方式才会在开启时就进入InnoDB层，（调用 <code>innobase_start_trx_and_assign_read_view</code>）去开启一个 trx 并通过 <code>trx_assign_read_view</code> 分配 readview，否则会在事务第一次需要进行一执行读的时候分配 readview。</p>
<p>   对于 InnoDB 通过 <code>trx_start_low</code> 在存储层真正配置 trx_t 对象，将事务设置 TRX_STATE_ACTIVE 及相关读写状态，对于<strong>读写事务</strong>还会（或切换为读写事务 <code>trx_set_rw_mode</code>）：</p>
<ul>
<li>分配 undo 回滚段， <code>trx_assign_rseg_durable</code>，通过轮询方式从 undospace 中分配一个有效的回滚段；</li>
<li>分配 trx id，并将其加入全局的活跃事务id数组 <strong>trx_ids_t</strong>、读写事务队列 <strong>rw_trx_list</strong> 和 活跃事务对象哈希表 <strong>shards</strong>。</li>
</ul>
<h3 id="事务提交">事务提交<a hidden class="anchor" aria-hidden="true" href="#事务提交">#</a></h3>
<p>   事务的提交分为两种方式，一种是隐式提交，一种是显式提交。显式开启一个新的事务，或者执行一条非临时表的DDL语句时，就会隐式的将上一个事务提交掉。另外一种就是显式的执行“COMMIT” 语句来提交事务。 在 MySQL 的 server 层有两个提交函数 <code>trans_commit_stmt</code> 和 <code>trans_commit</code>，前者在每个语句执行完成时都会调用，而后者是在整个事务真正提交时候调用。</p>
<p>   再往前进一层到 handler 接口处，为了保证分布式/多事务引擎事务的一致性，MySQL 实现了经典的 XA 标准，使用两阶段提交 2PC 协议来保证一个全局事务在所有参与节点要么都提交，要么都中止。如果不需要实现分布事务的能力，则不会进行 XA 实际操作。</p>
<p>   MySQL的 XA 事务支持包括内部 XA 和外部 XA。<strong>内部 XA</strong> 事务主要指单节点实例内部，一个事务跨多个存储引擎进行读写，那么就会产生内部XA事务；另外，若打开 binlog 需要保证 binlog 与引擎修改的一致性，即使事务只涉及一个引擎，MySQL 内部也会启动 XA 事务。外部 XA 事务与内部 XA 事务核心逻辑类似，提供给用户一套 XA 事务的操作命令，包括 XA start，XA end，XA prepre 和 XA commit等，可以支持跨多个节点的 XA 事务。<strong>外部 XA</strong> 的协调者是用户的应用，参与者是 MySQL 节点，需要应用持久化协调信息，解决事务一致性问题。无论外部XA事务还是内部XA事务，存储引擎实现的都是同一 prepare 和 commit 接口。</p>
<p>   在开启 binlog 情况下，则 XA 控制对象（TC_LOG）为 MYSQL_BIN_LOG；若关闭了binlog，且存在不止一种事务引擎时，则 XA 控制对象（TC_LOG）为 TC_LOG_MMAP；若没有 XA 需求则实际上无需任何协调者，使用的是 TC_LOG_DUMMY。这里下文不对 XA 控制流程做进一步的讨论，主要讨论 InnoDB 层在事务提交时的操作。</p>
<p>   在 tc_log-&gt;commit 阶段会调用引擎层的事务提交接口，InnoDB 的接口函数为 <code>innobase_commit</code>。<code>trans_commit_stmt</code> 和 <code>trans_commit</code> 两者最后都会走到 <code>innobase_commit</code> 中，但其有一个参数 commit_trx 来进一步控制是否真的进行存储引擎层的提交处理，<code>trans_commit_stmt</code> 会设置 commit_trx 为 0 而 <code>trans_commit</code> 会设置为 1。只有当 commit_trx = 1 或者设置 autocommit = 1 的情况下，才会真正进入事务提交逻辑。</p>
<p>   顺便一提在知乎上看到过<strong>一个很有意思的说法，有人通过下面这个图来总结出：“结果MySQL的默认表现竟然是允许部分成功的事务提交（写入一条，丢弃一条），也就是丧失了原子性。 没有原子性就没有一致性”</strong>。这个说法如果是对数据库原理，或者数据库实现源码了解不太深入的人很容易混淆，它错误的将语句和事务概念混淆，导致了错误的结论。另外，实际业务中应用端是需要对 DB 的操作返回状态进行判断处理的，这也是 rollback 操作存在的意义之一。
<img loading="lazy" src="mysql_commit.png" alt="mysql_commit"  />
</p>
<p>   InnoDB 的事务提交 <code>trx_commit_low</code> 主要分成两个部分 <code>trx_write_serialisation_history</code> 和 <code>trx_commit_in_memory</code>。</p>
<ul>
<li><code>trx_write_serialisation_history</code> 主要是处理事务所使用的 insert / update 回滚段
<ul>
<li>对于 undo 只使用单个 page 且使用量小于 3/4 的会被设置为 TRX_UNDO_CACHED 状态；其余的 insert undo 状态被设置为 TRX_UNDO_TO_FREE，update undo 状态被设置为 TRX_UNDO_TO_PURGE；</li>
<li>给 trx 分配提交顺序 trx_no，并且加入 serialisation_list；</li>
<li>将使用过的 undo 回滚段内存结构加入 purge_sys-&gt;purge_queue 这一队列（其内按事务提交时的 trx-&gt;no 排列）以给 purge 系统定位回收；</li>
<li>将 trx-&gt;no 写入 rseg/undo header，并 undo header 将加入到 rseg header 中 history list 的开始；</li>
<li>对 update undo，内存结构 trx_undo_t 按状态加入 rseg-&gt;update_undo_cached 或释放 trx_undo_mem_free；</li>
</ul>
</li>
<li><code>trx_commit_in_memory</code> 处理事务锁、Readview、savepoint 等
<ul>
<li>在 trx_sys 系统中清理当前事务，等到没有隐式锁引用后释放所有事务锁并尝试唤醒阻塞事务；</li>
<li>对 insert undo，内存结构 trx_undo_t 按状态加入 rseg-&gt;insert_undo_list 或释放 trx_undo_mem_free，并且在 rollback segment 中清理不在 history 的 insert undo segment（trx_undo_seg_free）；</li>
<li>非 2PC 时等待 redo 落盘；</li>
<li>清理所有 savepoint</li>
</ul>
</li>
</ul>
<h3 id="事务回滚">事务回滚<a hidden class="anchor" aria-hidden="true" href="#事务回滚">#</a></h3>
<p>   当由于各种原因（例如死锁，或者显式回滚）需要将事务回滚时，会调用接口 <code>trans_rollback</code>，进而调用 InnoDB 函数 <code>trx_rollback_for_mysql</code> 来回滚事务。另外类似 commit 逻辑分为语句级别和事务级别，如果 SQL 语句级别的执行失败，就会进行语句级别的回滚操作 <code>trx_rollback_last_sql_stat_for_mysql</code> 来回滚语句。两种最终又会通过 <code>trx_rollback_to_savepoint</code> 回滚到对应的 savepoint，而 savepoint 是通过 undo_no 来标记回滚到哪个事务状态。</p>
<ul>
<li>构建一个回滚用的执行图节点，启动执行图，首先通过 QUE_NODE_ROLLBACK 类型用 trx 上的相关信息构建其内执行的 undo 执行节点（undo_node_t 类型）；</li>
<li>再以 QUE_NODE_UNDO 类型进行具体的数据回滚操作（这块操作可以参见 <a href="/posts/mysql/undo">Undo Log 代码学习</a> 这一章节）。</li>
</ul>
<hr>
<!-- copyright -->
<div class="admonition">
  <div class="admonition-content">
    <ul>
      <li>版权声明：如需转载或引用，请附加本文链接并注明来源。</li>
    </ul>
  </div>
</div>
<!-- copyright -->

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://mzyee.github.io/tags/mysql/">mysql</a></li>
      <li><a href="https://mzyee.github.io/tags/transaction/">transaction</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://mzyee.github.io/posts/mysql/redo/">
    <span class="title">« 上一页</span>
    <br>
    <span>InnoDB Redo 日志系统</span>
  </a>
  <a class="next" href="https://mzyee.github.io/posts/mysql/purge/">
    <span class="title">下一页 »</span>
    <br>
    <span>InnoDB Purge System 代码学习</span>
  </a>
</nav>


<div class="share-buttons">
    <a target="_blank" rel="noopener noreferrer" aria-label="share InnoDB 事务系统和事务执行流程 on twitter"
        href="https://twitter.com/intent/tweet/?text=InnoDB%20%e4%ba%8b%e5%8a%a1%e7%b3%bb%e7%bb%9f%e5%92%8c%e4%ba%8b%e5%8a%a1%e6%89%a7%e8%a1%8c%e6%b5%81%e7%a8%8b&amp;url=https%3a%2f%2fmzyee.github.io%2fposts%2fmysql%2ftrx%2f&amp;hashtags=mysql%2ctransaction">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-253.927,424.544c135.939,0 210.268,-112.643 210.268,-210.268c0,-3.218 0,-6.437 -0.153,-9.502c14.406,-10.421 26.973,-23.448 36.935,-38.314c-13.18,5.824 -27.433,9.809 -42.452,11.648c15.326,-9.196 26.973,-23.602 32.49,-40.92c-14.252,8.429 -30.038,14.56 -46.896,17.931c-13.487,-14.406 -32.644,-23.295 -53.946,-23.295c-40.767,0 -73.87,33.104 -73.87,73.87c0,5.824 0.613,11.494 1.992,16.858c-61.456,-3.065 -115.862,-32.49 -152.337,-77.241c-6.284,10.881 -9.962,23.601 -9.962,37.088c0,25.594 13.027,48.276 32.95,61.456c-12.107,-0.307 -23.448,-3.678 -33.41,-9.196l0,0.92c0,35.862 25.441,65.594 59.311,72.49c-6.13,1.686 -12.72,2.606 -19.464,2.606c-4.751,0 -9.348,-0.46 -13.946,-1.38c9.349,29.426 36.628,50.728 68.965,51.341c-25.287,19.771 -57.164,31.571 -91.8,31.571c-5.977,0 -11.801,-0.306 -17.625,-1.073c32.337,21.15 71.264,33.41 112.95,33.41Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share InnoDB 事务系统和事务执行流程 on linkedin"
        href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fmzyee.github.io%2fposts%2fmysql%2ftrx%2f&amp;title=InnoDB%20%e4%ba%8b%e5%8a%a1%e7%b3%bb%e7%bb%9f%e5%92%8c%e4%ba%8b%e5%8a%a1%e6%89%a7%e8%a1%8c%e6%b5%81%e7%a8%8b&amp;summary=InnoDB%20%e4%ba%8b%e5%8a%a1%e7%b3%bb%e7%bb%9f%e5%92%8c%e4%ba%8b%e5%8a%a1%e6%89%a7%e8%a1%8c%e6%b5%81%e7%a8%8b&amp;source=https%3a%2f%2fmzyee.github.io%2fposts%2fmysql%2ftrx%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share InnoDB 事务系统和事务执行流程 on reddit"
        href="https://reddit.com/submit?url=https%3a%2f%2fmzyee.github.io%2fposts%2fmysql%2ftrx%2f&title=InnoDB%20%e4%ba%8b%e5%8a%a1%e7%b3%bb%e7%bb%9f%e5%92%8c%e4%ba%8b%e5%8a%a1%e6%89%a7%e8%a1%8c%e6%b5%81%e7%a8%8b">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share InnoDB 事务系统和事务执行流程 on facebook"
        href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fmzyee.github.io%2fposts%2fmysql%2ftrx%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share InnoDB 事务系统和事务执行流程 on whatsapp"
        href="https://api.whatsapp.com/send?text=InnoDB%20%e4%ba%8b%e5%8a%a1%e7%b3%bb%e7%bb%9f%e5%92%8c%e4%ba%8b%e5%8a%a1%e6%89%a7%e8%a1%8c%e6%b5%81%e7%a8%8b%20-%20https%3a%2f%2fmzyee.github.io%2fposts%2fmysql%2ftrx%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share InnoDB 事务系统和事务执行流程 on telegram"
        href="https://telegram.me/share/url?text=InnoDB%20%e4%ba%8b%e5%8a%a1%e7%b3%bb%e7%bb%9f%e5%92%8c%e4%ba%8b%e5%8a%a1%e6%89%a7%e8%a1%8c%e6%b5%81%e7%a8%8b&amp;url=https%3a%2f%2fmzyee.github.io%2fposts%2fmysql%2ftrx%2f">
        <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
            <path
                d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share InnoDB 事务系统和事务执行流程 on ycombinator"
        href="https://news.ycombinator.com/submitlink?t=InnoDB%20%e4%ba%8b%e5%8a%a1%e7%b3%bb%e7%bb%9f%e5%92%8c%e4%ba%8b%e5%8a%a1%e6%89%a7%e8%a1%8c%e6%b5%81%e7%a8%8b&u=https%3a%2f%2fmzyee.github.io%2fposts%2fmysql%2ftrx%2f">
        <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
            xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
            <path
                d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
        </svg>
    </a>
</div>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://mzyee.github.io">MZY&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
