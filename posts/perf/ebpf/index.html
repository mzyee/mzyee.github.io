<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>é€šè¿‡ eBPF å·¥å…·è¿›è¡Œæ€§èƒ½åˆ†æ | MZY&#39;s Blog</title>
<meta name="keywords" content="Performance, BPF">
<meta name="description" content="Learning About eBPF Usages">
<meta name="author" content="Miao Zheyu">
<link rel="canonical" href="https://mzyee.github.io/posts/perf/ebpf/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.78ed8947c1508d00bdf7a3061370dcaebcd4ba680f4567ec440d26a4043b4e64.css" integrity="sha256-eO2JR8FQjQC996MGE3DcrrzUumgPRWfsRA0mpAQ7TmQ=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://mzyee.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://mzyee.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://mzyee.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://mzyee.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://mzyee.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<meta property="og:title" content="é€šè¿‡ eBPF å·¥å…·è¿›è¡Œæ€§èƒ½åˆ†æ" />
<meta property="og:description" content="Learning About eBPF Usages" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mzyee.github.io/posts/perf/ebpf/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-10-09T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-10-09T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="é€šè¿‡ eBPF å·¥å…·è¿›è¡Œæ€§èƒ½åˆ†æ"/>
<meta name="twitter:description" content="Learning About eBPF Usages"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://mzyee.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Performance",
      "item": "https://mzyee.github.io/posts/perf/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "é€šè¿‡ eBPF å·¥å…·è¿›è¡Œæ€§èƒ½åˆ†æ",
      "item": "https://mzyee.github.io/posts/perf/ebpf/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "é€šè¿‡ eBPF å·¥å…·è¿›è¡Œæ€§èƒ½åˆ†æ",
  "name": "é€šè¿‡ eBPF å·¥å…·è¿›è¡Œæ€§èƒ½åˆ†æ",
  "description": "Learning About eBPF Usages",
  "keywords": [
    "Performance", "BPF"
  ],
  "articleBody": "1. eBPFæŠ€æœ¯èƒŒæ™¯ BPFï¼ˆBerkeley Packet Filterï¼‰æ˜¯ç±»Unixç³»ç»Ÿä¸Šæ•°æ®é“¾è·¯å±‚çš„ä¸€ç§åŸå§‹æ¥å£ï¼Œæä¾›åŸå§‹é“¾è·¯å±‚å°åŒ…çš„æ”¶å‘ã€‚BPFåœ¨æ•°æ®åŒ…è¿‡æ»¤ä¸Šå¼•å…¥äº†ä¸¤å¤§ç‰¹æ€§ï¼š\nä¸€ä¸ªå¯æœ‰æ•ˆåœ°å·¥ä½œåœ¨åŸºäºå¯„å­˜å™¨ç»“æ„ CPU ä¸Šçš„è™šæ‹Ÿæœºï¼› åº”ç”¨ç¨‹åºåªå¤åˆ¶ä¸è¿‡æ»¤æ•°æ®åŒ…ç›¸å…³çš„æ•°æ®ï¼Œä¸å¤åˆ¶æ•°æ®åŒ…çš„æ‰€æœ‰ä¿¡æ¯ã€‚ eBPF åœ¨åŸå§‹BPFåŸºç¡€ä¸Šè¿›ä¸€æ­¥é’ˆå¯¹ç°ä»£ CPU ç¡¬ä»¶è¿›è¡Œäº†æŒ‡ä»¤é›†ä¼˜åŒ–ï¼Œå¢åŠ äº† VM ä¸­çš„å¯„å­˜å™¨æ•°é‡ï¼Œä½¿æ•°æ®å¤„ç†é€Ÿåº¦æé«˜äº†æ•°å€ã€‚æ€»ç»“æ¥è¯´ï¼ŒeBPF æä¾›äº†ä¸€ä¸ªåŸºäºå¯„å­˜å™¨çš„è™šæ‹Ÿæœºï¼Œä½¿ç”¨è‡ªå®šä¹‰çš„ 64 ä½ RISC æŒ‡ä»¤é›†ï¼Œèƒ½å¤Ÿåœ¨ Linux å†…æ ¸å†…è¿è¡Œæœ¬åœ°å³æ—¶ç¼–è¯‘çš„ BPF ç¨‹åºï¼Œå¹¶èƒ½è®¿é—®å†…æ ¸åŠŸèƒ½å’Œå†…å­˜çš„ç‰¹å®šå­é›†ã€‚\neBPFç¨‹åºåˆ†ä¸ºç”¨æˆ·ç©ºé—´ç¨‹åºå’Œå†…æ ¸ç¨‹åºä¸¤éƒ¨åˆ†ï¼š\nç”¨æˆ·ç©ºé—´ç¨‹åºè´Ÿè´£åŠ è½½ BPF å­—èŠ‚ç è‡³å†…æ ¸ï¼Œä¸€èˆ¬ä½¿ç”¨è€…å¯ä»¥é€šè¿‡ LLVM æˆ–è€… GCC å°†ç¼–å†™çš„ BPF ä»£ç ç¨‹åºç¼–è¯‘æˆå†…æ ¸å¯éªŒè¯çš„ BPF å­—èŠ‚ç ã€‚å†…æ ¸åŠ è½½å‰ä¼šä½¿ç”¨éªŒè¯å™¨ verfier ç»„ä»¶ä¿è¯å­—èŠ‚ç çš„å®‰å…¨æ€§ï¼Œä»¥é¿å…å¯¹å†…æ ¸é€ æˆç¾éš¾é—®é¢˜ã€‚å¦‚æœ‰éœ€è¦ï¼Œç”¨æˆ·ç©ºé—´ç¨‹åºä¹Ÿä¼šè´Ÿè´£è¯»å–å¹¶å¤„ç†å†…æ ¸å›ä¼ çš„ç»Ÿè®¡ä¿¡æ¯æˆ–è€…äº‹ä»¶è¯¦æƒ…ã€‚ åœ¨å†…æ ¸ä¸­åŠ è½½çš„ BPF å­—èŠ‚ç ç¨‹åºä¼šåœ¨å†…æ ¸ä¸­æ‰§è¡Œç‰¹å®šäº‹ä»¶ï¼ŒBPF ç¨‹åºå¯èƒ½åŸºäº kprobes / uprobes / tracepoint / perf_events ç­‰ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªäº‹ä»¶ã€‚å¦‚æœ‰éœ€è¦ï¼Œå†…æ ¸ç¨‹åºä¹Ÿä¼šå°†æ‰§è¡Œçš„ç»“æœé€šè¿‡ç¼“å­˜ map æˆ–è€… perf-event äº‹ä»¶å‘é€è‡³ç”¨æˆ·ç©ºé—´ã€‚ é€šè¿‡ä¸Šè¿°æœºåˆ¶ï¼ŒeBPF çš„ä½¿ç”¨è€…ï¼ˆä¸å±€é™äºå†…æ ¸å¼€å‘è€…ï¼‰èƒ½å¤ŸåŸºäºç³»ç»Ÿå†…æ ¸æˆ–ç¨‹åºäº‹ä»¶é«˜æ•ˆã€å®‰å…¨çš„ï¼ˆåœ¨å†…æ ¸ä¸­ï¼‰æ‰§è¡Œç‰¹å®šä»£ç ï¼Œé€šè¿‡å‘å†…æ ¸æ·»åŠ  eBPF æ¨¡å—æ¥å¢åŠ åŠŸèƒ½ã€‚\n2. åŸºäºeBPFè¿›è¡Œè½¯ä»¶å¼€å‘ eBPF æŒ‡ä»¤æ˜¯å›ºå®šå¤§å°çš„ 64 ä½ç¼–ç ï¼Œå¤§çº¦æœ‰ä¸Šç™¾æ¡æŒ‡ä»¤ï¼Œè¢«åˆ†ç»„ä¸º 8 ç±»ï¼Œå¸¸ç”¨æŒ‡ä»¤æ”¯æŒå¦‚ä»é€šç”¨å†…å­˜è¿›è¡ŒåŠ è½½/å­˜å‚¨ï¼Œå‰/åï¼ˆéï¼‰æ¡ä»¶è·³è½¬ã€ç®—æœ¯/é€»è¾‘æ“ä½œå’Œå‡½æ•°è°ƒç”¨ç­‰ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 /* msb lsb +---------------------+---------------+----+----+-------+ |immediate |offset |src |dst |opcode | +---------------------+---------------+----+----+-------+ */ struct bpf_insn { __u8\tcode;\t/* opcode */ __u8\tdst_reg:4;\t/* dest register */ __u8\tsrc_reg:4;\t/* source register */ __s16\toff;\t/* signed offset */ __s32\timm;\t/* signed immediate constant */ }; ç›´æ¥ä½¿ç”¨åŸå§‹å­—èŠ‚ç æ¥å®ç° eBPF ç¨‹åºï¼Œéå¸¸åƒç¼–å†™æ±‡ç¼–ä»£ç ï¼Œè¿™ç§è¡Œä¸ºæ— ç–‘æ˜¯è¾ƒä¸ºå›°éš¾ï¼Œé€šå¸¸ä½¿ç”¨æ›´é«˜çº§åˆ«çš„è¯­è¨€å’Œå·¥å…·æ¥å®ç°åŠŸèƒ½å¤æ‚çš„ eBPF ç”¨ä¾‹ã€‚ä¸€ç§å¾ˆè‡ªç„¶çš„æƒ³æ³•æ˜¯èƒ½ä¸èƒ½å°†é«˜çº§è¯­è¨€çš„ä¸­é—´è¡¨ç¤ºå±‚ç¼–è¯‘æˆ eBPF ç¨‹åºæ¨¡å—ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å°†ä½¿ç”¨å…·æœ‰â€œé™åˆ¶æ€§â€œçš„é«˜çº§æŠ½è±¡å±‚è¯­è¨€æ¥ç¼–å†™ eBPF ç¨‹åºã€‚è¿™ç§è®¾è®¡æœ‰æ•ˆåœ°å°†å†…æ ¸ä¸­è¿è¡Œçš„eBPFå­—èŠ‚ç çš„å®šä¹‰ï¼ˆåç«¯ï¼‰ä»å­—èŠ‚ç åŠ è½½å™¨å’Œå‰ç«¯ç¨‹åºä¸­åˆ†ç¦»å‡ºæ¥ã€‚\nåŸºäºè¿™æ ·çš„ç›®çš„ï¼Œç¤¾åŒºåˆ›å»ºäº† BCC é¡¹ç›®ï¼Œä½¿ç”¨æˆ·å¯ä»¥ä½¿ç”¨å¸¦æœ‰é™åˆ¶æ€§çš„Cè¯­è¨€ï¼ˆBPF Cï¼‰ç¼–å†™ eBPF åç«¯ç¨‹åºï¼Œå¹¶ä¸” BCC ä¸ºç”¨æˆ·å°è£…äº†è®¸å¤šå®ç”¨åº•å±‚å‡½æ•°é¿å…é‡å¤é€ è½®å­çš„è‹¦æ¼ã€‚å€ŸåŠ© BCCï¼Œç”¨æˆ·è¿˜å¯ä»¥é€šè¿‡ç¼–å†™ python æ¥å¿«é€Ÿå®ç°åŠ è½½å™¨å’Œå‰ç«¯ç¨‹åºã€‚æ­¤å¤–ï¼Œå¦ä¸€ä¸ªé¡¹ç›® BPFtrace å»ºç«‹åœ¨ BCC ä¹‹ä¸Šï¼Œé€šè¿‡ç‰¹å®šé¢†åŸŸè¯­è¨€æä¾›æ›´é«˜çº§åˆ«çš„æŠ½è±¡é€»è¾‘ï¼Œä»¥å¸®åŠ©ç”¨æˆ·å®ç°æ›´å¿«é€Ÿåˆ†æ/è°ƒè¯•ã€‚\næˆ‘ä»¬ä»¥ BCC çš„ bashreadline ä¸ºä¾‹ç®€å•ä»‹ç»ä¸‹ä½¿ç”¨ BCC è¿›è¡Œ eBPF ç¨‹åºå¼€å‘çš„æµç¨‹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 #!/usr/bin/env python from __future__ import print_function from bcc import BPF from time import strftime import argparse ############################ # part 1 # ############################ # load BPF program bpf_text = \"\"\" #include #include struct str_t { u32 pid; char str[80]; }; BPF_PERF_OUTPUT(events); int printret(struct pt_regs *ctx) { struct str_t data = {}; char comm[TASK_COMM_LEN] = {}; if (!PT_REGS_RC(ctx)) return 0; data.pid = bpf_get_current_pid_tgid() \u003e\u003e 32; bpf_probe_read_user(\u0026data.str, sizeof(data.str), (void *)PT_REGS_RC(ctx)); bpf_get_current_comm(\u0026comm, sizeof(comm)); if (comm[0] == 'b' \u0026\u0026 comm[1] == 'a' \u0026\u0026 comm[2] == 's' \u0026\u0026 comm[3] == 'h' \u0026\u0026 comm[4] == 0 ) { events.perf_submit(ctx,\u0026data,sizeof(data)); } return 0; }; \"\"\" ############################ # part 2 # ############################ parser = argparse.ArgumentParser( description=\"Print entered bash commands from all running shells\", formatter_class=argparse.RawDescriptionHelpFormatter) parser.add_argument(\"-s\", \"--shared\", nargs=\"?\", const=\"/lib/libreadline.so\", type=str, help=\"specify the location of libreadline.so library.\\ Default is /lib/libreadline.so\") args = parser.parse_args() name = args.shared if args.shared else \"/bin/bash\" b = BPF(text=bpf_text) b.attach_uretprobe(name=name, sym=\"readline\", fn_name=\"printret\") ############################ # part 3 # ############################ # header print(\"%-9s %-7s %s\" % (\"TIME\", \"PID\", \"COMMAND\")) def print_event(cpu, data, size): event = b[\"events\"].event(data) print(\"%-9s %-7d %s\" % (strftime(\"%H:%M:%S\"), event.pid, event.str.decode('utf-8', 'replace'))) b[\"events\"].open_perf_buffer(print_event) while 1: try: b.perf_buffer_poll() except KeyboardInterrupt: exit() å¯ä»¥å°†ä¸Šé¢è¿™ä¸ª eBPF ç¨‹åºåˆ†ä¸º3ä¸ªéƒ¨åˆ†ï¼š\nPart 1 æ˜¯ç”¨ BPF C å®ç°çš„ eBPF åç«¯ç¨‹åºï¼Œé¦–å…ˆè¿™é‡Œæ„å»ºäº†å†…ç½® BPF_PERF_OUTPUT ç»“æ„æ¥åˆ›å»ºä¸€ä¸ª BPF tableï¼Œé€šè¿‡ perf ç¯å½¢ç¼“å†²åŒºå°†è‡ªå®šä¹‰äº‹ä»¶æ•°æ®æ¨é€åˆ°ç”¨æˆ·ç©ºé—´ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡ events æ¥è·å–æ¨é€çš„æ•°æ®ã€‚ç„¶ååœ¨ printret å‡½æ•°ä¸­é€šè¿‡ PT_REGS_RC æ¥åˆ¤æ–­ã€è·å–å½“å‰ç¯å¢ƒå‡½æ•°çš„è¿”å›å€¼ï¼Œå¹¶é€šè¿‡å†…ç½®å‡½æ•°è·å–ç¨‹åºpidå’Œè¿”å›å€¼ã€‚é€šè¿‡å†…ç½®å‡½æ•° bpf_get_current_comm åˆ¤æ–­å½“å‰ç¨‹åºåç§°ï¼Œå¦‚æœæ˜¯ bash å‘½ä»¤å°±å‘ events è¾“å‡ºç¨‹åºè¿è¡Œè¿”å›å€¼ã€‚ Part 2 æ˜¯é€šè¿‡ BCC çš„æ”¯æŒåˆ©ç”¨ python è¿›è¡Œå‰è¿° eBPF åç«¯ç¨‹åºçš„åŠ è½½å™¨ã€‚åŠ è½½ç±»å‹æ˜¯ uretprobeï¼Œå³å°†ç¨‹åºæŒ‚è½½åˆ° user-level çš„ readline() å‡½æ•°ä¸Šï¼Œå³åœ¨ç”¨æˆ·è°ƒç”¨ readline() å‡½æ•°è¿”å›æ—¶æ‰§è¡Œç›¸åº” eBPF åç«¯ä»£ç ã€‚ Part 3 æ˜¯æ˜¾ç¤ºè¾“å‡ºçš„å‰ç«¯ç¨‹åºï¼Œç”¨æˆ·å¯¹ events ç¼“å†²åŒºè¿›è¡Œpollingï¼Œå½“ç¼“å†²åŒºæœ‰å†…å®¹æ—¶å°†å¯¹åº”å†…å®¹è¾“å‡ºæ˜¾ç¤ºã€‚ è‡³æ­¤ï¼Œé€šè¿‡è¿è¡Œè¿™ä¸€ä¸ª BCC ç¨‹åºï¼Œç”¨æˆ·å°±å¯ä»¥é€šè¿‡ eBPFå®ç°ç›‘æ§æ‰€æœ‰ bash è¿›ç¨‹çš„ readline å‡½æ•°ï¼Œè¾“å‡ºå¯¹åº” pid å’Œ readline å¯¹è¿”å›ç»“æœï¼ˆå³ bash è¾“å…¥çš„å‘½ä»¤å†…å®¹ï¼‰ã€‚æ›´å¤šçš„å†…ç½®åŠŸèƒ½åŠæ¥å£è‡ªè¡Œå‚è§ç›¸å…³é¡¹ç›®å®˜ç½‘ã€‚\näº‹ä»¶ç±»å‹ å‰é¢æåˆ° BPF ç¨‹åºç±»å‹å¯èƒ½åŸºäº kprobes / uprobes / tracepoint /perf_events ç­‰äº‹ä»¶ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªï¼Œå…¶ä¸­ï¼š\nkprobesï¼šå†…æ ¸ä¸­åŠ¨æ€è·Ÿè¸ªã€‚å¯ä»¥è·Ÿè¸ªåˆ° Linux å†…æ ¸ä¸­çš„å‡½æ•°å…¥å£æˆ–è¿”å›ç‚¹ï¼Œä½†ä¸æ˜¯ç¨³å®šæ¥å£ï¼Œå¯èƒ½ä¼šå› ä¸ºå†…æ ¸ç‰ˆæœ¬å˜åŒ–å¯¼è‡´è·Ÿè¸ªå¤±æ•ˆã€‚ ç†è®ºä¸Šå¯ä»¥è·Ÿè¸ªåˆ°æ‰€æœ‰å¯¼å‡ºç¬¦å· /proc/kallsyms ä½†ä¸åœ¨ /sys/kernel/debug/kprobes/blacklist ä¸­çš„å‡½æ•°ã€‚ uprobesï¼šç”¨æˆ·çº§åˆ«çš„åŠ¨æ€è·Ÿè¸ªã€‚ä¸ kprobes ç±»ä¼¼ï¼Œåªæ˜¯è·Ÿè¸ªçš„å‡½æ•°ä¸ºç”¨æˆ·ç¨‹åºä¸­çš„å‡½æ•°ã€‚ tracepointsï¼šå†…æ ¸ä¸­é™æ€è·Ÿè¸ªã€‚tracepoints æ˜¯å†…æ ¸å¼€å‘äººå‘˜ç»´æŠ¤çš„è·Ÿè¸ªç‚¹ï¼Œèƒ½å¤Ÿæä¾›ç¨³å®šçš„æ¥å£ï¼Œä½†æ˜¯éœ€ç»´æŠ¤æ•°é‡ä¸”åœºæ™¯å—é™ã€‚ USDTï¼šç”¨æˆ·é™æ€æ¢é’ˆï¼Œç±»ä¼¼ tracepoints ä½†æ˜¯éœ€è¦ç”¨æˆ·ç©ºé—´è‡ªå·±ç»´æŠ¤ã€‚ perf_eventsï¼šå®šæ—¶é‡‡æ ·å’Œ PMC äº‹ä»¶ã€‚ eBPF æ¨¡å—å„ç§ç±»å‹äº‹ä»¶çš„åŠ è½½æ‰§è¡Œåœ¨åé¢æœ‰æ—¶é—´çš„è¯å†å±•å¼€è®²è®²ï¼Œæœ‰å…´è¶£çš„å¯ä»¥æœç´¢ Linux å†…æ ¸çš„ text hook/pokeã€static-key å’Œ static-jump ç­‰æœºåˆ¶å®ç°ã€‚\n3. å¸¸ç”¨eBPFå·¥å…·ä¸æŒ‡ä»¤ BCC å’Œ BPFtrace æä¾›äº†å¾ˆå¤šç°æˆå®ç”¨çš„å·¥å…·ï¼Œä¸‹é¢åˆ†äº«ä¸€äº›æˆ‘è§‰å¾—æœ‰ç”¨çš„å·¥å…·ï¼Œå…·ä½“å‚æ•°å‚è€ƒå„ä¸ªå‘½ä»¤çš„helpæŸ¥çœ‹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 # æ£€æŸ¥ pidç¨‹åºæ‰“å¼€çš„æ–‡ä»¶ opensnoop -p 123 # æ£€æµ‹ disk çš„ I/O çŠ¶æ€ biolatency [-D for each disk] [-Q include OS queued time in I/O time] # è¿½è¸ªpidç¨‹åºfsæ“ä½œå¤§äº10msçš„æ“ä½œ ext4slower 10 -p 123 # è¿½è¸ªpidç¨‹åºfsæ“ä½œåˆ†å¸ƒ ext4dist -p 123 # ç³»ç»Ÿ time æ—¶é—´çš„ cache çŠ¶æ€ cachestat time llcstat time # å‡½æ•° count / latency / call-interval ç»Ÿè®¡: funccount './test:read*' -p 123 -d 1 funclatency './test:read*' -p 123 -d 1 funcinterval './test:read*' -p 123 -d 1 # on-CPU å’Œ off-CPU ç«ç„°å›¾ï¼Œé‡‡é›† DURATION ç§’ profile -p 123 -f DURATION --stack-storage-size=165535 \u003e profile01.txt flamegraph.pl --width=1600 \u003c profile01.txt \u003e profile01.svg offcputime -p 123 -f DURATION --stack-storage-size=165535 \u003e offcpu01.txt flamegraph.pl --width=1600 \u003c offcpu01.txt \u003e offcpu01.svg # é‡‡é›† pid ç¨‹åºcache-missesè¶…è¿‡çš„10000æ¬¡çº¿ç¨‹åŠå…¶10000æ¬¡çš„æ¬¡æ•° bpftrace -e 'hardware:cache-misses:10000 /pid==123/ { @[comm, tid] = count(); }' ç‰ˆæƒå£°æ˜ï¼šå¦‚éœ€è½¬è½½æˆ–å¼•ç”¨ï¼Œè¯·é™„åŠ æœ¬æ–‡é“¾æ¥å¹¶æ³¨æ˜æ¥æºã€‚ ",
  "wordCount" : "669",
  "inLanguage": "zh",
  "datePublished": "2023-10-09T00:00:00Z",
  "dateModified": "2023-10-09T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Miao Zheyu"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://mzyee.github.io/posts/perf/ebpf/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "MZY's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://mzyee.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://mzyee.github.io" accesskey="h" title=" MZY&#39;s Blog (Alt + H)">
                <img src="https://mzyee.github.io/img/eye.jpg" alt="" aria-label="logo"
                    height="38"> MZY&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://mzyee.github.io/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://mzyee.github.io/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://mzyee.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://mzyee.github.io/contact" title="Contact">
                    <span>Contact</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://mzyee.github.io">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://mzyee.github.io/posts/">Posts</a>&nbsp;Â»&nbsp;<a href="https://mzyee.github.io/posts/perf/">Performance</a></div>
    <h1 class="post-title">
      é€šè¿‡ eBPF å·¥å…·è¿›è¡Œæ€§èƒ½åˆ†æ
    </h1>
    <div class="post-meta"><span title='2023-10-09 00:00:00 +0000 UTC'>åæœˆ 9, 2023</span>&nbsp;Â·&nbsp;4 åˆ†é’Ÿ&nbsp;Â·&nbsp;Miao Zheyu
      &nbsp;|&nbsp;ğŸ“– &nbsp;
      <ul class="post-tags-meta">
        <a href="https://mzyee.github.io/tags/performance/">Performance</a>
        <a href="https://mzyee.github.io/tags/bpf/">&nbsp;BPF</a>
      </ul>&nbsp;|&nbsp;<a href="https://github.com/mzyee/mzyee.github.io" rel="noopener noreferrer" target="_blank">Suggestions</a>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#1-ebpf%e6%8a%80%e6%9c%af%e8%83%8c%e6%99%af" aria-label="1. eBPFæŠ€æœ¯èƒŒæ™¯">1. eBPFæŠ€æœ¯èƒŒæ™¯</a></li>
                    <li>
                        <a href="#2-%e5%9f%ba%e4%ba%8eebpf%e8%bf%9b%e8%a1%8c%e8%bd%af%e4%bb%b6%e5%bc%80%e5%8f%91" aria-label="2. åŸºäºeBPFè¿›è¡Œè½¯ä»¶å¼€å‘">2. åŸºäºeBPFè¿›è¡Œè½¯ä»¶å¼€å‘</a><ul>
                            
                    <li>
                        <a href="#%e4%ba%8b%e4%bb%b6%e7%b1%bb%e5%9e%8b" aria-label="äº‹ä»¶ç±»å‹">äº‹ä»¶ç±»å‹</a></li></ul>
                    </li>
                    <li>
                        <a href="#3-%e5%b8%b8%e7%94%a8ebpf%e5%b7%a5%e5%85%b7%e4%b8%8e%e6%8c%87%e4%bb%a4" aria-label="3. å¸¸ç”¨eBPFå·¥å…·ä¸æŒ‡ä»¤">3. å¸¸ç”¨eBPFå·¥å…·ä¸æŒ‡ä»¤</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>


  <div class="post-content"><h3 id="1-ebpfæŠ€æœ¯èƒŒæ™¯">1. eBPFæŠ€æœ¯èƒŒæ™¯<a hidden class="anchor" aria-hidden="true" href="#1-ebpfæŠ€æœ¯èƒŒæ™¯">#</a></h3>
<p>â€ƒâ€ƒ BPFï¼ˆBerkeley Packet Filterï¼‰æ˜¯ç±»Unixç³»ç»Ÿä¸Šæ•°æ®é“¾è·¯å±‚çš„ä¸€ç§åŸå§‹æ¥å£ï¼Œæä¾›åŸå§‹é“¾è·¯å±‚å°åŒ…çš„æ”¶å‘ã€‚BPFåœ¨æ•°æ®åŒ…è¿‡æ»¤ä¸Šå¼•å…¥äº†ä¸¤å¤§ç‰¹æ€§ï¼š</p>
<ol>
<li>ä¸€ä¸ªå¯æœ‰æ•ˆåœ°å·¥ä½œåœ¨åŸºäºå¯„å­˜å™¨ç»“æ„ CPU ä¸Šçš„è™šæ‹Ÿæœºï¼›</li>
<li>åº”ç”¨ç¨‹åºåªå¤åˆ¶ä¸è¿‡æ»¤æ•°æ®åŒ…ç›¸å…³çš„æ•°æ®ï¼Œä¸å¤åˆ¶æ•°æ®åŒ…çš„æ‰€æœ‰ä¿¡æ¯ã€‚</li>
</ol>
<p>â€ƒâ€ƒ eBPF åœ¨åŸå§‹BPFåŸºç¡€ä¸Šè¿›ä¸€æ­¥é’ˆå¯¹ç°ä»£ CPU ç¡¬ä»¶è¿›è¡Œäº†æŒ‡ä»¤é›†ä¼˜åŒ–ï¼Œå¢åŠ äº† VM ä¸­çš„å¯„å­˜å™¨æ•°é‡ï¼Œä½¿æ•°æ®å¤„ç†é€Ÿåº¦æé«˜äº†æ•°å€ã€‚æ€»ç»“æ¥è¯´ï¼ŒeBPF æä¾›äº†ä¸€ä¸ªåŸºäºå¯„å­˜å™¨çš„è™šæ‹Ÿæœºï¼Œä½¿ç”¨è‡ªå®šä¹‰çš„ 64 ä½ RISC æŒ‡ä»¤é›†ï¼Œèƒ½å¤Ÿåœ¨ Linux å†…æ ¸å†…è¿è¡Œæœ¬åœ°å³æ—¶ç¼–è¯‘çš„ BPF ç¨‹åºï¼Œå¹¶èƒ½è®¿é—®å†…æ ¸åŠŸèƒ½å’Œå†…å­˜çš„ç‰¹å®šå­é›†ã€‚</p>
<p>â€ƒâ€ƒ eBPFç¨‹åºåˆ†ä¸º<strong>ç”¨æˆ·ç©ºé—´ç¨‹åº</strong>å’Œ<strong>å†…æ ¸ç¨‹åº</strong>ä¸¤éƒ¨åˆ†ï¼š</p>
<center><img loading="lazy" src="images/bpfkernel.png" width="100%" /></center>
<ol>
<li>ç”¨æˆ·ç©ºé—´ç¨‹åºè´Ÿè´£åŠ è½½ BPF å­—èŠ‚ç è‡³å†…æ ¸ï¼Œä¸€èˆ¬ä½¿ç”¨è€…å¯ä»¥é€šè¿‡ LLVM æˆ–è€… GCC å°†ç¼–å†™çš„ BPF ä»£ç ç¨‹åºç¼–è¯‘æˆå†…æ ¸å¯éªŒè¯çš„ BPF å­—èŠ‚ç ã€‚å†…æ ¸åŠ è½½å‰ä¼šä½¿ç”¨éªŒè¯å™¨ verfier ç»„ä»¶ä¿è¯å­—èŠ‚ç çš„å®‰å…¨æ€§ï¼Œä»¥é¿å…å¯¹å†…æ ¸é€ æˆç¾éš¾é—®é¢˜ã€‚å¦‚æœ‰éœ€è¦ï¼Œç”¨æˆ·ç©ºé—´ç¨‹åºä¹Ÿä¼šè´Ÿè´£è¯»å–å¹¶å¤„ç†å†…æ ¸å›ä¼ çš„ç»Ÿè®¡ä¿¡æ¯æˆ–è€…äº‹ä»¶è¯¦æƒ…ã€‚</li>
<li>åœ¨å†…æ ¸ä¸­åŠ è½½çš„ BPF å­—èŠ‚ç ç¨‹åºä¼šåœ¨å†…æ ¸ä¸­æ‰§è¡Œç‰¹å®šäº‹ä»¶ï¼ŒBPF ç¨‹åºå¯èƒ½åŸºäº kprobes / uprobes / tracepoint / perf_events ç­‰ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªäº‹ä»¶ã€‚å¦‚æœ‰éœ€è¦ï¼Œå†…æ ¸ç¨‹åºä¹Ÿä¼šå°†æ‰§è¡Œçš„ç»“æœé€šè¿‡ç¼“å­˜ map æˆ–è€… perf-event äº‹ä»¶å‘é€è‡³ç”¨æˆ·ç©ºé—´ã€‚</li>
</ol>
<p>â€ƒâ€ƒ é€šè¿‡ä¸Šè¿°æœºåˆ¶ï¼ŒeBPF çš„ä½¿ç”¨è€…ï¼ˆä¸å±€é™äºå†…æ ¸å¼€å‘è€…ï¼‰èƒ½å¤ŸåŸºäºç³»ç»Ÿå†…æ ¸æˆ–ç¨‹åºäº‹ä»¶é«˜æ•ˆã€å®‰å…¨çš„ï¼ˆåœ¨å†…æ ¸ä¸­ï¼‰æ‰§è¡Œç‰¹å®šä»£ç ï¼Œé€šè¿‡å‘å†…æ ¸æ·»åŠ  eBPF æ¨¡å—æ¥å¢åŠ åŠŸèƒ½ã€‚</p>
<h3 id="2-åŸºäºebpfè¿›è¡Œè½¯ä»¶å¼€å‘">2. åŸºäºeBPFè¿›è¡Œè½¯ä»¶å¼€å‘<a hidden class="anchor" aria-hidden="true" href="#2-åŸºäºebpfè¿›è¡Œè½¯ä»¶å¼€å‘">#</a></h3>
<p>â€ƒâ€ƒ eBPF æŒ‡ä»¤æ˜¯å›ºå®šå¤§å°çš„ 64 ä½ç¼–ç ï¼Œå¤§çº¦æœ‰ä¸Šç™¾æ¡æŒ‡ä»¤ï¼Œè¢«åˆ†ç»„ä¸º 8 ç±»ï¼Œ<a href="https://github.com/iovisor/bpf-docs/blob/master/eBPF.md">å¸¸ç”¨æŒ‡ä»¤</a>æ”¯æŒå¦‚ä»é€šç”¨å†…å­˜è¿›è¡ŒåŠ è½½/å­˜å‚¨ï¼Œå‰/åï¼ˆéï¼‰æ¡ä»¶è·³è½¬ã€ç®—æœ¯/é€»è¾‘æ“ä½œå’Œå‡½æ•°è°ƒç”¨ç­‰ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">  <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">    msb                                                     lsb
</span></span></span><span class="line"><span class="cl"><span class="cm">    +---------------------+---------------+----+----+-------+
</span></span></span><span class="line"><span class="cl"><span class="cm">    |immediate            |offset         |src |dst |opcode |
</span></span></span><span class="line"><span class="cl"><span class="cm">    +---------------------+---------------+----+----+-------+
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">bpf_insn</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">__u8</span>	<span class="n">code</span><span class="p">;</span>		<span class="cm">/* opcode */</span>
</span></span><span class="line"><span class="cl">    <span class="n">__u8</span>	<span class="nl">dst_reg</span><span class="p">:</span><span class="mi">4</span><span class="p">;</span>	<span class="cm">/* dest register */</span>
</span></span><span class="line"><span class="cl">    <span class="n">__u8</span>	<span class="nl">src_reg</span><span class="p">:</span><span class="mi">4</span><span class="p">;</span>	<span class="cm">/* source register */</span>
</span></span><span class="line"><span class="cl">    <span class="n">__s16</span>	<span class="n">off</span><span class="p">;</span>		<span class="cm">/* signed offset */</span>
</span></span><span class="line"><span class="cl">    <span class="n">__s32</span>	<span class="n">imm</span><span class="p">;</span>		<span class="cm">/* signed immediate constant */</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>â€ƒâ€ƒ ç›´æ¥ä½¿ç”¨åŸå§‹å­—èŠ‚ç æ¥å®ç° eBPF ç¨‹åºï¼Œéå¸¸åƒç¼–å†™æ±‡ç¼–ä»£ç ï¼Œè¿™ç§è¡Œä¸ºæ— ç–‘æ˜¯è¾ƒä¸ºå›°éš¾ï¼Œé€šå¸¸ä½¿ç”¨æ›´é«˜çº§åˆ«çš„è¯­è¨€å’Œå·¥å…·æ¥å®ç°åŠŸèƒ½å¤æ‚çš„ eBPF ç”¨ä¾‹ã€‚ä¸€ç§å¾ˆè‡ªç„¶çš„æƒ³æ³•æ˜¯èƒ½ä¸èƒ½å°†é«˜çº§è¯­è¨€çš„ä¸­é—´è¡¨ç¤ºå±‚ç¼–è¯‘æˆ eBPF ç¨‹åºæ¨¡å—ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å°†ä½¿ç”¨å…·æœ‰â€œé™åˆ¶æ€§â€œçš„é«˜çº§æŠ½è±¡å±‚è¯­è¨€æ¥ç¼–å†™ eBPF ç¨‹åºã€‚è¿™ç§è®¾è®¡æœ‰æ•ˆåœ°å°†å†…æ ¸ä¸­è¿è¡Œçš„eBPFå­—èŠ‚ç çš„å®šä¹‰ï¼ˆåç«¯ï¼‰ä»å­—èŠ‚ç åŠ è½½å™¨å’Œå‰ç«¯ç¨‹åºä¸­åˆ†ç¦»å‡ºæ¥ã€‚</p>
<p>â€ƒâ€ƒ åŸºäºè¿™æ ·çš„ç›®çš„ï¼Œç¤¾åŒºåˆ›å»ºäº† <a href="https://github.com/iovisor/bcc/blob/master/docs/reference_guide.md">BCC</a> é¡¹ç›®ï¼Œä½¿ç”¨æˆ·å¯ä»¥ä½¿ç”¨å¸¦æœ‰é™åˆ¶æ€§çš„Cè¯­è¨€ï¼ˆBPF Cï¼‰ç¼–å†™ eBPF åç«¯ç¨‹åºï¼Œå¹¶ä¸” BCC ä¸ºç”¨æˆ·å°è£…äº†è®¸å¤šå®ç”¨åº•å±‚å‡½æ•°é¿å…é‡å¤é€ è½®å­çš„è‹¦æ¼ã€‚å€ŸåŠ© BCCï¼Œç”¨æˆ·è¿˜å¯ä»¥é€šè¿‡ç¼–å†™ python æ¥å¿«é€Ÿå®ç°åŠ è½½å™¨å’Œå‰ç«¯ç¨‹åºã€‚æ­¤å¤–ï¼Œå¦ä¸€ä¸ªé¡¹ç›® <a href="https://github.com/iovisor/bpftrace/blob/master/docs/reference_guide.md">BPFtrace</a> å»ºç«‹åœ¨ BCC ä¹‹ä¸Šï¼Œé€šè¿‡ç‰¹å®šé¢†åŸŸè¯­è¨€æä¾›æ›´é«˜çº§åˆ«çš„æŠ½è±¡é€»è¾‘ï¼Œä»¥å¸®åŠ©ç”¨æˆ·å®ç°æ›´å¿«é€Ÿåˆ†æ/è°ƒè¯•ã€‚</p>
<p>â€ƒâ€ƒ æˆ‘ä»¬ä»¥ BCC çš„ bashreadline ä¸ºä¾‹ç®€å•ä»‹ç»ä¸‹ä½¿ç”¨ BCC è¿›è¡Œ eBPF ç¨‹åºå¼€å‘çš„æµç¨‹ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">  <span class="c1">#!/usr/bin/env python</span>
</span></span><span class="line"><span class="cl">  <span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
</span></span><span class="line"><span class="cl">  <span class="kn">from</span> <span class="nn">bcc</span> <span class="kn">import</span> <span class="n">BPF</span>
</span></span><span class="line"><span class="cl">  <span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">strftime</span>
</span></span><span class="line"><span class="cl">  <span class="kn">import</span> <span class="nn">argparse</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">############################</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#           part 1         #</span>
</span></span><span class="line"><span class="cl">  <span class="c1">############################</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># load BPF program</span>
</span></span><span class="line"><span class="cl">  <span class="n">bpf_text</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">  #include &lt;uapi/linux/ptrace.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">  #include &lt;linux/sched.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">  struct str_t {
</span></span></span><span class="line"><span class="cl"><span class="s2">      u32 pid;
</span></span></span><span class="line"><span class="cl"><span class="s2">      char str[80];
</span></span></span><span class="line"><span class="cl"><span class="s2">  };
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">  BPF_PERF_OUTPUT(events);
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">  int printret(struct pt_regs *ctx) {
</span></span></span><span class="line"><span class="cl"><span class="s2">      struct str_t data  = </span><span class="si">{}</span><span class="s2">;
</span></span></span><span class="line"><span class="cl"><span class="s2">      char comm[TASK_COMM_LEN] = </span><span class="si">{}</span><span class="s2">;
</span></span></span><span class="line"><span class="cl"><span class="s2">      if (!PT_REGS_RC(ctx)) return 0;
</span></span></span><span class="line"><span class="cl"><span class="s2">      data.pid = bpf_get_current_pid_tgid() &gt;&gt; 32;
</span></span></span><span class="line"><span class="cl"><span class="s2">      bpf_probe_read_user(&amp;data.str, sizeof(data.str), (void *)PT_REGS_RC(ctx));
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">      bpf_get_current_comm(&amp;comm, sizeof(comm));
</span></span></span><span class="line"><span class="cl"><span class="s2">      if (comm[0] == &#39;b&#39; &amp;&amp; comm[1] == &#39;a&#39; &amp;&amp; comm[2] == &#39;s&#39; &amp;&amp; comm[3] == &#39;h&#39; &amp;&amp; comm[4] == 0 ) {
</span></span></span><span class="line"><span class="cl"><span class="s2">          events.perf_submit(ctx,&amp;data,sizeof(data));
</span></span></span><span class="line"><span class="cl"><span class="s2">      }
</span></span></span><span class="line"><span class="cl"><span class="s2">      return 0;
</span></span></span><span class="line"><span class="cl"><span class="s2">  };
</span></span></span><span class="line"><span class="cl"><span class="s2">  &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">############################</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#           part 2         #</span>
</span></span><span class="line"><span class="cl">  <span class="c1">############################</span>
</span></span><span class="line"><span class="cl">  <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="n">description</span><span class="o">=</span><span class="s2">&#34;Print entered bash commands from all running shells&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&#34;-s&#34;</span><span class="p">,</span> <span class="s2">&#34;--shared&#34;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&#34;?&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">const</span><span class="o">=</span><span class="s2">&#34;/lib/libreadline.so&#34;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">help</span><span class="o">=</span><span class="s2">&#34;specify the location of libreadline.so library.</span><span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="s2">                Default is /lib/libreadline.so&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">shared</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">shared</span> <span class="k">else</span> <span class="s2">&#34;/bin/bash&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">b</span> <span class="o">=</span> <span class="n">BPF</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">bpf_text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">b</span><span class="o">.</span><span class="n">attach_uretprobe</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">sym</span><span class="o">=</span><span class="s2">&#34;readline&#34;</span><span class="p">,</span> <span class="n">fn_name</span><span class="o">=</span><span class="s2">&#34;printret&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">############################</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#           part 3         #</span>
</span></span><span class="line"><span class="cl">  <span class="c1">############################</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># header</span>
</span></span><span class="line"><span class="cl">  <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%-9s</span><span class="s2"> </span><span class="si">%-7s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&#34;TIME&#34;</span><span class="p">,</span> <span class="s2">&#34;PID&#34;</span><span class="p">,</span> <span class="s2">&#34;COMMAND&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="nf">print_event</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">      <span class="n">event</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="s2">&#34;events&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%-9s</span><span class="s2"> </span><span class="si">%-7d</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&#34;%H:%M:%S&#34;</span><span class="p">),</span> <span class="n">event</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="n">event</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">b</span><span class="p">[</span><span class="s2">&#34;events&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">open_perf_buffer</span><span class="p">(</span><span class="n">print_event</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">          <span class="n">b</span><span class="o">.</span><span class="n">perf_buffer_poll</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">          <span class="n">exit</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>â€ƒâ€ƒ å¯ä»¥å°†ä¸Šé¢è¿™ä¸ª eBPF ç¨‹åºåˆ†ä¸º3ä¸ªéƒ¨åˆ†ï¼š</p>
<ul>
<li>Part 1 æ˜¯ç”¨ BPF C å®ç°çš„ eBPF <strong>åç«¯ç¨‹åº</strong>ï¼Œé¦–å…ˆè¿™é‡Œæ„å»ºäº†å†…ç½® <a href="https://github.com/iovisor/bcc/blob/master/docs/reference_guide.md#2-bpf_perf_output">BPF_PERF_OUTPUT</a> ç»“æ„æ¥åˆ›å»ºä¸€ä¸ª BPF tableï¼Œé€šè¿‡ perf ç¯å½¢ç¼“å†²åŒºå°†è‡ªå®šä¹‰äº‹ä»¶æ•°æ®æ¨é€åˆ°ç”¨æˆ·ç©ºé—´ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡ events æ¥è·å–æ¨é€çš„æ•°æ®ã€‚ç„¶ååœ¨ printret å‡½æ•°ä¸­é€šè¿‡ PT_REGS_RC æ¥åˆ¤æ–­ã€è·å–å½“å‰ç¯å¢ƒå‡½æ•°çš„è¿”å›å€¼ï¼Œå¹¶é€šè¿‡å†…ç½®å‡½æ•°è·å–ç¨‹åºpidå’Œè¿”å›å€¼ã€‚é€šè¿‡å†…ç½®å‡½æ•° bpf_get_current_comm åˆ¤æ–­å½“å‰ç¨‹åºåç§°ï¼Œå¦‚æœæ˜¯ <code>bash</code> å‘½ä»¤å°±å‘ events è¾“å‡ºç¨‹åºè¿è¡Œè¿”å›å€¼ã€‚</li>
<li>Part 2 æ˜¯é€šè¿‡ BCC çš„æ”¯æŒåˆ©ç”¨ python è¿›è¡Œå‰è¿° eBPF åç«¯ç¨‹åºçš„<strong>åŠ è½½å™¨</strong>ã€‚åŠ è½½ç±»å‹æ˜¯ uretprobeï¼Œå³å°†ç¨‹åºæŒ‚è½½åˆ° user-level çš„ readline() å‡½æ•°ä¸Šï¼Œå³åœ¨ç”¨æˆ·è°ƒç”¨ readline() å‡½æ•°è¿”å›æ—¶æ‰§è¡Œç›¸åº” eBPF åç«¯ä»£ç ã€‚</li>
<li>Part 3 æ˜¯æ˜¾ç¤ºè¾“å‡ºçš„<strong>å‰ç«¯ç¨‹åº</strong>ï¼Œç”¨æˆ·å¯¹ events ç¼“å†²åŒºè¿›è¡Œpollingï¼Œå½“ç¼“å†²åŒºæœ‰å†…å®¹æ—¶å°†å¯¹åº”å†…å®¹è¾“å‡ºæ˜¾ç¤ºã€‚</li>
</ul>
<p>â€ƒâ€ƒ è‡³æ­¤ï¼Œé€šè¿‡è¿è¡Œè¿™ä¸€ä¸ª BCC ç¨‹åºï¼Œç”¨æˆ·å°±å¯ä»¥é€šè¿‡ eBPFå®ç°ç›‘æ§æ‰€æœ‰ bash è¿›ç¨‹çš„ readline å‡½æ•°ï¼Œè¾“å‡ºå¯¹åº” pid å’Œ readline å¯¹è¿”å›ç»“æœï¼ˆå³ bash è¾“å…¥çš„å‘½ä»¤å†…å®¹ï¼‰ã€‚æ›´å¤šçš„å†…ç½®åŠŸèƒ½åŠæ¥å£è‡ªè¡Œå‚è§ç›¸å…³é¡¹ç›®å®˜ç½‘ã€‚</p>
<h4 id="äº‹ä»¶ç±»å‹">äº‹ä»¶ç±»å‹<a hidden class="anchor" aria-hidden="true" href="#äº‹ä»¶ç±»å‹">#</a></h4>
<p>â€ƒâ€ƒ å‰é¢æåˆ° BPF ç¨‹åºç±»å‹å¯èƒ½åŸºäº kprobes / uprobes / tracepoint /perf_events ç­‰äº‹ä»¶ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªï¼Œå…¶ä¸­ï¼š</p>
<ul>
<li><strong>kprobes</strong>ï¼šå†…æ ¸ä¸­åŠ¨æ€è·Ÿè¸ªã€‚å¯ä»¥è·Ÿè¸ªåˆ° Linux å†…æ ¸ä¸­çš„å‡½æ•°å…¥å£æˆ–è¿”å›ç‚¹ï¼Œä½†ä¸æ˜¯ç¨³å®šæ¥å£ï¼Œå¯èƒ½ä¼šå› ä¸ºå†…æ ¸ç‰ˆæœ¬å˜åŒ–å¯¼è‡´è·Ÿè¸ªå¤±æ•ˆã€‚
ç†è®ºä¸Šå¯ä»¥è·Ÿè¸ªåˆ°æ‰€æœ‰å¯¼å‡ºç¬¦å· /proc/kallsyms ä½†ä¸åœ¨ /sys/kernel/debug/kprobes/blacklist ä¸­çš„å‡½æ•°ã€‚</li>
<li><strong>uprobes</strong>ï¼šç”¨æˆ·çº§åˆ«çš„åŠ¨æ€è·Ÿè¸ªã€‚ä¸ kprobes ç±»ä¼¼ï¼Œåªæ˜¯è·Ÿè¸ªçš„å‡½æ•°ä¸ºç”¨æˆ·ç¨‹åºä¸­çš„å‡½æ•°ã€‚</li>
<li><strong>tracepoints</strong>ï¼šå†…æ ¸ä¸­é™æ€è·Ÿè¸ªã€‚tracepoints æ˜¯å†…æ ¸å¼€å‘äººå‘˜ç»´æŠ¤çš„è·Ÿè¸ªç‚¹ï¼Œèƒ½å¤Ÿæä¾›ç¨³å®šçš„æ¥å£ï¼Œä½†æ˜¯éœ€ç»´æŠ¤æ•°é‡ä¸”åœºæ™¯å—é™ã€‚</li>
<li><strong>USDT</strong>ï¼šç”¨æˆ·é™æ€æ¢é’ˆï¼Œç±»ä¼¼ tracepoints ä½†æ˜¯éœ€è¦ç”¨æˆ·ç©ºé—´è‡ªå·±ç»´æŠ¤ã€‚</li>
<li><strong>perf_events</strong>ï¼šå®šæ—¶é‡‡æ ·å’Œ PMC äº‹ä»¶ã€‚</li>
</ul>
<p>â€ƒâ€ƒ eBPF æ¨¡å—å„ç§ç±»å‹äº‹ä»¶çš„åŠ è½½æ‰§è¡Œåœ¨åé¢æœ‰æ—¶é—´çš„è¯å†å±•å¼€è®²è®²ï¼Œæœ‰å…´è¶£çš„å¯ä»¥æœç´¢ Linux å†…æ ¸çš„ text hook/pokeã€static-key å’Œ static-jump ç­‰æœºåˆ¶å®ç°ã€‚</p>
<h3 id="3-å¸¸ç”¨ebpfå·¥å…·ä¸æŒ‡ä»¤">3. å¸¸ç”¨eBPFå·¥å…·ä¸æŒ‡ä»¤<a hidden class="anchor" aria-hidden="true" href="#3-å¸¸ç”¨ebpfå·¥å…·ä¸æŒ‡ä»¤">#</a></h3>
<p>â€ƒâ€ƒ BCC å’Œ BPFtrace æä¾›äº†å¾ˆå¤šç°æˆå®ç”¨çš„å·¥å…·ï¼Œä¸‹é¢åˆ†äº«ä¸€äº›æˆ‘è§‰å¾—æœ‰ç”¨çš„å·¥å…·ï¼Œå…·ä½“å‚æ•°å‚è€ƒå„ä¸ªå‘½ä»¤çš„helpæŸ¥çœ‹ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># æ£€æŸ¥ pidç¨‹åºæ‰“å¼€çš„æ–‡ä»¶</span>
</span></span><span class="line"><span class="cl">opensnoop -p <span class="m">123</span>
</span></span><span class="line"><span class="cl"><span class="c1"># æ£€æµ‹ disk çš„ I/O çŠ¶æ€</span>
</span></span><span class="line"><span class="cl">biolatency <span class="o">[</span>-D <span class="k">for</span> each disk<span class="o">]</span> <span class="o">[</span>-Q include OS queued <span class="nb">time</span> in I/O time<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># è¿½è¸ªpidç¨‹åºfsæ“ä½œå¤§äº10msçš„æ“ä½œ</span>
</span></span><span class="line"><span class="cl">ext4slower <span class="m">10</span> -p <span class="m">123</span>
</span></span><span class="line"><span class="cl"><span class="c1"># è¿½è¸ªpidç¨‹åºfsæ“ä½œåˆ†å¸ƒ</span>
</span></span><span class="line"><span class="cl">ext4dist -p <span class="m">123</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ç³»ç»Ÿ time æ—¶é—´çš„ cache çŠ¶æ€</span>
</span></span><span class="line"><span class="cl">cachestat <span class="nb">time</span>
</span></span><span class="line"><span class="cl">llcstat <span class="nb">time</span>
</span></span><span class="line"><span class="cl"><span class="c1"># å‡½æ•° count / latency / call-interval ç»Ÿè®¡:</span>
</span></span><span class="line"><span class="cl">funccount <span class="s1">&#39;./test:read*&#39;</span> -p <span class="m">123</span> -d <span class="m">1</span>
</span></span><span class="line"><span class="cl">funclatency <span class="s1">&#39;./test:read*&#39;</span> -p <span class="m">123</span> -d <span class="m">1</span>
</span></span><span class="line"><span class="cl">funcinterval <span class="s1">&#39;./test:read*&#39;</span> -p <span class="m">123</span> -d <span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># on-CPU å’Œ off-CPU ç«ç„°å›¾ï¼Œé‡‡é›† DURATION ç§’</span>
</span></span><span class="line"><span class="cl">profile -p <span class="m">123</span> -f DURATION --stack-storage-size<span class="o">=</span><span class="m">165535</span> &gt; profile01.txt
</span></span><span class="line"><span class="cl">flamegraph.pl --width<span class="o">=</span><span class="m">1600</span> &lt; profile01.txt &gt; profile01.svg
</span></span><span class="line"><span class="cl">offcputime -p <span class="m">123</span> -f DURATION --stack-storage-size<span class="o">=</span><span class="m">165535</span> &gt; offcpu01.txt
</span></span><span class="line"><span class="cl">flamegraph.pl --width<span class="o">=</span><span class="m">1600</span> &lt; offcpu01.txt &gt; offcpu01.svg
</span></span><span class="line"><span class="cl"><span class="c1"># é‡‡é›† pid ç¨‹åºcache-missesè¶…è¿‡çš„10000æ¬¡çº¿ç¨‹åŠå…¶10000æ¬¡çš„æ¬¡æ•°</span>
</span></span><span class="line"><span class="cl">bpftrace -e <span class="s1">&#39;hardware:cache-misses:10000 /pid==123/ { @[comm, tid] = count(); }&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<!-- copyright -->
<div class="admonition">
  <div class="admonition-content">
    <ul>
      <li>ç‰ˆæƒå£°æ˜ï¼šå¦‚éœ€è½¬è½½æˆ–å¼•ç”¨ï¼Œè¯·é™„åŠ æœ¬æ–‡é“¾æ¥å¹¶æ³¨æ˜æ¥æºã€‚</li>
    </ul>
  </div>
</div>
<!-- copyright -->

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://mzyee.github.io/tags/performance/">Performance</a></li>
      <li><a href="https://mzyee.github.io/tags/bpf/">BPF</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://mzyee.github.io/posts/mysql/undo/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>InnoDB Undo Log ä»£ç å­¦ä¹ </span>
  </a>
</nav>

  </footer>
<div>
  <div class="pagination__title">
    <span class="pagination__title-h" style="font-size: 20px;">ğŸ’¬ è¯„è®º</span>
    <hr />
  </div>
  <div id="tcomment"></div>
  <script src="https://cdn.staticfile.org/twikoo/1.6.25/twikoo.all.min.js"></script>
  <script>
    twikoo.init({
      envId: "https://mzyeee.netlify.app/.netlify/functions/twikoo",  
      el: "#tcomment",
      lang: 'zh-CN',
      region: 'ap-hongkong',
      path: window.TWIKOO_MAGIC_PATH || window.location.pathname,
    });
  </script>
</div>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://mzyee.github.io">MZY&#39;s Blog</a></span>
    <span>
        | Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a>
    </span>
    <span id="busuanzi_container">
        | Viewer
        <span class="fa fa-user"></span> <span id="busuanzi_value_site_uv"></span>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerHTML = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerHTML = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
