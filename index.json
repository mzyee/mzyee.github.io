[{"content":"å‰è¨€ InnoDB çš„ redo log æ¨¡å—æ˜¯ä¿è¯äº‹åŠ¡æŒä¹…æ€§çš„æ ¸å¿ƒï¼ŒInnoDB éµå®ˆ WAL åŸåˆ™ä¿è¯æ€»æ˜¯æ—¥å¿—å…ˆè¡Œï¼Œå³åœ¨æŒä¹…åŒ–æ•°æ®æ–‡ä»¶æ—¶ä¿è¯å…¶å¯¹åº”çš„ redo æ—¥å¿—å·²ç»å†™åˆ°ç£ç›˜ï¼Œè¿™æ ·åœ¨å´©æºƒçš„æƒ…å†µä¸‹ï¼Œå®ƒå°±å¯ä»¥ç”¨äºæ¢å¤å¯¹å·²ä¿®æ”¹ä½†å°šæœªåˆ·æ–°åˆ°ç£ç›˜çš„é¡µé¢çš„ä¿®æ”¹ã€‚æœ¬æ–‡ä¸»è¦è®¨è®º InnoDB ä¸­ redo æ—¥å¿—çš„ç‰©ç†ç»„ç»‡æ ¼å¼ï¼Œå†…å­˜ç»“æ„åŠå‰åå‘çš„ç”Ÿæˆ/åº”ç”¨æµç¨‹ã€‚å¯ä»¥å‚è€ƒé˜…è¯»æ–‡æ¡£ï¼š\næ•°æ®åº“æ•…éšœæ¢å¤æœºåˆ¶ï¼šARIESã€ARIES/IM InnoDB Redo Log å®˜æ–¹ä»‹ç» InnoDB redo log æ¼«æ¸¸ åº–ä¸è§£ InnoDB ä¹‹ REDO LOG Redo æ—¥å¿—çš„ç‰©ç†æ ¼å¼ åœ¨ 8.0.30 ç‰ˆæœ¬å‰ï¼ŒMySQL é€šè¿‡ innodb_log_file_size å’Œ innodb_log_files_in_group åˆ†åˆ«æ§åˆ¶ redo æ–‡ä»¶çš„å¤§å°å’Œæ•°ç›®ï¼Œæ–‡ä»¶åä¸º ib_logfilexxï¼›åœ¨ 8.0.30 ç‰ˆæœ¬åï¼Œå®˜æ–¹æ–°åŠ äº†å‚æ•° innodb_redo_log_capacity å¹¶å…è®¸åŠ¨æ€é…ç½® redo æ—¥å¿—çš„æ€»å®¹é‡ï¼Œç³»ç»Ÿä¸€å…±ç»´æŠ¤äº† 32 ä¸ªæ–‡ä»¶åä¸º #ib_redoxx å’Œ #ib_redoxx_tmpï¼Œå…·æœ‰ _tmp åç¼€çš„æ–‡ä»¶ä¸ºç©ºä½™æœªä½¿ç”¨çš„æ–‡ä»¶ã€‚redo æ—¥å¿—ä¸­çš„æ•°æ®æ˜¯ä»¥ append çš„å½¢å¼ä¸æ–­å¢åŠ ï¼Œæ–‡ä»¶ä¸­ä»»ä¸€ä½ç‚¹çš„æ•°æ®å¯¹åº”ä¸€ä¸ªæ°¸ä¹…é€’å¢çš„ LSN å·æ ‡å¿—ã€‚\nä¸€ä¸ª redo æ–‡ä»¶é¦–å…ˆä»¥ LOG_FILE_HDR_SIZE (2KB = 4*512B) å¤§å°çš„ file header å¼€å¤´ï¼ŒåŒ…å« header info blockã€checkpoint 1ã€encryption infoã€checkpoint 2 è¿™ 4 ä¸ªblockï¼›å…¶ä¸­ header info block è®°å½•äº†ä¸€äº›ï¼Œ4å­—èŠ‚çš„ Log ç‰ˆæœ¬ FORMATã€4å­—èŠ‚ LOG_UUIDã€8å­—èŠ‚ START_LSN æ ‡è¯†çš„å½“å‰æ–‡ä»¶å¼€å§‹LSNã€æœ€é•¿32ä½çš„ Creator ä¿¡æ¯è¡¨ç¤ºå½“å‰ mysql ç‰ˆæœ¬ã€‚æœ‰ä¸¤ä¸ª checkpoint çš„åŸå› æ˜¯é€šè¿‡ double write æœºåˆ¶é˜²æ­¢å•ä¸ª checkpoint è®°å½•å› ä¸ºå†™ç›˜è¿‡ç¨‹ä¸­é—´ crash è€ŒæŸåï¼ˆç°åœ¨å¤šæ•° SSD æ”¯æŒåŸå­å†™ 4K ç²’åº¦ï¼‰ã€‚\nè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯åœ¨ 8.0 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œcheckpoint_lsn ä¸€å®šæŒ‡å‘ä¸€ä¸ª mtr record group çš„å¼€å¤´ï¼Œå¹¶ä¸”è¯¥ mtr record åº”è¯¥è¢«æ¢å¤ï¼ˆè™½ç„¶ç›¸å…³é¡µé¢ä»ç„¶å¯èƒ½å·²è¢«åˆ·å†™ä¸‹å»ï¼‰ã€‚ä½†ä» 8.0 å¼€å§‹ï¼Œç”±äº recent_closed buffer çš„å­˜åœ¨ï¼Œè¿™ä¸ªå€¼å¯èƒ½æŒ‡å‘ record group ä¸­é—´çš„æŸä¸ªå­—èŠ‚ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ¢å¤åº”è¯¥è·³è¿‡åŒ…å«æ£€æŸ¥ç‚¹ lsn çš„æ—¥å¿—è®°å½•ç»„å¹¶ä»å…¶ä¸‹ä¸€æ¡å¼€å§‹ã€‚redo æ–‡ä»¶ä¸­å†™å…¥çš„ checkpoint_lsn ä¸€å®šåœ¨æ­¤ redo çš„ lsn èŒƒå›´ã€‚\næ¥ç€ file header çš„æ˜¯ä¸€ä¸ªä¸ª OS_FILE_LOG_BLOCK_SIZE (512B) å¤§å°çš„ log blockï¼ŒåŒ…æ‹¬12å­—èŠ‚çš„ Header (block number + data length + first record offset + checkpoint number)ã€496ä¸ªå­—èŠ‚çš„ Bodyã€4å­—èŠ‚çš„ Tailer (checksum)ã€‚å¯¹äº Header éƒ¨åˆ†çš„è¯´æ˜æ˜¯ï¼š\n4å­—èŠ‚ Block Numberï¼Œè€ç‰ˆæœ¬ä¸­ Flush Flag å ç”¨æœ€é«˜ä½bitæ ‡è¯†ä¸€æ¬¡ I/O çš„ç¬¬ä¸€ä¸ª Blockï¼Œå‰©ä¸‹çš„31ä¸ª bit æ˜¯å½“å‰ Block ç¼–å· 2å­—èŠ‚ Data Lengthï¼Œé•¿åº¦ä¸º 0 ä¸º æœªä½¿ç”¨ blockï¼ˆreuse æƒ…å†µä¸‹å¯èƒ½æ— æ•ˆï¼‰ï¼Œé•¿åº¦ä¸º [12 , 508) è¡¨ç¤ºæœ€åä¸€ä¸ªæœªå†™å®Œçš„ blockï¼Œ é•¿åº¦ä¸º 512 è¡¨ç¤ºå†™å®Œæ•´çš„ blockï¼› 2å­—èŠ‚ First Record Group Offsetï¼Œç”¨æ¥æŒ‡å‘ Block ä¸­ç¬¬ä¸€ä¸ª mtr record group çš„å¼€å§‹ä½ç½®ï¼Œå¦‚æœå’Œ Data Length ç›¸åŒåˆ™è¯´æ˜å†…éƒ¨æ²¡æœ‰å¼€å¯è®°å½•æ–°çš„ mtr record groupï¼› 4å­—èŠ‚ Epoch Numberï¼Œå’Œ Block Number ä¸€èµ·ç»„æˆäº† block çš„å”¯ä¸€æ ‡å¿—ï¼Œé€šè¿‡ 64 ä½ block start lsn è½¬æ¢è·å¾—ã€‚åœ¨è€ç‰ˆæœ¬ä¸­ï¼Œè¿™é‡Œè®°å½•çš„æ˜¯æ¯æ¬¡åˆ· checkpoint æ—¶æ¨è¿›çš„ log_sys-\u0026gt;next_checkpoint_no çš„ä½å››ä½ã€‚ åœ¨ log block çš„ body éƒ¨åˆ†ï¼Œåˆ™æ˜¯ä¸€æ¡æ¡å®é™…çš„ redo log recordï¼Œæˆ–è€…åœ¨ InnoDB ä¸­ç§°ä¸º mtr record æ›´ä¸ºè´´åˆ‡ã€‚æ¯ä¸ª redo record çš„ç¬¬ä¸€ä¸ª Byte æ˜¯è¿™ä¸ªè®°å½•çš„ç±»å‹ï¼Œå…¶ä¸­æœ€é«˜ä½çš„ bit ä¸º MLOG_SINGLE_REC_FLAGï¼Œå¦‚æœè¢«è®¾ç½®åˆ™è¡¨ç¤ºæ­¤ mtr åªåŒ…å«äº†ï¼ˆæœ€å¤šå•ä¸ªé¡µç›¸å…³ï¼‰çš„å•æ¡è®°å½•ï¼Œå¦åˆ™æ˜¯ç”±å¤šæ¡å• record ç»„æˆçš„ mtr record groupï¼Œå¹¶ä¸”åœ¨ group ç»“å°¾ä¼šä»¥ MLOG_MULTI_REC_ENDæ ‡è®°ï¼›ä¹‹åä»¥å‹ç¼©æ ¼å¼è®°å½•å½“å‰ record å¯¹åº”çš„ space id å’Œ page noï¼ˆé™¤ TABLE_DYNAMIC_META ç­‰ç±»å‹ï¼‰ï¼›æ¥ç€æ˜¯å½“å‰ record å¯¹åº”çš„ record body éƒ¨åˆ†å†…å®¹ï¼Œå…·ä½“å†…å®¹ä¼šç”± record çš„ç±»å‹å†³å®šã€‚\nInnoDB çš„ redo æ˜¯ Physiological Loggingï¼Œç½‘ä¸Šä¸€ç§å¸¸ç”¨è¯´æ³•æ˜¯ â€œPhysical to a pageï¼Œlogical within a pageâ€ï¼Œå®é™…ä¸Šå¯ä»¥ç†è§£æ˜¯åœ¨è®°å½•æ—¥å¿—æ—¶å¯¹å‰å‘è¿‡ç¨‹æ—¥å¿—è®°å½•é‡å’Œåå‘æ—¥å¿—æ¢å¤é€Ÿåº¦çš„ä¼˜åŒ–è€ƒè™‘ï¼Œåœ¨å¯¹äº page å†…çš„ä¿®æ”¹æ—¥å¿—å¹¶éä¸€å®šæ˜¯ logical çš„ï¼Œä½†åœ¨å¯¹äºä¸€ä¸ªæˆ–å¤šä¸ª page çš„å›ºå®šæ¨¡å¼çš„ä¿®æ”¹å¯ä»¥é€šè¿‡ logical log æ¥å‡å° redo è®°å½•é‡ã€‚å¦å¤–åœ¨ undo ç›¸å…³çš„åˆ†ææ–‡ç« ä¸­æåˆ°è¿‡ undo è¡¨ç©ºé—´æ•°æ®ä¹Ÿæ˜¯é€šè¿‡ redo æ¥ç»´æŠ¤çš„ï¼Œè€Œ undo æœ¬èº«æ˜¯åŸºäºé€»è¾‘è€Œéç‰©ç†å»åšå›æ»šçš„ã€‚\nRedo æ—¥å¿—çš„ç”Ÿæˆ é¦–å…ˆæœ‰å¿…è¦ä»‹ç» InnoDB ä¸­ mtr (mini-transaction) çš„æ¦‚å¿µï¼ŒInnoDB ä¸­å¯¹äºç‰©ç†æ–‡ä»¶çš„ä¿®æ”¹éƒ½æ˜¯ä»¥ mtr ä½œä¸ºåŸå­å•ä½ï¼ˆæ— è®ºå…¶å†…æ˜¯ single è¿˜æ˜¯ multi record çš„ï¼‰ã€‚ä¸€ä¸ª mtr åœ¨å‰å‘æ‰§è¡Œè¿‡ç¨‹ä¸­ä¼šå æ®æ‰€éœ€çš„èµ„æºï¼ŒåŒ…æ‹¬ indexã€page åŠå…¶å¯¹åº”ç‰©ç†é”ç­‰ï¼Œä»¥ä¿è¯å¹¶å‘æ“ä½œæ­£ç¡®æ€§ï¼Œå¹¶å°†æ•°æ®ä¿®æ”¹æ“ä½œå¯¹åº”ç”Ÿæˆçš„ redo åœ¨ mtr å†…éƒ¨ç¼“å­˜ã€‚åœ¨ mtr commit çš„æ—¶å€™æ­¤ mtr ä¼šå°†ç¼“å­˜çš„ redo record æäº¤åˆ°å…¨å±€ log buffer ä¸­ç­‰å¾…è½ç›˜ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨å†…å­˜é€»è¾‘æ¥çœ‹ï¼ˆä¸å‘ç”Ÿcrashæƒ…å†µä¸‹ï¼‰mtr ä¸€æ—¦æäº¤å°±ä»£è¡¨äº†è¿™ä¸ªç‰©ç†æ“ä½œåœ¨ç³»ç»Ÿå…¨å±€äº§ç”ŸæŒä¹…åŒ–æ•ˆæœï¼Œå“ªæ€•å¯¹åº”æ‰€å±çš„ transaction è¿˜æ²¡æœ‰æˆ–æœ€ç»ˆæœ€ç»ˆæäº¤ï¼Œå› æ­¤è¿™é‡Œåœ¨å¿…é¡»æ—¶å°±éœ€è¦ undo mtr çš„æ“ä½œï¼Œå› æ­¤åœ¨å¯¹åº”æ•°æ®æ“ä½œå‰éƒ½éœ€è¦å…ˆè®°å½• undoï¼›æ­¤å¤–ï¼Œéƒ¨åˆ†ç‰©ç†æ“ä½œå¯èƒ½ä¸ä¼šè¢«æ’¤é”€ï¼Œæ¯”å¦‚ç©ºé—´æ‹“å±•åˆ†é…ç­‰ã€‚\nå¦‚æœ mtr äº§ç”Ÿ redo log åˆ™å…¶åœ¨æäº¤è¿‡ç¨‹ä¸­ï¼š\næ ¹æ®æ•°æ®é•¿åº¦å‘ log_sys ç”³è¯·å¯¹åº”çš„å…¨å±€é¡ºåºè®°å½•çš„ sn èŒƒå›´ï¼Œå…¶é€šè¿‡åŠ ä¸Š block header å’Œ tailerï¼Œä¸åŒ…æ‹¬ file header å¯ä»¥è½¬æ¢ä¸ºå¯¹åº”çš„ lsn èŒƒå›´ï¼›å¹¶ä¸”ç­‰å¾…åˆ° log buffer çš„ç©ºé—´è¶³å¤Ÿå¯¹åº” sn èŒƒå›´æ•°æ®è¢«å†™å…¥ï¼› å¯¹äº mtr ä¸­ç¼“å­˜çš„æ‰€æœ‰ redo recordï¼ŒæŒ‰ log block çš„æ ¼å¼å°† header å’Œ tailer ç•™ç©º copy body å†…å®¹ï¼Œå¹¶å°† header ä¸­çš„ First Record Group Offset å­—æ®µï¼ˆå†™å®Œåçš„ä¸‹ä¸€ä¸ªï¼‰å¡«ä¸Šï¼› ç­‰å¾…è‡³ recent_written link_buf æœ‰ç©ºé—²ä½ç½®ï¼Œè¡¨ç¤ºåˆ°è¿™ä¸€ä½ç½®çš„ lsn å¯¹åº”çš„ log å¯ä»¥è¢«å†™å…¥ï¼›å†æ¨è¿›æ­¤ç»“æ„çš„ä¸­ç›¸åº”çš„ lsn èŒƒå›´ï¼Œè¡¨ç¤ºè¿™ä¸€æ®µå†…å®¹å·²ç»å®Œæ•´å†™å…¥åˆ° log buffer ä¸­ï¼Œå¹¶å°è¯•æ¨è¿›å…¶ m_tailï¼ˆå·²ç»è¿ç»­å®Œæ•´å†™å…¥åˆ°ä½ç½®ï¼‰ï¼› ç­‰å¾…è‡³ recent_closed link_buf æœ‰ç©ºé—²ä½ç½®ï¼Œè¡¨ç¤ºåˆ°è¿™ä¸€ä½ç½®çš„ lsn å¯¹åº”çš„ dirty page å¯ä»¥è¢«åŠ åˆ° flush list ä¸Šï¼›å†å°† dirty page æŒ‚åˆ° flush list ä¸Šï¼› æœ€ç»ˆé‡Šæ”¾æ‰€æœ‰ page é”ç­‰ç‹¬å èµ„æºã€‚ Redo æ—¥å¿—çš„å†™å…¥ åœ¨ mtr redo record å†™å…¥åˆ°å…¨å±€ log buffer ä¸­åï¼Œç³»ç»Ÿé€šè¿‡å…¨å±€ç»“æ„ log_t *log_sys å’Œåå°å·¥ä½œçº¿ç¨‹æ¥å†™å…¥ redo æ—¥å¿—ï¼Œå¹¶ç»´æŠ¤å¦‚å„ç§ lsn ä½ç‚¹ç­‰ç›¸å…³çŠ¶æ€ã€‚\nåå°å·¥ä½œçº¿ç¨‹æœ‰å¦‚ä¸‹è¿™äº›ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 /* æ§åˆ¶ log æ–‡ä»¶çš„è½®è½¬ */ void log_files_governor(log_t *log_ptr); /* å°†å…¨å±€ log buffer ä¸­çš„æ—¥å¿—å†™å…¥åˆ° OS buffer ä¸­ */ void log_writer(log_t *log_ptr); /* å°† OS buffers ä¸­çš„æ•°æ®åˆ·å†™åˆ°ç£ç›˜ä¸Š (fsyncs) */ void log_flusher(log_t *log_ptr); /* é€šçŸ¥ç”¨æˆ·çº¿ç¨‹å¯¹åº” log write å®Œæˆï¼Œwrite_lsn å·²æ›´æ–° */ void log_write_notifier(log_t *log_ptr); /* é€šçŸ¥ç”¨æˆ·çº¿ç¨‹å¯¹åº” log flush å®Œæˆï¼Œflushed_to_disk_lsn å·²æ›´æ–° */ void log_flush_notifier(log_t *log_ptr); /* æ£€æŸ¥æ˜¯å¦éœ€è¦è¦æ±‚å®Œæˆå¼ºåˆ¶åˆ·è„å¹¶å†™å…¥ checkpoint lsn åˆ°æ—¥å¿—æ–‡ä»¶ä¸­ */ void log_checkpointer(log_t *log_ptr); è¿™é‡Œåˆ·å†™ç›¸å…³çš„ä»»åŠ¡å…¶å®éƒ½æ˜¯å›´ç»• log file å’Œ log buffer é¦–ä½ç«¯çš„æ¨è¿›ï¼š\nç³»ç»Ÿç»´æŠ¤äº†æ‰€æœ‰çš„ log file çš„å†…å­˜å¯¹è±¡ Log_files_dictï¼Œå¹¶é€šè¿‡ log_files_governor æ§åˆ¶å·²å†™å…¥å®Œå…¨ï¼ˆå¯ purge æˆ–ä»éœ€è¦ï¼‰ã€å½“å‰æ­£åœ¨å†™å…¥ã€åç»­å¯ä½¿ç”¨çš„ redo æ–‡ä»¶çŠ¶æ€ï¼› log buffer å¤´éƒ¨çš„æ¨è¿›çš„ç›¸å…³çŠ¶æ€ï¼Œbuf_limit_snï¼ˆé™åˆ¶å¯è¢«å†™å…¥åˆ° buffer çš„æœ€å¤§ snï¼Œå³ wirte_lsn + buf_sizeï¼‰ã€recent_written bufferï¼ˆè¿½è¸ªæ§åˆ¶ mtr å¹¶å‘å†™å…¥çŠ¶æ€ log bufferï¼‰ã€recent_closed bufferï¼ˆè¿½è¸ªæ§åˆ¶ dirty page æŒ‚è½½ flush listï¼‰ï¼› log buffer åˆ·å†™çŠ¶æ€ï¼Œåˆ° recent_written tail ä½ç½®çš„ redo å·²ç»å®Œæ•´å¯å†™ç›˜ï¼ˆè¿™é‡Œéœ€è¦ç­‰è‡³ä¸Šä¸€æ¬¡ checkpoint åŠ  redo file æ€»å®¹é‡è¶…è¿‡ç›®æ ‡å†™å…¥ lsnï¼‰ï¼Œlog writer ä¼šå°† log block çš„ header å’Œ tailer å¡«å……ï¼Œç„¶åç¡®å®šå†™å…¥èŒƒå›´ç›´æ¥ä» log bufferï¼ˆå®Œæ•´ log_write_ahead_size å¤§å°å€æ•°ï¼‰æˆ–é€šè¿‡ write_ahead_bufferï¼ˆå°äº log_write_ahead_sizeï¼‰ å†™å…¥ log fileï¼› log buffer å°¾éƒ¨çš„æ¨è¿›çš„ç›¸å…³çŠ¶æ€ï¼Œå¦‚ write_lsnã€flushed_to_disk_lsnï¼Œäº‹ä»¶é€šçŸ¥ç­‰ã€‚ checkpoint æ¨è¿›ï¼Œå¹¶å¯¹ log file å°¾éƒ¨æ–‡ä»¶çš„å›æ”¶ã€‚ å¯¹åº”çº¿ç¨‹å…·ä½“çš„æ‰§è¡Œæµç¨‹ä»‹ç»å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚ Redo æ—¥å¿—åº”ç”¨åŠ InnoDB å¥”æºƒæ¢å¤ åœ¨å¥”æºƒæ¢å¤çš„æƒ…å†µä¸‹ï¼ŒInnoDBé€šè¿‡åº”ç”¨ redo æ¥æ¢å¤å·²ç»æäº¤ä½†è¿˜æ²¡æœ‰åˆ·ç›˜çš„äº‹åŠ¡æ•°æ®ã€‚å¦å¤–ï¼Œä¸€äº›åŸºäºç‰©ç†å¤åˆ¶æ¶æ„çš„æ•°æ®åº“ï¼Œåƒ PolarDBã€AWS Aurora ç­‰ï¼Œè¿˜å­˜åœ¨é€šè¿‡åº”ç”¨ redo æ¥è¿›è¡Œæ•°æ®åŒæ­¥çš„æµç¨‹ã€‚æˆ‘ä»¬è¿™é‡Œåªè®¨è®º recovery çš„ redo é˜¶æ®µï¼Œæ•´ä¸ª InnoDB server çš„å¯åŠ¨ç®€åŒ–æµç¨‹å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 dberr_t srv_start(bool create_new_db) { // Step 0. ç¯å¢ƒå‡†å¤‡å’Œæ£€æŸ¥ï¼Œ... // Step 1. åˆå§‹åŒ– SRV å˜é‡ï¼Œ... srv_boot(); // Step 2. æ‰«æé…ç½®çš„ç›®å½•ï¼Œç”Ÿæˆæ–‡ä»¶map fil_init(innobase_get_open_files_limit()); // ç¡®å®šè·¯å¾„... // æ‰«æè·å– .IBD å’Œ undo æ–‡ä»¶ï¼Œä»é¦– page ä¸­è¯»å– space_id å¹¶è®°å½•åˆ° fil_system çš„ Tablespace_dirs err = fil_scan_for_tablespaces(); // Step 3. INNODB STATUS ç›‘æ§æ–‡ä»¶... // Step 4. åˆå§‹åŒ– AIO çº¿ç¨‹... os_aio_init(srv_n_read_io_threads, srv_n_write_io_threads) // Step 5. åˆå§‹åŒ– buffer pool... err = buf_pool_init(srv_buf_pool_size, srv_buf_pool_instances); // Step 6. åˆå§‹åŒ–å¤šä¸ªå­ç³»ç»Ÿ... fsp_init(); pars_init(); recv_sys_create(); recv_sys_init(); trx_sys_create(); lock_sys_create(srv_lock_table_size); os_aio_start_threads();/* i/o-handler threads */ buf_flush_page_cleaner_init(); // Step 7. åˆå§‹åŒ– system tablespace... // ibdata1 æ–‡ä»¶å†…å«ç³»ç»Ÿè¡¨ç©ºé—´ï¼ˆæ³¨æ„ä¸ å…ƒæ•°æ®DDè¡¨ç©ºé—´ æˆ–å« å†…éƒ¨ç³»ç»Ÿè¡¨ çš„ mysql.ibd åŒºåˆ†ï¼‰ // å†…å« change buffer(ï¼Œç‰¹å®šæƒ…å†µä¸‹å«ç”¨æˆ·è¡¨ã€undo è¡¨)ç­‰ // åˆ›å»ºå¯¹åº”çš„ sysspace å¹¶åŠ å…¥ fil_system (fil_space_create + fil_node_create) err = srv_sys_space.open_or_create(false, create_new_db, \u0026amp;sum_of_new_sizes, \u0026amp;flushed_lsn); dict_persist_init(); // Step 8. åˆå§‹åŒ– log sysï¼Œè¿™é‡Œè¿˜ä¼šæ‰«æå‡ºæ‰€æœ‰ redo file æ¥æ„å»º Log_files_dict err = log_sys_init(create_new_db, flushed_lsn, new_files_lsn); //... if (create_new_db) { // åˆå§‹åŒ–å»ºç«‹æ–° db } else { // Step 9. BPçŠ¶æ€é‡ç½® err = dblwr::v1::init(); /* åˆå§‹åŒ– double write */ buf_pool_invalidate(); /* æ·˜æ±°æ‰€æœ‰ page ç¡®ä¿ recovery é‡è¯» */ // Step 10. æ‰“å¼€æ‰€æœ‰ log files å’Œ system data files fil_open_system_tablespace_files(); // Step 11. å¼€å§‹æ¢å¤ redo æ—¥å¿—... err = recv_recovery_from_checkpoint_start(*log_sys, flushed_lsn); // ... åˆå§‹åŒ– innodb data dictionary system // Step 12. å¯åŠ¨åå° log çº¿ç¨‹ ... if (!srv_read_only_mode) { log_start_background_threads(*log_sys); } // Step 13. åº”ç”¨å‰©ä½™çš„æœ€åä¸€æ‰¹ hashed log records if (srv_force_recovery \u0026lt; SRV_FORCE_NO_LOG_REDO) { err = recv_apply_hashed_log_recs(*log_sys, !recv_sys-\u0026gt;is_cloned_db \u0026amp;\u0026amp; !log_upgrade); } // ä¸€äº›æ£€æŸ¥... // Step 14. åˆ·å†™æ‰€æœ‰è„é¡µ if (!srv_force_recovery \u0026amp;\u0026amp; !srv_read_only_mode) { buf_flush_sync_all_buf_pools(); } // Step 15. å®Œæˆ redo æ—¥å¿—æ¢å¤åçš„æ¸…ç†ï¼Œæ¢å¤dynamic metadata MetadataRecover *dict_metadata = recv_recovery_from_checkpoint_finish(false); /* æ­¤æ—¶ DDï¼ˆtable persistent dataï¼‰è¿˜æ²¡æœ‰å®Œå…¨ recovery */ if (!recv_sys-\u0026gt;is_cloned_db \u0026amp;\u0026amp; !dict_metadata-\u0026gt;empty()) { fil_space_t *space = fil_space_acquire_silent(dict_sys_t::s_dict_space_id); if (space == nullptr) { dberr_t error = fil_ibd_open(true, FIL_TYPE_TABLESPACE, dict_sys_t::s_dict_space_id, predefined_flags, dict_sys_t::s_dd_space_name, dict_sys_t::s_dd_space_file_name, true, false); } else { fil_space_release(space); } dict_persist-\u0026gt;table_buffer = ut::new_withkey\u0026lt;DDTableBuffer\u0026gt;(UT_NEW_THIS_FILE_PSI_KEY); dict_metadata-\u0026gt;store(); // å°†æ¢å¤è¿‡ç¨‹ä¸­persistent dynamic metadataä¿®æ”¹ store åˆ° mysql.innodb_dynamic_metadata log_buffer_flush_to_disk(*log_sys); } ut::delete_(dict_metadata); // Step 16. æ„å»º Undo Tablespaces å’Œ Rollback Segments å†…å­˜ç»“æ„å¹¶è¿›è¡Œæ¢å¤ err = srv_undo_tablespaces_init(false); trx_purge_sys_mem_create(); purge_queue = trx_sys_init_at_db_start(); srv_undo_tablespaces_upgrade(); trx_purge_sys_initialize(srv_threads.m_purge_workers_n, purge_queue); } /* Open temp-tablespace and keep it open until shutdown. */ err = srv_open_tmp_tablespace(create_new_db, \u0026amp;srv_tmp_space); err = ibt::open_or_create(create_new_db); // Step 17. å®Œæ•´åŒ– undo è¡¨ç©ºé—´ // å¢åŠ  rollback segment æ•°ç›®åˆ° srv_rollback_segmentsï¼Œæ­¤æ¬¡é…ç½®å¯èƒ½å’Œä¸Šæ¬¡ä¸åŒ trx_rseg_adjust_rollback_segments(srv_rollback_segments); // æ„å»ºå®Œæˆå®Œæ•´ undo è¡¨ç©ºé—´ï¼Œåˆ é™¤ trunc.logï¼Œè®¾ç½®active srv_undo_tablespaces_mark_construction_done(); undo::spaces-\u0026gt;s_lock(); for (auto undo_space : undo::spaces-\u0026gt;m_spaces) { if (!undo_space-\u0026gt;is_empty()) { undo_space-\u0026gt;set_active(); } } undo::spaces-\u0026gt;s_unlock(); // Step 18. ç›‘æ§ç³»ç»Ÿç­‰... // Step 19. something... return (DB_SUCCESS); } å…¶ä¸­æ¯”è¾ƒå…³é”®çš„é˜¶æ®µåœ¨äº Step 11 recv_recovery_from_checkpoint_start ä¸­è¿›è¡Œ redo æ¢å¤ä»¥åŠ Step 16 æ¢å¤ undo å’Œ trx ç³»ç»Ÿçš„çŠ¶æ€ï¼Œåè€…åœ¨ undo ç³»ç»Ÿçš„è®¨è®ºä¸­è¿›è¡Œä»‹ç»ï¼Œæœ¬æ–‡ä¸»è¦è®¨è®ºå‰è€…ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 dberr_t recv_recovery_from_checkpoint_start(log_t \u0026amp;log, lsn_t flush_lsn) { // Step 1. åˆå§‹åŒ–flush_rbtï¼Œä¿è¯è„é¡µæŒ‰åºæ’å…¥flush list buf_flush_init_flush_rbt(); // Step 2. é€šè¿‡æ‰«æ Log_files_dict æ‰¾æœ€åçš„ checkpoint è®°å½• Log_checkpoint_location checkpoint; recv_find_max_checkpoint(log, checkpoint); // ... /* Step 3. è§£æå­˜å‚¨ redo recordï¼š 1. ä» checkpoint è¯»å– redo æ–‡ä»¶æš‚å­˜åˆ° log_sys-\u0026gt;bufï¼› 2. æŒ‰ log block æ‰«æå» block head/tail å­˜åˆ° recv_sys-\u0026gt;buf ä¸­ï¼› 3. å°† recv_sys-\u0026gt;buf ä¸­çš„è®°å½• parseï¼Œç”Ÿæˆ recv_t *recvï¼ˆå•ä¸ª recordï¼‰å’Œ recv_addr_t *recv_addrï¼ˆpage æ‰€æœ‰ record ä¸²ï¼‰ï¼› 4. å­˜å‚¨ recv_addr_t åˆ° recv_sys å“ˆå¸Œè¡¨å¯¹åº”çš„ (space_id, page_no) å¤„ 5. ï¼ˆå¦‚æœå ç”¨å†…å­˜è¾ƒå¤§ï¼‰å°†æ‰€æœ‰å­˜å‚¨çš„ record apply åˆ° page ä¸Šï¼Œbpå†…çš„èµ° recv_recover_pageã€bpå¤–çš„èµ° buf_read_recv_pages */ recv_recovery_begin(log, checkpoint_lsn); // Step 4. åˆå§‹åŒ– log_sys çŠ¶æ€ï¼ŒåŒ…æ‹¬å„ lsn ä½ç‚¹ã€å„ buf çŠ¶æ€ lsn_t recovered_lsn = log.recovered_lsn = recv_sys-\u0026gt;recovered_lsn; auto check_scanned_lsn = log.m_scanned_lsn; if (check_scanned_lsn % OS_FILE_LOG_BLOCK_SIZE == 0) { // If it is at block boundary, add header size. check_scanned_lsn += LOG_BLOCK_HDR_SIZE; } err = log_start(log, checkpoint_lsn, recovered_lsn, false); if (!srv_read_only_mode) { log.next_checkpoint_header_no = log_next_checkpoint_header(checkpoint.m_checkpoint_header_no); err = log_files_next_checkpoint(log, checkpoint_lsn); } mutex_enter(\u0026amp;recv_sys-\u0026gt;mutex); recv_sys-\u0026gt;apply_log_recs = true; mutex_exit(\u0026amp;recv_sys-\u0026gt;mutex); return DB_SUCCESS; } å¯¹åº” redo çš„ä½¿ç”¨ä¸»è¦åœ¨äº parse å’Œ apply ä¸¤ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«å¯¹åº” recv_parse_log_recs å’Œ recv_apply_log_rec ä¸¤ä¸ªæ¥å£ã€‚parse é˜¶æ®µå®Œæˆå recv_sys å†… redo record hash çš„ç»“æ„å±‚æ¬¡å¦‚ä¸‹ï¼Œå­˜å‚¨çš„æ˜¯å¯¹åº” (space,page) çš„è§£æå®Œæˆçš„ redo record bodyã€‚\n1 2 3 4 recv_sys =\u0026gt; space_m =\u0026gt; page_x =\u0026gt; recv_addr_t =\u0026gt; recv_t(data1)-\u0026gt;recv_t(data2)-\u0026gt;recv_t(data3) =\u0026gt; page_y =\u0026gt; recv_addr_t =\u0026gt; recv_t(data1)-\u0026gt;... =\u0026gt; ... space_n =\u0026gt; ... è§£æçš„é€»è¾‘è¾ƒä¸ºç®€å•ï¼Œç”±äº InnoDB å¯¹äºå•ä¸ª redo record ä¸ä¼šè®°å½•é•¿åº¦ï¼Œå› æ­¤å°±æ˜¯é€šè¿‡ redo ç±»å‹ç¡®å®šèµ°ä¸åŒè§£æé€»è¾‘ç¡®å®š redo record é•¿åº¦ï¼ˆè¿™é‡Œ MariaDB è®°å½•äº†é•¿åº¦æ¥åŠ é€Ÿï¼Œå½“ç„¶å…¶ redo å†…å®¹ä¹Ÿè¿˜æœ‰è®¸å¤šå…¶ä»–ä¿®æ”¹ï¼‰ã€‚éœ€è¦æ³¨æ„çš„æ˜¯å¯¹åº”ä¸€äº›éç‰©ç† page çš„ redo (å¦‚ MLOG_FILE_EXTEND) æˆ–ç‰¹æ®Š page (å¦‚ page 0) å…ƒä¿¡æ¯ä¿®æ”¹ï¼Œåœ¨ parse é˜¶æ®µå°±ä¼šåšé¢å¤–çš„å¤„ç†å·¥ä½œæ¥ç»´æŠ¤çŠ¶æ€ã€‚\nåº”ç”¨çš„é€»è¾‘è§¦å‘é€»è¾‘æœ‰ä¸¤ç§ï¼Œå¯¹äº bp å†…çš„ page ç›´æ¥èµ° recv_recover_pageï¼Œå¯¹äº bp å¤–çš„ page åœ¨è¯» I/O å®Œæˆæ—¶ buf_page_io_complete ä¹Ÿæ˜¯è°ƒç”¨ recv_recover_pageï¼ˆå”¯ä¸€ä¸åŒçš„æ˜¯åè€…ä¼šè½¬ç§» page çš„ x-latch çš„ ownership åˆ°å½“å‰çº¿ç¨‹ï¼‰ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 void recv_recover_page_func(bool just_read_in, buf_block_t *block) { mutex_enter(\u0026amp;recv_sys-\u0026gt;mutex); if (recv_sys-\u0026gt;apply_log_recs == false) { mutex_exit(\u0026amp;recv_sys-\u0026gt;mutex); return; } recv_addr_t *recv_addr = recv_get_rec(block-\u0026gt;page.id.space(), block-\u0026gt;page.id.page_no()); if (recv_addr == nullptr || recv_addr-\u0026gt;state == RECV_BEING_PROCESSED || recv_addr-\u0026gt;state == RECV_PROCESSED) { mutex_exit(\u0026amp;recv_sys-\u0026gt;mutex); return; } recv_addr-\u0026gt;state = RECV_BEING_PROCESSED; mutex_exit(\u0026amp;recv_sys-\u0026gt;mutex); mtr_t mtr; mtr_start(\u0026amp;mtr); mtr_set_log_mode(\u0026amp;mtr, MTR_LOG_NONE); // redo åº”ç”¨ä¸åœ¨è®°å½•redo // è·å– page block page_t *page = block-\u0026gt;frame; page_zip_des_t *page_zip = buf_block_get_page_zip(block); if (just_read_in) { rw_lock_x_lock_move_ownership(\u0026amp;block-\u0026gt;lock); } bool success = buf_page_get_known_nowait( RW_X_LATCH, block, Cache_hint::KEEP_OLD, __FILE__, __LINE__, \u0026amp;mtr); ut_a(success); // è·å– page lsn lsn_t page_lsn = mach_read_from_8(page + FIL_PAGE_LSN); lsn_t page_newest_lsn = buf_page_get_newest_modification(\u0026amp;block-\u0026gt;page); lsn_t end_lsn = 0; lsn_t start_lsn = 0; bool modification_to_page = false; if (page_newest_lsn) { page_lsn = page_newest_lsn; } for (auto recv : recv_addr-\u0026gt;rec_list) { end_lsn = recv-\u0026gt;end_lsn; byte *buf = nullptr; if (recv-\u0026gt;len \u0026gt; RECV_DATA_BLOCK_SIZE) { buf = static_cast\u0026lt;byte *\u0026gt;(ut::malloc_withkey(UT_NEW_THIS_FILE_PSI_KEY, recv-\u0026gt;len)); recv_data_copy_to_buf(buf, recv); } else if (recv-\u0026gt;data != nullptr) { buf = ((byte *)(recv-\u0026gt;data)) + sizeof(recv_data_t); } if (recv-\u0026gt;type == MLOG_INIT_FILE_PAGE) { // init page ç±»å‹å…ˆä¿®æ­£ page lsnï¼Œç›¸å½“äºç¬¬ä¸€æ¬¡ä¼šå¼ºåˆ¶åš apply page_lsn = page_newest_lsn; memset(FIL_PAGE_LSN + page, 0, 8); memset(UNIV_PAGE_SIZE - FIL_PAGE_END_LSN_OLD_CHKSUM + page, 0, 8); if (page_zip) memset(FIL_PAGE_LSN + page_zip-\u0026gt;data, 0, 8); } // è¿‡æ»¤æ¡ä»¶ï¼š1. page lsn ä¸è¶…è¿‡ redo çš„ lsnï¼›2. å¯¹äº undo ç©ºé—´æ²¡æœ‰ truncate if (recv-\u0026gt;start_lsn \u0026gt;= page_lsn \u0026amp;\u0026amp; undo::is_active(recv_addr-\u0026gt;space)) { lsn_t end_lsn; unsigned char *buf_end = nullptr; if (!modification_to_page) { modification_to_page = true; start_lsn = recv-\u0026gt;start_lsn; } if (buf != nullptr) { buf_end = buf + recv-\u0026gt;len; } // è¿™é‡ŒæŒ‰ç…§ redo ç±»å‹å¯¹ page çœŸæ­£è¿›è¡Œæ•°æ®ä¿®æ”¹æ¢å¤ recv_parse_or_apply_log_rec_body(recv-\u0026gt;type, buf, buf_end, recv_addr-\u0026gt;space, recv_addr-\u0026gt;page_no, block, \u0026amp;mtr, ULINT_UNDEFINED, LSN_MAX); end_lsn = recv-\u0026gt;start_lsn + recv-\u0026gt;len; // æ›´æ–° page lsn mach_write_to_8(FIL_PAGE_LSN + page, end_lsn); mach_write_to_8(UNIV_PAGE_SIZE - FIL_PAGE_END_LSN_OLD_CHKSUM + page, end_lsn); if (page_zip) mach_write_to_8(FIL_PAGE_LSN + page_zip-\u0026gt;data, end_lsn); ++applied_recs; } else { ++skipped_recs; } if (recv-\u0026gt;len \u0026gt; RECV_DATA_BLOCK_SIZE) ut::free(buf); } // æœ‰ä¿®æ”¹è¦åŠ å…¥è„é¡µ if (modification_to_page) { buf_flush_recv_note_modification(block, start_lsn, end_lsn); } mtr_commit(\u0026amp;mtr); // æ›´æ–° recv_sys çŠ¶æ€ mutex_enter(\u0026amp;recv_sys-\u0026gt;mutex); if (recv_max_page_lsn \u0026lt; page_lsn) recv_max_page_lsn = page_lsn; recv_addr-\u0026gt;state = RECV_PROCESSED; --recv_sys-\u0026gt;n_addrs; mutex_exit(\u0026amp;recv_sys-\u0026gt;mutex); } ç‰ˆæƒå£°æ˜ï¼šå¦‚éœ€è½¬è½½æˆ–å¼•ç”¨ï¼Œè¯·é™„åŠ æœ¬æ–‡é“¾æ¥å¹¶æ³¨æ˜æ¥æºã€‚ ","permalink":"https://mzyee.github.io/posts/mysql/redo/","summary":"InnoDB Redo æ—¥å¿—çš„å‰åå‘æµç¨‹","title":"InnoDB Redo æ—¥å¿—ç³»ç»Ÿ"},{"content":"å‰è¨€ äº‹åŠ¡ç³»ç»Ÿæ˜¯ InnoDB å®ç° MVCC åŠ ACIDã€è¿›è¡Œäº‹åŠ¡å¹¶å‘æ§åˆ¶çš„æ ¸å¿ƒæ¨¡å—ã€‚æœ¬æ–‡ä¸»è¦è®¨è®ºäº‹åŠ¡ç³»ç»Ÿç»“æ„å’Œä¸€ä¸ªäº‹åŠ¡çš„æ‰§è¡Œæµç¨‹ï¼ˆåŸºäº MySQL 8.0.30ï¼‰ï¼Œéœ€è¦æ¶‰åŠåˆ°å¯¹ redoã€undo ç³»ç»Ÿçš„ç›¸å…³çŸ¥è¯†ã€‚æœ¬æ–‡è¿˜ä¼šæ¶‰åŠä¸€éƒ¨åˆ† MVCC å’Œ äº‹åŠ¡é”çš„è®¨è®ºï¼Œä½†æ˜¯æ›´è¯¦ç»†å†…å®¹ä¼šåœ¨å¯¹ Concurrency Control è®¨è®ºçš„æ–‡ç« ä¸­ç»™å‡ºã€‚\näº‹åŠ¡å’Œäº‹åŠ¡ç³»ç»Ÿçš„å†…å­˜ç»“æ„ äº‹åŠ¡å’Œäº‹åŠ¡ç³»ç»Ÿå¯¹åº”çš„å†…å­˜ç»“æ„åˆ†åˆ«æ˜¯ trx_t å’Œ trx_sys_tã€‚æ¯ä¸ª session è¿æ¥æŒæœ‰ä¸€ä¸ª trx_tï¼Œå…¶åœ¨åˆ›å»ºè¿æ¥æ‰§è¡Œç¬¬ä¸€ä¸ªäº‹åŠ¡å¼€å§‹æ•´ä¸ªç»“æ„ä½“å°±åœ¨ innobase_trx_allocate åˆå§‹åŒ–äº†ï¼Œåç»­è¿™ä¸ªè¿æ¥çš„æ‰€æœ‰äº‹åŠ¡ä¸€ç›´å¤ç”¨æ­¤æ•°æ®ç»“æ„ï¼Œç›´åˆ°è¿æ¥æ–­å¼€ã€‚\näº‹åŠ¡å¯åŠ¨åä¸ç®¡è¯»å†™ï¼ŒæŠŠè¿™ä¸ªç»“æ„ä½“åŠ å…¥åˆ°å…¨å±€äº‹åŠ¡é“¾è¡¨ä¸­ (trx_sys-\u0026gt;mysql_trx_list)ï¼› å¦‚æœè½¬æ¢ä¸ºè¯»å†™äº‹åŠ¡ï¼Œè¿˜ä¼šåŠ å…¥åˆ°å…¨å±€è¯»å†™äº‹åŠ¡é“¾è¡¨ä¸­ (trx_sys-\u0026gt;rw_trx_list)ï¼›åŒæ—¶ï¼Œè¯»å†™äº‹åŠ¡åœ¨å¼€å¯æ—¶ï¼ˆæ›´ç¡®åˆ‡çš„è¯´æ˜¯åœ¨åˆ†é…å›æ»šæ®µæ—¶ï¼‰é€šè¿‡å…¨å±€ id äº§ç”Ÿå™¨äº§ç”Ÿä»¥åŒºåˆ†ä¸åŒçš„å†™äº‹åŠ¡ï¼ˆè¿™é‡Œ trx_id åªè¯»äº‹åŠ¡ä¸º0ï¼Œåªè¯»äº‹åŠ¡åªéœ€è¦é€šè¿‡æŒ‡é’ˆåœ°å€æ¥è·å–åŒºåˆ†ï¼Œå¦‚æœåªè¯»äº‹åŠ¡éœ€è¦å†™ä¸´æ—¶è¡¨ï¼Œä¹Ÿä¼šåˆ†é…ï¼‰ï¼›åŒæ—¶ï¼Œè¿˜ä¼šåˆ†é…å›æ»šæ®µç»™ trx_t ä»¥ä¾›è®°å½• undo recordã€‚ åœ¨äº‹åŠ¡å†…å­˜æäº¤çš„æ—¶å€™ï¼Œè¿˜ä¼šåŠ å…¥åˆ°å…¨å±€æäº¤äº‹åŠ¡é“¾è¡¨ä¸­(trx_sys-\u0026gt;serialisation_list)ã€‚åŒæ—¶ï¼Œåœ¨ trx æäº¤æ—¶ (trx_commit_low çš„ trx_write_serialisation_history) trx_no å­—æ®µé€šè¿‡å…¨å±€äº§ç”Ÿå™¨äº§ç”Ÿå¹¶åŠ å…¥ serialisation_listï¼Œè¿™æ ·å¯ä»¥ç¡®å®šäº‹åŠ¡æäº¤çš„é¡ºåºï¼Œä¿è¯åŠ å…¥åˆ° purge_queue å’Œ history list ä¸­çš„ update undo æœ‰åºã€‚ç„¶ååœ¨æäº¤çš„æœ€åé˜¶æ®µ (trx_commit_low çš„ trx_commit_in_memory)ï¼Œåˆ é™¤ serialisation_listã€é‡Šæ”¾æ‰€æœ‰äº‹åŠ¡é”ã€æ¸…ç† insert undoã€ç­‰å¾…åˆ·å®Œ redo logã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 struct trx_t { mutable TrxMutex mutex; /* ä¿æŠ¤ `state` å’Œ `lock` */ trx_id_t id; /* äº‹åŠ¡ idï¼Œåœ¨å¼€å¯è¯»å†™äº‹åŠ¡æˆ–åˆ†é…å›æ»šæ®µæ—¶èµ‹äºˆ */ trx_id_t no; /* äº‹åŠ¡ numberï¼Œåœ¨äº‹åŠ¡æäº¤é˜¶æ®µèµ‹äºˆ */ /* äº‹åŠ¡çš„å¯èƒ½çŠ¶æ€: TRX_STATE_NOT_STARTED TRX_STATE_FORCED_ROLLBACK TRX_STATE_ACTIVE TRX_STATE_PREPARED TRX_STATE_COMMITTED_IN_MEMORY (alias below COMMITTED) æœ‰æ•ˆçš„çŠ¶æ€è½¬ç§»æ¨¡å¼: 1. Regular transactions: * NOT_STARTED -\u0026gt; ACTIVE -\u0026gt; COMMITTED -\u0026gt; NOT_STARTED 2. Auto-commit non-locking read-only: * NOT_STARTED -\u0026gt; ACTIVE -\u0026gt; NOT_STARTED 3. XA (2PC): * NOT_STARTED -\u0026gt; ACTIVE -\u0026gt; PREPARED -\u0026gt; COMMITTED -\u0026gt; NOT_STARTED 4. Recovered XA: * NOT_STARTED -\u0026gt; PREPARED -\u0026gt; COMMITTED -\u0026gt; (freed) 5. XA (2PC) (shutdown or disconnect before ROLLBACK or COMMIT): * NOT_STARTED -\u0026gt; PREPARED -\u0026gt; (freed) 6. Disconnected XA can become recovered: * ... -\u0026gt; ACTIVE -\u0026gt; PREPARED (connected) -\u0026gt; PREPARED (disconnected) */ std::atomic\u0026lt;trx_state_t\u0026gt; state; /* ä¸€è‡´æ€§è¯»æ‰€ä½¿ç”¨çš„ read viewï¼Œé‡Œé¢è®°å½•äº†å¯åŠ¨æ—¶åˆ»ç³»ç»Ÿçš„æ´»è·ƒäº‹åŠ¡çŠ¶æ€ï¼š 1. trx ids çš„å…¨å¯è§ï¼ˆup_toï¼‰ä¸Šç•Œ/ å…¨ä¸å¯è§ï¼ˆlow_fromï¼‰ä¸‹ç•Œ 2. trx no çš„ undo éœ€æ±‚ä¸‹ç•Œï¼Œå°äºæ­¤çš„ undo ä¸è¢«éœ€è¦ 3. æ‰€æœ‰æ´»è·ƒäº‹åŠ¡ trx_id çš„æ•°ç»„ */ ReadView *read_view; UT_LIST_NODE_T(trx_t) trx_list; /* rw_trx_list èŠ‚ç‚¹ï¼Œè¯»å†™äº‹åŠ¡ */ UT_LIST_NODE_T(trx_t) no_list; /* serialisation_list èŠ‚ç‚¹ï¼Œæäº¤äº‹åŠ¡ */ UT_LIST_NODE_T(trx_t) mysql_trx_list; /* mysql_trx_list èŠ‚ç‚¹ï¼Œæ‰€æœ‰äº‹åŠ¡ */ trx_lock_t lock; /* äº‹åŠ¡é”ä¿¡æ¯ */ isolation_level_t isolation_level; /* éš”ç¦»ç­‰çº§ */ std::atomic\u0026lt;std:ğŸ§µ:id\u0026gt; killed_by; /*------------------------------*/ trx_dict_op_t dict_operation; /* æ˜¯å¦ä¿®æ”¹ data dictionary */ lsn_t commit_lsn; /* commit æ—¶çš„ lsn */ /*------------------------------*/ /*----------- Undo ç›¸å…³ä¿¡æ¯ -------------*/ UT_LIST_BASE_NODE_T_EXTERN(trx_named_savept_t, trx_savepoints) trx_savepoints{}; UndoMutex undo_mutex; undo_no_t undo_no; /* æ¯ä¸ªäº‹åŠ¡ç‹¬ç«‹è¿ç»­çš„ undo record number */ space_id_t undo_rseg_space; trx_savept_t last_sql_stat_start; trx_rsegs_t rsegs; /* rollback segments for undo logging */ undo_no_t roll_limit; ulint pages_undone; /*------------------------------*/ /* ä¸€äº›äº‹åŠ¡çŠ¶æ€ï¼Œä¾‹å¦‚ï¼š æ˜¯å¯åŠ¨åå°æ¢å¤çš„äº‹åŠ¡ï¼› æ˜¯å¦ä¿®æ”¹ dd tableï¼› æ˜¯å¦éœ€è¦ gap lockï¼› æ˜¯å¦éœ€è¦æ»ååˆ·å†™ redo logï¼› å½“å‰æ‰§è¡ŒçŠ¶æ€ ... */ // something... /* å¦‚æœæœ‰äº‹åŠ¡æ­£ç»™å½“å‰äº‹åŠ¡åŠ éšå¼é”ä¼šå¢åŠ è¿™ä¸ªæ ‡è®°ï¼Œ åŠ å®Œåå‡å°‘ï¼Œäº‹åŠ¡åœ¨æäº¤æ”¾é”å‰éœ€è¦ä¿è¯æ ‡è®°ä¸º 0ï¼Œ é¿å…äº‹åŠ¡é”åŠ ç»™æäº¤äº‹åŠ¡ */ lint n_ref; uint32_t in_depth; /* äº‹åŠ¡è¿›å…¥ innodb å±‚æ‰§è¡Œ */ uint32_t in_innodb; bool abort; /* äº‹åŠ¡è¢«ä¸­æ–­ */ std::atomic_uint64_t version; trx_mod_tables_t mod_tables; /* æ‰€æœ‰ä¿®æ”¹çš„ tables */ /* Xidä¿¡æ¯ */ // something... }; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 struct trx_sys_t { /* å­˜å‚¨æ‰€æœ‰çš„ readviewï¼ŒåŒ…æ‹¬ active å’Œ free çš„å¯¹è±¡ */ MVCC *mvcc; /* æ‰€æœ‰çš„ undo å›æ»šæ®µçš„å†…å­˜å¯¹è±¡ */ Rsegs rsegs; Rsegs tmp_rsegs; /* history list çš„é•¿åº¦ */ std::atomic\u0026lt;uint64_t\u0026gt; rseg_history_len; /* æœ€å°çš„æœªåˆ†é… trx id */ std::atomic\u0026lt;trx_id_t\u0026gt; next_trx_id_or_no; /* äº‹åŠ¡æäº¤æ—¶çš„å…¨å±€æœ‰åºé˜Ÿåˆ— */ TrxSysMutex serialisation_mutex; UT_LIST_BASE_NODE_T(trx_t, no_list) serialisation_list; std::atomic\u0026lt;trx_id_t\u0026gt; serialisation_min_trx_no; TrxSysMutex mutex; /* è¯»å†™äº‹åŠ¡é˜Ÿåˆ— */ UT_LIST_BASE_NODE_T(trx_t, trx_list) rw_trx_list; /* æ‰€æœ‰å¼€å¯äº‹åŠ¡é˜Ÿåˆ— */ UT_LIST_BASE_NODE_T(trx_t, mysql_trx_list) mysql_trx_list; /* å½“å‰æ´»è·ƒè¯»å†™äº‹åŠ¡çš„ trx id æ•°ç»„ï¼Œåœ¨åˆ†é… trx id æ—¶åŠ å…¥ï¼› ç”¨äºç»™ ReadView åˆ›å»º snapshot è®°å½•äº‹åŠ¡å¯åŠ¨æ—¶åˆ»å…¨å±€äº‹åŠ¡çŠ¶æ€ï¼Œæ¥åˆ¤æ–­å¯è§æ€§ï¼› å¦å¤–å°±æ˜¯ purge æ—¶å€™ clone_oldest æ¥ purge é™åˆ¶ä½ç‚¹ï¼› */ trx_ids_t rw_trx_ids; /* trx id åˆ° trx_t çš„æ˜ å°„ mapï¼Œç”¨äºäº‹åŠ¡æ´»è·ƒæ€§åˆ¤æ–­ */ Trx_shard shards[TRX_SHARDS_N]; ulint n_prepared_trx; /* XA PREPARED é˜¶æ®µäº‹åŠ¡æ•°ç›® */ bool found_prepared_trx; }; MySQL çš„äº‹åŠ¡æœ‰å¦‚ä¸‹å››ç§éš”ç¦»çº§åˆ«ï¼Œä¸åŒçš„çº§åˆ«ä¸‹äº‹åŠ¡çš„äº‹åŠ¡é”åŠ é”é€»è¾‘ä¸åŒã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 enum isolation_level_t { /* æ‰§è¡Œéé”å®š SELECT è¯­å¥æ—¶ï¼Œä¸æŸ¥çœ‹è®°å½•å¯èƒ½å­˜åœ¨çš„æ—©æœŸä¸€è‡´æ€§ç‰ˆæœ¬ */ READ_UNCOMMITTED, /* èŒƒå›´ UPDATE å’Œ DELETE ä¼šåŠ  next-key locks é¿å…å¹»è¯»ï¼› æ‰§è¡Œé”å®š SELECT è¯­å¥æ—¶ï¼ŒåªåŠ  record é”ä¸åŠ  gap é”ï¼› ä¸€è‡´æ€§éé”å®š SELECT è¯­å¥ï¼Œè¯­å¥çº§åˆ« snapshot å®ç° */ READ_COMMITTED, /* æ‰§è¡Œé”å®š SELECT è¯­å¥æ—¶ï¼ŒåŠ  next-key é”é”å®š gapï¼› ä¸€è‡´æ€§éé”å®š SELECT è¯­å¥ï¼Œäº‹åŠ¡çº§åˆ« snapshot å®ç° */ REPEATABLE_READ, /* æ‰€æœ‰ SELECT è¯­å¥ä»¥é”å®šæ¨¡å¼æ‰§è¡Œ */ SERIALIZABLE }; äº‹åŠ¡å¼€å¯ ç”¨æˆ·å¯ä»¥é€šè¿‡ START TRANSACTION [READ WRITE] / [WITH CONSISTENT SNAPSHOT] / [READ ONLY] ç­‰è¯­å¥æ˜¾ç¤ºå¼€å¯ï¼ˆä¸åŒç‰¹æ€§çš„ï¼‰äº‹åŠ¡ (trans_begin)ã€‚æ˜¾å¼å¼€å¯äº‹åŠ¡çš„è¡Œä¸ºéƒ½ä¼šéšå¼çš„å°†ä¸Šä¸€æ¡äº‹åŠ¡æäº¤æ‰ã€‚åªæœ‰é€šè¿‡ WITH CONSISTENT SNAPSHOT çš„æ–¹å¼æ‰ä¼šåœ¨å¼€å¯æ—¶å°±è¿›å…¥InnoDBå±‚ï¼Œï¼ˆè°ƒç”¨ innobase_start_trx_and_assign_read_viewï¼‰å»å¼€å¯ä¸€ä¸ª trx å¹¶é€šè¿‡ trx_assign_read_view åˆ†é… readviewï¼Œå¦åˆ™ä¼šåœ¨äº‹åŠ¡ç¬¬ä¸€æ¬¡éœ€è¦è¿›è¡Œä¸€æ‰§è¡Œè¯»çš„æ—¶å€™åˆ†é… readviewã€‚\nå¯¹äº InnoDB é€šè¿‡ trx_start_low åœ¨å­˜å‚¨å±‚çœŸæ­£é…ç½® trx_t å¯¹è±¡ï¼Œå°†äº‹åŠ¡è®¾ç½® TRX_STATE_ACTIVE åŠç›¸å…³è¯»å†™çŠ¶æ€ï¼Œå¯¹äºè¯»å†™äº‹åŠ¡è¿˜ä¼šï¼ˆæˆ–åˆ‡æ¢ä¸ºè¯»å†™äº‹åŠ¡ trx_set_rw_modeï¼‰ï¼š\nåˆ†é… undo å›æ»šæ®µï¼Œ trx_assign_rseg_durableï¼Œé€šè¿‡è½®è¯¢æ–¹å¼ä» undospace ä¸­åˆ†é…ä¸€ä¸ªæœ‰æ•ˆçš„å›æ»šæ®µï¼› åˆ†é… trx idï¼Œå¹¶å°†å…¶åŠ å…¥å…¨å±€çš„æ´»è·ƒäº‹åŠ¡idæ•°ç»„ trx_ids_tã€è¯»å†™äº‹åŠ¡é˜Ÿåˆ— rw_trx_list å’Œ æ´»è·ƒäº‹åŠ¡å¯¹è±¡å“ˆå¸Œè¡¨ shardsã€‚ äº‹åŠ¡æäº¤ äº‹åŠ¡çš„æäº¤åˆ†ä¸ºä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯éšå¼æäº¤ï¼Œä¸€ç§æ˜¯æ˜¾å¼æäº¤ã€‚æ˜¾å¼å¼€å¯ä¸€ä¸ªæ–°çš„äº‹åŠ¡ï¼Œæˆ–è€…æ‰§è¡Œä¸€æ¡éä¸´æ—¶è¡¨çš„DDLè¯­å¥æ—¶ï¼Œå°±ä¼šéšå¼çš„å°†ä¸Šä¸€ä¸ªäº‹åŠ¡æäº¤æ‰ã€‚å¦å¤–ä¸€ç§å°±æ˜¯æ˜¾å¼çš„æ‰§è¡Œâ€œCOMMITâ€ è¯­å¥æ¥æäº¤äº‹åŠ¡ã€‚ åœ¨ MySQL çš„ server å±‚æœ‰ä¸¤ä¸ªæäº¤å‡½æ•° trans_commit_stmt å’Œ trans_commitï¼Œå‰è€…åœ¨æ¯ä¸ªè¯­å¥æ‰§è¡Œå®Œæˆæ—¶éƒ½ä¼šè°ƒç”¨ï¼Œè€Œåè€…æ˜¯åœ¨æ•´ä¸ªäº‹åŠ¡çœŸæ­£æäº¤æ—¶å€™è°ƒç”¨ã€‚\nå†å¾€å‰è¿›ä¸€å±‚åˆ° handler æ¥å£å¤„ï¼Œä¸ºäº†ä¿è¯åˆ†å¸ƒå¼/å¤šäº‹åŠ¡å¼•æ“äº‹åŠ¡çš„ä¸€è‡´æ€§ï¼ŒMySQL å®ç°äº†ç»å…¸çš„ XA æ ‡å‡†ï¼Œä½¿ç”¨ä¸¤é˜¶æ®µæäº¤ 2PC åè®®æ¥ä¿è¯ä¸€ä¸ªå…¨å±€äº‹åŠ¡åœ¨æ‰€æœ‰å‚ä¸èŠ‚ç‚¹è¦ä¹ˆéƒ½æäº¤ï¼Œè¦ä¹ˆéƒ½ä¸­æ­¢ã€‚å¦‚æœä¸éœ€è¦å®ç°åˆ†å¸ƒäº‹åŠ¡çš„èƒ½åŠ›ï¼Œåˆ™ä¸ä¼šè¿›è¡Œ XA å®é™…æ“ä½œã€‚\nMySQLçš„ XA äº‹åŠ¡æ”¯æŒåŒ…æ‹¬å†…éƒ¨ XA å’Œå¤–éƒ¨ XAã€‚å†…éƒ¨ XA äº‹åŠ¡ä¸»è¦æŒ‡å•èŠ‚ç‚¹å®ä¾‹å†…éƒ¨ï¼Œä¸€ä¸ªäº‹åŠ¡è·¨å¤šä¸ªå­˜å‚¨å¼•æ“è¿›è¡Œè¯»å†™ï¼Œé‚£ä¹ˆå°±ä¼šäº§ç”Ÿå†…éƒ¨XAäº‹åŠ¡ï¼›å¦å¤–ï¼Œè‹¥æ‰“å¼€ binlog éœ€è¦ä¿è¯ binlog ä¸å¼•æ“ä¿®æ”¹çš„ä¸€è‡´æ€§ï¼Œå³ä½¿äº‹åŠ¡åªæ¶‰åŠä¸€ä¸ªå¼•æ“ï¼ŒMySQL å†…éƒ¨ä¹Ÿä¼šå¯åŠ¨ XA äº‹åŠ¡ã€‚å¤–éƒ¨ XA äº‹åŠ¡ä¸å†…éƒ¨ XA äº‹åŠ¡æ ¸å¿ƒé€»è¾‘ç±»ä¼¼ï¼Œæä¾›ç»™ç”¨æˆ·ä¸€å¥— XA äº‹åŠ¡çš„æ“ä½œå‘½ä»¤ï¼ŒåŒ…æ‹¬ XA startï¼ŒXA endï¼ŒXA prepre å’Œ XA commitç­‰ï¼Œå¯ä»¥æ”¯æŒè·¨å¤šä¸ªèŠ‚ç‚¹çš„ XA äº‹åŠ¡ã€‚å¤–éƒ¨ XA çš„åè°ƒè€…æ˜¯ç”¨æˆ·çš„åº”ç”¨ï¼Œå‚ä¸è€…æ˜¯ MySQL èŠ‚ç‚¹ï¼Œéœ€è¦åº”ç”¨æŒä¹…åŒ–åè°ƒä¿¡æ¯ï¼Œè§£å†³äº‹åŠ¡ä¸€è‡´æ€§é—®é¢˜ã€‚æ— è®ºå¤–éƒ¨XAäº‹åŠ¡è¿˜æ˜¯å†…éƒ¨XAäº‹åŠ¡ï¼Œå­˜å‚¨å¼•æ“å®ç°çš„éƒ½æ˜¯åŒä¸€ prepare å’Œ commit æ¥å£ã€‚\nåœ¨å¼€å¯ binlog æƒ…å†µä¸‹ï¼Œåˆ™ XA æ§åˆ¶å¯¹è±¡ï¼ˆTC_LOGï¼‰ä¸º MYSQL_BIN_LOGï¼›è‹¥å…³é—­äº†binlogï¼Œä¸”å­˜åœ¨ä¸æ­¢ä¸€ç§äº‹åŠ¡å¼•æ“æ—¶ï¼Œåˆ™ XA æ§åˆ¶å¯¹è±¡ï¼ˆTC_LOGï¼‰ä¸º TC_LOG_MMAPï¼›è‹¥æ²¡æœ‰ XA éœ€æ±‚åˆ™å®é™…ä¸Šæ— éœ€ä»»ä½•åè°ƒè€…ï¼Œä½¿ç”¨çš„æ˜¯ TC_LOG_DUMMYã€‚è¿™é‡Œä¸‹æ–‡ä¸å¯¹ XA æ§åˆ¶æµç¨‹åšè¿›ä¸€æ­¥çš„è®¨è®ºï¼Œä¸»è¦è®¨è®º InnoDB å±‚åœ¨äº‹åŠ¡æäº¤æ—¶çš„æ“ä½œã€‚\nåœ¨ tc_log-\u0026gt;commit é˜¶æ®µä¼šè°ƒç”¨å¼•æ“å±‚çš„äº‹åŠ¡æäº¤æ¥å£ï¼ŒInnoDB çš„æ¥å£å‡½æ•°ä¸º innobase_commitã€‚trans_commit_stmt å’Œ trans_commit ä¸¤è€…æœ€åéƒ½ä¼šèµ°åˆ° innobase_commit ä¸­ï¼Œä½†å…¶æœ‰ä¸€ä¸ªå‚æ•° commit_trx æ¥è¿›ä¸€æ­¥æ§åˆ¶æ˜¯å¦çœŸçš„è¿›è¡Œå­˜å‚¨å¼•æ“å±‚çš„æäº¤å¤„ç†ï¼Œtrans_commit_stmt ä¼šè®¾ç½® commit_trx ä¸º 0 è€Œ trans_commit ä¼šè®¾ç½®ä¸º 1ã€‚åªæœ‰å½“ commit_trx = 1 æˆ–è€…è®¾ç½® autocommit = 1 çš„æƒ…å†µä¸‹ï¼Œæ‰ä¼šçœŸæ­£è¿›å…¥äº‹åŠ¡æäº¤é€»è¾‘ã€‚\né¡ºä¾¿ä¸€æåœ¨çŸ¥ä¹ä¸Šçœ‹åˆ°è¿‡ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„è¯´æ³•ï¼Œæœ‰äººé€šè¿‡ä¸‹é¢è¿™ä¸ªå›¾æ¥æ€»ç»“å‡ºï¼šâ€œç»“æœMySQLçš„é»˜è®¤è¡¨ç°ç«Ÿç„¶æ˜¯å…è®¸éƒ¨åˆ†æˆåŠŸçš„äº‹åŠ¡æäº¤ï¼ˆå†™å…¥ä¸€æ¡ï¼Œä¸¢å¼ƒä¸€æ¡ï¼‰ï¼Œä¹Ÿå°±æ˜¯ä¸§å¤±äº†åŸå­æ€§ã€‚ æ²¡æœ‰åŸå­æ€§å°±æ²¡æœ‰ä¸€è‡´æ€§â€ã€‚è¿™ä¸ªè¯´æ³•å¦‚æœæ˜¯å¯¹æ•°æ®åº“åŸç†ï¼Œæˆ–è€…æ•°æ®åº“å®ç°æºç äº†è§£ä¸å¤ªæ·±å…¥çš„äººå¾ˆå®¹æ˜“æ··æ·†ï¼Œå®ƒé”™è¯¯çš„å°†è¯­å¥å’Œäº‹åŠ¡æ¦‚å¿µæ··æ·†ï¼Œå¯¼è‡´äº†é”™è¯¯çš„ç»“è®ºã€‚å¦å¤–ï¼Œå®é™…ä¸šåŠ¡ä¸­åº”ç”¨ç«¯æ˜¯éœ€è¦å¯¹ DB çš„æ“ä½œè¿”å›çŠ¶æ€è¿›è¡Œåˆ¤æ–­å¤„ç†çš„ï¼Œè¿™ä¹Ÿæ˜¯ rollback æ“ä½œå­˜åœ¨çš„æ„ä¹‰ä¹‹ä¸€ã€‚ InnoDB çš„äº‹åŠ¡æäº¤ trx_commit_low ä¸»è¦åˆ†æˆä¸¤ä¸ªéƒ¨åˆ† trx_write_serialisation_history å’Œ trx_commit_in_memoryã€‚\ntrx_write_serialisation_history ä¸»è¦æ˜¯å¤„ç†äº‹åŠ¡æ‰€ä½¿ç”¨çš„ insert / update å›æ»šæ®µ å¯¹äº undo åªä½¿ç”¨å•ä¸ª page ä¸”ä½¿ç”¨é‡å°äº 3/4 çš„ä¼šè¢«è®¾ç½®ä¸º TRX_UNDO_CACHED çŠ¶æ€ï¼›å…¶ä½™çš„ insert undo çŠ¶æ€è¢«è®¾ç½®ä¸º TRX_UNDO_TO_FREEï¼Œupdate undo çŠ¶æ€è¢«è®¾ç½®ä¸º TRX_UNDO_TO_PURGEï¼› ç»™ trx åˆ†é…æäº¤é¡ºåº trx_noï¼Œå¹¶ä¸”åŠ å…¥ serialisation_listï¼› å°†ä½¿ç”¨è¿‡çš„ undo å›æ»šæ®µå†…å­˜ç»“æ„åŠ å…¥ purge_sys-\u0026gt;purge_queue è¿™ä¸€é˜Ÿåˆ—ï¼ˆå…¶å†…æŒ‰äº‹åŠ¡æäº¤æ—¶çš„ trx-\u0026gt;no æ’åˆ—ï¼‰ä»¥ç»™ purge ç³»ç»Ÿå®šä½å›æ”¶ï¼› å°† trx-\u0026gt;no å†™å…¥ rseg/undo headerï¼Œå¹¶ undo header å°†åŠ å…¥åˆ° rseg header ä¸­ history list çš„å¼€å§‹ï¼› å¯¹ update undoï¼Œå†…å­˜ç»“æ„ trx_undo_t æŒ‰çŠ¶æ€åŠ å…¥ rseg-\u0026gt;update_undo_cached æˆ–é‡Šæ”¾ trx_undo_mem_freeï¼› trx_commit_in_memory å¤„ç†äº‹åŠ¡é”ã€Readviewã€savepoint ç­‰ åœ¨ trx_sys ç³»ç»Ÿä¸­æ¸…ç†å½“å‰äº‹åŠ¡ï¼Œç­‰åˆ°æ²¡æœ‰éšå¼é”å¼•ç”¨åé‡Šæ”¾æ‰€æœ‰äº‹åŠ¡é”å¹¶å°è¯•å”¤é†’é˜»å¡äº‹åŠ¡ï¼› å¯¹ insert undoï¼Œå†…å­˜ç»“æ„ trx_undo_t æŒ‰çŠ¶æ€åŠ å…¥ rseg-\u0026gt;insert_undo_list æˆ–é‡Šæ”¾ trx_undo_mem_freeï¼Œå¹¶ä¸”åœ¨ rollback segment ä¸­æ¸…ç†ä¸åœ¨ history çš„ insert undo segmentï¼ˆtrx_undo_seg_freeï¼‰ï¼› é 2PC æ—¶ç­‰å¾… redo è½ç›˜ï¼› æ¸…ç†æ‰€æœ‰ savepoint äº‹åŠ¡å›æ»š å½“ç”±äºå„ç§åŸå› ï¼ˆä¾‹å¦‚æ­»é”ï¼Œæˆ–è€…æ˜¾å¼å›æ»šï¼‰éœ€è¦å°†äº‹åŠ¡å›æ»šæ—¶ï¼Œä¼šè°ƒç”¨æ¥å£ trans_rollbackï¼Œè¿›è€Œè°ƒç”¨ InnoDB å‡½æ•° trx_rollback_for_mysql æ¥å›æ»šäº‹åŠ¡ã€‚å¦å¤–ç±»ä¼¼ commit é€»è¾‘åˆ†ä¸ºè¯­å¥çº§åˆ«å’Œäº‹åŠ¡çº§åˆ«ï¼Œå¦‚æœ SQL è¯­å¥çº§åˆ«çš„æ‰§è¡Œå¤±è´¥ï¼Œå°±ä¼šè¿›è¡Œè¯­å¥çº§åˆ«çš„å›æ»šæ“ä½œ trx_rollback_last_sql_stat_for_mysql æ¥å›æ»šè¯­å¥ã€‚ä¸¤ç§æœ€ç»ˆåˆä¼šé€šè¿‡ trx_rollback_to_savepoint å›æ»šåˆ°å¯¹åº”çš„ savepointï¼Œè€Œ savepoint æ˜¯é€šè¿‡ undo_no æ¥æ ‡è®°å›æ»šåˆ°å“ªä¸ªäº‹åŠ¡çŠ¶æ€ã€‚\næ„å»ºä¸€ä¸ªå›æ»šç”¨çš„æ‰§è¡Œå›¾èŠ‚ç‚¹ï¼Œå¯åŠ¨æ‰§è¡Œå›¾ï¼Œé¦–å…ˆé€šè¿‡ QUE_NODE_ROLLBACK ç±»å‹ç”¨ trx ä¸Šçš„ç›¸å…³ä¿¡æ¯æ„å»ºå…¶å†…æ‰§è¡Œçš„ undo æ‰§è¡ŒèŠ‚ç‚¹ï¼ˆundo_node_t ç±»å‹ï¼‰ï¼› å†ä»¥ QUE_NODE_UNDO ç±»å‹è¿›è¡Œå…·ä½“çš„æ•°æ®å›æ»šæ“ä½œï¼ˆè¿™å—æ“ä½œå¯ä»¥å‚è§ Undo Log ä»£ç å­¦ä¹  è¿™ä¸€ç« èŠ‚ï¼‰ã€‚ ç‰ˆæƒå£°æ˜ï¼šå¦‚éœ€è½¬è½½æˆ–å¼•ç”¨ï¼Œè¯·é™„åŠ æœ¬æ–‡é“¾æ¥å¹¶æ³¨æ˜æ¥æºã€‚ ","permalink":"https://mzyee.github.io/posts/mysql/trx/","summary":"InnoDB äº‹åŠ¡ç³»ç»Ÿå’Œäº‹åŠ¡æµç¨‹ä»£ç å­¦ä¹ ","title":"InnoDB äº‹åŠ¡ç³»ç»Ÿå’Œäº‹åŠ¡æ‰§è¡Œæµç¨‹"},{"content":"å‰è¨€ æœ¬æ–‡è®¨è®º InnoDB çš„ Purge å­ç³»ç»Ÿçš„ä»£ç å®ç°ï¼Œå»ºè®®å…ˆé˜…è¯» Undo ç³»ç»Ÿçš„ä»‹ç»ã€‚\nPurge ç³»ç»Ÿ InnoDB æ§åˆ¶ purge æ“ä½œçš„ç»“æ„ä½“æ˜¯ trx_purge_tï¼Œå…¶ä¸­ä¸»è¦ç»´æŠ¤äº†éœ€è¦è¢« purge çš„å›æ»šæ®µã€purge viewã€purge çŠ¶æ€ä½ç½®ç­‰ã€‚å…¨å±€ trx_purge_t ç»“æ„ä¼šåœ¨ innodb å¯åŠ¨æ—¶çš„trx_sys_init_at_db_startå‡½æ•°é€šè¿‡æ‰«ææ‰€æœ‰rollback segment æ¥åˆå§‹åŒ–è®¾å®šï¼Œå…¶å†…å®¹å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 struct trx_purge_t { sess_t *sess; // purgeçš„ç³»ç»Ÿsession trx_t *trx; // purgeçš„ç³»ç»Ÿtrxï¼Œä¸åœ¨ trx list rw_lock_t latch; // purge viewï¼Œstateçš„ä¿æŠ¤é” os_event_t event; // stateçš„ä¿¡å· ulint n_stop; // åœæ­¢è¿½è¸ªå™¨ volatile bool running; // æ˜¯å¦åœ¨è¿è¡Œ volatile purge_state_t state; // CoordinatorçŠ¶æ€ï¼šINITã€RUNã€STOPã€EXITã€DISABLED que_t *query; // è¿è¡Œpurgeç”¨çš„query graph ReadView view; // purge viewï¼Œå¤§äºæˆ–å‡ºç°åœ¨è¿™ä¸ªviewçš„undoä¸ä¼šè¢«purge bool view_active; // purge viewæ˜¯å¦æœ‰æ•ˆ volatile ulint n_submitted; // æäº¤çš„purgeä»»åŠ¡æ•°ç›® std::atomic\u0026lt;ulint\u0026gt; n_completed; // å®Œæˆçš„purgeä»»åŠ¡æ•°ç›® /* è¿½è¸ªpurgeçš„ä½ç½®ï¼Œç”¨äºhistory list truncation */ purge_iter_t iter; // å·²ç»readå’Œparsedçš„UNDO logä½ç½®ï¼Œä¸€å®šæ¯”limitæ›´æ–° purge_iter_t limit; // å·²ç»purgeï¼ˆæˆ–å·²ç»åˆ†é…é©¬ä¸Šè¦purgeï¼‰çš„UNDO logä½ç½® bool next_stored; // æ ‡è®°è¦purgeçš„ä¸‹ä¸€ä¸ªundoæ˜¯å¦å­˜åœ¨ä¸‹é¢è¿™äº›å˜é‡ä¸­ trx_rseg_t *rseg; // ä¸‹ä¸€ä¸ªpurgeçš„å›æ»šæ®µ page_no_t page_no; // ä¸‹ä¸€ä¸ªpurgeçš„undoçš„page no ulint offset; // ä¸‹ä¸€ä¸ªpurgeçš„undoçš„page in-page-offset page_no_t hdr_page_no; // ä¸‹ä¸€ä¸ªpurgeçš„undoçš„header page ulint hdr_offset; // // ä¸‹ä¸€ä¸ªpurgeçš„undoçš„header page in-page-offset TrxUndoRsegsIterator *rseg_iter; // ç”¨äºè·å–ä¸‹ä¸€ä¸ªpurgeçš„å›æ»šæ®µ purge_pq_t *purge_queue; // æŒ‰trx_noæ’åºçš„è¦è¢«purgeçš„ï¼ˆupdateï¼‰å›æ»šæ®µï¼Œå†…å­˜ PQMutex pq_mutex; undo::Truncate undo_trunc; // æ ‡è®°è¦truncateçš„undospace mem_heap_t *heap; std::vector\u0026lt;trx_rseg_t *\u0026gt; rsegs_queue; // å­˜å‚¨æ‰€æœ‰çš„å›æ»šæ®µ }; Purge ä¸»æµç¨‹ä»£ç  åœ¨ddlæ¢å¤å®Œæˆï¼ˆinnobase_post_recoverï¼‰ï¼Œä¿è¯ tablespaces ç›¸å…³å…ƒä¿¡æ¯çŠ¶æ€ä¸€è‡´åï¼Œç³»ç»Ÿä¼šå¯åŠ¨ srv_purge_coordinator_thread å’Œ srv_worker_thread æ¥è¿›è¡Œ undo purgeã€‚srv_purge_coordinator_thread æ˜¯ä¸»è¦æ§åˆ¶ purge æµç¨‹çš„ä»»åŠ¡çº¿ç¨‹ï¼Œåœ¨è¿è¡ŒæœŸé—´å¾ªç¯è°ƒç”¨ srv_do_purge å»å°½å¯èƒ½ purge æ‰€æœ‰ undoã€‚åœ¨srv_do_purgeä¸­æ¯æ¬¡ purge ä¸€æ‰¹ undo ä¼šæ ¹æ®ç³»ç»ŸçŠ¶æ€è‡ªé€‚åº”è°ƒæ•´ purge ç³»ç»Ÿæ‰€ä½¿ç”¨çš„çº¿ç¨‹æ•°ç›®ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 void srv_purge_coordinator_thread() { // åˆå§‹åŒ–ç¯å¢ƒï¼Œsomething... do { // å¸¸æ€å¾ªç¯ /* å¦‚æœä¸Šä¸€æ¬¡purgeæ²¡æœ‰æ¸…ç†ä¸œè¥¿ï¼Œåˆ™suspendæš‚åœç­‰å¾…ä¿¡å·ï¼Œé¿å…ç©ºè½¬ï¼› å¦å¤–ï¼Œå¤–éƒ¨æ“ä½œåƒ FLUSH TABLES FOR EXPORT ä¼šé™é»˜tablespaceç­‰çš„ä¹Ÿä¼šæš‚åœpurge */ if (srv_shutdown_state == SRV_SHUTDOWN_NONE \u0026amp;\u0026amp; (purge_sys-\u0026gt;state == PURGE_STATE_STOP || n_total_purged == 0)) { srv_purge_coordinator_suspend(slot, rseg_history_len); } if (srv_purge_should_exit(n_total_purged)) break; n_total_purged = 0; rseg_history_len = srv_do_purge(\u0026amp;n_total_purged); // è‡ªå·±åšpurge } while (!srv_purge_should_exit(n_total_purged)); // é€€å‡ºæ¸…ç†undo /* å¦‚æœä¸æ˜¯fast shutdownï¼Œç¡®ä¿æ‰€æœ‰è®°å½•è¢«purgeï¼Œé€€å‡ºé˜¶æ®µä¹Ÿå¯èƒ½æœ‰åŠ å…¥undoè®°å½•ï¼Œæ¸…ç†æ‰€æœ‰åå°çº¿ç¨‹å‚æ•°çš„undo */ ulint n_pages_purged = ULINT_MAX; while (srv_fast_shutdown == 0 \u0026amp;\u0026amp; n_pages_purged \u0026gt; 0) { n_pages_purged = trx_purge(1, srv_purge_batch_size, false); } n_pages_purged = trx_purge(1, ut_min(srv_purge_batch_size, 20), true); ut_a(n_pages_purged == 0 || srv_fast_shutdown != 0); // æ¸…ç†ç¯å¢ƒï¼Œsomething... } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 static ulint srv_do_purge(ulint *n_total_purged) { // åˆå§‹åŒ–ç¯å¢ƒï¼Œsomething... do { // å¸¸æ€å¾ªç¯å°½å¯èƒ½purge // S1. é€šè¿‡å½“å‰ç³»ç»Ÿå’ŒhistoryçŠ¶æ€ï¼Œè°ƒæ•´purge threadsæ•°ç›®ï¼š... // S2. åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œundo truncateï¼š... // S3. è°ƒç”¨trx_purgeå®é™…åšpurge n_pages_purged = trx_purge(n_use_threads, srv_purge_batch_size, do_truncate); *n_total_purged += n_pages_purged; // S4. åˆ¤æ–­æ˜¯å¦æœ‰éœ€è¦truncateçš„undo spaceä»¥å†æ¬¡è¿›å…¥ï¼š... } while (purge_sys-\u0026gt;state == PURGE_STATE_RUN \u0026amp;\u0026amp; (n_pages_purged \u0026gt; 0 || need_explicit_truncate) \u0026amp;\u0026amp; !srv_purge_should_exit(n_pages_purged)); return rseg_history_len; // ä¸Šä¸€æ‰¹purgeå‰çš„historyé•¿åº¦ } Purge coordinator çš„å®é™… purge ä»»åŠ¡æ˜¯åœ¨ trx_purge ä¸­è¿›è¡Œåˆ†é…å’Œè¿›è¡Œçš„ï¼Œ coordinator ä¼šå°† undo record åˆ†é…ç»™ srv_sys-\u0026gt;tasks ä¸­å¯¹åº”æ•°ç›®çš„ query threadï¼ŒPurge worker ç›´æ¥åŒ¹é…ç³»ç»Ÿç¯å¢ƒçš„ query thread æ‹¿ query thread nodeï¼ˆpurge_node_tç±»å‹ï¼‰è¿›è¡Œæ‰§è¡Œã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 ulint trx_purge(ulint n_purge_threads, ulint batch_size, bool truncate) { // S0. åˆå§‹åŒ–ï¼Œsomething... /****************************************************** S1. è·å–ï¼ˆcloneï¼‰æœ€è€ read view ç”¨äºä¸º MVCC é™åˆ¶ purge çš„ä½ç½® *******************************************************/ rw_lock_x_lock(\u0026amp;purge_sys-\u0026gt;latch, UT_LOCATION_HERE); purge_sys-\u0026gt;view_active = false; trx_sys-\u0026gt;mvcc-\u0026gt;clone_oldest_view(\u0026amp;purge_sys-\u0026gt;view); purge_sys-\u0026gt;view_active = true; rw_lock_x_unlock(\u0026amp;purge_sys-\u0026gt;latch); /****************************************************** S2. ç»™ purge_sys æ¯ä¸ª query thread çš„æ‰§è¡ŒèŠ‚ç‚¹ï¼ˆpurge_node_tï¼‰åˆ†é… undo recs *******************************************************/ /* S2.0. åœ¨ trx_commit æ—¶å€™å°† update undo å†™å…¥ purge_queueï¼Œï¼ˆinsert undo ç›´æ¥æ›´æ–°æˆ cache æˆ–è€… freeï¼‰ï¼› S2.1. purge_sys ç»´æŠ¤äº† next undo rec çš„ä½ç½®ï¼ˆpurge_sys-\u0026gt;iterï¼‰ï¼Œè¿™é‡Œä»è¿™ä¸€ä½ç½®å¼€å§‹è·å–batch_sizeå¤§å°çš„ undo rec S2.2. å°†è·å–çš„ undo rec åˆ†é…ç»™ä¸åŒçš„work threadï¼Œè¿™é‡Œå®˜æ–¹å…ˆæŒ‰table IDè¿›è¡Œåˆ†é…ï¼Œå†è¿›è¡Œå¹³è¡¡å°½å¯èƒ½ä¿è¯å„ worker çš„ undo æ•°ç›®å‡åŒ€ ï¼ˆæŸ¥çœ‹æäº¤ Bug #32089028 CONCURRENTLY UPDATING MANY JSON DOCUMENTS STEADILY INCREASES IBD FILE SIZEï¼‰ S2.3. å°† undo rec çœŸæ­£åˆ†é…æŒ‚åˆ° query thread çš„æ‰§è¡ŒèŠ‚ç‚¹ purge_node_t ä¸Š */ n_pages_handled = trx_purge_attach_undo_recs(n_purge_threads, batch_size); /****************************************************** S3. å¯åŠ¨å¹¶è¿›è¡Œ purge ä»»åŠ¡ *******************************************************/ // S3.1. å¯åŠ¨æ‰€æœ‰query thread if (n_purge_threads \u0026gt; 1) { for (ulint i = 0; i \u0026lt; n_purge_threads - 1; ++i) { thr = que_fork_scheduler_round_robin(purge_sys-\u0026gt;query, thr); // å‘åå° srv_sys-\u0026gt;tasks æäº¤ä»»åŠ¡ï¼Œä»¥ä¾› purger worker æ‰§è¡Œ srv_que_task_enqueue_low(thr); } purge_sys-\u0026gt;n_submitted += n_purge_threads - 1; thr = que_fork_scheduler_round_robin(purge_sys-\u0026gt;query, thr); } else { thr = que_fork_scheduler_round_robin(purge_sys-\u0026gt;query, nullptr); } ++purge_sys-\u0026gt;n_submitted; // S3.2. æ‰§è¡Œpurgeä»»åŠ¡ï¼Œå¹¶ç­‰å¾…æ‰€æœ‰workerå®Œæˆ que_run_threads(thr); purge_sys-\u0026gt;n_completed.fetch_add(1); if (n_purge_threads \u0026gt; 1) trx_purge_wait_for_workers_to_complete(); /****************************************************** S4. å°†æ‰€æœ‰ blob\u0026#39;s first page å»¶è¿Ÿåˆ°æœ«å°¾ç»Ÿä¸€é‡Šæ”¾ï¼Œé¿å…è®¿é—® freed page *******************************************************/ for (thr = UT_LIST_GET_FIRST(purge_sys-\u0026gt;query-\u0026gt;thrs); thr != nullptr; thr = UT_LIST_GET_NEXT(thrs, thr)) { purge_node_t *node = static_cast\u0026lt;purge_node_t *\u0026gt;(thr-\u0026gt;child); node-\u0026gt;free_lob_pages(); } /****************************************************** S5. è¿›è¡Œ undospace truncate *******************************************************/ if (truncate || srv_upgrade_old_undo_found) { trx_purge_truncate(); } return (n_pages_handled); } Purge ç‰©ç†æ“ä½œ åœ¨row_purgeä¸­ä¼šå¯¹åœ¨å¯¹åº” query thread çš„ run_nodeï¼ˆpurge_node_tï¼‰ä¸­å–çš„ undo record è®°å½•è¿›è¡Œ purgeï¼Œç›´åˆ° purge å®Œæ‰€æœ‰åˆ†é…çš„ undo recordï¼š\né¦–å…ˆè§£æ undo record è·å– trxidã€tableid ç­‰æ“ä½œä¿¡æ¯ï¼Œé€šè¿‡ tableid å¼€å¯ innodb è¡¨å¹¶è·å– Shared MDL é”ï¼Œç„¶åæ„å»º row reference ç­‰ä¿¡æ¯ã€‚è¿™é‡Œçš„é€»è¾‘ç±»ä¼¼ rollback æ“ä½œçš„çš„ç¬¬ä¸€æ­¥è§£æï¼› ç„¶åå¯¹ delete mark ç±»å‹çš„æ“ä½œ purge æ‰æ‰€æœ‰äºŒçº§ç´¢å¼•å’Œä¸»é”®ä¸Šä¸å†éœ€è¦çš„ index recordï¼ˆåŒ…æ‹¬extern fieldï¼‰ï¼Œè¿™é‡Œä¹Ÿæ˜¯å…ˆæ ¹æ® row reference ç´¢å¼• BTree åˆ°å¯¹åº”çš„ cursor ä¸Šï¼Œåˆ é™¤èµ°çš„æ˜¯ btr_cur çš„ delete æ¥å£ btr_cur_optimistic_delete å’Œ btr_cur_pessimistic_deleteï¼› Purge truncate å‰ä¸€ä¸ªé˜¶æ®µ purge ç‰©ç†æ“ä½œåªæ˜¯å°†ç´¢å¼•ä¸Šçš„æ•°æ®åˆ é™¤ï¼Œä½†æ˜¯ä¸ä¼šå¤„ç† undospace å†…çš„ç©ºé—´ã€‚è™½ç„¶ undo log å¯ä»¥è¢« purgeï¼Œä½†æ˜¯ç±»ä¼¼ ibd æ–‡ä»¶ï¼ˆä¸ä¸»åŠ¨optimizeï¼‰ä¸€æ—¦æ–‡ä»¶å¢å¤§é‚£ä¹ˆå°±æ— æ³•ç¼©å°ã€‚Innodb åœ¨ä¸€ä¸ª undo è¡¨ç©ºé—´æ²¡æœ‰äº‹åŠ¡ä½¿ç”¨æ—¶ï¼Œå…è®¸å°†å…¶ truncate æ¥å›æ”¶ undo è¡¨ç©ºé—´ã€‚å›æ”¶åŠ¨ä½œåœ¨ coordinator ä¸€æ‰¹ purge ä»»åŠ¡å®Œæˆåè§¦å‘ï¼Œæ¥å£ä¸ºtrx_purge_truncateï¼Œå…¶å†…éƒ¨ä¸»è¦åˆ†ä¸º purge rollback segment å’Œ truncate space ä¸¤ä¸ªéƒ¨åˆ†ã€‚\npurge rollback segmentï¼ˆtrx_purge_truncate_historyï¼‰ä¼šä»æ‰€æœ‰è¡¨ç©ºé—´çš„æ‰€æœ‰å›æ»šæ®µå›æ”¶æ— ç”¨çš„ undo æ•°æ®å¹¶æ¸…ç† history listï¼› truncate spaceï¼ˆtrx_purge_truncate_undo_spacesï¼‰ä¼šæ£€ç´¢æ˜¯å¦å­˜åœ¨æ»¡è¶³truncateè¦æ±‚çš„ undospaceï¼ˆ1. æ‰‹åŠ¨è®¾ç½®ä¸º inactive æˆ–å¤§å°è¶…è¿‡é™åˆ¶ï¼›2. ç©ºé—´ä¸­ undo è®°å½•è¢« purge å®Œå…¨ä¸”æ²¡æœ‰è¢«ä»»ä½•äº‹åŠ¡ä½¿ç”¨ï¼‰ï¼Œå¹¶è¿›è¡Œç‰©ç†æ–‡ä»¶ truncate æ“ä½œã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 /** æ¸…ç†æŸä¸ª rollback segment */ static void trx_purge_truncate_rseg_history( trx_rseg_t *rseg, /*!\u0026lt; in: rollback segment */ const purge_iter_t *limit) /*!\u0026lt; in: truncate offset */ { // å˜é‡åˆå§‹åŒ–ï¼Œsomething... // ä»å½“å‰ rollback segment çš„ history list ä¸Šé¢è·å–æœ€åä½ç½®çš„ undo log header rseg-\u0026gt;latch(); rseg_hdr = trx_rsegf_get(rseg-\u0026gt;space_id, rseg-\u0026gt;page_no, rseg-\u0026gt;page_size, \u0026amp;mtr); hdr_addr = trx_purge_get_log_from_hist(flst_get_last(rseg_hdr + TRX_RSEG_HISTORY, \u0026amp;mtr)); loop: if (hdr_addr.page == FIL_NULL) { // history ä¸å‰©ä¸‹éœ€è¦å¤„ç†çš„ undo rseg-\u0026gt;unlatch(); mtr_commit(\u0026amp;mtr); return; } undo_page = trx_undo_page_get(page_id_t(rseg-\u0026gt;space_id, hdr_addr.page), rseg-\u0026gt;page_size, \u0026amp;mtr); log_hdr = undo_page + hdr_addr.boffset; seg_hdr = undo_page + TRX_UNDO_SEG_HDR; undo_trx_no = mach_read_from_8(log_hdr + TRX_UNDO_TRX_NO); if (undo_trx_no \u0026gt;= limit-\u0026gt;trx_no) { // å½“å‰è¦å¤„ç†çš„ undo å·²ç»åˆ°è¾¾ã€è¶…è¿‡ purge limit if (undo_trx_no == limit-\u0026gt;trx_no \u0026amp;\u0026amp; rseg-\u0026gt;space_id == limit-\u0026gt;undo_rseg_space) { // å°†æ‰€æœ‰å°äº limit çš„ undo normal page freeï¼Œheader page empty trx_undo_truncate_start(rseg, hdr_addr.page, hdr_addr.boffset, limit-\u0026gt;undo_no); } rseg-\u0026gt;unlatch(); mtr_commit(\u0026amp;mtr); return; } prev_hdr_addr = trx_purge_get_log_from_hist(flst_get_prev_addr(log_hdr + TRX_UNDO_HISTORY_NODE, \u0026amp;mtr)); if ((mach_read_from_2(seg_hdr + TRX_UNDO_STATE) == TRX_UNDO_TO_PURGE) \u0026amp;\u0026amp; (mach_read_from_2(log_hdr + TRX_UNDO_NEXT_LOG) == 0)) { // æ— logå‰©ä½™ï¼Œå›æ”¶æ•´ä¸ª undo segment rseg-\u0026gt;unlatch(); mtr_commit(\u0026amp;mtr); trx_purge_free_segment(rseg, hdr_addr, is_temp); // å†…éƒ¨æœ‰trx_purge_remove_log_hdråˆ é™¤history listèŠ‚ç‚¹ } else { // åœ¨history listä¸Šåˆ é™¤å½“å‰ log headerï¼ˆè¿™é‡Œç›¸å½“äºæˆ‘é‚£æ¬¡ä¸€æ¡historyçš„purgeï¼‰ trx_purge_remove_log_hdr(rseg_hdr, log_hdr, \u0026amp;mtr); rseg-\u0026gt;unlatch(); mtr_commit(\u0026amp;mtr); } // è½¬ç§»åˆ° history list ä¸Šçš„ä¸‹ä¸€æ¡log mtr_start(\u0026amp;mtr); if (is_temp) { mtr.set_log_mode(MTR_LOG_NO_REDO); } rseg-\u0026gt;latch(); rseg_hdr = trx_rsegf_get(rseg-\u0026gt;space_id, rseg-\u0026gt;page_no, rseg-\u0026gt;page_size, \u0026amp;mtr); hdr_addr = prev_hdr_addr; goto loop; } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 // è¿›è¡Œç‰©ç†æ–‡ä»¶ truncate static bool trx_purge_truncate_marked_undo() { // S0. å˜é‡åˆå§‹åŒ–ï¼Œsomething... /****************************************************** S1. è·å– MDL é” *******************************************************/ MDL_ticket *mdl_ticket; bool dd_result = dd_tablespace_get_mdl(space_name.c_str(), \u0026amp;mdl_ticket, false); // something... /****************************************************** S2. å¼€å§‹ truncate æ“ä½œï¼Œåˆ‡æ¢ undospace *******************************************************/ mutex_enter(\u0026amp;undo::ddl_mutex); if (!trx_purge_truncate_marked_undo_low(space_num, space_name)) { mutex_exit(\u0026amp;undo::ddl_mutex); dd_release_mdl(mdl_ticket); MONITOR_INC_TIME(MONITOR_UNDO_TRUNCATE_MICROSECOND, counter_time_truncate); return (false); } /****************************************************** S3. åˆ é™¤ undo log fileï¼Œæ ‡å¿— undo truncate å®Œæˆ *******************************************************/ undo::spaces-\u0026gt;x_lock(); undo::done_logging(space_num); undo::spaces-\u0026gt;x_unlock(); // S4. æ¸…ç†ç¯å¢ƒï¼Œsomething... return (true); } static bool trx_purge_truncate_marked_undo_low(space_id_t space_num, std::string space_name) { /****************************************************** S2.1. è·å–ç¯å¢ƒ *******************************************************/ // someting... /****************************************************** S2.2. åˆ›å»º undo æ–‡ä»¶ï¼Œæ ‡å¿— undo truncate å¼€å§‹ *******************************************************/ dberr_t err = undo::start_logging(marked_space); // someting... /****************************************************** S2.3. è¿‡æ»¤ç‰¹æ®Šæ¡ä»¶ï¼Œsometing... *******************************************************/ /****************************************************** S2.4. å®é™… undo space æ–‡ä»¶è£å‰ªè½®è½¬ *******************************************************/ /* è®¡ç®—æ–° undo space id å’Œ undo space noï¼› åˆ é™¤+æ–°å»º file tablespaceï¼ˆfil_delete_tablespace + fil_ibd_createï¼‰ï¼› é‡æ–°åˆå§‹åŒ–æ–° tablespace æ–‡ä»¶ï¼Œæ„å»º undo æ–‡ä»¶å†…å®¹ï¼› é‡æ–°è®¾ç½®ç›¸åº” undo space å›æ»šæ®µå†…å­˜ç»“æ„ä½“ï¼ˆRsegs *m_rsegsï¼‰ */ bool success = trx_undo_truncate_tablespace(marked_space); // someting... /****************************************************** S2.5. è®¾å®šæ­¤ undo ç©ºé—´åé¢çš„å¯ç”¨çŠ¶æ€ *******************************************************/ space_id_t new_space_id = marked_space-\u0026gt;id(); dd_space_states next_state; undo::spaces-\u0026gt;s_lock(); Rsegs *marked_rsegs = marked_space-\u0026gt;rsegs(); marked_rsegs-\u0026gt;x_lock(); if (marked_rsegs-\u0026gt;is_inactive_explicit()) { // ç”±å¤–éƒ¨æ‰‹åŠ¨ inactive next_state = DD_SPACE_STATE_EMPTY; marked_rsegs-\u0026gt;set_empty(); } else { // ç”±åå° purge é€‰æ‹©ï¼Œå¯è¢«å†ä½¿ç”¨ next_state = DD_SPACE_STATE_ACTIVE; marked_rsegs-\u0026gt;set_active(); } /****************************************************** S2.6. åœ¨ DD ä¸­æ›´æ–° space ID å’Œ state ä¿¡æ¯ *******************************************************/ if (DD_FAILURE == dd_tablespace_set_id_and_state(space_name.c_str(), new_space_id, next_state)) return (false); return (true); } ç‰ˆæƒå£°æ˜ï¼šå¦‚éœ€è½¬è½½æˆ–å¼•ç”¨ï¼Œè¯·é™„åŠ æœ¬æ–‡é“¾æ¥å¹¶æ³¨æ˜æ¥æºã€‚ ","permalink":"https://mzyee.github.io/posts/mysql/purge/","summary":"InnoDB Purge System ç›¸å…³ä»£ç å­¦ä¹ ","title":"InnoDB Purge System ä»£ç å­¦ä¹ "},{"content":"å‰è¨€ å·²ç»æœ‰ä¸å°‘æ–‡ç« å¯¹ InnoDB çš„ undo ç³»ç»Ÿè¿›è¡Œäº†å…¨é¢ä»‹ç»ï¼Œæ¯”å¦‚ï¼š\nInnoDB undo log æ¼«æ¸¸ InnoDBä¹‹UNDO LOGä»‹ç» åº–ä¸è§£InnoDBä¹‹UNDO LOG æœ¬æ–‡ä¸»è¦å…³æ³¨ä¸€äº› Undo ç³»ç»Ÿè®¾è®¡/ä»£ç å®ç°æ˜ å°„ï¼Œä»¥åŠéƒ¨åˆ†ç¬”è€…å…³å¿ƒçš„ä»£ç ç»†èŠ‚ï¼Œå»ºè®®ç»“åˆé˜…è¯»ä¸Šè¿°æ–‡ç« ã€‚\nUndoçš„ç‰©ç†ç»„ç»‡ é¦–å…ˆè¦æ˜ç¡®çš„ä¸€ç‚¹æ˜¯ InnoDB çš„ undo log å®é™…ä¸Šæ˜¯ä»¥è¡¨æ•°æ®æ ¼å¼è®°å½•çš„ï¼ˆæ‰€ä»¥å« undo tablespaceï¼‰ï¼Œå¹¶ä¸”é™¤äº† temporary table çš„ undoï¼Œæ­£å¸¸ç”¨æˆ·è¡¨ undo éƒ½é€šè¿‡ redo æ¥ç»´æŠ¤æŒä¹…æ€§ã€‚\nç”±äºé€šè¿‡è¡¨ç©ºé—´å­˜å‚¨ undo logï¼Œæ‰€ä»¥ undo æ–‡ä»¶çš„åŸºç¡€ç»„ç»‡å½¢å¼æ˜¯ç±»ä¼¼ InnoDB çš„ ibd æ–‡ä»¶ï¼Œå†…éƒ¨æœ‰å¦‚ File Segment ç­‰æ¦‚å¿µã€æœ‰å„ç§æ–‡ä»¶ç»´æŠ¤ç»“æ„çš„ listã€æœ‰ page ä¸Šæ–‡ä»¶ç»´æŠ¤ç»“æ„ç›¸å…³çš„ metaï¼Œç­‰ç­‰ã€‚å¹¶ä¸”åˆ†é… undo page æ—¶å€™ä¹Ÿæ˜¯é€šè¿‡ fsp_reserve_free_extents è¿™ä¸€æ¥å£å»ç”³è¯·ç©ºé—²æ•°æ®é¡µã€‚\næ¯ä¸ª Undo Tablespace æœ‰æœ€å¤š128ä¸ªå¯ç”¨çš„ Rollback Segmentï¼ŒUndo Tablespace ç¬¬ä¸‰ä¸ªé¡µæœ‰128ä¸ª Rollback Segment çš„ç›®å½•ï¼ˆRollback Segment Header\u0026rsquo;s Arraryï¼‰ï¼Œå…¶ä¸­æ¯ä¸ªå…ƒç´ æŒ‡å‘å„ä¸ª Rollback Segment Header æ‰€åœ¨çš„ page numberã€‚åˆå§‹åŒ–æ—¶å€™ä¼šå¤„ç†æ‰€æœ‰ Rollback Segmentï¼Œå¦‚æœæœªä½¿ç”¨åˆ™ä¸º FIL_NULLï¼Œé€šè¿‡ innodb_rollback_segments å‚æ•°æ§åˆ¶å®é™…ä½¿ç”¨æ•°ç›®ã€‚\nä¸€ä¸ª Rollback Segment Header åŒ…å«1024ä¸ª slotï¼ˆå››å­—èŠ‚ï¼‰ï¼Œæ¯ä¸ª slot æŒ‡å‘ Undo Segment çš„ first page numberï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ª Undo Segment çš„ Undo Header Pageã€‚æ¯ä¸€æ—¶åˆ»ï¼Œæ¯ä¸ªä½¿ç”¨çš„ Undo Segment éƒ½è¢«ä¸€ä¸ªäº‹åŠ¡ç‹¬å ï¼Œè€Œæ¯ä¸ªå†™äº‹åŠ¡éƒ½ä¼šæŒæœ‰è‡³å°‘ä¸€ä¸ªUndo Segmentï¼Œå› æ­¤è¢«ä½¿ç”¨çš„ Undo Header Page ä¸­åªæœ‰ä¸€ä¸ªæœªæäº¤äº‹åŠ¡çš„ Undo Segment Headerï¼Œå½“æ´»è·ƒäº‹åŠ¡äº§ç”Ÿçš„ undo è¶…è¿‡ Undo Header Page å®¹é‡åä¼šè¢«åˆ†é…æ–°çš„ Undo Normal Pageã€‚\nå†™äº‹åŠ¡åœ¨ä¿®æ”¹æ•°æ®å‰ï¼Œä¼šå…ˆé€šè¿‡ Undo Log è®°å½•ä¿®æ”¹å‰çš„ï¼ˆä¸»é”®ï¼‰æ•°æ®ï¼Œå¹¶ä¸” undo åˆ†ä¸º insert (UNDO_INSERT) å’Œ update (UNDO_UPD_EXISTã€UNDO_DEL_MARKã€UNDO_UPD_DEL) ä¸¤ç±»ã€‚è®°å½• undo log å‰ä¼šå…ˆå†™å…¥ Undo Log Header ç”¨äºæ ‡è®°å’Œå®šä½ï¼Œç„¶åé€æ¡å†™å…¥ Undo Recordã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 File Segment |- File Segment Header Rollback Segment |- Rollback Segment Header Undo Segment |- Undo Segment Header Undo Page |- Undo Page Header Undo Header Page Undo Normal Page Undo Log |- Undo Log Header Undo Record |- head, body, tail å¯ä»¥é€šè¿‡å‚è€ƒèµ„æ–™ä¸­çš„è¿™ä¸ªå›¾æ¥æŸ¥çœ‹ä¸Šè¿°ç‰©ç†ç»“æ„çš„é€»è¾‘å…³ç³»ï¼Œæ›´å…·ä½“çš„ç»†èŠ‚ç»“æ„å®šä¹‰å¯ä»¥æŸ¥çœ‹trx0undo.hæ–‡ä»¶ã€‚ ç”ŸæˆUndoçš„ä»£ç é€»è¾‘ åˆ†é…å›æ»šæ®µ å¯¹äºåªè¯»äº‹åŠ¡ï¼Œå½“äº‹åŠ¡æ¶‰åŠåˆ°å¯¹ä¸´æ—¶è¡¨çš„è¯»å†™æ—¶ï¼Œä¼šä¸ºå…¶åˆ†é…ä¸€ä¸ªå›æ»šæ®µå¯¹å…¶äº§ç”Ÿçš„ undo log record è¿›è¡Œè®°å½•ï¼š\n1 trx_assign_rseg_temp() -\u0026gt; get_next_temp_rseg() å¯¹äºè¯»å†™äº‹åŠ¡ï¼Œå½“äº‹åŠ¡è¿›å…¥è¯»å†™æ¨¡å¼æ—¶ï¼Œä¼šä¸ºå…¶åˆ†é… trx_id ä»¥åŠå›æ»šæ®µï¼š\n1 trx_assign_rseg_durable() -\u0026gt; get_next_redo_rseg() -\u0026gt; get_next_redo_rseg_from_trx_sys() / get_next_redo_rseg_from_undo_spaces() åˆ†é…è¡Œä¸ºåªæ˜¯ä¸€ä¸ªåŸºäºè½®è¯¢çš„å†…å­˜æ“ä½œï¼Œé¡ºåºä¸º[(space0, rseg0), (space1, rseg0), \u0026hellip; (spaceN, rseg0), (space1, rseg0)\u0026hellip;]ï¼Œæœ€ç»ˆä¼šä¸º trx è¿”å›ä¸€ä¸ªæœ‰æ•ˆçš„ trx_rseg_tï¼ˆå›æ»šæ®µçš„å†…å­˜ç»“æ„ï¼‰ã€‚ä¸€ä¸ªäº‹åŠ¡æœ€å¤šä¼šæœ‰2ä¸ª rollback segmentï¼ˆtemp/durableåŒºåˆ†ï¼‰å’Œ 4ä¸ª undo segmentï¼ˆinsert/updateå†æ¬¡åŒºåˆ†ï¼‰ã€‚\nåˆ†é…Undo 1 2 3 4 5 6 7 8 trx_undo_report_row_operation \u0026lt;- | btr_cur_ins_lock_and_undo (btr_cur_optimistic_insert / btr_cur_pessimistic_insert) | btr_cur_upd_lock_and_undo (btr_cur_update_in_place / btr_cur_optimistic_update / btr_cur_pessimistic_update) | btr_cur_del_mark_set_clust_rec |\u0026lt;- è¡Œçº§åˆ«æ“ä½œæ¥å£ // é€šè¿‡ BTR_NO_UNDO_LOG_FLAG æ ‡è®°å†³å®šæ˜¯å¦è®°å½• undo å‡½æ•°trx_undo_report_row_operationæ˜¯å†™å…¥undoçš„ä»£ç æ¥å£ï¼Œé¦–å…ˆä¼šå¦‚æœå½“å‰äº‹åŠ¡æ²¡æœ‰åˆ†é…è¿‡æ‰€éœ€ç±»å‹çš„ undo segmentï¼Œåˆ™ä¼šé€šè¿‡trx_undo_assign_undoåˆ†é… undo segment/pageï¼ˆtrx_undo_tç»“æ„ï¼‰ï¼Œé¦–å…ˆå°è¯•ä»å½“å‰ trx_rseg_t çš„ insert/update cacheä¸­å–ï¼ˆæ¥å£ä¸ºtrx_undo_reuse_cachedï¼Œcache å†…æ˜¯å¦‚æœå¯¹åº”undoäº‹åŠ¡ç»“æŸæ—¶å€™æ‰€ä½¿ç”¨çš„ undo page æ‰€ç”¨ç©ºé—´å°äº3/4åˆ™è¢«åŠ å…¥çš„ï¼‰ï¼Œcache ä¸­æ²¡æœ‰åˆ™åœ¨ç©ºé—´æ€»é‡æ–°åˆ†é…ä¸€ä¸ªundo segmentï¼ˆæ¥å£ä¸ºtrx_undo_createï¼‰ã€‚åˆ†é…å¥½ undo page ä»ç©ºé—²ä½ç½®å¼€å§‹å¯¹åº”å†™å…¥ Undo Recordï¼Œå¦‚æœ undo page çš„å‰©ä½™ç©ºé—´ä¸æ»¡è¶³è¦æ±‚åˆ™é€šè¿‡trx_undo_add_pageåŠ ä¸€ä¸ªç©ºç™½çš„ normal page è®°å½• Undo Recordã€‚\næ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œé™¤äº†ç‰©ç† undo page æ›´æ–°åŠé€šè¿‡ redo æŒä¹…åŒ–ï¼Œè¿˜ç»´æŠ¤äº†å†…å­˜ä¸­çš„å½“å‰äº‹åŠ¡æ‰€ä½¿ç”¨çš„ trx_undo_t ç»“æ„ä½“ï¼ˆtrx-\u0026gt;rsegs.m_redo/ m_noredo.insert_undo/ update_undoï¼‰ï¼ŒåŒ…æ‹¬ header pageã€log headerã€top undo page/offsetç­‰ä¿¡æ¯ã€‚\nå†™å…¥Undo Reocrd 1 2 3 4 5 6 7 8 9 10 11 12 // Insertç±»å‹ï¼šTRX_UNDO_INSERT_REC /*-------- header ------*/ Next_record_offset 2B Type_flags 1B Undo_no compressed Table_id compressed /*-------- key field ------*/ Key_field_1_len compressed Key_field_1_data compressed ...(ä»¥ä¸Š dict_index_get_n_unique ä¸ª field) /*-------- tail ------*/ Next_record_offset 2B 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 // Updateç±»å‹ï¼šTRX_UNDO_UPD_EXIST_RECã€TRX_UNDO_DEL_MARK_RECã€TRX_UNDO_UPD_DEL_REC /*-------- header ------*/ Next_record_offset 2B Type_flags 1B Undo_no compressed Table_id compressed Rec_info 1B Trx_id compressed Roll_ptr compressed //æŒ‡å‘çš„æ˜¯è¯¥è®°å½•çš„ä¸Šä¸€ä¸ªç‰ˆæœ¬çš„ä½ç½® /*-------- key field ------*/ Key_field_1_len compressed Key_field_1_data len ...(ä»¥ä¸Š dict_index_get_n_unique ä¸ª field) Update_field_num compressed // ä¿®æ”¹çš„fieldæ•°ç›® Update_field_1_pos compressed Update_field_1_len compressed Update_field_1_ctx len //è¿™æ¬¡ä¿®æ”¹å‰çš„fieldä¿¡æ¯ï¼Œåº”ç”¨è¿™ä¸ªå¯ä»¥è¿”å›åˆ°ä¿®æ”¹ä¹‹å‰åˆ°å€¼ ...(ä»¥ä¸Š upd_t ä¸­ä¸ª field æ•°ç›®) /*-------- tail ------*/ Next_record_offset 2B Undo Recordçš„å†…å®¹æ ¼å¼å¦‚ä¸Šæ‰€ç¤ºï¼Œè¿™é‡Œå†é¢å¤–è¯´æ˜ä¸‹ï¼š\nå¯¹äº insert undoï¼Œè®°å½•çš„æ˜¯æ’å…¥çš„ entry çš„ key éƒ¨åˆ†ï¼Œç”¨äºå›æ»šæ—¶å®šä½å¯»æ‰¾å¹¶åˆ é™¤ï¼Œinsert æ“ä½œä¸å­˜åœ¨å¯è§æ€§åˆ¤è¯»å› æ­¤æ²¡æœ‰è®°å½•Trx_idï¼› å¯¹äº update undoï¼Œä¼ å…¥çš„å‚æ•°æ—¶ index_recordï¼ˆrec_tï¼‰å’Œ updateï¼ˆupd_tï¼‰è¿™ä¸ªå†…å­˜ç»“æ„ï¼Œå®é™…è®°å½•çš„æ˜¯ record key å’Œè¦è¢«ä¿®æ”¹çš„ fieldï¼Œå‰è€…ç”¨äºå®šä½ï¼Œåè€…ç”¨äºè¿˜åŸåˆ°åŸå§‹ç‰ˆæœ¬ã€‚ å¯¹ä¸»é”®æ•°æ®ç”Ÿæˆ undo åå°±äº§ç”Ÿäº† roll_ptr å¹¶å¯¹æ–° record è¿›è¡Œæ›´æ–°ï¼Œå°±æ˜¯é€šè¿‡ roll_ptr å°† record çš„æ‰€æœ‰ç‰ˆæœ¬é“¾æ¥èµ·æ¥ã€‚ äº‹åŠ¡æäº¤æ—¶çš„Undoå¤„ç† åœ¨ trx_commit çš„æ—¶å€™ï¼Œå¦‚æœäº‹åŠ¡å‘ç”Ÿä¿®æ”¹å¹¶äº§ç”Ÿäº† undoï¼š\nè®¾ç½® undo åç»­å¤„ç†çŠ¶æ€ï¼š undo ä½¿ç”¨å•ä¸ª page ä¸”ä½¿ç”¨é‡å°äº 3/4 çš„ä¼šè¢«è®¾ç½®ä¸º TRX_UNDO_CACHED çŠ¶æ€ï¼›å…¶ä½™çš„ insert undo çŠ¶æ€è¢«è®¾ç½®ä¸º TRX_UNDO_TO_FREEï¼Œupdate undo çŠ¶æ€è¢«è®¾ç½®ä¸º TRX_UNDO_TO_PURGEï¼› ç»™äº‹åŠ¡åˆ†é…æäº¤é¡ºåº trx_noï¼› å¯¹ update undo å›æ»šæ®µçš„å†…å­˜ç»“æ„ï¼ŒåŠ å…¥ purge_sys-\u0026gt;purge_queue è¿™ä¸€é˜Ÿåˆ—ï¼ˆå…¶å†…æŒ‰äº‹åŠ¡æäº¤æ—¶çš„ trx-\u0026gt;no æ’åˆ—ï¼‰ä»¥ç»™ purge ç³»ç»Ÿå®šä½å›æ”¶ï¼› å°† trx-\u0026gt;no å†™å…¥ rseg/undo headerï¼Œå¹¶ undo header å°†åŠ å…¥åˆ° rseg header ä¸­ history list çš„å¼€å§‹ï¼› å¯¹ update undoï¼Œå†…å­˜ç»“æ„ trx_undo_t æŒ‰çŠ¶æ€åŠ å…¥ rseg-\u0026gt;update_undo_cached æˆ– trx_undo_mem_freeï¼› å¯¹ insert undoï¼Œå†…å­˜ç»“æ„ trx_undo_t æŒ‰çŠ¶æ€åŠ å…¥ rseg-\u0026gt;insert_undo_list æˆ– trx_undo_mem_freeï¼Œå¹¶ä¸”åœ¨ rollback segment ä¸­æ¸…ç†ä¸åœ¨ history çš„ undo log segmentï¼ˆtrx_undo_seg_freeï¼‰ï¼› åº”ç”¨Undoçš„ä»£ç é€»è¾‘ åº”ç”¨ undo ä¸»è¦æ˜¯åœ¨ mvcc å’Œ rollback è¿‡ç¨‹ä¸­ï¼Œè€Œ rollback åˆå¯ä»¥åˆ†ä¸ºç”¨æˆ· rollback å’Œå¥”æºƒæ¢å¤ rollbackã€‚æœ¬æ–‡ä¸»è¦è®¨è®º rollback è¿‡ç¨‹ï¼Œå¯¹äº mvcc æ“ä½œä¼šå¼€å¦å¤–çš„æ–‡ç« ä¸“é—¨è®¨è®ºã€‚\nå¥”æºƒæ¢å¤æ—¶Rollback å¯¹äºå¥”æºƒæ¢å¤è¿‡ç¨‹ä¸­çš„ Rollbackï¼Œé¦–å…ˆéœ€è¦æ¢å¤ undo ç›¸å…³ä¿¡æ¯ï¼š\né€šè¿‡ redoï¼Œåœ¨å¯åŠ¨çš„recv_recovery_from_checkpoint_start-\u0026gt;recv_recovery_beginé˜¶æ®µæ¢å¤undoæ•°æ®ï¼› é€šè¿‡æ¢å¤çš„ undo æ•°æ®ï¼Œåœ¨å¯åŠ¨çš„trx_sys_init_at_db_starté˜¶æ®µæ¢å¤æ‰€æœ‰å›æ»šæ®µçš„å†…å­˜ç»“æ„ï¼Œtrx_sys çš„æ´»è·ƒäº‹ç‰©ã€‚æ´»è·ƒäº‹ç‰©é€šè¿‡trx_resurrectåˆ†åˆ«æ‰«ærseg-\u0026gt;insert_undo_list/update_undo_listï¼Œç”Ÿæˆåå°trxå¯¹è±¡å¹¶åˆå§‹åŒ–ç›¸å…³å‚æ•°å¹¶åŠ å…¥trx_sys-\u0026gt;rw_trx_setï¼Œå†æŒ‰çŠ¶æ€åŠ å…¥ trx_sys-\u0026gt;rw_trx_idsï¼ˆæ´»è·ƒï¼‰å’Œ trx_sys-\u0026gt;rw_trx_listï¼ˆæ‰€æœ‰ï¼‰ã€‚ åœ¨ dict_recover DICT_RECOVERY_RESTART_SERVER é˜¶æ®µï¼Œsrv_dict_recover_on_restart ä¸­ä¼šåŠ ä¸Šè¡¨é”å¹¶ rollback DD ç›¸å…³äº‹åŠ¡ï¼› åœ¨ post_recover é˜¶æ®µæœ«å°¾ï¼Œsrv_start_threads_after_ddl_recovery å¼€å¯åå°å›æ»šçº¿ç¨‹ï¼Œæ‰«æ trx_sys-\u0026gt;rw_trx_listï¼Œå¯¹æ¢å¤çš„äº‹åŠ¡ï¼Œå›æ»šTRX_STATE_ACTIVEäº‹åŠ¡ï¼ˆtrx_rollback_activeï¼‰ã€æ¸…ç†COMMITTED_IN_MEMORYäº‹åŠ¡ï¼ˆtrx_free_resurrectedï¼‰ã€‚ åå°å›æ»šçº¿ç¨‹trx_recovery_rollback_threadæœ€ç»ˆé€šè¿‡trx_rollback_activeåå‘åº”ç”¨ trx undo log åæäº¤ï¼ˆrollbackæœ¬èº«ä¹Ÿæ˜¯é€šè¿‡trx_commitè¡¨ç¤ºäº‹åŠ¡å®Œæˆï¼‰æ¥å›æ»šæ´»è·ƒäº‹åŠ¡ã€‚ è¿™é‡Œå¯ä»¥çœ‹åˆ°åœ¨ recovery çš„å‰å‘ redo æ˜¯ä¸ä¼šä½¿ç”¨åˆ° undo çš„ï¼Œå·²ç»æŒä¹…åŒ–çš„ redo å¯¹åº”éœ€è¦çš„ undo è‚¯å®šå·²ç»è¢«æŒä¹…åŒ–ï¼Œå‰å‘ redo æœ¬èº«ä¹Ÿä¸åœ¨äº§ç”Ÿé¢å¤– undoã€‚æ­¤å¤–ä¹Ÿå†æ¬¡å¯è§ï¼Œundo å†…å®¹æ˜¯ä»¥æ•°æ®æ¨¡å¼è®°å½•çš„ã€‚\nåº”ç”¨Undo å®é™…åº”ç”¨ undo æ˜¯åœ¨ row_undo_step ä¸­:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 row_undo_step -\u0026gt; ... | row_undo_ins | row_undo_ins_parse_undo_rec(undo_node_t) å°† insert undo ä¸­çš„å†…å®¹ parseå‡ºæ¥ä¾›åç»­undoä½¿ç”¨ | trx_undo_rec_get_pars() è§£æå¸¸è§„å‚æ•°ï¼šæ˜¯å¦æœ‰LOB field updateï¼Œtype compilation infoï¼Œundo no | trx_undo_rec_get_row_ref() æ„å»º row referenceï¼ˆdtuple_tï¼Œå³index recordçš„å†…å­˜å¯¹è±¡ï¼‰ | row_undo_search_clust_to_pcur() åœ¨ä¸»é”®ä¸Šç´¢å¼•row referenceï¼Œåˆ¤æ–­æ˜¯å¦æ‰¾åˆ°çš„ä¸»é”®æ˜¯éœ€è¦undoçš„ä¸»é”®ï¼ˆå®šä½ undo_node_t-\u0026gt;pcurï¼‰ï¼Œç³»ç»Ÿåˆ—ç­‰ä¹Ÿéœ€è¦ä¸€è‡´ | row_undo_ins_remove_sec_rec(undo_node_t, que_thr_t) å…ˆ åˆ é™¤ æ‰€æœ‰äºŒçº§ç´¢å¼•ï¼ˆå’Œæ­£å‘è·¯å¾„ç›¸åæ–¹å‘ï¼‰ | row_undo_ins_remove_clust_rec(undo_node_t) å† åˆ é™¤ ä¸»é”®çº§ç´¢å¼• | row_undo_mod | row_undo_mod_parse_undo_rec() | trx_undo_rec_get_pars() ç±»ä¸Š | trx_undo_update_rec_get_sys_cols() è·å–è€ç‰ˆæœ¬recordçš„ç³»ç»Ÿåˆ— | trx_undo_rec_get_row_ref() ç±»ä¸Š | trx_undo_update_rec_get_update() æ„å»ºè€ç‰ˆæœ¬recordçš„update vectorç”¨äºåç»­updateä½¿ç”¨ | row_undo_search_clust_to_pcur() ç±»ä¸Š | row_undo_mod_upd_exist_sec() / row_undo_mod_del_mark_sec() / row_undo_mod_upd_del_sec() å…ˆ æ›´æ–° äºŒçº§ç´¢å¼• | row_undo_mod_clust() å† æ›´æ–° ä¸»é”®ç´¢å¼• é¦–å…ˆè§£æéœ€è¦è¢«åº”ç”¨çš„ undoï¼Œè¿™é‡Œæ¶‰åŠå¼€ innodb è¡¨ï¼Œä¸”åœ¨åå°å›æ»šæƒ…å†µä¸‹è¿™é‡Œå†éœ€è¦åŠ ä¸Š DD çš„ MDL é”ï¼› åœ¨row_undo_search_clust_to_pcuré€šè¿‡ undo é‡Œé¢çš„ key ä¿¡æ¯åœ¨ä¸»é”®ä¸Šç´¢å¼• row referenceï¼Œå¹¶æ ¹æ® roll_ptr åˆ¤æ–­æ‰¾åˆ°çš„ä¸»é”®æ˜¯å¦æ˜¯éœ€è¦undoçš„ä¸»é”®ã€‚å¦‚æœæ‰¾åˆ°åˆ™æ„å»ºå¹¶å­˜å‚¨æ‰¾åˆ°çš„ index record çš„å†…å­˜ç»“æ„ dtuple_tï¼Œå¦‚æœæ˜¯ updateï¼Œè¿˜éœ€æ„å»ºå‡ºæ¥ update ä¹‹å‰çš„ç‰ˆæœ¬ï¼ˆå³åº”ç”¨äº†undoåè¿˜åŸçš„åŸå…ˆç‰ˆæœ¬ï¼‰ï¼› å¯¹äº insert çš„ undo è¾ƒä¸ºç®€å•ï¼Œä»äºŒçº§ç´¢å¼•åˆ°ä¸»é”®åˆ é™¤ç›®æ ‡ recordï¼› å¯¹äº update çš„ undoï¼Œåœ¨äºŒçº§ç´¢å¼•ä¸Šï¼Œ UPD_EXISTï¼ˆåŸæ“ä½œä¸º update recordï¼‰çš„ undo ä¼šæ ¹æ®å¯è§æ€§ æ ‡è®°åˆ é™¤ æˆ– ç‰©ç†åˆ é™¤ ç°æœ‰äºŒçº§ç´¢å¼•è®°å½•ï¼Œå†æ›´æ–°æˆ–æ’å…¥undone recordï¼› DEL_MARKï¼ˆåŸæ“ä½œä¸º delete mark recordï¼‰çš„ undo ä¼š å»é™¤åˆ é™¤æ ‡è®° ç°æœ‰äºŒçº§ç´¢å¼•è®°å½•ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ é‡æ–°æ’å…¥ï¼› UPD_DELï¼ˆåŸæ“ä½œä¸º undelete mark recordï¼‰çš„ undo ä¼šæ ¹æ®å¯è§æ€§ æ ‡è®°åˆ é™¤ æˆ– ç‰©ç†åˆ é™¤ ç°æœ‰äºŒçº§ç´¢å¼•è®°å½•ã€‚ å¯¹äº update çš„ undoï¼Œåœ¨ä¸»é”®ä¸Šåˆ™èµ° btr_cur çš„ update é€»è¾‘è¿›è¡Œæ›´æ–°ï¼Œå¯¹äº UPD_DEL è¿˜ä¼šä¸»åŠ¨å°è¯•æ¸…ç†æ ‡è®°åˆ é™¤çš„ recordã€‚ å€¼å¾—ä¸€ä½“çš„æ˜¯åœ¨å´©æºƒæ¢å¤çš„ undo äº‹åŠ¡ï¼Œäº‹åŠ¡é”åœ¨åˆå§‹çŠ¶æ€ä¸‹éƒ½æ˜¯éšå¼é”ï¼Œæ˜¯é€šè¿‡å…¶ä»–å†²çªäº‹åŠ¡åœ¨åŠ é”æ—¶é€šè¿‡lock_rec_convert_impl_to_expl æˆ– undo åº”ç”¨é˜¶æ®µé€šè¿‡ row_convert_impl_to_expl_if_neededåŠ ä¸Šäº‹åŠ¡é”ã€‚æ­¤è¿‡ç¨‹ä¸­åŠ çš„éƒ½æ˜¯ record lockï¼Œè¿™æ˜¯ç”±äºåå° undo ä¸è¢«ç”¨æˆ·æ‰€è§ï¼Œå…¶æœ¬èº«ä¸å…·å¤‡å¯è§æ€§è¦æ±‚å› æ­¤ä¸ä¼šåŠ ä¸Š next key lockã€‚\nå›æ”¶Undoçš„ä»£ç é€»è¾‘ åœ¨ innobase_post_recover ä¸­ ddlæ¢å¤å®Œæˆåï¼Œä¿è¯ InnoDB metadata å’Œ file system ä¸€è‡´åçš„é˜¶æ®µï¼Œç³»ç»Ÿä¼šå¯åŠ¨ srv_purge_coordinator_thread å’Œ srv_worker_thread æ¥purge undoï¼Œç›¸å…³å†…å®¹ä¼šåœ¨ purge ç³»ç»Ÿä¸­ä»‹ç»ã€‚\nç‰ˆæƒå£°æ˜ï¼šå¦‚éœ€è½¬è½½æˆ–å¼•ç”¨ï¼Œè¯·é™„åŠ æœ¬æ–‡é“¾æ¥å¹¶æ³¨æ˜æ¥æºã€‚ ","permalink":"https://mzyee.github.io/posts/mysql/undo/","summary":"InnoDB Undo Log ç›¸å…³ä»£ç å­¦ä¹ ","title":"InnoDB Undo Log ä»£ç å­¦ä¹ "},{"content":"eBPFæŠ€æœ¯èƒŒæ™¯ BPFï¼ˆBerkeley Packet Filterï¼‰æ˜¯ç±»Unixç³»ç»Ÿä¸Šæ•°æ®é“¾è·¯å±‚çš„ä¸€ç§åŸå§‹æ¥å£ï¼Œæä¾›åŸå§‹é“¾è·¯å±‚å°åŒ…çš„æ”¶å‘ã€‚BPFåœ¨æ•°æ®åŒ…è¿‡æ»¤ä¸Šå¼•å…¥äº†ä¸¤å¤§ç‰¹æ€§ï¼š\nä¸€ä¸ªå¯æœ‰æ•ˆåœ°å·¥ä½œåœ¨åŸºäºå¯„å­˜å™¨ç»“æ„ CPU ä¸Šçš„è™šæ‹Ÿæœºï¼› åº”ç”¨ç¨‹åºåªå¤åˆ¶ä¸è¿‡æ»¤æ•°æ®åŒ…ç›¸å…³çš„æ•°æ®ï¼Œä¸å¤åˆ¶æ•°æ®åŒ…çš„æ‰€æœ‰ä¿¡æ¯ã€‚ eBPF åœ¨åŸå§‹BPFåŸºç¡€ä¸Šè¿›ä¸€æ­¥é’ˆå¯¹ç°ä»£ CPU ç¡¬ä»¶è¿›è¡Œäº†æŒ‡ä»¤é›†ä¼˜åŒ–ï¼Œå¢åŠ äº† VM ä¸­çš„å¯„å­˜å™¨æ•°é‡ï¼Œä½¿æ•°æ®å¤„ç†é€Ÿåº¦æé«˜äº†æ•°å€ã€‚æ€»ç»“æ¥è¯´ï¼ŒeBPF æä¾›äº†ä¸€ä¸ªåŸºäºå¯„å­˜å™¨çš„è™šæ‹Ÿæœºï¼Œä½¿ç”¨è‡ªå®šä¹‰çš„ 64 ä½ RISC æŒ‡ä»¤é›†ï¼Œèƒ½å¤Ÿåœ¨ Linux å†…æ ¸å†…è¿è¡Œæœ¬åœ°å³æ—¶ç¼–è¯‘çš„ BPF ç¨‹åºï¼Œå¹¶èƒ½è®¿é—®å†…æ ¸åŠŸèƒ½å’Œå†…å­˜çš„ç‰¹å®šå­é›†ã€‚\neBPFç¨‹åºåˆ†ä¸ºç”¨æˆ·ç©ºé—´ç¨‹åºå’Œå†…æ ¸ç¨‹åºä¸¤éƒ¨åˆ†ï¼š ç”¨æˆ·ç©ºé—´ç¨‹åºè´Ÿè´£åŠ è½½ BPF å­—èŠ‚ç è‡³å†…æ ¸ï¼Œä¸€èˆ¬ä½¿ç”¨è€…å¯ä»¥é€šè¿‡ LLVM æˆ–è€… GCC å°†ç¼–å†™çš„ BPF ä»£ç ç¨‹åºç¼–è¯‘æˆå†…æ ¸å¯éªŒè¯çš„ BPF å­—èŠ‚ç ã€‚å†…æ ¸åŠ è½½å‰ä¼šä½¿ç”¨éªŒè¯å™¨ verfier ç»„ä»¶ä¿è¯å­—èŠ‚ç çš„å®‰å…¨æ€§ï¼Œä»¥é¿å…å¯¹å†…æ ¸é€ æˆç¾éš¾é—®é¢˜ã€‚å¦‚æœ‰éœ€è¦ï¼Œç”¨æˆ·ç©ºé—´ç¨‹åºä¹Ÿä¼šè´Ÿè´£è¯»å–å¹¶å¤„ç†å†…æ ¸å›ä¼ çš„ç»Ÿè®¡ä¿¡æ¯æˆ–è€…äº‹ä»¶è¯¦æƒ…ã€‚ åœ¨å†…æ ¸ä¸­åŠ è½½çš„ BPF å­—èŠ‚ç ç¨‹åºä¼šåœ¨å†…æ ¸ä¸­æ‰§è¡Œç‰¹å®šäº‹ä»¶ï¼ŒBPF ç¨‹åºå¯èƒ½åŸºäº kprobes / uprobes / tracepoint / perf_events ç­‰ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªäº‹ä»¶ã€‚å¦‚æœ‰éœ€è¦ï¼Œå†…æ ¸ç¨‹åºä¹Ÿä¼šå°†æ‰§è¡Œçš„ç»“æœé€šè¿‡ç¼“å­˜ map æˆ–è€… perf-event äº‹ä»¶å‘é€è‡³ç”¨æˆ·ç©ºé—´ã€‚ é€šè¿‡ä¸Šè¿°æœºåˆ¶ï¼ŒeBPF çš„ä½¿ç”¨è€…ï¼ˆä¸å±€é™äºå†…æ ¸å¼€å‘è€…ï¼‰èƒ½å¤ŸåŸºäºç³»ç»Ÿå†…æ ¸æˆ–ç¨‹åºäº‹ä»¶é«˜æ•ˆã€å®‰å…¨çš„ï¼ˆåœ¨å†…æ ¸ä¸­ï¼‰æ‰§è¡Œç‰¹å®šä»£ç ï¼Œé€šè¿‡å‘å†…æ ¸æ·»åŠ  eBPF æ¨¡å—æ¥å¢åŠ åŠŸèƒ½ã€‚\nåŸºäºeBPFè¿›è¡Œè½¯ä»¶å¼€å‘ eBPF æŒ‡ä»¤æ˜¯å›ºå®šå¤§å°çš„ 64 ä½ç¼–ç ï¼Œå¤§çº¦æœ‰ä¸Šç™¾æ¡æŒ‡ä»¤ï¼Œè¢«åˆ†ç»„ä¸º 8 ç±»ï¼Œå¸¸ç”¨æŒ‡ä»¤æ”¯æŒå¦‚ä»é€šç”¨å†…å­˜è¿›è¡ŒåŠ è½½/å­˜å‚¨ï¼Œå‰/åï¼ˆéï¼‰æ¡ä»¶è·³è½¬ã€ç®—æœ¯/é€»è¾‘æ“ä½œå’Œå‡½æ•°è°ƒç”¨ç­‰ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 /* msb lsb +---------------------+---------------+----+----+-------+ |immediate |offset |src |dst |opcode | +---------------------+---------------+----+----+-------+ */ struct bpf_insn { __u8\tcode;\t/* opcode */ __u8\tdst_reg:4;\t/* dest register */ __u8\tsrc_reg:4;\t/* source register */ __s16\toff;\t/* signed offset */ __s32\timm;\t/* signed immediate constant */ }; ç›´æ¥ä½¿ç”¨åŸå§‹å­—èŠ‚ç æ¥å®ç° eBPF ç¨‹åºï¼Œéå¸¸åƒç¼–å†™æ±‡ç¼–ä»£ç ï¼Œè¿™ç§è¡Œä¸ºæ— ç–‘æ˜¯è¾ƒä¸ºå›°éš¾ï¼Œé€šå¸¸ä½¿ç”¨æ›´é«˜çº§åˆ«çš„è¯­è¨€å’Œå·¥å…·æ¥å®ç°åŠŸèƒ½å¤æ‚çš„ eBPF ç”¨ä¾‹ã€‚ä¸€ç§å¾ˆè‡ªç„¶çš„æƒ³æ³•æ˜¯èƒ½ä¸èƒ½å°†é«˜çº§è¯­è¨€çš„ä¸­é—´è¡¨ç¤ºå±‚ç¼–è¯‘æˆ eBPF ç¨‹åºæ¨¡å—ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å°†ä½¿ç”¨å…·æœ‰â€œé™åˆ¶æ€§â€œçš„é«˜çº§æŠ½è±¡å±‚è¯­è¨€æ¥ç¼–å†™ eBPF ç¨‹åºã€‚è¿™ç§è®¾è®¡æœ‰æ•ˆåœ°å°†å†…æ ¸ä¸­è¿è¡Œçš„eBPFå­—èŠ‚ç çš„å®šä¹‰ï¼ˆåç«¯ï¼‰ä»å­—èŠ‚ç åŠ è½½å™¨å’Œå‰ç«¯ç¨‹åºä¸­åˆ†ç¦»å‡ºæ¥ã€‚\nåŸºäºè¿™æ ·çš„ç›®çš„ï¼Œç¤¾åŒºåˆ›å»ºäº† BCC é¡¹ç›®ï¼Œä½¿ç”¨æˆ·å¯ä»¥ä½¿ç”¨å¸¦æœ‰é™åˆ¶æ€§çš„Cè¯­è¨€ï¼ˆBPF Cï¼‰ç¼–å†™ eBPF åç«¯ç¨‹åºï¼Œå¹¶ä¸” BCC ä¸ºç”¨æˆ·å°è£…äº†è®¸å¤šå®ç”¨åº•å±‚å‡½æ•°é¿å…é‡å¤é€ è½®å­çš„è‹¦æ¼ã€‚å€ŸåŠ© BCCï¼Œç”¨æˆ·è¿˜å¯ä»¥é€šè¿‡ç¼–å†™ python æ¥å¿«é€Ÿå®ç°åŠ è½½å™¨å’Œå‰ç«¯ç¨‹åºã€‚æ­¤å¤–ï¼Œå¦ä¸€ä¸ªé¡¹ç›® BPFtrace å»ºç«‹åœ¨ BCC ä¹‹ä¸Šï¼Œé€šè¿‡ç‰¹å®šé¢†åŸŸè¯­è¨€æä¾›æ›´é«˜çº§åˆ«çš„æŠ½è±¡é€»è¾‘ï¼Œä»¥å¸®åŠ©ç”¨æˆ·å®ç°æ›´å¿«é€Ÿåˆ†æ/è°ƒè¯•ã€‚\næˆ‘ä»¬ä»¥ BCC çš„ bashreadline ä¸ºä¾‹ç®€å•ä»‹ç»ä¸‹ä½¿ç”¨ BCC è¿›è¡Œ eBPF ç¨‹åºå¼€å‘çš„æµç¨‹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 #!/usr/bin/env python from __future__ import print_function from bcc import BPF from time import strftime import argparse ############################ # part 1 # ############################ # load BPF program bpf_text = \u0026#34;\u0026#34;\u0026#34; #include \u0026lt;uapi/linux/ptrace.h\u0026gt; #include \u0026lt;linux/sched.h\u0026gt; struct str_t { u32 pid; char str[80]; }; BPF_PERF_OUTPUT(events); int printret(struct pt_regs *ctx) { struct str_t data = {}; char comm[TASK_COMM_LEN] = {}; if (!PT_REGS_RC(ctx)) return 0; data.pid = bpf_get_current_pid_tgid() \u0026gt;\u0026gt; 32; bpf_probe_read_user(\u0026amp;data.str, sizeof(data.str), (void *)PT_REGS_RC(ctx)); bpf_get_current_comm(\u0026amp;comm, sizeof(comm)); if (comm[0] == \u0026#39;b\u0026#39; \u0026amp;\u0026amp; comm[1] == \u0026#39;a\u0026#39; \u0026amp;\u0026amp; comm[2] == \u0026#39;s\u0026#39; \u0026amp;\u0026amp; comm[3] == \u0026#39;h\u0026#39; \u0026amp;\u0026amp; comm[4] == 0 ) { events.perf_submit(ctx,\u0026amp;data,sizeof(data)); } return 0; }; \u0026#34;\u0026#34;\u0026#34; ############################ # part 2 # ############################ parser = argparse.ArgumentParser( description=\u0026#34;Print entered bash commands from all running shells\u0026#34;, formatter_class=argparse.RawDescriptionHelpFormatter) parser.add_argument(\u0026#34;-s\u0026#34;, \u0026#34;--shared\u0026#34;, nargs=\u0026#34;?\u0026#34;, const=\u0026#34;/lib/libreadline.so\u0026#34;, type=str, help=\u0026#34;specify the location of libreadline.so library.\\ Default is /lib/libreadline.so\u0026#34;) args = parser.parse_args() name = args.shared if args.shared else \u0026#34;/bin/bash\u0026#34; b = BPF(text=bpf_text) b.attach_uretprobe(name=name, sym=\u0026#34;readline\u0026#34;, fn_name=\u0026#34;printret\u0026#34;) ############################ # part 3 # ############################ # header print(\u0026#34;%-9s %-7s %s\u0026#34; % (\u0026#34;TIME\u0026#34;, \u0026#34;PID\u0026#34;, \u0026#34;COMMAND\u0026#34;)) def print_event(cpu, data, size): event = b[\u0026#34;events\u0026#34;].event(data) print(\u0026#34;%-9s %-7d %s\u0026#34; % (strftime(\u0026#34;%H:%M:%S\u0026#34;), event.pid, event.str.decode(\u0026#39;utf-8\u0026#39;, \u0026#39;replace\u0026#39;))) b[\u0026#34;events\u0026#34;].open_perf_buffer(print_event) while 1: try: b.perf_buffer_poll() except KeyboardInterrupt: exit() å¯ä»¥å°†ä¸Šé¢è¿™ä¸ª eBPF ç¨‹åºåˆ†ä¸º3ä¸ªéƒ¨åˆ†ï¼š\nPart 1 æ˜¯ç”¨ BPF C å®ç°çš„ eBPF åç«¯ç¨‹åºï¼Œé¦–å…ˆè¿™é‡Œæ„å»ºäº†å†…ç½® BPF_PERF_OUTPUT ç»“æ„æ¥åˆ›å»ºä¸€ä¸ª BPF tableï¼Œé€šè¿‡ perf ç¯å½¢ç¼“å†²åŒºå°†è‡ªå®šä¹‰äº‹ä»¶æ•°æ®æ¨é€åˆ°ç”¨æˆ·ç©ºé—´ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡ events æ¥è·å–æ¨é€çš„æ•°æ®ã€‚ç„¶ååœ¨ printret å‡½æ•°ä¸­é€šè¿‡ PT_REGS_RC æ¥åˆ¤æ–­ã€è·å–å½“å‰ç¯å¢ƒå‡½æ•°çš„è¿”å›å€¼ï¼Œå¹¶é€šè¿‡å†…ç½®å‡½æ•°è·å–ç¨‹åºpidå’Œè¿”å›å€¼ã€‚é€šè¿‡å†…ç½®å‡½æ•° bpf_get_current_comm åˆ¤æ–­å½“å‰ç¨‹åºåç§°ï¼Œå¦‚æœæ˜¯ bash å‘½ä»¤å°±å‘ events è¾“å‡ºç¨‹åºè¿è¡Œè¿”å›å€¼ã€‚ Part 2 æ˜¯é€šè¿‡ BCC çš„æ”¯æŒåˆ©ç”¨ python è¿›è¡Œå‰è¿° eBPF åç«¯ç¨‹åºçš„åŠ è½½å™¨ã€‚åŠ è½½ç±»å‹æ˜¯ uretprobeï¼Œå³å°†ç¨‹åºæŒ‚è½½åˆ° user-level çš„ readline() å‡½æ•°ä¸Šï¼Œå³åœ¨ç”¨æˆ·è°ƒç”¨ readline() å‡½æ•°è¿”å›æ—¶æ‰§è¡Œç›¸åº” eBPF åç«¯ä»£ç ã€‚ Part 3 æ˜¯æ˜¾ç¤ºè¾“å‡ºçš„å‰ç«¯ç¨‹åºï¼Œç”¨æˆ·å¯¹ events ç¼“å†²åŒºè¿›è¡Œpollingï¼Œå½“ç¼“å†²åŒºæœ‰å†…å®¹æ—¶å°†å¯¹åº”å†…å®¹è¾“å‡ºæ˜¾ç¤ºã€‚ è‡³æ­¤ï¼Œé€šè¿‡è¿è¡Œè¿™ä¸€ä¸ª BCC ç¨‹åºï¼Œç”¨æˆ·å°±å¯ä»¥é€šè¿‡ eBPFå®ç°ç›‘æ§æ‰€æœ‰ bash è¿›ç¨‹çš„ readline å‡½æ•°ï¼Œè¾“å‡ºå¯¹åº” pid å’Œ readline å¯¹è¿”å›ç»“æœï¼ˆå³ bash è¾“å…¥çš„å‘½ä»¤å†…å®¹ï¼‰ã€‚æ›´å¤šçš„å†…ç½®åŠŸèƒ½åŠæ¥å£è‡ªè¡Œå‚è§ç›¸å…³é¡¹ç›®å®˜ç½‘ã€‚\näº‹ä»¶ç±»å‹ å‰é¢æåˆ° BPF ç¨‹åºç±»å‹å¯èƒ½åŸºäº kprobes / uprobes / tracepoint /perf_events ç­‰äº‹ä»¶ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªï¼Œå…¶ä¸­ï¼š\nkprobesï¼šå†…æ ¸ä¸­åŠ¨æ€è·Ÿè¸ªã€‚å¯ä»¥è·Ÿè¸ªåˆ° Linux å†…æ ¸ä¸­çš„å‡½æ•°å…¥å£æˆ–è¿”å›ç‚¹ï¼Œä½†ä¸æ˜¯ç¨³å®šæ¥å£ï¼Œå¯èƒ½ä¼šå› ä¸ºå†…æ ¸ç‰ˆæœ¬å˜åŒ–å¯¼è‡´è·Ÿè¸ªå¤±æ•ˆã€‚ ç†è®ºä¸Šå¯ä»¥è·Ÿè¸ªåˆ°æ‰€æœ‰å¯¼å‡ºç¬¦å· /proc/kallsyms ä½†ä¸åœ¨ /sys/kernel/debug/kprobes/blacklist ä¸­çš„å‡½æ•°ã€‚ uprobesï¼šç”¨æˆ·çº§åˆ«çš„åŠ¨æ€è·Ÿè¸ªã€‚ä¸ kprobes ç±»ä¼¼ï¼Œåªæ˜¯è·Ÿè¸ªçš„å‡½æ•°ä¸ºç”¨æˆ·ç¨‹åºä¸­çš„å‡½æ•°ã€‚ tracepointsï¼šå†…æ ¸ä¸­é™æ€è·Ÿè¸ªã€‚tracepoints æ˜¯å†…æ ¸å¼€å‘äººå‘˜ç»´æŠ¤çš„è·Ÿè¸ªç‚¹ï¼Œèƒ½å¤Ÿæä¾›ç¨³å®šçš„æ¥å£ï¼Œä½†æ˜¯éœ€ç»´æŠ¤æ•°é‡ä¸”åœºæ™¯å—é™ã€‚ USDTï¼šç”¨æˆ·é™æ€æ¢é’ˆï¼Œç±»ä¼¼ tracepoints ä½†æ˜¯éœ€è¦ç”¨æˆ·ç©ºé—´è‡ªå·±ç»´æŠ¤ã€‚ perf_eventsï¼šå®šæ—¶é‡‡æ ·å’Œ PMC äº‹ä»¶ã€‚ eBPF æ¨¡å—å„ç§ç±»å‹äº‹ä»¶çš„åŠ è½½æ‰§è¡Œåœ¨åé¢æœ‰æ—¶é—´çš„è¯å†å±•å¼€è®²è®²ï¼Œæœ‰å…´è¶£çš„å¯ä»¥æœç´¢ Linux å†…æ ¸çš„ text hook/pokeã€static-key å’Œ static-jump ç­‰æœºåˆ¶å®ç°ã€‚\nå¸¸ç”¨eBPFå·¥å…·ä¸æŒ‡ä»¤ BCC å’Œ BPFtrace æä¾›äº†å¾ˆå¤šç°æˆå®ç”¨çš„å·¥å…·ï¼Œä¸‹é¢åˆ†äº«ä¸€äº›æˆ‘è§‰å¾—æœ‰ç”¨çš„å·¥å…·ï¼Œå…·ä½“å‚æ•°å‚è€ƒå„ä¸ªå‘½ä»¤çš„helpæŸ¥çœ‹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 # æ£€æŸ¥ pidç¨‹åºæ‰“å¼€çš„æ–‡ä»¶ opensnoop -p 123 # æ£€æµ‹ disk çš„ I/O çŠ¶æ€ biolatency [-D for each disk] [-Q include OS queued time in I/O time] # è¿½è¸ªpidç¨‹åºfsæ“ä½œå¤§äº10msçš„æ“ä½œ ext4slower 10 -p 123 # è¿½è¸ªpidç¨‹åºfsæ“ä½œåˆ†å¸ƒ ext4dist -p 123 # ç³»ç»Ÿ time æ—¶é—´çš„ cache çŠ¶æ€ cachestat time llcstat time # å‡½æ•° count / latency / call-interval ç»Ÿè®¡: funccount \u0026#39;./test:read*\u0026#39; -p 123 -d 1 funclatency \u0026#39;./test:read*\u0026#39; -p 123 -d 1 funcinterval \u0026#39;./test:read*\u0026#39; -p 123 -d 1 # on-CPU å’Œ off-CPU ç«ç„°å›¾ï¼Œé‡‡é›† DURATION ç§’ profile -p 123 -f DURATION --stack-storage-size=165535 \u0026gt; profile01.txt flamegraph.pl --width=1600 \u0026lt; profile01.txt \u0026gt; profile01.svg offcputime -p 123 -f DURATION --stack-storage-size=165535 \u0026gt; offcpu01.txt flamegraph.pl --width=1600 \u0026lt; offcpu01.txt \u0026gt; offcpu01.svg # é‡‡é›† pid ç¨‹åºcache-missesè¶…è¿‡çš„10000æ¬¡çº¿ç¨‹åŠå…¶10000æ¬¡çš„æ¬¡æ•° bpftrace -e \u0026#39;hardware:cache-misses:10000 /pid==123/ { @[comm, tid] = count(); }\u0026#39; ç‰ˆæƒå£°æ˜ï¼šå¦‚éœ€è½¬è½½æˆ–å¼•ç”¨ï¼Œè¯·é™„åŠ æœ¬æ–‡é“¾æ¥å¹¶æ³¨æ˜æ¥æºã€‚ ","permalink":"https://mzyee.github.io/posts/usebpf/","summary":"Learning About eBPF Usages","title":"é€šè¿‡ eBPF å·¥å…·è¿›è¡Œæ€§èƒ½åˆ†æ"},{"content":"E-mail: mzyeee@gmail.com\nçŸ¥ä¹: https://www.zhihu.com/people/mzy-59-9\n","permalink":"https://mzyee.github.io/contact/","summary":"E-mail: mzyeee@gmail.com\nçŸ¥ä¹: https://www.zhihu.com/people/mzy-59-9","title":""}]